<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<title>git 中的分支 | ChuckLin's Blog</title>
<meta name=description content="Love and Peace">
<meta name=author content>
<link rel=apple-touch-icon sizes=180x180 href=https://www.chucklin.net/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://www.chucklin.net/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://www.chucklin.net/favicon-16x16.png>
<link rel=manifest href=https://www.chucklin.net/site.webmanifest>
<link rel=mask-icon href=https://www.chucklin.net/safari-pinned-tab.svg color=#00416a>
<meta name=msapplication-TileColor content="#00aba9">
<meta name=theme-color content="#ffffff">
<link rel=me href=mailto:mikumiku.lch@hotmail.com>
<link rel=me href=https://github.com/chuck1in>
<link rel=authorization_endpoint href=https://indieauth.com/auth>
<link rel=token_endpoint href=https://tokens.indieauth.com/token>
<link rel=stylesheet href=https://www.chucklin.net/css/fonts.css>
<link rel=stylesheet href=https://www.chucklin.net/css/style.css>
<link rel=stylesheet href=https://www.chucklin.net/css/custom.css>
<meta name=viewport content="width=device-width,initial-scale=1">
</head>
<body>
<div id=sitelogo>
<a class=glyph alt=Home href=https://www.chucklin.net/><img src=https://www.chucklin.net/images/site-logo.svg alt="Site Logo" height=64px width=64px></a>
</div>
<header>
<nav>
<div id=page-nav>
<div class=page-nav-item>
<a href=https://www.chucklin.net/>Home</a>
</div>
<div class=page-nav-item>
<a href=/about/me>
<span>About</span>
</a>
</div>
<div class=page-nav-item>
<a href=/tags>
<span>Tag</span>
</a>
</div>
</div>
</nav>
</header>
<div id=content>
<article class=h-entry>
<header>
<h1 class="post-title p-name">git 中的分支</h1>
<p class=post-date>Posted on
<time class=dt-published datetime=2019-06-01T09:23:00+08:00>
1 June, 2019 at 09:23 +0800
</time> by <a href=https://www.chucklin.net/ class="p-author h-card" rel=author>Chuck Lin</a>
</p>
</header>
<section class="content e-content">
<h2 id=git-如何存储数据>Git 如何存储数据</h2>
<p>Git 仓库中包含了三种对象：blob 对象、tree object、commit object。三种对象共同组成 git 仓库中的提交记录。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># add file to workspace</span>
vim gitbranchA.txt
vim gitbranchB.txt
vim gitbranchC.txt
<span style=color:#75715e># 暂存操作会为目录下每个文件计算校验和，并生成相应的 tree object 的树对象并存放到仓库中。</span>
git add .
<span style=color:#75715e># 生成一个持有指向 tree object 对象的指针的提交对象。</span>
git commit -m <span style=color:#e6db74>&#39;initial commit of branch&#39;</span>
</code></pre></div><p><img src=https://git-scm.com/book/en/v2/images/commit-and-tree.png alt=此处输入图片的描述></p>
<p>假设你现在又做了一些更改并进行了一次提交，那么第二次提交就会保存着指向它上一次提交的指针。</p>
<p><img src=https://git-scm.com/book/en/v2/images/commits-and-parents.png alt=此处输入图片的描述></p>
<h2 id=分支是什么>分支是什么</h2>
<p>git 的分支只不过是一个指向某次对象的指针。无论指针的名称叫做 master 还是 dev，他们在 git 内部都以指针的形式存在，没有任何区别。</p>
<p><img src=https://git-scm.com/book/en/v2/images/branch-and-history.png alt=此处输入图片的描述></p>
<p>当你使用<code>git branch testing</code> 创建一个分支时，将会创建一个新的指针指向当前你所在分支指向的提交对象上。注意上图中叫做 HEAD 的特殊指针。和其他指针不同，HEAD 是一个指向指针的指针。HEAD 指针中存放的指针内存地址，即代表了你目前所在的分支。
<img src=https://git-scm.com/book/en/v2/images/two-branches.png alt=此处输入图片的描述></p>
<p>现在我们切换到 testing 分支，并进行一系列的提交。</p>
<pre tabindex=0><code>git checkout testing
vim test.rb
git commit - a -m 'made a change'
</code></pre><p><img src=https://git-scm.com/book/en/v2/images/advance-testing.png alt=此处输入图片的描述>
情况开始变得有趣了：testing 分支已经向前移动，而 master 分支依然指向移动之前的提交对象。换言之，目前 master 分支指向的提交对象，是 testing 分支指向的提交对象的父提交对象。</p>
<p>现在让我们切换回 master 分支，做出一些改动并再次提交一次。</p>
<pre tabindex=0><code>git checkout master
vim test.rb
git commit -a -m 'made other changes'
</code></pre><p><img src=https://git-scm.com/book/en/v2/images/checkout-master.png alt=此处输入图片的描述>
<img src=https://git-scm.com/book/en/v2/images/advance-master.png alt=此处输入图片的描述></p>
<p>从现在开始。项目历史产生了分叉。可见，改变分支指针指向的提交对象，就能轻而易举的在各个不同的分支之间进行切换。而其他版本控制系统缺乏类似的轻量级的分支切换开销特性。</p>
<h2 id=什么时候需要将分支合并>什么时候需要将分支合并？</h2>
<p>试想目以下图示中的工作场景。你正在 iss53 号分支上进行着开发工作。突然，业务人员反馈线上出现了一个紧急问题需要修复。
于是你基于 master 分支建立了 hotfix 分支，并将补丁开发完毕。剩下的只要将 hotfix 分支合并回 master 分支，即可大功告成了。</p>
<p><img src=https://git-scm.com/book/en/v2/images/basic-branching-4.png alt=此处输入图片的描述></p>
<pre tabindex=0><code>git checkout master
git merge hotfix
Updating f42c576..3a0874c
Fast-forward
 index.html | 2 ++
 1 file changed, 2 insertions(+)
</code></pre><p>在 master 分支上使用 <code>git merge hotfix</code> 即可将 hotfix 分支合并回 master。你会注意到合并时出现了 fast-forward 的提示。由于当前所在分支 master 所指向的提交对象，是待合并分支 hotfix 所指向的提交对象父提交对象。
所以，对于顺着其中一个提交历史可以直达另一个提交提交历史的合并请求，git 会把分支指针向前移动。这种单线历史合并操作不存在分歧。</p>
<p><img src=https://git-scm.com/book/en/v2/images/basic-branching-5.png alt=此处输入图片的描述></p>
<p>关于这个紧急问题的解决方案发布之后，你准备回到被打断之前时的工作中。然而，你应该先删除 hotfix 分支，因为你已经不再需要它了 —— master 分支已经指向了同一个位置。</p>
<pre tabindex=0><code>git branch -d hotfix
</code></pre><p>现在你可以切换回你正在工作的分支继续你的工作，也就是针对 #53 问题的那个分支(iss53 分支)。
时光飞逝，iss53 的开发工作正式完成。你打算将其合并回 master 分支。</p>
<pre tabindex=0><code>$ git checkout master
Switched to branch 'master'
$ git merge iss53
Merge made by the 'recursive' strategy.
index.html |    1 +
1 file changed, 1 insertion(+)

</code></pre><p>很显然，这和你之前合并 hotfix 分支的时候看起来有一点不一样。
在这种情况下，你的开发历史从一个更早的地方开始分叉开来(diverged)。 因为 master 分支所在的提交并不是 iss53 分支所在提交的直接祖先，Git 不得不做一些额外的工作。 出现这种情况的时候，Git 会使用两个分支的末端所指的快照（C4 和 C5）以及这两个分支的工作祖先（C2），做一个简单的三方合并。</p>
<p><img src=https://git-scm.com/book/en/v2/images/basic-merging-1.png alt=此处输入图片的描述></p>
<p>和之前将分支指针向前推进所不同的是，Git 将此次三方合并的结果做了一个新的快照并且自动创建一个新的提交指向它。 这个被称作一次合并提交，它的特别之处在于他有不止一个父提交。</p>
<p><img src=https://git-scm.com/book/en/v2/images/basic-merging-2.png alt=此处输入图片的描述></p>
<h3 id=合并请求产生冲突的原因>合并请求产生冲突的原因</h3>
<p>当合并请求产生三方合并操作时，git 并不会自作聪明的帮助你判断在应该以哪一方的信息为准。只要待合并的 2 个分支针对同一个文件的同一个位置有改动，git 就没办法帮助你自动进行处理。此时，就产生了合并冲突，需要用户自行解决。</p>
<pre tabindex=0><code>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD:index.html
&lt;div id=&quot;footer&quot;&gt;contact : email.support@github.com&lt;/div&gt;
=======
&lt;div id=&quot;footer&quot;&gt;
 please contact us at support@github.com
&lt;/div&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; iss53:index.html
</code></pre><h2 id=什么是远程分支>什么是远程分支</h2>
<p>刚接触远程分支这个概念时，容易被 remote 这个词汇所误导。实际上，远程分支就是一个存在于本地的，指向某个提交对象的特殊指针而已。你只能合并或者基于远程分支创建副本。
简而言之，远程分支是一个你无法直接在上面工作的普通分支。</p>
<h4 id=远程指针特殊在哪里>远程指针特殊在哪里？</h4>
<p>远程分支的表现形式是<code>(remote)/(branch)</code>。当你将数据从服务器上克隆到本地时，clone 命令会将服务器所有的分支指针拉取到本地，并在本地创建一个指向服务器上 master 分支的分支，并取名为：<code>orgin/master</code>。同时，git 也会帮你创建你自己的本地 master 分支。这个分支和 <code>orgin/master</code> 分支在最开始是指向同样的位置，这样你就可以在上面开始工作了。</p>
<p><img src=https://git-scm.com/book/en/v2/images/remote-branches-1.png alt=此处输入图片的描述></p>
<p>如果你在本地的 master 分支做了一些工作，然而在同一时间，其他人推送提交到 git.ourcompany.com 并更新了它的 master 分支，同时，你又使用 <code>git fetch origin</code> 命令同步了远程服务器的数据。那么现在你的分支就会像是下面这样。</p>
<p><img src=https://git-scm.com/book/en/v2/images/remote-branches-3.png alt=此处输入图片的描述></p>
<p>这和本地分支产生历史分叉没什么区别。唯一不同的是，你无法直接切换到 <code>orgin/master</code> 分支下进行工作，仅此而已。
如果你想要把 <code>origin/master</code> 远程分支所指向的提交对象的内容，反应到你本地的 master 分支的工作空间中，只需要通过合并或者<code>pull</code>的方式，将 <code>origin/master</code> 合并即可。</p>
<pre tabindex=0><code>git merge origin/master
</code></pre><p>同时你也可以基于远程分支，创建自己的本地分支，以便在其上工作。</p>
<h2 id=结语>结语</h2>
<p>git 中的切换分支其实就是改写 HEAD 指针文件中的内容。这样的设计思想，使得其他版本控制系统中费时费力的分支切换到了 git 中变得易如反掌。低廉的分支切换开销，使得在不同的分支上进行快速切换，迅速应对问题的工作方式成为了可能。</p>
<hr>
<p><a href=https://www.progit.cn>《精通 Git pro 第二版》</a></p>
</section>
<footer>
<a class="permalink u-url" href=https://www.chucklin.net/post/git_branch/>🔗</a>
<hr class=post-underline>
<p class=post-tag>Tags for this post:
<a href=https://www.chucklin.net/tags/git class="post-tag p-category">git</a>
</p>
</footer>
</article>
</div>
<div class=h-card>
<img class=u-photo src=https://www.chucklin.net/images/avator.jpg>
<div class=card-content>
<h2 class=card-name><a class="p-name u-url" href=https://www.chucklin.net/ rel=me>Chuck Lin</a></h2>
<p class=card-subhead>
<span class=p-locality>Chengdu</span>,
<span class=p-country-name>China</span><br>
<a class=u-email href=mailto:mikumiku.lch@hotmail.com>Email me</a>
</p>
</div>
<p class=p-note>从事开发工作10年，持续写作4年，现在的身份是一名 freelancer。项目外包、雇佣洽谈等事项请通过邮箱和我联系。</p>
</div>
<div id=footer>
<nav id=article-skip>
<div class=next>
<a alt="Newer article" href=https://www.chucklin.net/post/softskill/>&larr; Newer</a>
</div>
<div class=top>
<a alt="Top of page" href=#>Top</a>
</div>
<div class=prev>
<a alt="Older article" href=https://www.chucklin.net/post/git_revert_reset/>Older &rarr;</a>
</div>
</nav>
<aside id=social>
<div id=social-icons>
<div class=icon-24x24>
<a class=glyph alt="GitHub profile" href=https://github.com/chuck1in><img src=https://www.chucklin.net/icons/github.svg height=24px width=24px></a>
</div>
</div>
</aside>
<p class=copyright>
Copyright © 2021 Chuck Lin. All rights reserved.
</p>
</div>
</body>
</html>