<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>SQL 注入 | ChuckLin's Blog</title><meta name=description content="Love and Peace"><meta name=author content><link rel=apple-touch-icon sizes=180x180 href=https://www.chucklin.net/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://www.chucklin.net/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://www.chucklin.net/favicon-16x16.png><link rel=manifest href=https://www.chucklin.net/site.webmanifest><link rel=mask-icon href=https://www.chucklin.net/safari-pinned-tab.svg color=#00416a><meta name=msapplication-TileColor content="#00aba9"><meta name=theme-color content="#ffffff"><link rel=me href=mailto:chuck1inzl@gmail.com><link rel=me href=https://github.com/chuck1in><link rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link rel=stylesheet href=https://www.chucklin.net/css/fonts.css><link rel=stylesheet href=https://www.chucklin.net/css/style.css><link rel=stylesheet href=https://www.chucklin.net/css/custom.css><meta name=viewport content="width=device-width,initial-scale=1"></head><body><div id=sitelogo><a class=glyph alt=Home href=https://www.chucklin.net/><img src=https://www.chucklin.net/images/site-logo.svg alt="Site Logo" height=64px width=64px></a></div><header><nav><div id=page-nav><div class=page-nav-item><a href=https://www.chucklin.net/>Home</a></div><div class=page-nav-item><a href=/about/me><span>About</span></a></div><div class=page-nav-item><a href=/tags><span>Tag</span></a></div></div></nav></header><div id=content><article class=h-entry><header><h1 class="post-title p-name">SQL 注入</h1><p class=post-date>Posted on
<time class=dt-published datetime=2020-01-29T09:51:00+08:00>29 January, 2020 at 09:51 +0800</time> by <a href=https://www.chucklin.net/ class="p-author h-card" rel=author>Chuck Lin</a></p></header><section class="content e-content"><h2 id=什么是-sql-注入>什么是 SQL 注入</h2><p>SQL 注入攻击（SQL Injection），简称注入攻击，是 Web 开发中最常见的一种安全漏洞。可以用它来从数据库获取敏感信息，或者利用数据库的特性执行添加用户，导出文件等一系列恶意操作，甚至有可能获取数据库乃至系统用户最高权限。</p><p>而造成 SQL 注入的原因是因为程序没有有效过滤用户的输入，使攻击者成功的向服务器提交恶意的 SQL 查询代码，程序在接收后错误的将攻击者的输入作为查询语句的一部分执行，导致原始的查询逻辑被改变，额外的执行了攻击者精心构造的恶意代码。</p><h2 id=sql-注入实例>SQL 注入实例</h2><p>很多 Web 开发者没有意识到 SQL 查询是可以被篡改的，从而把 SQL 查询当作可信任的命令。殊不知，SQL 查询是可以绕开访问控制，从而绕过身份验证和权限检查的。更有甚者，有可能通过 SQL 查询去运行主机系统级的命令。</p><p>下面将通过一些真实的例子来详细讲解 SQL 注入的方式。</p><p>考虑以下简单的登录表单：</p><pre tabindex=0><code>&lt;form action=&#34;/login&#34; method=&#34;POST&#34;&gt;
&lt;p&gt;Username: &lt;input type=&#34;text&#34; name=&#34;username&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Password: &lt;input type=&#34;password&#34; name=&#34;password&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;input type=&#34;submit&#34; value=&#34;登陆&#34; /&gt;&lt;/p&gt;
&lt;/form&gt;
</code></pre><p>我们的处理里面的 SQL 可能是这样的：</p><pre tabindex=0><code>username:=r.Form.Get(&#34;username&#34;)
password:=r.Form.Get(&#34;password&#34;)
sql:=&#34;SELECT * FROM user WHERE username=&#39;&#34;+username+&#34;&#39; AND password=&#39;&#34;+password+&#34;&#39;&#34;
</code></pre><p>如果用户的输入的用户名如下，密码任意</p><pre tabindex=0><code>myuser&#39; or &#39;foo&#39; = &#39;foo&#39; --
</code></pre><p>那么我们的 SQL 变成了如下所示：</p><pre tabindex=0><code>SELECT * FROM user WHERE username=&#39;myuser&#39; or &#39;foo&#39; = &#39;foo&#39; --&#39;&#39; AND password=&#39;xxx&#39;
</code></pre><p>在 SQL 里面&ndash;是注释标记，所以查询语句会在此中断。这就让攻击者在不知道任何合法用户名和密码的情况下成功登录了。</p><p>对于 MSSQL 还有更加危险的一种 SQL 注入，就是控制系统，下面这个可怕的例子将演示如何在某些版本的 MSSQL 数据库上执行系统命令。</p><pre tabindex=0><code>sql:=&#34;SELECT * FROM products WHERE name LIKE &#39;%&#34;+prod+&#34;%&#39;&#34;
Db.Exec(sql)
</code></pre><p>如果攻击提交「a%&rsquo; exec master..xp_cmdshell &rsquo;net user test testpass /ADD&rsquo; &ndash;」作为变量 prod 的值，那么 sql 将会变成</p><pre tabindex=0><code>sql:=&#34;SELECT * FROM products WHERE name LIKE &#39;%a%&#39; exec master..xp_cmdshell &#39;net user test testpass /ADD&#39;--%&#39;&#34;
</code></pre><p>MSSQL 服务器会执行这条 SQL 语句，包括它后面那个用于向系统添加新用户的命令。如果这个程序是以 sa 运行而 MSSQLSERVER 服务又有足够的权限的话，攻击者就可以获得一个系统帐号来访问主机了。</p><p>虽然以上的例子是针对某一特定的数据库系统的，但是这并不代表不能对其它数据库系统实施类似的攻击。针对这种安全漏洞，只要使用不同方法，各种数据库都有可能遭殃。</p><h2 id=如何预防-sql-注入>如何预防 SQL 注入</h2><p>也许你会说攻击者要知道数据库结构的信息才能实施 SQL 注入攻击。确实如此，但没人能保证攻击者一定拿不到这些信息，一旦他们拿到了，数据库就存在泄露的危险。如果你在用开放源代码的软件包来访问数据库，比如论坛程序，攻击者就很容易得到相关的代码。如果这些代码设计不良的话，风险就更大了。目前 Discuz、phpwind、phpcms 等这些流行的开源程序都有被 SQL 注入攻击的先例。
这些攻击总是发生在安全性不高的代码上。所以，永远不要信任外界输入的数据，特别是来自于用户的数据，包括选择框、表单隐藏域和 cookie。就如上面的第一个例子那样，就算是正常的查询也有可能造成灾难。</p><p>SQL 注入攻击的危害这么大，那么该如何来防治呢?下面这些建议或许对防治 SQL 注入有一定的帮助。</p><ol><li>严格限制 Web 应用的数据库的操作权限，给此用户提供仅仅能够满足其工作的最低权限，从而最大限度的减少注入攻击对数据库的危害。</li><li>检查输入的数据是否具有所期望的数据格式，严格限制变量的类型，例如使用 regexp 包进行一些匹配处理，或者使用 strconv 包对字符串转化成其他基本类型的数据进行判断。</li><li>对进入数据库的特殊字符（&rsquo;"\尖括号&*;等）进行转义处理，或编码转换。Go 的 text/template 包里面的 HTMLEscapeString 函数可以对字符串进行转义处理。</li><li>所有的查询语句建议使用数据库提供的参数化查询接口，参数化的语句使用参数而不是将用户输入变量嵌入到 SQL 语句中，即不要直接拼接 SQL 语句。例如使用 database/sql 里面的查询函数 Prepare 和 Query，或者</li></ol><p><code>Exec(query string, args ...interface{})</code></p><p>也就是我们常说的「使用预编译语句 」例如如下句子，可以有效防止注入漏洞：</p><p><code>select * from user where nick = ? and pwd = ?</code></p><ol start=5><li>在应用发布之前建议使用专业的 SQL 注入检测工具进行检测，以及时修补被发现的 SQL 注入漏洞。网上有很多这方面的开源工具，例如 sqlmap、SQLninja 等。</li><li>避免网站打印出 SQL 错误信息，比如类型错误、字段不匹配等，把代码里的 SQL 语句暴露 出来，以防止攻击者利用这些错误信息进行 SQL 注入。</li></ol><h2 id=总结>总结</h2><p>通过上面的示例我们可以知道，SQL 注入是危害相当大的安全漏洞。所以对于我们平常编写的 Web 应用，应该对于每一个小细节都要非常重视，细节决定命运，生活如此，编写 Web 应用也是这样。</p><hr><p>参考链接</p><ul><li><a href=https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/09.4.md>避免 SQL 注入</a>, by wuyuanwei</li><li><a href=http://liuwanlin.info/webgong-ji-yu-fang-hu/>Web 攻击与防护</a>, by liuwulin</li><li><a href=https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy>浏览器的同源策略</a></li><li><a href=https://blog.tonyseek.com/post/introduce-to-xss-and-csrf/>总结 XSS 与 CSRF 两种跨站攻击</a></li><li><a href=http://www.cnblogs.com/bangerlee/archive/2013/04/06/3002142.html>XSS 攻击入门</a></li><li><a href="https://blog.wilddog.com/?p=290">关于 Web 安全，99%的网站都忽略了这些</a>, by wilddog</li><li><a href=https://www.ibm.com/developerworks/cn/web/se-appscan-detect-csrf-xsrf/>预防跨站点请求伪造：了解浏览器选项卡中的隐藏危险</a></li><li><a href=http://www.importnew.com/5839.html>CSRF 攻击的应对之道</a></li></ul></section><footer><a class="permalink u-url" href=https://www.chucklin.net/post/sql-inject/>🔗</a><hr class=post-underline><p class=post-tag>Tags for this post:
<a href=https://www.chucklin.net/tags/security class="post-tag p-category">security</a></p></footer></article></div><div class=h-card><img class=u-photo src=https://www.chucklin.net/images/avator.jpg><div class=card-content><h2 class=card-name><a class="p-name u-url" href=https://www.chucklin.net/ rel=me>Chuck Lin</a></h2><p class=card-subhead><span class=p-locality>Chengdu</span>,
<span class=p-country-name>China</span><br><a class=u-email href=mailto:chuck1inzl@gmail.com>Email me</a></p></div><p class=p-note>从事开发工作10年，持续写作4年，现在的身份是一名 freelancer。项目外包、雇佣洽谈等事项请通过邮箱和我联系。</p></div><div id=footer><nav id=article-skip><div class=next><a alt="Newer article" href=https://www.chucklin.net/post/xss/>&larr; Newer</a></div><div class=top><a alt="Top of page" href=#>Top</a></div><div class=prev><a alt="Older article" href=https://www.chucklin.net/post/goodtest/>Older &rarr;</a></div></nav><aside id=social><div id=social-icons><div class=icon-24x24><a class=glyph alt="GitHub profile" href=https://github.com/chuck1in><img src=https://www.chucklin.net/icons/github.svg height=24px width=24px></a></div></div></aside><p class=copyright>Copyright © 2021 Chuck Lin. All rights reserved.</p></div></body></html>