<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>Spring security è‡ªå®šä¹‰ token èº«ä»½éªŒè¯ | ChuckLin's Blog</title><meta name=description content="Love and Peace"><meta name=author content><link rel=apple-touch-icon sizes=180x180 href=https://www.chucklin.net/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://www.chucklin.net/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://www.chucklin.net/favicon-16x16.png><link rel=manifest href=https://www.chucklin.net/site.webmanifest><link rel=mask-icon href=https://www.chucklin.net/safari-pinned-tab.svg color=#00416a><meta name=msapplication-TileColor content="#00aba9"><meta name=theme-color content="#ffffff"><link rel=me href=mailto:mikumiku.lch@hotmail.com><link rel=me href=https://github.com/chuck1in><link rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link rel=stylesheet href=https://www.chucklin.net/css/fonts.css><link rel=stylesheet href=https://www.chucklin.net/css/style.css><link rel=stylesheet href=https://www.chucklin.net/css/custom.css><meta name=viewport content="width=device-width,initial-scale=1"></head><body><div id=sitelogo><a class=glyph alt=Home href=https://www.chucklin.net/><img src=https://www.chucklin.net/images/site-logo.svg alt="Site Logo" height=64px width=64px></a></div><header><nav><div id=page-nav><div class=page-nav-item><a href=https://www.chucklin.net/>Home</a></div><div class=page-nav-item><a href=/about/me><span>About</span></a></div><div class=page-nav-item><a href=/tags><span>Tag</span></a></div></div></nav></header><div id=content><article class=h-entry><header><h1 class="post-title p-name">Spring security è‡ªå®šä¹‰ token èº«ä»½éªŒè¯</h1><p class=post-date>Posted on
<time class=dt-published datetime=2021-04-03T10:52:00+08:00>3 April, 2021 at 10:52 +0800</time> by <a href=https://www.chucklin.net/ class="p-author h-card" rel=author>Chuck Lin</a></p></header><section class="content e-content"><h2 id=å‰è¨€>å‰è¨€</h2><p>æ—¢ç„¶ Spring securtiy çš„æ ¸å¿ƒæ˜¯ Filter chainsï¼Œé‚£æˆ‘ä»¬åªéœ€è¦å®šä¹‰ä¸€ä¸ªç¬¦åˆ security æ ‡å‡†çš„ filter ï¼Œå†æŠŠè‡ªå·±çš„ chain åŠ å…¥åˆ° VirtualFilterChain é‡Œé¢ï¼Œå°±å¯ä»¥è‡ªå®šä¹‰èº«ä»½éªŒè¯çš„è®¤è¯é€»è¾‘äº†ã€‚</p><p>ä¹‹å‰æåˆ°è¿‡ï¼Œå¤§éƒ¨åˆ†èº«ä»½è®¤è¯ç›¸å…³çš„è¿‡æ»¤å™¨éƒ½ç»§æ‰¿äº† AbstractAuthenticationProcessingFilterã€‚ä½†æ˜¯è¿™ä¸€æ¬¡æˆ‘ä»¬è®©æ¥ä¸‹æ¥çš„è‡ªå®šä¹‰è¿‡æ»¤å™¨ä¸é€‰æ‹©ç»§æ‰¿å®ƒï¼Œè€Œæ˜¯ç»§æ‰¿ OncePerRequestFilterã€‚</p><p>è¿™ä¸ªç±»ä¹‹å‰æˆ‘ä»¬æ²¡æœ‰è§è¿‡ï¼Œå…¶å®å®ƒä¹Ÿæ˜¯ security æ¡†æ¶æä¾›çš„ä¸€ä¸ª VirtualFilter çˆ¶ç±»ã€‚ç»§æ‰¿ä¸€ä¸ªé™Œç”Ÿçš„ç±»å¬èµ·æ¥æœ‰ç‚¹å“äººï¼Œä¸è¿‡å¾ˆå¿«ä½ å°±çŸ¥é“ AbstractAuthenticationProcessingFilter ä¹Ÿå¥½ï¼ŒOncePerRequestFilter ä¹Ÿç½¢ï¼Œéƒ½æ˜¯ filter è€Œå·²ã€‚</p><h2 id=è‡ªå®šä¹‰ä¸€ä¸ª-filter>è‡ªå®šä¹‰ä¸€ä¸ª Filter</h2><p>æˆ‘ä»¬å‚ç…§ security çš„åŸºç¡€èº«ä»½è®¤è¯è¿‡æ»¤å™¨ UsernamePasswordAuthenticationFilter æ¥ç¼–å†™æˆ‘ä»¬çš„è¿‡æ»¤å™¨ã€‚è¿™æ˜¯ä¸æ˜¯æ„å‘³ç€æˆ‘ä»¬ä¹Ÿå¿…é¡»ä½¿ç”¨æ¨¡æ¿è®¾è®¡æ¨¡å¼æ¥ç¼–å†™è‡ªå®šä¹‰è¿‡æ»¤å™¨çš„çˆ¶ç±»ï¼Œç„¶åèšåˆ providerManager å†è‡ªå®šä¹‰ provider å®ç°ä¸€æ•´å¥— security èŒƒå¼çš„èº«ä»½è®¤è¯ä»£ç ï¼Ÿ</p><p>ä¸æ˜¯çš„ï¼Œä½ å®Œå…¨å¯ä»¥æŠŠ provider çš„é€»è¾‘å…¨éƒ¨æŠ½ç¦»å‡ºæ¥åŠ å…¥åˆ°ä½ çš„è‡ªå®šä¹‰è¿‡æ»¤å™¨é‡Œé¢ã€‚å®é™…ä¸Šæˆ‘çš„è¿‡æ»¤å™¨ä¸€å…±å°±ä¸‰ä¸ªé€»è¾‘ã€‚éå¸¸ç®€å•å¹¶ä¸”å¯ä»¥å·¥ä½œçš„å¾ˆå¥½ï¼</p><ol><li>é€šè¿‡ç¡®è®¤ token çš„æœ‰æ•ˆæ€§æ¥éªŒè¯è¯·æ±‚çš„èº«ä»½ã€‚ç±»ä¼¼äº DaoAuthenticationProvider.additionalAuthenticationChecksã€‚</li><li>ä»æ•°æ®åº“æ£€ç´¢å‡ºç”¨æˆ·çš„è¯¦æƒ…ï¼Œæ–¹ä¾¿åç»­å–ç”¨ã€‚ç±»ä¼¼äº DaoAuthenticationProvider. retrieveUser()ã€‚</li><li>å°†éªŒè¯é€šè¿‡çš„èº«ä»½èµ„äº§ï¼ˆprincipalï¼‰å°è£…åˆ° UsernamePasswordAuthenticationTokenï¼Œå¹¶è®¾ç½®åˆ° security contextã€‚ç±»ä¼¼äº AbstractAuthenticationProcessingFilter.successfulAuthenticationã€‚</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doFilterInternal</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>,</span>
                                    HttpServletResponse response<span style=color:#f92672>,</span>
                                    FilterChain chain<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>throws</span> ServletException<span style=color:#f92672>,</span> IOException <span style=color:#f92672>{</span>
        String header <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>(</span>HttpHeaders<span style=color:#f92672>.</span><span style=color:#a6e22e>AUTHORIZATION</span><span style=color:#f92672>);</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>(</span>header<span style=color:#f92672>)</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>header<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span>BEARER_SPACE<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
            globalExceptionHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>commence</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> AuthenticationException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;éæ³•çš„ token è¯·æ±‚å‚æ•°&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#f92672>});</span>
            <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>

        String token <span style=color:#f92672>=</span> header<span style=color:#f92672>.</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34; &#34;</span><span style=color:#f92672>)[</span>1<span style=color:#f92672>].</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            TokenUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>verifyToken</span><span style=color:#f92672>(</span>token<span style=color:#f92672>,</span> base64Secret<span style=color:#f92672>);</span>

        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>FoundationAppException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            globalExceptionHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>commence</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> AuthenticationException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;éæ³•çš„ token&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#f92672>});</span>
            <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>
        <span style=color:#75715e>// è¿”å› 401
</span><span style=color:#75715e></span>        <span style=color:#75715e>// jwt è®¤è¯é€šè¿‡å³ä»£è¡¨è®¤è¯æˆåŠŸã€‚å°† principal èµ„æºè£…é…åˆ° context
</span><span style=color:#75715e></span>        UserDetails userDetails <span style=color:#f92672>=</span> userAppService<span style=color:#f92672>.</span><span style=color:#a6e22e>loadUserByUsername</span><span style=color:#f92672>(</span>TokenUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>getUsername</span><span style=color:#f92672>(</span>token<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;@&#34;</span> <span style=color:#f92672>+</span> TokenUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>getDomain</span><span style=color:#f92672>(</span>token<span style=color:#f92672>));</span>
        UsernamePasswordAuthenticationToken
            authentication <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> UsernamePasswordAuthenticationToken<span style=color:#f92672>(</span>
            userDetails<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span>
            userDetails<span style=color:#f92672>.</span><span style=color:#a6e22e>getAuthorities</span><span style=color:#f92672>()</span>
        <span style=color:#f92672>);</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>userDetails<span style=color:#f92672>.</span><span style=color:#a6e22e>isEnabled</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
            globalExceptionHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>commence</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> DisabledException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;å½“å‰è´¦æˆ·å·²é”å®š&#34;</span><span style=color:#f92672>));</span>
            <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>
        authentication<span style=color:#f92672>.</span><span style=color:#a6e22e>setDetails</span><span style=color:#f92672>(</span>
            <span style=color:#66d9ef>new</span> WebAuthenticationDetailsSource<span style=color:#f92672>().</span><span style=color:#a6e22e>buildDetails</span><span style=color:#f92672>(</span>request<span style=color:#f92672>)</span>
        <span style=color:#f92672>);</span>
        SecurityContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setAuthentication</span><span style=color:#f92672>(</span>authentication<span style=color:#f92672>);</span>
        chain<span style=color:#f92672>.</span><span style=color:#a6e22e>doFilter</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

</code></pre></div><h2 id=å®ç°-loadbyusername>å®ç° loadByUsername</h2><p>è®©æˆ‘ä»¬çš„ä»»ä½•ä¸€ä¸ªç±»â€”â€”æˆ‘å»ºè®®æ˜¯å’Œ user ç›¸å…³å¤„ç†çš„ service ç±»å®ç° UserDetailsService æ¥å£ï¼Œå°±å¯ä»¥é‡å†™ loadByUsername æ–¹æ³•äº†ã€‚
å®ç°è¿™ä¸ªæ¥å£å¾ˆé‡è¦ï¼Œå› ä¸ºä»–å®šä¹‰äº† UserDetails æ¥å£â€”â€”è¿™ä¸ªä½ çš„ç”¨æˆ·å¯¹è±¡åº”è¯¥éµå®ˆçš„è§„èŒƒå’Œè¡Œä¸ºã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> UserDetails <span style=color:#a6e22e>loadUserByUsername</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> UsernameNotFoundException <span style=color:#f92672>{</span>
        String<span style=color:#f92672>[]</span> split <span style=color:#f92672>=</span> name<span style=color:#f92672>.</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;@&#34;</span><span style=color:#f92672>);</span>
        String username <span style=color:#f92672>=</span> split<span style=color:#f92672>[</span>0<span style=color:#f92672>];</span>
        String domainCode <span style=color:#f92672>=</span> split<span style=color:#f92672>[</span>1<span style=color:#f92672>];</span>
        Domain domain <span style=color:#f92672>=</span> domainRepository<span style=color:#f92672>.</span><span style=color:#a6e22e>findByCode</span><span style=color:#f92672>(</span>domainCode<span style=color:#f92672>).</span><span style=color:#a6e22e>orElseThrow</span><span style=color:#f92672>(</span>
            <span style=color:#f92672>()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>new</span> UsernameNotFoundException<span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;User with domain - %s, not found&#34;</span><span style=color:#f92672>,</span> domainCode<span style=color:#f92672>))</span>
        <span style=color:#f92672>);</span>
        AuthUser user <span style=color:#f92672>=</span> authUserRepository
            <span style=color:#f92672>.</span><span style=color:#a6e22e>findByDomainAndUsername</span><span style=color:#f92672>(</span>domain<span style=color:#f92672>,</span> username<span style=color:#f92672>)</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>orElseThrow</span><span style=color:#f92672>(</span>
                <span style=color:#f92672>()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>new</span> UsernameNotFoundException<span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;User with username and domain - %s, not found&#34;</span><span style=color:#f92672>,</span> name<span style=color:#f92672>))</span>
            <span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> user<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
</code></pre></div><h2 id=è€ƒè™‘ä¸€ä¸‹å¼‚å¸¸å¤„ç†>è€ƒè™‘ä¸€ä¸‹å¼‚å¸¸å¤„ç†</h2><p>è‡ªå®šä¹‰ token è¿‡æ»¤å™¨çš„å·¥ä½œè¿™å°±åŸºæœ¬å®Œæˆäº†ã€‚ä¸è¿‡å¥å£®çš„å¤„ç†ç¨‹åºï¼Œå¾€å¾€éƒ½ä¼´éšç€å¼‚å¸¸é€»è¾‘çš„å®Œç¾æ•è·ã€‚å›å¿†ä¹‹å‰çš„å†…å®¹ï¼Œfilter çš„å¼‚å¸¸å¤„ç†éƒ½æ˜¯é€šè¿‡ç«¯ç‚¹å¤„ç†ç¨‹åºâ€”â€”AuthenticationEntryPointFailureHandler æ¥å¤„ç†çš„ã€‚æ‰€ä»¥åªè¦æˆ‘ä»¬è‡ªå®šä¹‰ç«¯ç‚¹å¤„ç†ç¨‹åºå¹¶é‡å†™ commence æ–¹æ³•å°±å®Œå…¨å¯ä»¥è¾¾åˆ°ä¸€æ ·çš„æ•ˆæœã€‚</p><p><strong>AuthenticationEntryPointFailureHandler</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Override</span>
	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onAuthenticationFailure</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>,</span> HttpServletResponse response<span style=color:#f92672>,</span>
			AuthenticationException exception<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>,</span> ServletException <span style=color:#f92672>{</span>
		<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>authenticationEntryPoint</span><span style=color:#f92672>.</span><span style=color:#a6e22e>commence</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>,</span> exception<span style=color:#f92672>);</span>
	<span style=color:#f92672>}</span>
</code></pre></div><p><strong>è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ç¨‹åº</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>commence</span><span style=color:#f92672>(</span>HttpServletRequest httpServletRequest<span style=color:#f92672>,</span> HttpServletResponse httpServletResponse<span style=color:#f92672>,</span> AuthenticationException e<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
        log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;spring security è®¤è¯å‘ç”Ÿå¼‚å¸¸ã€‚&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
        HttpResponseWriter<span style=color:#f92672>.</span><span style=color:#a6e22e>sendError</span><span style=color:#f92672>(</span>httpServletResponse<span style=color:#f92672>,</span> HttpServletResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>SC_UNAUTHORIZED</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;èº«ä»½è®¤è¯å¤±è´¥&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handle</span><span style=color:#f92672>(</span>HttpServletRequest httpServletRequest<span style=color:#f92672>,</span> HttpServletResponse httpServletResponse<span style=color:#f92672>,</span> AccessDeniedException e<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
        log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;spring security é‰´æƒå‘ç”Ÿå¼‚å¸¸ã€‚&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
        HttpResponseWriter<span style=color:#f92672>.</span><span style=color:#a6e22e>sendError</span><span style=color:#f92672>(</span>httpServletResponse<span style=color:#f92672>,</span> HttpServletResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>SC_FORBIDDEN</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;é‰´æƒå¤±è´¥&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
</code></pre></div><h2 id=å°†è‡ªå®šä¹‰å†…å®¹è£…é…è¿›-security-æ¶æ„>å°†è‡ªå®šä¹‰å†…å®¹è£…é…è¿› security æ¶æ„</h2><p>è¦æƒ³æˆ‘ä»¬çš„è¿‡æ»¤å™¨å…ˆä¸€æ­¥ç”Ÿæ•ˆï¼Œéœ€è¦å°†è¿‡æ»¤å™¨åŠ å…¥åˆ° security è‡ªå¸¦çš„è®¤è¯è¿‡æ»¤å™¨ä¹‹å‰ï¼›æ¥ç€è¿˜éœ€è¦æŠŠè‡ªå®šä¹‰å¼‚å¸¸é…ç½®åˆ°å¼‚å¸¸å¤„ç†æµç¨‹ä¸­ã€‚æ˜¯çš„ï¼Œå°±è¿™äº›å·¥ä½œå†…å®¹ï¼Œæ²¡æœ‰æ›´å¤šäº†ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@EnableWebSecurity</span>
<span style=color:#a6e22e>@EnableGlobalMethodSecurity</span><span style=color:#f92672>(</span>prePostEnabled <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> securedEnabled <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecurityConfig</span> <span style=color:#66d9ef>extends</span> WebSecurityConfigurerAdapter <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> UserAppService userAppService<span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> JwtTokenFilter jwtTokenFilter<span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> GlobalExceptionHandler globalExceptionHandler<span style=color:#f92672>;</span>

    <span style=color:#75715e>/**
</span><span style=color:#75715e>     * é…ç½®å¯†ç åŠ å¯†è£…ç½®
</span><span style=color:#75715e>     */</span>
    <span style=color:#a6e22e>@Bean</span>
    <span style=color:#66d9ef>public</span> PasswordEncoder <span style=color:#a6e22e>passwordEncoder</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> BCryptPasswordEncoder<span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>

    <span style=color:#75715e>/**
</span><span style=color:#75715e>     * é…ç½® Dao Authenticationprovider åè°ƒå™¨
</span><span style=color:#75715e>     */</span>
    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configure</span><span style=color:#f92672>(</span>AuthenticationManagerBuilder auth<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
        <span style=color:#75715e>// configure authentication manager
</span><span style=color:#75715e></span>        auth<span style=color:#f92672>.</span><span style=color:#a6e22e>userDetailsService</span><span style=color:#f92672>(</span>userAppService<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configure</span><span style=color:#f92672>(</span>WebSecurity web<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        web<span style=color:#f92672>.</span><span style=color:#a6e22e>ignoring</span><span style=color:#f92672>()</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>antMatchers</span><span style=color:#f92672>(</span>HttpMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>OPTIONS</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;/**&#34;</span><span style=color:#f92672>)</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>antMatchers</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/swagger-ui/index.html&#34;</span><span style=color:#f92672>)</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>antMatchers</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/test/**&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#75715e>/**
</span><span style=color:#75715e>     * web å®‰å…¨é…ç½®
</span><span style=color:#75715e>     */</span>
    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configure</span><span style=color:#f92672>(</span>HttpSecurity http<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
        <span style=color:#75715e>// Enable CORS and disable CSRF
</span><span style=color:#75715e></span>        http <span style=color:#f92672>=</span> http<span style=color:#f92672>.</span><span style=color:#a6e22e>cors</span><span style=color:#f92672>().</span><span style=color:#a6e22e>and</span><span style=color:#f92672>().</span><span style=color:#a6e22e>csrf</span><span style=color:#f92672>().</span><span style=color:#a6e22e>disable</span><span style=color:#f92672>();</span>

        <span style=color:#75715e>// Set session management to stateless
</span><span style=color:#75715e></span>        http <span style=color:#f92672>=</span> http
            <span style=color:#f92672>.</span><span style=color:#a6e22e>sessionManagement</span><span style=color:#f92672>()</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>sessionCreationPolicy</span><span style=color:#f92672>(</span>SessionCreationPolicy<span style=color:#f92672>.</span><span style=color:#a6e22e>STATELESS</span><span style=color:#f92672>)</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>and</span><span style=color:#f92672>();</span>

        <span style=color:#75715e>// exception handler
</span><span style=color:#75715e></span>        http<span style=color:#f92672>.</span><span style=color:#a6e22e>exceptionHandling</span><span style=color:#f92672>()</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>authenticationEntryPoint</span><span style=color:#f92672>(</span>globalExceptionHandler<span style=color:#f92672>)</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>accessDeniedHandler</span><span style=color:#f92672>(</span>globalExceptionHandler<span style=color:#f92672>);</span>

        <span style=color:#75715e>// Set permissions on endpoints
</span><span style=color:#75715e></span>        http<span style=color:#f92672>.</span><span style=color:#a6e22e>authorizeRequests</span><span style=color:#f92672>()</span>
            <span style=color:#75715e>// Our public endpoints
</span><span style=color:#75715e></span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>antMatchers</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/foundation/api/example/**&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>permitAll</span><span style=color:#f92672>()</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>anyRequest</span><span style=color:#f92672>().</span><span style=color:#a6e22e>authenticated</span><span style=color:#f92672>();</span>

        <span style=color:#75715e>// Add JWT token filter
</span><span style=color:#75715e></span>        http<span style=color:#f92672>.</span><span style=color:#a6e22e>addFilterBefore</span><span style=color:#f92672>(</span>
            jwtTokenFilter<span style=color:#f92672>,</span>
            UsernamePasswordAuthenticationFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span>
        <span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>


    <span style=color:#a6e22e>@Bean</span>
    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> AuthenticationManager <span style=color:#a6e22e>authenticationManagerBean</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>authenticationManagerBean</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>

</code></pre></div><h2 id=ç»“è¯­>ç»“è¯­</h2><p>è¿™å°±æ˜¯è‡ªå®šä¹‰ token èº«ä»½éªŒè¯ä¸é…ç½®çš„å…¨éƒ¨å·¥ä½œå†…å®¹ã€‚ç”±äº spring security å¤§é‡ä½¿ç”¨äº†ç»„åˆä¸è®¾è®¡æ¨¡å¼ä½¿å¾—ä»»ä½•å¼€å‘è€…éƒ½å¯ä»¥å®šä¹‰å‡ºå„å¼å„æ ·çš„èº«ä»½éªŒè¯é€»è¾‘ï¼Œæ‰€ä»¥åªè¦ä½ çš„è‡ªå®šä¹‰ç¨‹åºå¯ä»¥åµŒåˆåˆ° security æ¡†æ¶é‡Œå¹¶ä¸”å¯ä»¥å¾ˆå¥½çš„å·¥ä½œï¼Œé‚£ä»–å°±æ˜¯é€‚åˆä½ çš„èº«ä»½éªŒè¯ã€‚</p></section><footer><a class="permalink u-url" href=https://www.chucklin.net/post/springsecurity_authentication2/>ğŸ”—</a><hr class=post-underline><p class=post-tag>Tags for this post:
<a href=https://www.chucklin.net/tags/java class="post-tag p-category">java</a></p></footer></article></div><div class=h-card><img class=u-photo src=https://www.chucklin.net/images/avator.jpg><div class=card-content><h2 class=card-name><a class="p-name u-url" href=https://www.chucklin.net/ rel=me>Chuck Lin</a></h2><p class=card-subhead><span class=p-locality>Chengdu</span>,
<span class=p-country-name>China</span><br><a class=u-email href=mailto:mikumiku.lch@hotmail.com>Email me</a></p></div><p class=p-note>ğŸ‘‹å¾ˆé«˜å…´è§åˆ°ä½ ã€‚æˆ‘ä»äº‹å¼€å‘å·¥ä½œ10å¹´ã€æŒç»­å†™ä½œ4å¹´ï¼›ç°åœ¨çš„èº«ä»½æ˜¯ä¸€å freelancerã€‚é¡¹ç›®å¤–åŒ…ã€é›‡ä½£æ´½è°ˆç­‰äº‹é¡¹è¯·é€šè¿‡é‚®ç®±å’Œæˆ‘è”ç³»ã€‚</p></div><div id=footer><nav id=article-skip><div class=next><a alt="Newer article" href=https://www.chucklin.net/post/springsecurity_authority/>&larr; Newer</a></div><div class=top><a alt="Top of page" href=#>Top</a></div><div class=prev><a alt="Older article" href=https://www.chucklin.net/post/springsecurity_authentication/>Older &rarr;</a></div></nav><aside id=social><div id=social-icons><div class=icon-24x24><a class=glyph alt="GitHub profile" href=https://github.com/chuck1in><img src=https://www.chucklin.net/icons/github.svg height=24px width=24px></a></div></div></aside><p class=copyright>Copyright Â© 2021 Chuck Lin. All rights reserved.</p></div></body></html>