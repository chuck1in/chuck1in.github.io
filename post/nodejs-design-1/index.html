<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>é”è¯„ Nodejs è®¾è®¡æ¨¡å¼ - åˆ›å»ºä¸ç»“æ„å‹ | ChuckLin's Blog</title><meta name=description content="Love and Peace"><meta name=author content><link rel=apple-touch-icon sizes=180x180 href=https://www.chucklin.net/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://www.chucklin.net/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://www.chucklin.net/favicon-16x16.png><link rel=manifest href=https://www.chucklin.net/site.webmanifest><link rel=mask-icon href=https://www.chucklin.net/safari-pinned-tab.svg color=#00416a><meta name=msapplication-TileColor content="#00aba9"><meta name=theme-color content="#ffffff"><link rel=me href=mailto:chuck1inzl@gmail.com><link rel=me href=https://github.com/chuck1in><link rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link rel=stylesheet href=https://www.chucklin.net/css/fonts.css><link rel=stylesheet href=https://www.chucklin.net/css/style.css><link rel=stylesheet href=https://www.chucklin.net/css/custom.css><meta name=viewport content="width=device-width,initial-scale=1"></head><body><div id=sitelogo><a class=glyph alt=Home href=https://www.chucklin.net/><img src=https://www.chucklin.net/images/site-logo.svg alt="Site Logo" height=64px width=64px></a></div><header><nav><div id=page-nav><div class=page-nav-item><a href=https://www.chucklin.net/>Home</a></div><div class=page-nav-item><a href=/about/me><span>About</span></a></div><div class=page-nav-item><a href=/tags><span>Tag</span></a></div></div></nav></header><div id=content><article class=h-entry><header><h1 class="post-title p-name">é”è¯„ Nodejs è®¾è®¡æ¨¡å¼ - åˆ›å»ºä¸ç»“æ„å‹</h1><p class=post-date>Posted on
<time class=dt-published datetime=2022-06-17T07:31:52+08:00>17 June, 2022 at 07:31 +0800</time> by <a href=https://www.chucklin.net/ class="p-author h-card" rel=author>Chuck Lin</a></p></header><section class="content e-content"><h2 id=å•ä¾‹æ¨¡å¼ä¸æ¨¡å—ç³»ç»Ÿ>å•ä¾‹æ¨¡å¼ä¸æ¨¡å—ç³»ç»Ÿ</h2><p>Node çš„å•ä¾‹æ¨¡å¼æ—¢ç‰¹æ®Šåˆç®€å•â€”â€”å‡¡æ˜¯ä»æ¨¡å—ä¸­å¯¼å‡ºçš„å®ä¾‹å¤©ç”Ÿå°±æ˜¯å•ä¾‹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// database.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Database</span>(<span style=color:#a6e22e>connect</span>, <span style=color:#a6e22e>account</span>, <span style=color:#a6e22e>password</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>connect</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>connect</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>account</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>account</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>password</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>database</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Database</span>(<span style=color:#e6db74>&#34;localhost&#34;</span>, <span style=color:#e6db74>&#34;root&#34;</span>, <span style=color:#e6db74>&#34;123456&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>database</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// index.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>database1</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./database.js&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>database2</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./database.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>database1</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>database2</span>); <span style=color:#75715e>// true
</span></span></span></code></pre></div><p>è¿™æ˜¯ç”±äº Node.js åŠ è½½å®ŒæŸä¸ªæ¨¡å—åï¼Œä¼šåˆ›å»ºæ¨¡å—ä¸æ¨¡å—æ ‡è¯†ç¬¦
(module specifier) çš„æ˜ å°„å…³ç³»å¹¶å°†å…¶ç¼“å­˜èµ·æ¥ä¾›åç»­ä½¿ç”¨ï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š</p><p><strong>pseudo code (CommonJS module)</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>loadModule</span>(<span style=color:#a6e22e>filename</span>, <span style=color:#a6e22e>module</span>, <span style=color:#a6e22e>require</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>wrappedSrc</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`(function(module,exports,require) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readFileSync</span>(<span style=color:#a6e22e>filename</span>, <span style=color:#e6db74>&#34;utf8&#34;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74> 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  })(module,module.exports,require)`</span>;
</span></span><span style=display:flex><span>  eval(<span style=color:#a6e22e>wrappedSrc</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>require</span>(<span style=color:#a6e22e>moduleName</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>moduleName</span>);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åŠ è½½ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>cache</span>[<span style=color:#a6e22e>id</span>]) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>cache</span>[<span style=color:#a6e22e>id</span>].<span style=color:#a6e22e>exports</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>module</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>exports</span><span style=color:#f92672>:</span> {} };
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ç¼“å­˜æ¨¡å—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>cache</span>[<span style=color:#a6e22e>id</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>module</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>loadModule</span>(<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>module</span>, <span style=color:#a6e22e>require</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>cache</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span><span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>resolve</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>moduleName</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>moduleName</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>å¾—ç›Šäº CommonJS module å’Œ ES module çš„ç¼“å­˜åŠŸèƒ½ï¼Œåœ¨ Node ä¸­æˆ‘ä»¬ä¸å†éœ€è¦ä¸“é—¨çš„å•ä¾‹è®¾è®¡æ¨¡å¼äº†ã€‚</p><h2 id=revealing-constructor>Revealing Constructor</h2><p>å¦‚æœä½ æƒ³è®¾è®¡ä¸€ä¸ªåªèƒ½åœ¨åˆå§‹åŒ–æ—¶æ”¹å˜çŠ¶æ€çš„ç±»ï¼Œå°±å¯ä»¥é‡‡ç”¨è¿™ç§æŠ€å·§ã€‚æˆ–è€…æ¢ä¸€ç§è¯´æ³•ï¼šè¯¥ç±»å®ä¾‹åŒ–å®Œæ¯•åå°±ä¸å¯å˜ï¼ˆimmutableï¼‰ã€‚</p><p>å¯èƒ½ä½ ä¼šè§‰å¾— Revealing Constructor æœ‰ç‚¹é™Œç”Ÿï¼Œå› ä¸ºå®ƒä¸æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„é‚£ç§è®¾è®¡æ¨¡å¼ã€‚ä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œå› ä¸ºä½ ä¸€å®šè§è¿‡å®ƒäº†ã€‚åœ¨ Node.js ä¸­è¿™ä¸ªæ¨¡å¼è¿ç”¨çš„å¾ˆå¹¿æ³›ï¼Œå…¶ä¸­æœ€å¸¸è§çš„å°±æ˜¯ Promiseã€‚</p><p><strong>pseudo code</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TinyPromise</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>executor</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pending&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>undefined</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>executor</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>resolve</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resolve</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>value</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;resolve&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>then</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>func</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;resolve&#34;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>func</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TinyPromise</span>((<span style=color:#a6e22e>resolve</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resolve</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}).<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>value</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#75715e>// output: 1
</span></span></span></code></pre></div><h2 id=proxy-ä»£ç†è£…é¥°ä¸é€‚é…>Proxy ä»£ç†è£…é¥°ä¸é€‚é…</h2><p>ES å†…ç½®çš„ Proxy æ”¯æŒåœ¨è¿è¡ŒæœŸ (runtime) åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œä½¿é€šè¿‡ç»„åˆå’Œå§”æ´¾è§£å†³é—®é¢˜çš„è®¾è®¡æ¨¡å¼éƒ½èƒ½é€šè¿‡ Proxy çš„æ–¹å¼å¾—åˆ°ä½“ç°ï¼Œæ¶ˆé™¤äº†ç¡¬ç¼–ç ä»£ç†ç±»äº§ç”Ÿçš„å†—ä½™ä»£ç ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Subject</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>morning</span> <span style=color:#f92672>=</span> () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;morning&#34;</span>);
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bye</span> <span style=color:#f92672>=</span> () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;bye&#34;</span>);
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>subject</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Subject</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>subjectHandler</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>get</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>target</span>, <span style=color:#a6e22e>prop</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¿”å›å¢å¼ºåçš„æ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>prop</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;morning&#34;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å¢å¼ºé€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;good&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è°ƒç”¨åŸå¯¹è±¡é€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>target</span>[<span style=color:#a6e22e>prop</span>]();
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¿”å›åŸå¯¹è±¡ä¸­çš„å±æ€§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>target</span>[<span style=color:#a6e22e>prop</span>];
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#75715e>// setã€hasã€delete...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>enhanceSubject</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Proxy(<span style=color:#a6e22e>subject</span>, <span style=color:#a6e22e>subjectHandler</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>enhanceSubject</span>.<span style=color:#a6e22e>morning</span>(); <span style=color:#75715e>// good morning
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>enhanceSubject</span>.<span style=color:#a6e22e>bye</span>(); <span style=color:#75715e>// bye
</span></span></span></code></pre></div><p>é€šè¿‡ Proxy è¡¨è¾¾çš„ä»£ç†ã€è£…é¥°å™¨ã€é€‚é…å™¨è®¾è®¡æ¨¡å¼çœ‹èµ·æ¥éƒ½å·®ä¸å¤šï¼Œå·®åˆ«ä¸»è¦åœ¨äºåº”ç”¨åœºæ™¯ï¼š</p><ol><li>ä»£ç†å¼ºè°ƒå¯¹æŸä¸ªå¯¹è±¡çš„è®¿é—®çš„æ§åˆ¶ã€‚</li><li>è£…é¥°å™¨å¼ºè°ƒå¯¹å¯¹è±¡å±æ€§çš„å¢å¼ºã€‚</li><li>é€‚é…å™¨åˆ™æä¾›ä¸åŸå¯¹è±¡ä¸åŒçš„è¡Œä¸ºä»¥é€‚é…æ–°çš„åœºæ™¯ã€‚</li></ol><h2 id=proxy-ä¸å¯¹è±¡è™šæ‹ŸåŒ–>Proxy ä¸å¯¹è±¡è™šæ‹ŸåŒ–</h2><p>ä¸‹é¢è¿™ä¸ªä¾‹å­å®ç°äº†ä¸€ä¸ªæ¶µç›–æ‰€æœ‰å¶æ•°çš„è™šæ‹ŸåŒ–æ•°ç»„â€”â€”å…·å¤‡æ•°ç»„çš„è¡Œä¸ºä½†ä¸å®é™…å­˜å‚¨æ•°æ®ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>eventNumbers</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Proxy([], {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>get</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>target</span>, <span style=color:#a6e22e>prop</span>) =&gt; <span style=color:#a6e22e>index</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>has</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>target</span>, <span style=color:#a6e22e>number</span>) =&gt; <span style=color:#a6e22e>number</span> <span style=color:#f92672>%</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#ae81ff>2</span> <span style=color:#66d9ef>in</span> <span style=color:#a6e22e>eventNumbers</span>); <span style=color:#75715e>// true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#ae81ff>3</span> <span style=color:#66d9ef>in</span> <span style=color:#a6e22e>eventNumbers</span>); <span style=color:#75715e>// false
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>eventNumbers</span>[<span style=color:#ae81ff>7</span>]); <span style=color:#75715e>// 14
</span></span></span></code></pre></div><p>ä¸¾è¿™ä¸ªä¾‹å­æ˜¯æƒ³è¯´æ˜ï¼ŒProxy çš„ä½œç”¨ä¸ä»…ä»…å±€é™äºè®¾è®¡æ¨¡å¼ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–åŠŸèƒ½å¯ä»¥ç”¨ Proxy æ¥ä½“ç°ï¼Œæ¯”å¦‚ï¼šã€Œå…ƒç¼–ç¨‹ (meta-programming)ã€è¿ç®—ç¬¦é‡è½½ (operator overloading) å’Œå¯¹è±¡è™šæ‹ŸåŒ– (object virtualization)ã€</p><h2 id=change-observer-ä¸å“åº”å¼ç¼–ç¨‹>Change Observer ä¸å“åº”å¼ç¼–ç¨‹</h2><p>ç»“åˆ Proxy çš„ set æ–¹æ³• (trapMethod) è¿˜å¯ä»¥å®ç°è§‚å¯Ÿè€…æ¨¡å¼â€”â€”å½“æŸä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶é€šçŸ¥è§‚å¯Ÿè€…ã€‚</p><p>åœ¨å¼ºç±»å‹è¯­è¨€ä¸­è§‚å¯Ÿè€…ä¸€èˆ¬æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”±äº js ä¸­çš„æ‰€æœ‰å‡½æ•°éƒ½æ˜¯é—­åŒ…çš„ç¼˜æ•…ï¼Œæ‰€ä»¥è§‚å¯Ÿè€…å¯ä»¥æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// è¢«è§‚æµ‹å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>invoice</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>subtotal</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>discount</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tax</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>20</span>,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶çš„å›è°ƒå‡½æ•°(è®¡ç®—ç¥¨æ®æ€»é¢)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>calculateTotal</span>(<span style=color:#a6e22e>invoice</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>subtotal</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>discount</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>tax</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// target: è¢«ä»£ç†å¯¹è±¡ observe: å›è°ƒå‡½æ•°(calculateTotal)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>createObservable</span>(<span style=color:#a6e22e>target</span>, <span style=color:#a6e22e>observe</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>observable</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Proxy(<span style=color:#a6e22e>target</span>, {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// obj: åŸå§‹å¯¹è±¡ prop: å±æ€§ value: å€¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>obj</span>, <span style=color:#a6e22e>prop</span>, <span style=color:#a6e22e>value</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// å¦‚æœå¾…è®¾ç½®çš„å±æ€§å€¼å’Œä¹‹å‰çš„å±æ€§ä¸åŒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>value</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>prop</span>]) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>prev</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>prop</span>];
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>prop</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>        <span style=color:#75715e>// callback
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>observe</span>({ <span style=color:#a6e22e>prop</span>, <span style=color:#a6e22e>prev</span>, <span style=color:#a6e22e>curr</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>value</span> });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>observable</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>total</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>calculateTotal</span>(<span style=color:#a6e22e>invoice</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>total</span>); <span style=color:#75715e>// 120
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆ›å»ºä»£ç†å¯¹è±¡(è§‚æµ‹è¯¥å¯¹è±¡å±æ€§å‘ç”Ÿå˜åŒ–)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>obsInvoice</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createObservable</span>(<span style=color:#a6e22e>invoice</span>, (<span style=color:#a6e22e>change</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>change</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>calculateTotal</span>(<span style=color:#a6e22e>invoice</span>));
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ‰“å°ç¥¨æ® total: 210
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>obsInvoice</span>.<span style=color:#a6e22e>subtotal</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>200</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// æ‰“å°ç¥¨æ® total: 200
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>obsInvoice</span>.<span style=color:#a6e22e>discount</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// æ‰“å°ç¥¨æ® total: 200
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>obsInvoice</span>.<span style=color:#a6e22e>discount</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// æ‰“å°ç¥¨æ® total: 210
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>obsInvoice</span>.<span style=color:#a6e22e>tax</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>30</span>;
</span></span></code></pre></div><p>åƒä¸Šä¾‹è¿™æ ·ç”±å®ä¾‹çŠ¶æ€çš„å˜åŒ–æ¥é©±åŠ¨ä¸šåŠ¡ï¼Œè€Œä¸æ˜¯ç”±å®¢æˆ·ç«¯(è°ƒç”¨æ–¹)æ¥å‘èµ·ä¸šåŠ¡è°ƒç”¨çš„ç¼–ç¨‹èŒƒå¼ï¼Œç§°ä¸ºå“åº”å¼ç¼–ç¨‹ã€‚(reactive programming RP)</p><h2 id=ç»“è¯­>ç»“è¯­</h2><ol><li>ä»£ç†ã€è£…é¥°å™¨ã€é€‚é…å™¨éƒ½æ˜¯ç»“æ„å‹æ¨¡å¼ï¼Œä½“ç°çš„è®¾è®¡æ€æƒ³éƒ½å·®ä¸å¤šâ€”â€”é€šè¿‡å¯¹è±¡çš„ç»“æ„æ¥ç®¡ç†å®ä½“é—´çš„å…³ç³»ã€‚</li><li>Proxy ä¸ä»…ç”¨æ¥å®ç°è®¾è®¡æ¨¡å¼ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥å®Œæˆå¾ˆå¤šå…¶ä»–åŠŸèƒ½å’Œç¼–ç¨‹èŒƒå¼ã€‚</li><li>å°±åƒ js ä¸­çš„é—­åŒ…å‡½æ•°ä¸€æ ·ï¼Œæ¨¡å—å¯¼å‡ºå¤©ç”Ÿå°±æ˜¯å•ä¾‹ã€‚</li></ol></section><footer><a class="permalink u-url" href=https://www.chucklin.net/post/nodejs-design-1/>ğŸ”—</a><hr class=post-underline><p class=post-tag>Tags for this post:
<a href=https://www.chucklin.net/tags/javascript class="post-tag p-category">javascript</a></p></footer></article></div><div class=h-card><img class=u-photo src=https://www.chucklin.net/images/avator.jpg><div class=card-content><h2 class=card-name><a class="p-name u-url" href=https://www.chucklin.net/ rel=me>Chuck Lin</a></h2><p class=card-subhead><span class=p-locality>Chengdu</span>,
<span class=p-country-name>China</span><br><a class=u-email href=mailto:chuck1inzl@gmail.com>Email me</a></p></div><p class=p-note>ä»äº‹å¼€å‘å·¥ä½œ10å¹´ï¼ŒæŒç»­å†™ä½œ4å¹´ï¼Œç°åœ¨çš„èº«ä»½æ˜¯ä¸€å freelancerã€‚é¡¹ç›®å¤–åŒ…ã€é›‡ä½£æ´½è°ˆç­‰äº‹é¡¹è¯·é€šè¿‡é‚®ç®±å’Œæˆ‘è”ç³»ã€‚</p></div><div id=footer><nav id=article-skip><div class=next><a alt="Newer article" href=https://www.chucklin.net/post/nodejs-design-2/>&larr; Newer</a></div><div class=top><a alt="Top of page" href=#>Top</a></div><div class=prev><a alt="Older article" href=https://www.chucklin.net/post/transcation-lock/>Older &rarr;</a></div></nav><aside id=social><div id=social-icons><div class=icon-24x24><a class=glyph alt="GitHub profile" href=https://github.com/chuck1in><img src=https://www.chucklin.net/icons/github.svg height=24px width=24px></a></div></div></aside><p class=copyright>Copyright Â© 2021 Chuck Lin. All rights reserved.</p></div></body></html>