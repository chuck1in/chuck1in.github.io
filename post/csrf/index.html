<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<title>CSRF/XSRF 跨站请求伪造 | ChuckLin's Blog</title>
<meta name=description content="Love and Peace">
<meta name=author content>
<link rel=apple-touch-icon sizes=180x180 href=https://www.chucklin.net/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://www.chucklin.net/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://www.chucklin.net/favicon-16x16.png>
<link rel=manifest href=https://www.chucklin.net/site.webmanifest>
<link rel=mask-icon href=https://www.chucklin.net/safari-pinned-tab.svg color=#00416a>
<meta name=msapplication-TileColor content="#00aba9">
<meta name=theme-color content="#ffffff">
<link rel=me href=mailto:mikumiku.lch@hotmail.com>
<link rel=me href=https://github.com/chuck1in>
<link rel=authorization_endpoint href=https://indieauth.com/auth>
<link rel=token_endpoint href=https://tokens.indieauth.com/token>
<link rel=stylesheet href=https://www.chucklin.net/css/fonts.css>
<link rel=stylesheet href=https://www.chucklin.net/css/style.css>
<link rel=stylesheet href=https://www.chucklin.net/css/custom.css>
<meta name=viewport content="width=device-width,initial-scale=1">
</head>
<body>
<div id=sitelogo>
<a class=glyph alt=Home href=https://www.chucklin.net/><img src=https://www.chucklin.net/images/site-logo.svg alt="Site Logo" height=64px width=64px></a>
</div>
<header>
<nav>
<div id=page-nav>
<div class=page-nav-item>
<a href=https://www.chucklin.net/>Home</a>
</div>
<div class=page-nav-item>
<a href=/about/me>
<span>About</span>
</a>
</div>
<div class=page-nav-item>
<a href=/tags>
<span>Tag</span>
</a>
</div>
</div>
</nav>
</header>
<div id=content>
<article class=h-entry>
<header>
<h1 class="post-title p-name">CSRF/XSRF 跨站请求伪造</h1>
<p class=post-date>Posted on
<time class=dt-published datetime=2020-02-18T09:52:00+08:00>
18 February, 2020 at 09:52 +0800
</time> by <a href=https://www.chucklin.net/ class="p-author h-card" rel=author>Chuck Lin</a>
</p>
</header>
<section class="content e-content">
<p>CSRF（Cross Site Request Forgery, 跨站域请求伪造）也称 XSRF， 是一种网络的攻击方式，它在 2007 年曾被列为互联网 20 大安全隐患之一。其他安全隐患，比如 SQL 脚本注入，跨站域脚本攻击等在近年来已经逐渐为众人熟知，很多网站也都针对他们进行了防御。然而，对于大多数人来说，CSRF 却依然是一个陌生的概念。即便是大名鼎鼎的 Gmail, 在 2007 年底也存在着 CSRF 漏洞，从而被黑客攻击而使 Gmail 的用户造成巨大的损失。</p>
<h2 id=同源策略带来的安全隐患>同源策略带来的安全隐患</h2>
<p>回顾上一章节的内容我们有提到，在浏览器的同源策略的约束下，对于跨域资源交互进行处理时，通常允许跨「域资源嵌入（Cross-origin embedding）」。</p>
<p>下面是常见跨域资源嵌入示例：</p>
<ul>
<li><code>&lt;script src="...">&lt;/script></code>标签嵌入跨域脚本。语法错误信息只能在同源脚本中捕捉到。</li>
<li><code>&lt;img></code>嵌入图片。支持的图片格式包括 PNG,JPEG,GIF,BMP,SVG,&mldr;</li>
<li><code>&lt;video></code> 和 <code>&lt;audio></code>嵌入多媒体资源。</li>
</ul>
<p>CSRF 攻击的原理，就是利用由于浏览器的同源策略对以上嵌入资源不做限制的行为进行跨站请求伪造的。</p>
<h2 id=csrf-攻击原理>CSRF 攻击原理</h2>
<p><img src=http://static.zybuluo.com/mikumikulch/ta5h6dxooi0wzkkqq1st8y7n/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-04-03%20%E4%B8%8B%E5%8D%8812.11.03.png alt="屏幕快照 2017-04-03 下午12.11.03.png-62.4kB"></p>
<ol>
<li>用户浏览位于目标服务器 A 的网站。并通过登录验证。</li>
<li>获取到 cookie_session_id，保存到浏览器 cookie 中。</li>
<li>在未登出服务器 A ，并在 session_id 失效前用户浏览位于 hacked server B 上的网站。</li>
<li>server B 网站中的<code>&lt;img src = "http://www.altoromutual.com/bank/transfer.aspx?creditAccount=1001160141&transferAmount=1000"></code>嵌入资源起了作用，迫使用户访问目标服务器 A</li>
<li>由于用户未登出服务器 A 并且 sessionId 未失效，请求通过验证，非法请求被执行。</li>
</ol>
<h2 id=如何防御-csrf>如何防御 CSRF</h2>
<p><strong>referer 验证解决方案</strong>
最简单的方法依赖于浏览器引用页头部。大多数浏览器会告诉 Web 服务器，哪个页面发送了请求。如：</p>
<pre tabindex=0><code>POST /bank/transfer.aspx HTTP/1.1
Referer: http://evilsite.com/myevilblog
User-Agent: Mozilla/4....
Host: www.altoromutual.com
Content-Length: 42
Cookie: SessionId=x3q2v0qpjc0n1c55mf35fxid;
</code></pre><p>不少站点通过 referer 验证来防止盗链本站图片资源。
不过由于 http 头在某些版本的浏览器上存在可被篡改的可能性，所以这个解决方案并不完善。</p>
<p><strong>Token 解决方案</strong>
令牌解决方案向表单添加一个参数，让表单在用户注销时或一个超时期限结束后过期</p>
<pre tabindex=0><code>&lt;form id=&quot;transferForm&quot; action=&quot;https://www.altoromutual.com/bank/transfer.aspx&quot; method=&quot;post&quot;&gt;

Enter the credit account:
&lt;input type=&quot;text&quot; name=&quot;creditAccount&quot; value=&quot;&quot;&gt;
Enter the transfer amount:
&lt;input type=&quot;text&quot; name=&quot;transferAmount&quot; value=&quot;&quot;&gt;

&lt;input type=&quot;hidden&quot; name=&quot;xsrftoken&quot; value=&quot;JKBS38633jjhg0987PPll&quot;&gt;

&lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;

&lt;/form&gt;
</code></pre><p>或者将服务端动态生成的 Token 加入到 自定义 http 请求头参数中</p>
<pre tabindex=0><code>POST /bank/transfer.aspx HTTP/1.1
Referer: https://www.altoromutual.com/bank
xsrftoken: JKBS38633jjhg0987PPll
User-Agent: Mozilla/4....
Host: www.altoromutual.com
Content-Length: 42
Cookie: SessionId=x3q2v0qpjc0n1c55mf35fxid;

creditAccount=1001160141&amp;transferAmount=10
</code></pre><p>token 解决方案的问题在于前后端代码的巨大变更。并且每一步都动态生成 token 并且对 token 进行验证的话，也会造成额外的资源开销。可以尝试在关键性操作的地方再加上 token 验证逻辑。但是，token 验证所带来的前后端代码的变动所带来的消耗，则需要慎重考虑。</p>
<p><strong>userId 解决方案</strong>
相对于 token 这样的需要前后端逻辑作出改动，以及造成额外资源开销的方式以外还有一种小巧的防范措施。就是用户每次请求关键性数据时，后端接口在设计时都需要用户提交相关的 userId。userId 可以存储到浏览器的 localStorage 中，这样便能进一步提高接口安全性，防止跨站请求伪造。</p>
<h2 id=总结>总结</h2>
<p>要记住 CSRF 不是黑客唯一的攻击手段，无论你 CSRF 防范有多么严密，如果你系统有其他安全漏洞，比如跨站域脚本攻击 XSS，那么黑客就可以绕过你的安全防护，展开包括 CSRF 在内的各种攻击，你的防线将如同虚设。</p>
<p>CSRF 是一种危害非常大的攻击，又很难以防范。目前几种防御策略虽然可以很大程度上抵御 CSRF 的攻击，但并没有一种完美的解决方案。一些新的方案正在研究之中，比如对于每次请求都使用不同的动态口令，把 Referer 和 token 方案结合起来，甚至尝试修改 HTTP 规范，但是这些新的方案尚不成熟，要正式投入使用并被业界广为接受还需时日。在这之前，我们只有充分重视 CSRF，根据系统的实际情况选择最合适的策略，这样才能把 CSRF 的危害降到最低。</p>
<hr>
<p>参考链接</p>
<ul>
<li>
<p><a href=https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/09.4.md>避免 SQL 注入</a>, by wuyuanwei</p>
</li>
<li>
<p><a href=http://liuwanlin.info/webgong-ji-yu-fang-hu/>Web 攻击与防护</a>, by liuwulin</p>
</li>
<li>
<p><a href=https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy>浏览器的同源策略</a></p>
</li>
<li>
<p><a href=https://blog.tonyseek.com/post/introduce-to-xss-and-csrf/>总结 XSS 与 CSRF 两种跨站攻击</a></p>
</li>
<li>
<p><a href=http://www.cnblogs.com/bangerlee/archive/2013/04/06/3002142.html>XSS 攻击入门</a></p>
</li>
<li>
<p><a href="https://blog.wilddog.com/?p=290">关于 Web 安全，99%的网站都忽略了这些</a>, by wilddog</p>
</li>
<li>
<p><a href=https://www.ibm.com/developerworks/cn/web/se-appscan-detect-csrf-xsrf/>预防跨站点请求伪造：了解浏览器选项卡中的隐藏危险</a></p>
</li>
<li>
<p><a href=http://www.importnew.com/5839.html>CSRF 攻击的应对之道</a></p>
</li>
</ul>
</section>
<footer>
<a class="permalink u-url" href=https://www.chucklin.net/post/csrf/>🔗</a>
<hr class=post-underline>
<p class=post-tag>Tags for this post:
<a href=https://www.chucklin.net/tags/security class="post-tag p-category">security</a>
</p>
</footer>
</article>
</div>
<div class=h-card>
<img class=u-photo src=https://www.chucklin.net/images/avator.jpg>
<div class=card-content>
<h2 class=card-name><a class="p-name u-url" href=https://www.chucklin.net/ rel=me>Chuck Lin</a></h2>
<p class=card-subhead>
<span class=p-locality>Chengdu</span>,
<span class=p-country-name>China</span><br>
<a class=u-email href=mailto:mikumiku.lch@hotmail.com>Email me</a>
</p>
</div>
<p class=p-note>从事开发工作10年，持续写作4年，现在的身份是一名 freelancer。项目外包、雇佣洽谈等事项请通过邮箱和我联系。</p>
</div>
<div id=footer>
<nav id=article-skip>
<div class=next>
<a alt="Newer article" href=https://www.chucklin.net/post/cors/>&larr; Newer</a>
</div>
<div class=top>
<a alt="Top of page" href=#>Top</a>
</div>
<div class=prev>
<a alt="Older article" href=https://www.chucklin.net/post/xss/>Older &rarr;</a>
</div>
</nav>
<aside id=social>
<div id=social-icons>
<div class=icon-24x24>
<a class=glyph alt="GitHub profile" href=https://github.com/chuck1in><img src=https://www.chucklin.net/icons/github.svg height=24px width=24px></a>
</div>
</div>
</aside>
<p class=copyright>
Copyright © 2021 Chuck Lin. All rights reserved.
</p>
</div>
</body>
</html>