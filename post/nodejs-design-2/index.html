<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>é”è¯„ Nodejs è®¾è®¡æ¨¡å¼ - è¡Œä¸ºå‹ | ChuckLin's Blog</title><meta name=description content="Love and Peace"><meta name=author content><link rel=apple-touch-icon sizes=180x180 href=https://www.chucklin.net/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://www.chucklin.net/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://www.chucklin.net/favicon-16x16.png><link rel=manifest href=https://www.chucklin.net/site.webmanifest><link rel=mask-icon href=https://www.chucklin.net/safari-pinned-tab.svg color=#00416a><meta name=msapplication-TileColor content="#00aba9"><meta name=theme-color content="#ffffff"><link rel=me href=mailto:chuck1inzl@gmail.com><link rel=me href=https://github.com/chuck1in><link rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link rel=stylesheet href=https://www.chucklin.net/css/fonts.css><link rel=stylesheet href=https://www.chucklin.net/css/style.css><link rel=stylesheet href=https://www.chucklin.net/css/custom.css><meta name=viewport content="width=device-width,initial-scale=1"></head><body><div id=sitelogo><a class=glyph alt=Home href=https://www.chucklin.net/><img src=https://www.chucklin.net/images/site-logo.svg alt="Site Logo" height=64px width=64px></a></div><header><nav><div id=page-nav><div class=page-nav-item><a href=https://www.chucklin.net/>Home</a></div><div class=page-nav-item><a href=/about/me><span>About</span></a></div><div class=page-nav-item><a href=/tags><span>Tag</span></a></div></div></nav></header><div id=content><article class=h-entry><header><h1 class="post-title p-name">é”è¯„ Nodejs è®¾è®¡æ¨¡å¼ - è¡Œä¸ºå‹</h1><p class=post-date>Posted on
<time class=dt-published datetime=2022-06-20T04:39:00+08:00>20 June, 2022 at 04:39 +0800</time> by <a href=https://www.chucklin.net/ class="p-author h-card" rel=author>Chuck Lin</a></p></header><section class="content e-content"><h2 id=iterator-è¿­ä»£å™¨æ¨¡å¼>Iterator è¿­ä»£å™¨æ¨¡å¼</h2><p>Node ä¸­çš„è¿­ä»£å™¨æ˜¯ä¸€ç§çº¦å®šï¼Œè¿™ä¸ªçº¦å®šåŒ…æ¶µä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><p>ä¸€. å¦‚æœä¸€ä¸ªå¯¹è±¡æ‹¥æœ‰ä¸€ä¸ªåä¸º Symbol.iterator çš„æ–¹æ³•ï¼Œé‚£è¿™ä¸ªå¯¹è±¡å°±æ˜¯ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ (iterable)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyIterable</span> {
</span></span><span style=display:flex><span>  [<span style=color:#a6e22e>Symbol</span>.<span style=color:#a6e22e>iterator</span>]() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {};
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>äºŒ. Symbol.iterator æ–¹æ³•åº”è¯¥è¿”å›ä¸€ä¸ªè¢«ç§°ä¸º iterator çš„æŒ‰ç…§çº¦å®šå®ç°çš„å¯¹è±¡</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ¯æ¬¡è°ƒç”¨æ—¶éƒ½è¿”å›ä¸€ä¸ªè¡¨ç¤ºè¿­ä»£çŠ¶æ€çš„å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>next</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>done</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> <span style=color:#75715e>// true:false è¡¨ç¤ºè¿­ä»£å®Œæˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;element&#34;</span> <span style=color:#75715e>// è¿­ä»£å‡ºçš„å…ƒç´ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¸‰. iterator éœ€è¦è®°å½•è¢«è¿­ä»£å¯¹è±¡çš„è¿­ä»£ä½ç½®ï¼ŒåŒæ—¶åˆä¸èƒ½å°†è¿­ä»£ä½ç½®ç­‰å†…éƒ¨å±æ€§æš´éœ²åˆ°å¤–éƒ¨</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// è¢«è¿­ä»£å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>MyIterable</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>[<span style=color:#a6e22e>Symbol</span>.<span style=color:#a6e22e>iterator</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é€šè¿‡é—­åŒ…æ¥ç®¡ç† iterator çš„è¿­ä»£ä½ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>position</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¿”å›ä¸€ä¸ª iterator
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// è°ƒç”¨ iterator.next() è·å–å½“å‰è¿­ä»£å¯¹è±¡çš„è¿­ä»£çŠ¶æ€çš„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>next</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>position</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>done</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>, <span style=color:#75715e>// true:false è¡¨ç¤ºè¿­ä»£å®Œæˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;element&#34;</span>, <span style=color:#75715e>// è¿­ä»£å‡ºçš„å…ƒç´ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        };
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä»»ä½•å¯¹è±¡æ— è®ºæ˜¯å¦æ˜¯é›†åˆç»“æ„ï¼Œåªè¦ç¬¦åˆä¸Šè¿°çº¦å®šçš„å¯¹è±¡å°±æ˜¯å¯è¿­ä»£å¯¹è±¡ã€‚
æ¯”å¦‚ä¸‹é¢è¿™ä¸ªå¯éå†æ‰€æœ‰è‹±æ–‡å¤§å†™å­—æ¯çš„å¯¹è±¡å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„å¯è¿­ä»£å¯¹è±¡</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>AlphabetIterator</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>[<span style=color:#a6e22e>Symbol</span>.<span style=color:#a6e22e>iterator</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>A_CHAR_CODE</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>65</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Z_CHAR_CODE</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>90</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>currentCharCode</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>A_CHAR_CODE</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>next</span><span style=color:#f92672>:</span> () =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>currentCharCode</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>Z_CHAR_CODE</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>currentChar</span> <span style=color:#f92672>=</span> String.<span style=color:#a6e22e>fromCharCode</span>(<span style=color:#a6e22e>currentCharCode</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>currentCharCode</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>currentChar</span>, <span style=color:#a6e22e>done</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span> };
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>done</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> };
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>alphabet</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AlphabetIterator</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>iterator</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>alphabet</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>iterator</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// output: ABCDE...Z
</span></span></span></code></pre></div><p>é™¤äº† <code>for...of</code> çš„æ–¹å¼ä»¥å¤–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ›´åŠ ç›´è§‚çš„æ‰‹å·¥è°ƒç”¨æ–¹å¼</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>iterator</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AlphabetIterator</span>()[<span style=color:#a6e22e>Symbol</span>.<span style=color:#a6e22e>iterator</span>]();
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>iteratorStatus</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>(<span style=color:#a6e22e>iteratorStatus</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>iterator</span>.<span style=color:#a6e22e>next</span>()).<span style=color:#a6e22e>done</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>iteratorStatus</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=generator-ç”Ÿæˆå™¨>Generator ç”Ÿæˆå™¨</h2><p>ç”Ÿæˆå™¨å‡½æ•°æ˜¯ä¸€ç§ç‰¹æ®Šçš„å‡½æ•°ï¼Œè°ƒç”¨è¿™ç§å‡½æ•°ä¸ä¼šç«‹å³å¾—åˆ°è¿”å›å€¼ï¼Œè€Œæ˜¯ä¼šè¿”å›ä¸€ä¸ª iterable å¯¹è±¡</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>function</span><span style=color:#f92672>*</span> <span style=color:#a6e22e>fruitGenerator</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>yield</span> <span style=color:#e6db74>&#34;peach&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>yield</span> <span style=color:#e6db74>&#34;watermelon&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;summer&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>or</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>iterator</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>fruitGenerator</span>()) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>iterator</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// peach
</span></span></span><span style=display:flex><span><span style=color:#75715e>// watermelon
</span></span></span></code></pre></div><p>ä½¿ç”¨ <code>for of</code> å…³é”®å­—å¯ä»¥è¿­ä»£è¿™ä¸ªç”Ÿæˆå™¨å‡½æ•°åˆ›å»ºçš„ iterable å¯¹è±¡ï¼Œç´§è·Ÿ yield å…³é”®å­—çš„å€¼å°±æ˜¯æ¯æ¬¡è¿­ä»£çš„å…ƒç´ ã€‚</p><p>é™¤äº† <code>for of</code> ä»¥å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡æ‰‹å·¥çš„æ–¹å¼è¿­ä»£è¿™ä¸ªç”Ÿæˆå™¨å¯¹è±¡ï¼Œå› ä¸ºç”Ÿæˆå™¨å‡½æ•°å¹¶ä¸æ˜¯ä»€ä¹ˆé­”æ³•ï¼Œè°ƒç”¨è¯¥å‡½æ•°è¿”å›çš„å¯¹è±¡é™¤äº†å¯è¿­ä»£ (iterable) ä»¥å¤–ï¼Œè¿˜æ˜¯ä¸€ä¸ª iterator å¯¹è±¡</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>fruitGeneratorObj</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fruitGenerator</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>fruitGeneratorObj</span>.<span style=color:#a6e22e>next</span>());
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>fruitGeneratorObj</span>.<span style=color:#a6e22e>next</span>());
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>fruitGeneratorObj</span>.<span style=color:#a6e22e>next</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>{ <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;peach&#39;</span>, <span style=color:#a6e22e>done</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span> }
</span></span><span style=display:flex><span>{ <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;watermelon&#39;</span>, <span style=color:#a6e22e>done</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span> }
</span></span><span style=display:flex><span><span style=color:#75715e>// æ‰‹å·¥è°ƒç”¨ iterator èƒ½å¤Ÿè·å–åˆ° done:true çš„ç»“æœ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>{ <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;summer&#39;</span>, <span style=color:#a6e22e>done</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> }
</span></span></code></pre></div><p>ç”±äºä½¿ç”¨ç”Ÿæˆå™¨å‡½æ•°è¦æ¯”æ„å»ºä¸€ä¸ªæ»¡è¶³<a href=#iterator-%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%A8%A1%E5%BC%8F>çº¦å®š</a>çš„å¯è¿­ä»£å¯¹è±¡ç®€å•çš„å¤šï¼Œæ‰€ä»¥ç”Ÿæˆå™¨å‡½æ•°å¸¸è¢«ç”¨æ¥æ›¿ä»£æ™®é€šçš„è¿­ä»£å™¨</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>AlphabetIterator</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>[<span style=color:#a6e22e>Symbol</span>.<span style=color:#a6e22e>iterator</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span><span style=color:#f92672>*</span> () {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>A_CHAR_CODE</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>65</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Z_CHAR_CODE</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>90</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>currentCharCode</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>A_CHAR_CODE</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>currentCharCode</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>Z_CHAR_CODE</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>currentChar</span> <span style=color:#f92672>=</span> String.<span style=color:#a6e22e>fromCharCode</span>(<span style=color:#a6e22e>currentCharCode</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>currentCharCode</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>yield</span> <span style=color:#a6e22e>currentChar</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>alphabetIterator</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AlphabetIterator</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>iterator</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>alphabetIterator</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>iterator</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=å¼‚æ­¥è¿­ä»£å™¨ä¸æµ>å¼‚æ­¥è¿­ä»£å™¨ä¸æµ</h2><p>è¿­ä»£å™¨å’Œç”Ÿæˆå™¨é™¤äº†åŒæ­¥ä»¥å¤–è¿˜æœ‰å¼‚æ­¥çš„ç‰ˆæœ¬ã€‚å¦‚æœä¸€ä¸ª iterator è¿”å›äº†ä¸€ä¸ª Promise é‚£è¿™ä¸ªè¿­ä»£å™¨å°±æ˜¯å¼‚æ­¥çš„ã€‚</p><p><code>for await...of</code> è¯­æ³•è¿­ä»£ä¸€ä¸ªå®ç°äº† <code>@@asyncIterator</code> æ–¹æ³•çš„å¼‚æ­¥å¯è¿­ä»£å¯¹è±¡ï¼Œä½¿ç”¨çš„æ–¹æ³•å°±åƒä¸‹é¢è¿™æ ·</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>asyncIterator</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>iterable</span>[<span style=color:#a6e22e>Symbol</span>.<span style=color:#a6e22e>asyncIterator</span>]();
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>iterationResult</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>asyncIterator</span>.<span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>iterationResult</span>.<span style=color:#a6e22e>done</span>) {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>iterationResult</span>.<span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span> <span style=color:#a6e22e>iterationResult</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>asyncIterator</span>.<span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿­ä»£å™¨ä¸æµçš„ç»“æ„å¾ˆç›¸ä¼¼â€”â€”éƒ½æ˜¯ä¸€å°å—ä¸€å°å—çš„å¤„ç†èµ„æºã€‚æ‰€ä»¥å¾ˆå¤šæ—¶å€™ä»–ä»¬éƒ½å¯ä»¥äº’æ¢ï¼Œå¹¶æ”¯æŒè¢« <code>for await...of</code> è¯­æ³•è¿­ä»£</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>stream</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>stdin</span>.<span style=color:#a6e22e>pipe</span>(<span style=color:#a6e22e>split</span>());
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>await</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>line</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>stream</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>line</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=middleware-ä¸­é—´ä»¶>Middleware ä¸­é—´ä»¶</h2><p>ä¸­é—´ä»¶å·®ä¸å¤šç›¸å½“äºè´£ä»»é“¾è®¾è®¡æ¨¡å¼(Chain of Responsibility)ï¼Œä¸è¿‡ Node è¯­å¢ƒä¸‹çš„ä¸­é—´ä»¶ä¸€èˆ¬æ˜¯å¼‚æ­¥çš„å¤„ç†å‡½æ•°ï¼Œè€Œæ³¨å†Œä¸­é—´ä»¶çš„è¿‡ç¨‹å°±åƒæŠŠæµæ‹¼æ¥æˆä¸€ä¸ªç®¡é“ï¼Œæ‰€ä»¥ç”¨ã€Œæ¶æ„åŒ–çš„å¼‚æ­¥ç®¡é“å¤„ç†ã€æ¥å½¢å®¹æ›´åŠ è´´åˆ‡ä¸€ç‚¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>combine</span>(<span style=color:#a6e22e>req</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;hello &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>req</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>flip</span>(<span style=color:#a6e22e>req</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#34;&#34;</span>).<span style=color:#a6e22e>reverse</span>().<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Manager</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>middleWares</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>use</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>middleWare</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>middleWares</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>middleWare</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>execute</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>req</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>f</span> <span style=color:#66d9ef>of</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>middleWares</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>req</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>f</span>(<span style=color:#a6e22e>req</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>req</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>manager</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Manager</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>manager</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>combine</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>manager</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>flip</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>manager</span>.<span style=color:#a6e22e>execute</span>(<span style=color:#e6db74>&#34;chuck&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;finish&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>// output ==&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>// hello chuck
</span></span></span><span style=display:flex><span><span style=color:#75715e>// kcuhc olleh
</span></span></span><span style=display:flex><span><span style=color:#75715e>// finish
</span></span></span></code></pre></div><h2 id=å‘½ä»¤è®¾è®¡æ¨¡å¼>å‘½ä»¤è®¾è®¡æ¨¡å¼</h2><p>åœ¨ Node ä¸­è°ˆå‘½ä»¤å°±åƒ<a href=https://www.chucklin.net/post/nodejs-design-1/>å•ä¾‹</a>ä¸€æ ·æœ‰ç‚¹å¤šä½™ã€‚å› ä¸º js çš„é—­åŒ…å‡½æ•°å¤©ç”Ÿå°±æ˜¯ä¸€ä¸ª command</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// create command
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>createTask</span>(<span style=color:#a6e22e>target</span>, ...<span style=color:#a6e22e>args</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// execute target
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>target</span>(...<span style=color:#a6e22e>args</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>arg</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;chuck&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>command</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createTask</span>((<span style=color:#a6e22e>arg</span>) =&gt; <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>arg</span>), <span style=color:#a6e22e>arg</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>command</span>();
</span></span><span style=display:flex><span><span style=color:#75715e>// output ==&gt; chuck
</span></span></span></code></pre></div><h2 id=ç»“è¯­>ç»“è¯­</h2><ol><li>è¿­ä»£å™¨å’Œå¯è¿­ä»£å¯¹è±¡ä»£è¡¨çš„è¿­ä»£å™¨è®¾è®¡æ¨¡å¼æ˜¯ä¸€ç§çº¦å®šã€‚</li><li>ç”Ÿæˆå™¨å°±æ˜¯ä¸€ä¸ªå®ç°äº†<code>@@iterator</code>çš„è¿­ä»£å™¨ã€‚</li><li>è¿­ä»£å™¨å’Œç”Ÿæˆå™¨æ—¢å¯ä»¥æ˜¯åŒæ­¥ä¹Ÿå¯ä»¥æ˜¯å¼‚æ­¥ã€‚</li><li>node ä¸­çš„é—­åŒ…å‡½æ•°å¤©ç”Ÿå°±æ˜¯å‘½ä»¤å¼çš„ã€‚</li></ol></section><footer><a class="permalink u-url" href=https://www.chucklin.net/post/nodejs-design-2/>ğŸ”—</a><hr class=post-underline><p class=post-tag>Tags for this post:
<a href=https://www.chucklin.net/tags/javascript class="post-tag p-category">javascript</a></p></footer></article></div><div class=h-card><img class=u-photo src=https://www.chucklin.net/images/avator.jpg><div class=card-content><h2 class=card-name><a class="p-name u-url" href=https://www.chucklin.net/ rel=me>Chuck Lin</a></h2><p class=card-subhead><span class=p-locality>Chengdu</span>,
<span class=p-country-name>China</span><br><a class=u-email href=mailto:chuck1inzl@gmail.com>Email me</a></p></div><p class=p-note>ä»äº‹å¼€å‘å·¥ä½œ10å¹´ï¼ŒæŒç»­å†™ä½œ4å¹´ï¼Œç°åœ¨çš„èº«ä»½æ˜¯ä¸€å freelancerã€‚é¡¹ç›®å¤–åŒ…ã€é›‡ä½£æ´½è°ˆç­‰äº‹é¡¹è¯·é€šè¿‡é‚®ç®±å’Œæˆ‘è”ç³»ã€‚</p></div><div id=footer><nav id=article-skip><div class=next><p>&nbsp;</p></div><div class=top><a alt="Top of page" href=#>Top</a></div><div class=prev><a alt="Older article" href=https://www.chucklin.net/post/nodejs-design-1/>Older &rarr;</a></div></nav><aside id=social><div id=social-icons><div class=icon-24x24><a class=glyph alt="GitHub profile" href=https://github.com/chuck1in><img src=https://www.chucklin.net/icons/github.svg height=24px width=24px></a></div></div></aside><p class=copyright>Copyright Â© 2021 Chuck Lin. All rights reserved.</p></div></body></html>