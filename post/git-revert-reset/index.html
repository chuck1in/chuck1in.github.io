<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>git 中的撤回机制 | ChuckLin's Blog</title><meta name=description content="Love and Peace"><meta name=author content><link rel=apple-touch-icon sizes=180x180 href=https://www.chucklin.net/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://www.chucklin.net/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://www.chucklin.net/favicon-16x16.png><link rel=manifest href=https://www.chucklin.net/site.webmanifest><link rel=mask-icon href=https://www.chucklin.net/safari-pinned-tab.svg color=#00416a><meta name=msapplication-TileColor content="#00aba9"><meta name=theme-color content="#ffffff"><link rel=me href=mailto:chuck1inzl@gmail.com><link rel=me href=https://github.com/chuck1in><link rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link rel=stylesheet href=https://www.chucklin.net/css/fonts.css><link rel=stylesheet href=https://www.chucklin.net/css/style.css><link rel=stylesheet href=https://www.chucklin.net/css/custom.css><meta name=viewport content="width=device-width,initial-scale=1"></head><body><div id=sitelogo><a class=glyph alt=Home href=https://www.chucklin.net/><img src=https://www.chucklin.net/images/site-logo.svg alt="Site Logo" height=64px width=64px></a></div><header><nav><div id=page-nav><div class=page-nav-item><a href=https://www.chucklin.net/>Home</a></div><div class=page-nav-item><a href=/about/me><span>About</span></a></div><div class=page-nav-item><a href=/tags><span>Tag</span></a></div></div></nav></header><div id=content><article class=h-entry><header><h1 class="post-title p-name">git 中的撤回机制</h1><p class=post-date>Posted on
<time class=dt-published datetime=2019-06-01T09:23:00+08:00>1 June, 2019 at 09:23 +0800</time> by <a href=https://www.chucklin.net/ class="p-author h-card" rel=author>Chuck Lin</a></p></header><section class="content e-content"><h2 id=reset>Reset</h2><p>假设目前我们处于下图所示的工作场景中。我们正在 master 分支上进行工作。目前工作目录是干净的，这意味着暂存索引区中的文件内容与工作目录是一致的。并且，HEAD 指向的 master 分支指向的提交对象，也和目前工作空间中的文件内容保持一致。</p><p><img src=https://git-scm.com/book/en/v2/images/reset-start.png alt=此处输入图片的描述></p><p>现在，让我们来一步步看看 reset 命令究竟做了些什么。</p><h4 id=第一步移动-head>第一步：移动 HEAD</h4><p>reset 做的第一件事是移动 HEAD 的指向。 这与改变 HEAD 自身不同（checkout 所做的）；reset 移动 HEAD 指向的分支。 这意味着如果 HEAD 设置为 master 分支（例如，你正在 master 分支上），运行 git reset 9e5e64a 将会使 master 指向 9e5e64a。
使用 rest 命令将 HEAD 指向的 master 重置到其父提交对象。
<code>git reset --soft HEAD~</code></p><p><img src=https://git-scm.com/book/en/v2/images/reset-soft.png alt=此处输入图片的描述></p><p>再强调一次，checkout 命令修改的是 HEAD 分支变量保存的地址内容，而 reset 命令是修改的 HEAD 分支所指向的分支变量中保存的地址内容。到目前为止，reset 命令实际上撤销了最近一次的 git commit 命令。</p><h4 id=第二步更新暂存区>第二步：更新暂存区</h4><p>如果你现在执行 <code>git status</code> 你会看到 git 提示你当前暂存区的变动有差异，需要进行提交。现在，reset 要做的下一件事是使用 HEAD 当前所指向的快照的内容来更新索引。</p><p><img src=https://git-scm.com/book/en/v2/images/reset-mixed.png alt=此处输入图片的描述></p><h4 id=第三步更新工作目录>第三步：更新工作目录</h4><p>reset 要做的的第三件事情就是让工作目录看起来像索引。 如果使用 &ndash;hard 选项，它将会继续这一步。
<img src=https://git-scm.com/book/en/v2/images/reset-hard.png alt=此处输入图片的描述></p><p>现在让我们回想一下刚才发生的事情。你撤销了最后的提交、git add 和 git commit 命令以及工作目录中的所有工作。如果现在使用 <code>git log</code>查看 git 的提交记录，就会发现 reset 目标分支之后的提交记录全都消失了。</p><p>当客户端尝试将 reset 过后的版本内容推送到远端时，会被服务器拒绝并提示本地的版本落后于远端的版本。这很容易理解，因为你本地的分支指针指向的提交对象是远程仓库中的对应指针指向的提交对象的父提交对象。为了覆盖掉远端信息，你需要在命令的后面加上 &ndash;force 参数。</p><pre tabindex=0><code>git push origin &lt;分支名&gt; --force
</code></pre><h2 id=revert>Revert</h2><p>revert 命令可以生成一个新的提交，撤销已有提交的所有变更。这样的操作被称为还原。</p><pre tabindex=0><code>git revert -m 1 HEAD
</code></pre><p>-m 1 标记指出 “mainline” 需要被保留下来的父结点。 当你引入一个合并到 HEAD（git merge topic），新提交有两个父结点：第一个是 HEAD（C6），第二个是将要合并入分支的最新提交（C4）。 在本例中，我们想要撤消所有由父结点 #2（C4）合并引入的修改，同时保留从父结点 #1（C4）开始的所有内容。</p><p>有还原提交的历史看起来像这样：
<img src=https://git-scm.com/book/en/v2/images/undomerge-revert.png alt=此处输入图片的描述></p><p>新的提交 ^M 与 C6 有完全一样的内容，所以从这儿开始就像合并从未发生过，除了“现在还没合并”的提交依然在 HEAD 的历史中。 如果你尝试再次合并 topic 到 master Git 会感到困惑：</p><pre tabindex=0><code>git merge topic
Already up-to-date.
</code></pre><p>topic 中并没有东西不能从 master 中追踪到达。 更糟的是，如果你在 topic 中增加工作然后再次合并，Git 只会引入被还原的合并 之后 的修改。
<img src=https://git-scm.com/book/en/v2/images/undomerge-revert2.png alt=此处输入图片的描述></p><h2 id=总结>总结</h2><p><code>git reset</code>命令是一次对版本信息的清洗和回退。通过移动指针指向的内容达成回退版本，并且覆盖掉相应的历史信息的目的。这种重写历史记录的特性，可能会在使用远程仓库时造成问题。</p><p>假设在合并之后，远程仓库又创建了其他提交，那么你的强制提交可能就会洗掉别人的提交记录。所以如果你重写的他人的提交，那就应该避免使用 reset 。</p><p><code>git revert </code>命令是通过使用老的内容，产生一次新的提交以达到覆盖老的提交内容的目的。revert 命令不会覆盖历史记录，相对 reset 命令更加的安全。</p><p>唯一需要注意的是，revert 过后的提交对象由于在分支历史上处于时间线的前列。这就造成了凡是属于此提交对象的父对象的历史信息，都无法被合并到 revert 过后的提交对象上。</p><h2 id=建议>建议</h2><p>虽然根据不同的业务情况选择不同的命令往往是正确做法。但是鉴于 reset 命令会重写历史记录的特性，当你想要撤销某次提交时，请慎重使用 reset 命令。</p><hr><p><a href=https://www.progit.cn>《精通 Git pro 第二版》</a></p></section><footer><a class="permalink u-url" href=https://www.chucklin.net/post/git-revert-reset/>🔗</a><hr class=post-underline><p class=post-tag>Tags for this post:
<a href=https://www.chucklin.net/tags/git class="post-tag p-category">git</a></p></footer></article></div><div class=h-card><img class=u-photo src=https://www.chucklin.net/images/avator.jpg><div class=card-content><h2 class=card-name><a class="p-name u-url" href=https://www.chucklin.net/ rel=me>Chuck Lin</a></h2><p class=card-subhead><span class=p-locality>Chengdu</span>,
<span class=p-country-name>China</span><br><a class=u-email href=mailto:chuck1inzl@gmail.com>Email me</a></p></div><p class=p-note>从事开发工作10年，持续写作4年，现在的身份是一名 freelancer。项目外包、雇佣洽谈等事项请通过邮箱和我联系。</p></div><div id=footer><nav id=article-skip><div class=next><a alt="Newer article" href=https://www.chucklin.net/post/git-branch/>&larr; Newer</a></div><div class=top><a alt="Top of page" href=#>Top</a></div><div class=prev><a alt="Older article" href=https://www.chucklin.net/post/git/>Older &rarr;</a></div></nav><aside id=social><div id=social-icons><div class=icon-24x24><a class=glyph alt="GitHub profile" href=https://github.com/chuck1in><img src=https://www.chucklin.net/icons/github.svg height=24px width=24px></a></div></div></aside><p class=copyright>Copyright © 2021 Chuck Lin. All rights reserved.</p></div></body></html>